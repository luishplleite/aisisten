<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - TimePulse AI</title>
    <meta name="description" content="Configure seu restaurante e personalize o sistema">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/secure-config.js"></script>
    <!-- Sistema de Teste Gratuito -->
    <script src="js/trial-countdown.js"></script>
    
    <!-- QRCode Library for WhatsApp Integration -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- CSS Personalizado para WhatsApp Status -->
    <style>
        .integration-status.status-connected {
            color: #28a745;
            font-weight: 600;
        }
        .integration-status.status-warning {
            color: #ffc107;
            font-weight: 600;
        }
        .integration-status.status-error {
            color: #dc3545;
            font-weight: 600;
        }
        
        /* Status Badge Styles */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-badge.status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-badge.status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-badge.status-blocked {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        .status-badge.status-disconnected {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        /* Integration Card Layout */
        .integration-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .integration-icon {
            font-size: 2.5rem;
            color: #25D366;
            flex-shrink: 0;
        }
        
        .integration-icon .fa-whatsapp {
            color: #25D366;
        }
        
        .integration-icon .fa-credit-card {
            color: #6c63ff;
        }
        
        .integration-icon .fa-envelope {
            color: #ea4335;
        }
        
        .integration-info {
            flex: 1;
        }
        
        .integration-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .integration-info p {
            margin: 0;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .integration-status {
            flex-shrink: 0;
        }
        
        .integration-content {
            margin-top: 15px;
        }
        
        .integration-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .connection-success, .connection-warning, .connection-error {
            text-align: center;
            padding: 20px;
        }
        .connection-success i {
            color: #28a745;
        }
        .connection-warning i {
            color: #ffc107;
        }
        .connection-error i {
            color: #dc3545;
        }
        .qr-code-display {
            text-align: center;
            padding: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Scripts de Configura√ß√£o Segura -->
    <script src="js/secure-config.js"></script>
    <div class="dashboard-layout">
        <!-- Header Mobile com Menu Hamburger -->
        <div class="mobile-header">
            <button class="hamburger-btn" onclick="toggleMobileMenu()" aria-label="Abrir menu">
                <i class="fas fa-bars"></i>
            </button>
            <img src="https://raw.githubusercontent.com/luishplleite/logotimipulseai/refs/heads/main/LOGO%20FINAL.png" alt="TimePulse AI" class="mobile-logo">
        </div>

        <!-- Overlay para fechar menu mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo" style="text-align: center;"><img src="https://raw.githubusercontent.com/luishplleite/logotimipulseai/refs/heads/main/LOGO%20FINAL.png" alt="TimePulse AI" style="height: 200px; width: auto; max-width: 220px;"></div>
                <div class="restaurant-name" id="restaurantName">Carregando...</div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="dashboard.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="gestao_pedidos.html" class="nav-link">
                        <span class="nav-icon">üì¶</span>
                        Pedidos
                    </a>
                    <a href="cozinha.html" class="nav-link">
                        <span class="nav-icon">üë®‚Äçüç≥</span>
                        Cozinha
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Gest√£o</div>
                    <a href="cardapio.html" class="nav-link">
                        <span class="nav-icon">üçΩÔ∏è</span>
                        Card√°pio
                    </a>
                    <a href="gestao_entregadores.html" class="nav-link">
                        <span class="nav-icon">üèçÔ∏è</span>
                        Entregadores
                    </a>
                    <a href="clientes.html" class="nav-link">
                        <span class="nav-icon">üë•</span>
                        Clientes
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Relat√≥rios</div>
                    <a href="relatorios.html" class="nav-link">
                        <span class="nav-icon">üìà</span>
                        An√°lises
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Comercial</div>
                    <a href="assinaturas.html" class="nav-link">
                        <span class="nav-icon">üí≥</span>
                        Assinaturas
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Sistema</div>
                    <a href="configuracoes.html" class="nav-link active">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        Configura√ß√µes
                    </a>
                    <a href="#" class="nav-link">
                        <span class="nav-icon">‚ùì</span>
                        Ajuda
                    </a>
                    <a href="#" class="nav-link" id="logoutButton">
                        <span class="nav-icon">üö™</span>
                        Sair
                    </a>
                </div>
            </div>
            
        </nav>
        
        <!-- Conte√∫do Principal -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="btn btn-secondary d-md-none" data-action="toggle-sidebar">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="header-title">
                            <i class="fas fa-cog"></i>
                            Configura√ß√µes
                        </h1>
                    </div>
                    
                    <div class="header-actions">
                        <div class="user-menu">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- √Årea de Conte√∫do -->
            <div class="content-area">
                <!-- Navega√ß√£o das Configura√ß√µes -->
                <div class="settings-nav">
                    <button class="settings-tab active" data-tab="restaurant">
                        <i class="fas fa-store"></i>
                        Restaurante
                    </button>
                    <button class="settings-tab" data-tab="schedule">
                        <i class="fas fa-clock"></i>
                        Hor√°rios de Funcionamento
                    </button>
                    <button class="settings-tab" data-tab="delivery">
                        <i class="fas fa-motorcycle"></i>
                        Entrega Terceiros
                    </button>
                    <button class="settings-tab" data-tab="timing">
                        <i class="fas fa-clock"></i>
                        Tempo de Entrega
                    </button>
                    <button class="settings-tab" data-tab="payments">
                        <i class="fas fa-credit-card"></i>
                        Pagamentos
                    </button>
                    <button class="settings-tab" data-tab="integrations">
                        <i class="fas fa-plug"></i>
                        Integra√ß√µes
                    </button>
                    <button class="settings-tab" data-tab="security">
                        <i class="fas fa-shield-alt"></i>
                        Seguran√ßa
                    </button>
                </div>
                
                <!-- Conte√∫do das Configura√ß√µes -->
                <div class="settings-content">
                    <!-- Configura√ß√µes do Restaurante -->
                    <div class="settings-section active" id="restaurant-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-store"></i>
                                Informa√ß√µes do Restaurante
                            </h2>
                            <p>Configure as informa√ß√µes b√°sicas do seu estabelecimento</p>
                        </div>
                        
                        <form id="restaurantForm" class="settings-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Nome do Restaurante *</label>
                                    <input type="text" id="restaurantNameInput" class="form-input" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Nome do Propriet√°rio *</label>
                                    <input type="text" id="ownerName" class="form-input" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">CPF do Propriet√°rio</label>
                                    <input type="text" id="ownerCpf" class="form-input" placeholder="000.000.000-00">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Telefone do Propriet√°rio *</label>
                                    <input type="tel" id="ownerPhone" class="form-input" required placeholder="(11) 99999-9999">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" id="cnpj" class="form-input" placeholder="00.000.000/0000-00">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Tipo de Neg√≥cio</label>
                                    <select id="businessType" class="form-input">
                                        <option value="">Carregando...</option>
                                    </select>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label class="form-label">Endere√ßo Completo *</label>
                                    <textarea id="address" class="form-input" rows="3" required placeholder="Rua, N√∫mero, Bairro"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Cidade *</label>
                                    <input type="text" id="city" class="form-input" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Estado *</label>
                                    <select id="state" class="form-input" required>
                                        <option value="">Selecionar...</option>
                                        <option value="AC">Acre</option>
                                        <option value="AL">Alagoas</option>
                                        <option value="AP">Amap√°</option>
                                        <option value="AM">Amazonas</option>
                                        <option value="BA">Bahia</option>
                                        <option value="CE">Cear√°</option>
                                        <option value="DF">Distrito Federal</option>
                                        <option value="ES">Esp√≠rito Santo</option>
                                        <option value="GO">Goi√°s</option>
                                        <option value="MA">Maranh√£o</option>
                                        <option value="MT">Mato Grosso</option>
                                        <option value="MS">Mato Grosso do Sul</option>
                                        <option value="MG">Minas Gerais</option>
                                        <option value="PA">Par√°</option>
                                        <option value="PB">Para√≠ba</option>
                                        <option value="PR">Paran√°</option>
                                        <option value="PE">Pernambuco</option>
                                        <option value="PI">Piau√≠</option>
                                        <option value="RJ">Rio de Janeiro</option>
                                        <option value="RN">Rio Grande do Norte</option>
                                        <option value="RS">Rio Grande do Sul</option>
                                        <option value="RO">Rond√¥nia</option>
                                        <option value="RR">Roraima</option>
                                        <option value="SC">Santa Catarina</option>
                                        <option value="SP">S√£o Paulo</option>
                                        <option value="SE">Sergipe</option>
                                        <option value="TO">Tocantins</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">CEP *</label>
                                    <input type="text" id="zipCode" class="form-input" required placeholder="00000-000">
                                </div>
                            </div>
                            
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Salvar Informa√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Configura√ß√µes de Hor√°rios de Funcionamento -->
                    <div class="settings-section" id="schedule-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-clock"></i>
                                Hor√°rios de Funcionamento
                            </h2>
                            <p>Configure os hor√°rios de funcionamento do seu estabelecimento</p>
                        </div>
                        
                        <form id="scheduleForm" class="settings-form">
                            <div class="form-section">
                                <div class="schedule-grid" id="scheduleGrid">
                                    <!-- Hor√°rios ser√£o carregados aqui -->
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Salvar Hor√°rios
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Configura√ß√µes de Entrega -->
                    <div class="settings-section" id="delivery-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-motorcycle"></i>
                                Entrega Terceiros
                            </h2>
                            <p>Informa√ß√µes sobre entrega terceirizada (somente leitura)</p>
                        </div>
                        
                        <form id="deliveryForm" class="settings-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Taxa de Entrega M√≠nima (R$)</label>
                                    <input type="number" id="deliveryFee" class="form-input" step="0.50" min="0" value="8.00" disabled readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Taxa por Km (R$)</label>
                                    <input type="number" id="deliveryFeePerKm" class="form-input" step="0.25" min="0" value="2.50" disabled readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Dist√¢ncia M√≠nima (Km)</label>
                                    <input type="number" id="minimumDistance" class="form-input" step="0.5" min="0" value="3.0" disabled readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Raio de Entrega (Km)</label>
                                    <input type="number" id="deliveryRadius" class="form-input" step="0.5" min="1" value="10.0" disabled readonly>
                                </div>
                                
                            </div>
                            
                            <div class="readonly-notice">
                                <i class="fas fa-info-circle"></i>
                                <span>Estas configura√ß√µes s√£o gerenciadas pelo sistema de entrega terceirizada</span>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Configura√ß√µes de Tempo de Entrega -->
                    <div class="settings-section" id="timing-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-clock"></i>
                                Tempo de Entrega
                            </h2>
                            <p>Configure pedido m√≠nimo e tempo de preparo</p>
                        </div>
                        
                        <form id="timingForm" class="settings-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Pedido M√≠nimo (R$)</label>
                                    <input type="number" id="minimumOrderEdit" class="form-input" step="5.00" min="0" value="0.00">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Tempo de Preparo (min)</label>
                                    <input type="number" id="preparationTimeEdit" class="form-input" min="5" value="30">
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Salvar Tempo de Entrega
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Configura√ß√µes de Pagamento -->
                    <div class="settings-section" id="payments-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-credit-card"></i>
                                Formas de Pagamento
                            </h2>
                            <p>Configure as formas de pagamento aceitas</p>
                        </div>
                        
                        <form id="paymentsForm" class="settings-form">
                            
                            <div class="custom-payment-methods">
                                <div class="section-header-inline">
                                    <h3>Formas de Pagamento Customizadas</h3>
                                    <button type="button" class="btn btn-primary" onclick="openPaymentMethodModal()">
                                        <i class="fas fa-plus"></i>
                                        Adicionar
                                    </button>
                                </div>
                                
                                <div id="customPaymentMethodsList" class="custom-methods-list">
                                    <!-- Formas de pagamento customizadas ser√£o carregadas aqui -->
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Salvar Pagamentos
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Modal para adicionar/editar formas de pagamento -->
                    <div id="paymentMethodModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 id="paymentMethodModalTitle">Adicionar Forma de Pagamento</h2>
                                <button type="button" class="modal-close" onclick="closePaymentMethodModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <form id="paymentMethodForm" class="modal-form">
                                <div class="form-group">
                                    <label class="form-label">Nome da Forma de Pagamento *</label>
                                    <input type="text" id="paymentMethodName" class="form-input" required placeholder="Ex: Vale Alimenta√ß√£o">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Descri√ß√£o</label>
                                    <textarea id="paymentMethodDescription" class="form-input" rows="3" placeholder="Descri√ß√£o opcional"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" id="paymentMethodRequiresChange">
                                        Aceita troco
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">√çcone</label>
                                    <select id="paymentMethodIcon" class="form-input">
                                        <option value="fa-money-bill">üíµ Dinheiro</option>
                                        <option value="fa-credit-card">üí≥ Cart√£o</option>
                                        <option value="fa-qrcode">üì± QR Code</option>
                                        <option value="fa-receipt">üßæ Voucher</option>
                                        <option value="fa-gift">üéÅ Vale</option>
                                        <option value="fa-coins">ü™ô Moedas</option>
                                        <option value="fa-wallet">üëõ Carteira</option>
                                    </select>
                                </div>
                                
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" onclick="closePaymentMethodModal()">Cancelar</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√µes de Integra√ß√µes -->
                    <div class="settings-section" id="integrations-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-plug"></i>
                                Integra√ß√µes
                            </h2>
                            <p>Conecte o TimePulse AI com outros servi√ßos</p>
                        </div>
                        
                        <div class="integrations-grid">
                            <!-- WhatsApp Integration -->
                            <div class="integration-card">
                                <div class="integration-header">
                                    <div class="integration-icon">
                                        <i class="fab fa-whatsapp"></i>
                                    </div>
                                    <div class="integration-info">
                                        <h3>WhatsApp</h3>
                                        <p>Envie notifica√ß√µes autom√°ticas via WhatsApp</p>
                                    </div>
                                    <div class="integration-status" id="whatsapp-status">
                                        <span class="status-badge status-disconnected">Desconectado</span>
                                    </div>
                                </div>
                                
                                <div class="integration-content" id="whatsapp-content">
                                    <div class="alert alert-success" id="whatsapp-success" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                        WhatsApp conectado com sucesso!
                                    </div>
                                    
                                    <div class="integration-actions">
                                        <button type="button" class="btn btn-primary" id="configure-whatsapp" onclick="openWhatsAppModal()" disabled>
                                            <i class="fas fa-cog"></i>
                                            Configurar
                                        </button>
                                        <button type="button" class="btn btn-danger" id="disconnect-whatsapp" style="display: none;">
                                            <i class="fas fa-unlink"></i>
                                            Desconectar
                                        </button>
                                    </div>
                                    
                                    <div class="trial-warning" id="whatsapp-trial-warning" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Funcionalidade bloqueada: Teste gratuito expirado. 
                                        <a href="assinaturas.html">Assine para desbloquear</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Asaas Integration -->
                            <div class="integration-card">
                                <div class="integration-header">
                                    <div class="integration-icon">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="integration-info">
                                        <h3>Asaas</h3>
                                        <p>Processamento de pagamentos online</p>
                                    </div>
                                    <div class="integration-status" id="asaas-status">
                                        <span class="status-badge status-success">Conectado</span>
                                    </div>
                                </div>
                                
                                <div class="integration-content">
                                    <div class="integration-actions">
                                        <button type="button" class="btn btn-primary" id="btnConfigureAsaas">
                                            <i class="fas fa-cog"></i>
                                            Configurar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- E-mail SMTP Integration -->
                            <div class="integration-card">
                                <div class="integration-header">
                                    <div class="integration-icon">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="integration-info">
                                        <h3>E-mail SMTP</h3>
                                        <p>Envio de e-mails autom√°ticos</p>
                                    </div>
                                    <div class="integration-status" id="smtp-status">
                                        <span class="status-badge status-error">Desconectado</span>
                                    </div>
                                </div>
                                
                                <div class="integration-content">
                                    <div class="integration-actions">
                                        <button type="button" class="btn btn-primary" onclick="configureSMTP()">
                                            <i class="fas fa-cog"></i>
                                            Configurar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√µes de Seguran√ßa -->
                    <div class="settings-section" id="security-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-shield-alt"></i>
                                Seguran√ßa
                            </h2>
                            <p>Gerencie a seguran√ßa da sua conta e dados</p>
                        </div>
                        
                        <div class="security-options">
                            <div class="security-card">
                                <div>
                                    <h3>
                                        <i class="fas fa-key"></i>
                                        Alterar Senha
                                    </h3>
                                    <p>Altere sua senha de acesso regularmente</p>
                                </div>
                                <button class="btn btn-warning" onclick="changePassword()">
                                    Alterar Senha
                                </button>
                            </div>
                            
                            <div class="security-card">
                                <div>
                                    <h3>
                                        <i class="fas fa-download"></i>
                                        Backup dos Dados
                                    </h3>
                                    <p>Fa√ßa backup dos seus dados importantes</p>
                                </div>
                                <button class="btn btn-info" onclick="exportData()">
                                    Exportar Dados
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Configura√ß√£o WhatsApp -->
    <div class="modal-overlay" id="whatsappModal" style="display: none;">
        <div class="modal-container modal-lg">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fab fa-whatsapp text-success"></i>
                    Configura√ß√£o WhatsApp
                </h5>
                <button type="button" class="modal-close" onclick="closeWhatsAppModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="whatsapp-modal-content">
                
                <!-- Informa√ß√µes da Inst√¢ncia -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h6 style="margin-bottom: 15px; color: #2c3e50;">üìä Informa√ß√µes da Inst√¢ncia</h6>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="font-weight: bold; color: #495057;">Nome da Inst√¢ncia:</span>
                        <span style="color: #28a745; font-family: monospace;" id="modal-instanceName">Carregando...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span style="font-weight: bold; color: #495057;">Status da Inst√¢ncia:</span>
                        <span id="modal-instanceStatus">Verificando...</span>
                    </div>
                </div>

                <!-- Alertas din√¢micos -->
                <div id="modal-alerts"></div>

                <!-- Bot√£o Criar Inst√¢ncia -->
                <button 
                    class="btn btn-success" 
                    id="modal-createInstanceBtn" 
                    onclick="createEvolutionInstanceModal()" 
                    style="width: 100%; margin-bottom: 15px; display: none;">
                    üöÄ Criar Inst√¢ncia no Evolution
                </button>

                <!-- Bot√£o Gerar QR Code -->
                <button 
                    class="btn btn-primary" 
                    id="modal-generateQRBtn" 
                    onclick="generateQRCodeModal()" 
                    style="width: 100%; margin-bottom: 15px; display: none;">
                    üì± Gerar QR Code para Conectar
                </button>

                <!-- Bot√£o Configura√ß√µes WhatsApp -->
                <button 
                    class="btn btn-info" 
                    id="modal-settingsBtn" 
                    onclick="openWhatsAppSettingsModal()" 
                    style="width: 100%; margin-bottom: 15px; display: none;">
                    ‚öôÔ∏è Configura√ß√µes do WhatsApp
                </button>

                <!-- Loader -->
                <div style="text-align: center; margin: 20px 0; display: none;" id="modal-loader">
                    <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #28a745;"></i>
                </div>

                <!-- QR Code Section -->
                <div id="modal-qrcodeSection" style="display: none; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h6 style="margin-bottom: 15px; color: #2c3e50;">üì± QR Code para Conectar WhatsApp:</h6>
                    <img id="modal-qrcodeImage" src="" alt="QR Code" style="max-width: 300px; border: 2px solid #28a745; border-radius: 10px; background: white; padding: 10px; margin: 0 auto;">
                    <p style="margin-top: 15px; color: #28a745; font-weight: bold;">üì≤ Escaneie este QR Code com o WhatsApp</p>
                    <div style="text-align: left; margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                        <h6 style="color: #495057;"><i class="fas fa-mobile-alt"></i> Como conectar:</h6>
                        <ol style="color: #6c757d; font-size: 14px; margin-top: 10px;">
                            <li>Abra o WhatsApp no seu celular</li>
                            <li>Toque em <strong>Menu</strong> ou <strong>Configura√ß√µes</strong></li>
                            <li>Toque em <strong>Aparelhos conectados</strong></li>
                            <li>Toque em <strong>Conectar um aparelho</strong></li>
                            <li>Aponte o celular para esta tela para capturar o c√≥digo</li>
                        </ol>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeWhatsAppModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√µes WhatsApp Settings -->
    <div class="modal-overlay" id="whatsappSettingsModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog text-success"></i>
                    Configura√ß√µes do WhatsApp
                </h5>
                <button type="button" class="modal-close" onclick="closeWhatsAppSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: #d4edda; border-radius: 8px; border: 1px solid #c3e6cb;">
                    <p style="margin: 0; color: #155724;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Inst√¢ncia:</strong> <span id="settings-instanceName">-</span>
                    </p>
                </div>

                <div id="settings-alerts"></div>

                <!-- Settings Form -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    
                    <!-- Reject Calls -->
                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 5px 0; color: #2c3e50;">
                                    <i class="fas fa-phone-slash"></i> Rejeitar Chamadas
                                </h6>
                                <p style="margin: 0; font-size: 13px; color: #6c757d;">
                                    Rejeitar todas as chamadas recebidas
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting-rejectCall" onchange="updateWhatsAppSetting('rejectCall', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Ignore Groups -->
                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 5px 0; color: #2c3e50;">
                                    <i class="fas fa-users-slash"></i> Ignorar Grupos
                                </h6>
                                <p style="margin: 0; font-size: 13px; color: #6c757d;">
                                    Ignorar todas as mensagens de grupos
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting-groupsIgnore" onchange="updateWhatsAppSetting('groupsIgnore', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Always Online -->
                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 5px 0; color: #2c3e50;">
                                    <i class="fas fa-circle"></i> Sempre Online
                                </h6>
                                <p style="margin: 0; font-size: 13px; color: #6c757d;">
                                    Manter WhatsApp sempre online
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting-alwaysOnline" onchange="updateWhatsAppSetting('alwaysOnline', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Read Messages -->
                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 5px 0; color: #2c3e50;">
                                    <i class="fas fa-check-double"></i> Ler Mensagens
                                </h6>
                                <p style="margin: 0; font-size: 13px; color: #6c757d;">
                                    Marcar todas as mensagens como lidas
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting-readMessages" onchange="updateWhatsAppSetting('readMessages', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Sync Full History -->
                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 5px 0; color: #2c3e50;">
                                    <i class="fas fa-history"></i> Sincronizar Hist√≥rico Completo
                                </h6>
                                <p style="margin: 0; font-size: 13px; color: #6c757d;">
                                    Sincronizar todo o hist√≥rico de conversas ao escanear QR code
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting-syncFullHistory" onchange="updateWhatsAppSetting('syncFullHistory', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Read Status -->
                    <div class="setting-item">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 5px 0; color: #2c3e50;">
                                    <i class="fas fa-eye"></i> Ler Status
                                </h6>
                                <p style="margin: 0; font-size: 13px; color: #6c757d;">
                                    Marcar todos os status como lidos
                                </p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="setting-readStatus" onchange="updateWhatsAppSetting('readStatus', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                </div>

                <!-- Loader -->
                <div style="text-align: center; margin: 20px 0; display: none;" id="settings-loader">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: #28a745;"></i>
                    <p style="margin-top: 10px; color: #6c757d;">Salvando configura√ß√µes...</p>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeWhatsAppSettingsModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o Asaas -->
    <div class="modal-overlay" id="asaasModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-credit-card text-primary"></i>
                    Configura√ß√£o Asaas
                </h5>
                <button type="button" class="modal-close" onclick="closeAsaasModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="asaas-info">
                    <div class="info-card">
                        <i class="fas fa-info-circle text-info"></i>
                        <div>
                            <h6>Sobre a Integra√ß√£o Asaas</h6>
                            <p>Esta configura√ß√£o permite gerar c√≥digos PIX copia e cola que ser√£o enviados automaticamente para seus clientes via WhatsApp quando realizarem pedidos.</p>
                        </div>
                    </div>
                </div>

                <form id="asaasForm" class="asaas-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i>
                            API Key do Asaas *
                        </label>
                        <div class="password-input-container">
                            <input 
                                type="password" 
                                id="asaasApiKey" 
                                class="form-input" 
                                placeholder="Digite sua API Key do Asaas"
                                required
                            >
                            <button 
                                type="button" 
                                class="password-toggle-btn" 
                                onclick="toggleAsaasApiKeyVisibility()"
                                title="Mostrar/Ocultar API Key"
                            >
                                <i class="fas fa-eye" id="asaasToggleIcon"></i>
                            </button>
                        </div>
                        <small class="form-help">
                            <i class="fas fa-shield-alt"></i>
                            Sua API Key √© mantida segura e criptografada no banco de dados
                        </small>
                    </div>

                    <div class="asaas-status" id="asaasConnectionStatus" style="display: none;">
                        <div class="status-indicator">
                            <i class="fas fa-circle text-success"></i>
                            <span>Conectado com sucesso</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAsaasModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAsaasSettings()">
                    <i class="fas fa-save"></i>
                    Salvar Configura√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Inst√¢ncia N√£o Encontrada -->
    <div class="modal-overlay" id="instanceNotFoundModal" style="display: none;">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    Inst√¢ncia WhatsApp N√£o Encontrada
                </h5>
                <button type="button" class="modal-close" onclick="closeInstanceNotFoundModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <i class="fas fa-whatsapp" style="font-size: 64px; color: #25D366; margin-bottom: 20px;"></i>
                <h6 style="margin-bottom: 15px;">A inst√¢ncia WhatsApp ainda n√£o foi criada</h6>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Para conectar o WhatsApp ao sistema, precisamos criar uma nova inst√¢ncia.
                </p>
                <p style="font-weight: 600; color: #333;">
                    Nome da inst√¢ncia: <span id="modalInstanceName" style="color: #007bff;"></span>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeInstanceNotFoundModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="createInstanceFromModal()">
                    <i class="fas fa-plus-circle"></i> Criar Inst√¢ncia
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Sucesso -->
    <div class="modal-overlay" id="instanceSuccessModal" style="display: none;">
        <div class="modal-container" style="max-width: 450px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success"></i>
                    Sucesso!
                </h5>
                <button type="button" class="modal-close" onclick="closeInstanceSuccessModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <i class="fas fa-check-circle" style="font-size: 64px; color: #28a745; margin-bottom: 20px;"></i>
                <h6 style="margin-bottom: 15px;">Inst√¢ncia criada com sucesso!</h6>
                <p style="color: #6c757d;">
                    Agora vamos conectar seu WhatsApp escaneando o QR Code.
                </p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-primary" onclick="showQRCodeModal()">
                    <i class="fas fa-qrcode"></i> Ver QR Code
                </button>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div class="modal-overlay" id="qrcodeModal" style="display: none;">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fab fa-whatsapp text-success"></i>
                    Conectar WhatsApp
                </h5>
                <button type="button" class="modal-close" onclick="closeQRCodeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div id="qrcodeStatus" style="margin-bottom: 20px;">
                    <p><strong>Escaneie o QR Code com seu WhatsApp:</strong></p>
                    <ol style="text-align: left; display: inline-block; margin: 15px 0;">
                        <li>Abra o WhatsApp no seu celular</li>
                        <li>Toque em Menu ou Configura√ß√µes</li>
                        <li>Toque em "Aparelhos conectados"</li>
                        <li>Toque em "Conectar um aparelho"</li>
                        <li>Aponte seu celular para esta tela para escanear o c√≥digo</li>
                    </ol>
                </div>
                
                <div id="qrcodeContainer" style="display: flex; justify-content: center; align-items: center; min-height: 300px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                    <div id="qrcodeLoader" style="display: block;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #007bff;"></i>
                        <p style="margin-top: 15px; color: #6c757d;">Gerando QR Code...</p>
                    </div>
                    <img id="qrcodeImage" src="" alt="QR Code" style="display: none; max-width: 300px; max-height: 300px;">
                </div>

                <div id="connectionStatus" style="margin-top: 20px;">
                    <div class="alert alert-info" style="padding: 10px;">
                        <i class="fas fa-info-circle"></i> Aguardando conex√£o...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeQRCodeModal()">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ===== CONFIGURA√á√ÉO SEGURA =====
        async function fetchPublicConfig() {
            console.log('üöÄ CONFIGURA√á√ïES - Iniciando carregamento de configura√ß√µes p√∫blicas...');
            console.log('üìã CONFIGURA√á√ïES - Estado inicial da fun√ß√£o fetchPublicConfig:', {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent.substring(0, 100) + '...',
                location: window.location.href,
                hostname: window.location.hostname,
                port: window.location.port,
                protocol: window.location.protocol
            });
            try {
                const currentHost = window.location.hostname;
                const currentPort = window.location.port;
                const currentProtocol = window.location.protocol;
                
                console.log(`üåê CONFIGURA√á√ïES - Detec√ß√£o de ambiente:`);
                console.log(`   - Host: ${currentHost}`);
                console.log(`   - Porta: ${currentPort || 'n√£o especificada'}`);
                console.log(`   - Protocolo: ${currentProtocol}`);
                
                // Determinar URL base baseada no ambiente atual
                let baseUrl;
                if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                    baseUrl = `${currentProtocol}//${currentHost}:${currentPort || '5000'}`;
                    console.log('üè† CONFIGURA√á√ïES - Ambiente: Local (localhost)');
                } else if (currentHost === 'timepulseai.com.br' || currentHost === 'www.timepulseai.com.br') {
                    baseUrl = `https://${currentHost}`;
                    console.log('üåç CONFIGURA√á√ïES - Ambiente: Produ√ß√£o (timepulseai.com.br)');
                } else if (currentHost.includes('replit')) {
                    baseUrl = `${currentProtocol}//${currentHost}${currentPort ? ':' + currentPort : ''}`;
                    console.log('‚ö° CONFIGURA√á√ïES - Ambiente: Replit');
                } else {
                    baseUrl = `${currentProtocol}//${currentHost}${currentPort ? ':' + currentPort : ''}`;
                    console.log('üîß CONFIGURA√á√ïES - Ambiente: Gen√©rico');
                }
                
                console.log(`üì° CONFIGURA√á√ïES - URL base definida: ${baseUrl}`);
                
                const timestamp = Date.now();
                const configUrl = `${baseUrl}/api/config?t=${timestamp}`;
                
                console.log(`üîç CONFIGURA√á√ïES - Carregando configura√ß√£o b√°sica de: ${configUrl}`);
                
                // Buscar configura√ß√£o b√°sica do servidor
                console.log('üì§ CONFIGURA√á√ïES - Enviando requisi√ß√£o para configura√ß√£o b√°sica...');
                const response = await fetch(configUrl, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log(`üì• CONFIGURA√á√ïES - Resposta recebida (Status: ${response.status})`);
                
                if (!response.ok) {
                    console.error(`‚ùå CONFIGURA√á√ïES - Erro na requisi√ß√£o b√°sica: ${response.status} - ${response.statusText}`);
                    throw new Error(`Erro do servidor: ${response.status} - ${response.statusText}`);
                }
                
                const basicConfig = await response.json();
                console.log('‚úÖ CONFIGURA√á√ïES - Configura√ß√£o b√°sica carregada com sucesso');
                console.log('üìã CONFIGURA√á√ïES - Dados b√°sicos:', basicConfig);
                
                // Buscar configura√ß√£o do Supabase
                console.log('üîí CONFIGURA√á√ïES - Carregando configura√ß√£o do Supabase...');
                const supabaseUrl = `${baseUrl}/api/config/supabase`;
                console.log(`üì° CONFIGURA√á√ïES - URL Supabase: ${supabaseUrl}`);
                
                const supabaseResponse = await fetch(supabaseUrl, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log(`üì• CONFIGURA√á√ïES - Resposta Supabase (Status: ${supabaseResponse.status})`);
                
                if (!supabaseResponse.ok) {
                    console.error(`‚ùå CONFIGURA√á√ïES - Erro na configura√ß√£o Supabase: ${supabaseResponse.status}`);
                    throw new Error(`Erro ao carregar configura√ß√£o do Supabase: ${supabaseResponse.status}`);
                }
                
                const supabaseConfig = await supabaseResponse.json();
                console.log('‚úÖ CONFIGURA√á√ïES - Configura√ß√£o Supabase carregada com sucesso');
                console.log('üîë CONFIGURA√á√ïES - Dados Supabase:', { 
                    url: supabaseConfig.url, 
                    hasAnonKey: !!supabaseConfig.anon_key,
                    status: supabaseConfig.status
                });
                
                // Buscar configura√ß√£o do Evolution API
                console.log('üì± CONFIGURA√á√ïES - Carregando configura√ß√£o da Evolution API...');
                let evolutionConfig = {};
                try {
                    const evolutionUrl = `${baseUrl}/api/config/evolution?t=${timestamp}`;
                    console.log(`üì° CONFIGURA√á√ïES - URL Evolution: ${evolutionUrl}`);
                    
                    const evolutionResponse = await fetch(evolutionUrl, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    console.log(`üì• CONFIGURA√á√ïES - Resposta Evolution (Status: ${evolutionResponse.status})`);
                    
                    if (evolutionResponse.ok) {
                        evolutionConfig = await evolutionResponse.json();
                        console.log('‚úÖ CONFIGURA√á√ïES - Configura√ß√£o Evolution carregada com sucesso');
                        console.log('üì± CONFIGURA√á√ïES - Dados Evolution:', { 
                            serverUrl: evolutionConfig.serverUrl, 
                            hasApiKey: !!evolutionConfig.apiKey,
                            status: evolutionConfig.status
                        });
                    } else {
                        console.warn(`‚ö†Ô∏è CONFIGURA√á√ïES - Evolution API retornou status ${evolutionResponse.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå CONFIGURA√á√ïES - Erro ao carregar Evolution API:', error.message);
                    console.warn('‚ö†Ô∏è CONFIGURA√á√ïES - Evolution API n√£o dispon√≠vel:', error.message);
                }
                
                // Buscar configura√ß√£o do Mapbox
                console.log('üó∫Ô∏è CONFIGURA√á√ïES - Carregando configura√ß√£o do Mapbox...');
                let mapboxConfig = {};
                try {
                    const mapboxUrl = `${baseUrl}/api/config/mapbox?t=${timestamp}`;
                    console.log(`üì° CONFIGURA√á√ïES - URL Mapbox: ${mapboxUrl}`);
                    
                    const mapboxResponse = await fetch(mapboxUrl, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    console.log(`üì• CONFIGURA√á√ïES - Resposta Mapbox (Status: ${mapboxResponse.status})`);
                    
                    if (mapboxResponse.ok) {
                        mapboxConfig = await mapboxResponse.json();
                        console.log('‚úÖ CONFIGURA√á√ïES - Configura√ß√£o Mapbox carregada com sucesso');
                        console.log('üó∫Ô∏è CONFIGURA√á√ïES - Dados Mapbox:', { 
                            hasAccessToken: !!mapboxConfig.accessToken,
                            status: mapboxConfig.status
                        });
                    } else {
                        console.warn(`‚ö†Ô∏è CONFIGURA√á√ïES - Mapbox API retornou status ${mapboxResponse.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå CONFIGURA√á√ïES - Erro ao carregar Mapbox API:', error.message);
                    console.warn('‚ö†Ô∏è CONFIGURA√á√ïES - Mapbox API n√£o dispon√≠vel:', error.message);
                }
                
                // Buscar configura√ß√£o do OpenAI
                console.log('ü§ñ CONFIGURA√á√ïES - Carregando configura√ß√£o do OpenAI...');
                let openaiConfig = {};
                try {
                    const openaiUrl = `${baseUrl}/api/config/openai?t=${timestamp}`;
                    console.log(`üì° CONFIGURA√á√ïES - URL OpenAI: ${openaiUrl}`);
                    
                    const openaiResponse = await fetch(openaiUrl, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    console.log(`üì• CONFIGURA√á√ïES - Resposta OpenAI (Status: ${openaiResponse.status})`);
                    
                    if (openaiResponse.ok) {
                        openaiConfig = await openaiResponse.json();
                        console.log('‚úÖ CONFIGURA√á√ïES - Configura√ß√£o OpenAI carregada com sucesso');
                        console.log('ü§ñ CONFIGURA√á√ïES - Dados OpenAI:', { 
                            hasApiKey: !!openaiConfig.apiKey,
                            status: openaiConfig.status
                        });
                    } else {
                        console.warn(`‚ö†Ô∏è CONFIGURA√á√ïES - OpenAI API retornou status ${openaiResponse.status}`);
                    }
                } catch (error) {
                    console.error('‚ùå CONFIGURA√á√ïES - Erro ao carregar OpenAI API:', error.message);
                    console.warn('‚ö†Ô∏è CONFIGURA√á√ïES - OpenAI API n√£o dispon√≠vel:', error.message);
                }
                
                const finalConfig = {
                    ...basicConfig,
                    supabaseUrl: supabaseConfig.url,
                    supabaseAnonKey: supabaseConfig.anon_key,
                    evolution: evolutionConfig,
                    mapbox: mapboxConfig,
                    openai: openaiConfig
                };
                
                console.log('üéØ CONFIGURA√á√ïES - Configura√ß√£o final consolidada:');
                console.log('   ‚úÖ Configura√ß√£o b√°sica inclu√≠da');
                console.log(`   üîí Supabase: ${supabaseConfig.url ? 'Configurado' : 'N√£o configurado'}`);
                console.log(`   üì± Evolution: ${evolutionConfig.status === 'ok' ? 'Configurado' : 'N√£o configurado'}`);
                console.log(`   üó∫Ô∏è Mapbox: ${mapboxConfig.status === 'ok' ? 'Configurado' : 'N√£o configurado'}`);
                console.log(`   ü§ñ OpenAI: ${openaiConfig.status === 'ok' ? 'Configurado' : 'N√£o configurado'}`);
                
                console.log('üöÄ CONFIGURA√á√ïES - Carregamento de configura√ß√µes conclu√≠do com sucesso!');
                return finalConfig;
                
            } catch (error) {
                console.error('üí• CONFIGURA√á√ïES - ERRO CR√çTICO ao carregar configura√ß√£o:', error);
                console.error('üîç CONFIGURA√á√ïES - Stack trace:', error.stack);
                return null;
            }
        }

        // ===== GERENCIADOR DE CONFIGURA√á√ïES =====
        class SettingsManager {
            constructor() {
                console.log('üèóÔ∏è SETTINGS MANAGER - Iniciando construtor...');
                
                this.hasUnsavedChanges = false;
                console.log('üìù SETTINGS MANAGER - hasUnsavedChanges inicializado como false');
                
                // Detectar a aba ativa atual ou usar 'restaurant' como padr√£o
                const activeTab = document.querySelector('.settings-tab.active');
                this.currentSection = activeTab ? activeTab.dataset.tab : 'restaurant';
                console.log(`üè∑Ô∏è SETTINGS MANAGER - Aba ativa detectada: ${this.currentSection}`);
                console.log(`üìã SETTINGS MANAGER - Elemento da aba ativa:`, activeTab);
                
                this.supabase = null;
                this.currentRestaurant = null;
                this.originalRestaurantData = {};
                
                console.log('‚úÖ SETTINGS MANAGER - Construtor conclu√≠do com sucesso');
                console.log('üîç SETTINGS MANAGER - Estado inicial:', {
                    hasUnsavedChanges: this.hasUnsavedChanges,
                    currentSection: this.currentSection,
                    supabase: !!this.supabase,
                    currentRestaurant: !!this.currentRestaurant,
                    originalRestaurantData: Object.keys(this.originalRestaurantData).length
                });
            }
            
            async loadEvolutionAPICredentials() {
                console.log('üîê SETTINGS MANAGER - Iniciando carregamento de credenciais da Evolution API...');
                try {
                    const baseUrl = `${window.location.protocol}//${window.location.host}`;
                    console.log(`üì° SETTINGS MANAGER - URL base para APIs: ${baseUrl}`);
                    
                    const apiUrl = `${baseUrl}/api/config/apis`;
                    console.log(`üîó SETTINGS MANAGER - URL das APIs: ${apiUrl}`);
                    
                    console.log('üì§ SETTINGS MANAGER - Enviando requisi√ß√£o para credenciais...');
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    console.log(`üì• SETTINGS MANAGER - Resposta das credenciais (Status: ${response.status})`);
                    
                    if (!response.ok) {
                        console.error(`‚ùå SETTINGS MANAGER - Erro na requisi√ß√£o de credenciais: ${response.status}`);
                        throw new Error(`Erro ao carregar credenciais da Evolution API: ${response.status}`);
                    }
                    
                    const apis = await response.json();
                    console.log('üìã SETTINGS MANAGER - Dados das APIs recebidos:', apis);
                    
                    if (apis.evolution?.serverUrl && apis.evolution?.apiKey) {
                        EVOLUTION_API.serverUrl = apis.evolution.serverUrl;
                        EVOLUTION_API.apiKey = apis.evolution.apiKey;
                        console.log('‚úÖ SETTINGS MANAGER - Credenciais da Evolution API carregadas com sucesso');
                        console.log('üîë SETTINGS MANAGER - Evolution configurado:', {
                            serverUrl: apis.evolution.serverUrl,
                            hasApiKey: !!apis.evolution.apiKey
                        });
                    } else {
                        console.warn('‚ö†Ô∏è SETTINGS MANAGER - Credenciais da Evolution API n√£o encontradas no servidor');
                        console.log('üîç SETTINGS MANAGER - Estrutura recebida:', apis);
                        throw new Error('Credenciais Evolution n√£o encontradas na resposta do servidor');
                    }
                    
                } catch (error) {
                    console.error('üí• SETTINGS MANAGER - ERRO ao carregar credenciais da Evolution API:', error);
                    console.error('üîç SETTINGS MANAGER - Stack trace:', error.stack);
                    throw error;
                }
            }
            
            async loadEvolutionAPICredentialsFallback() {
                console.log('üîÑ FALLBACK - Carregando credenciais Evolution diretamente...');
                try {
                    // Tentar carregar configura√ß√µes Evolution e OpenAI separadamente
                    const baseUrl = `${window.location.protocol}//${window.location.host}`;
                    
                    console.log('üì° FALLBACK - Carregando configura√ß√£o Evolution...');
                    const evolutionResponse = await fetch(`${baseUrl}/api/config/evolution`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (evolutionResponse.ok) {
                        const evolutionConfig = await evolutionResponse.json();
                        console.log('üìã FALLBACK - Config Evolution recebida:', evolutionConfig);
                        
                        if (evolutionConfig.serverUrl && evolutionConfig.apiKey) {
                            EVOLUTION_API.serverUrl = evolutionConfig.serverUrl;
                            EVOLUTION_API.apiKey = evolutionConfig.apiKey;
                            console.log('‚úÖ FALLBACK - Evolution API configurada com sucesso!');
                            console.log('üîë FALLBACK - Evolution URL:', evolutionConfig.serverUrl);
                        } else {
                            console.error('‚ùå FALLBACK - Configura√ß√£o Evolution inv√°lida:', evolutionConfig);
                        }
                    } else {
                        console.error(`‚ùå FALLBACK - Erro ao carregar config Evolution: ${evolutionResponse.status}`);
                    }
                    
                } catch (error) {
                    console.error('üí• FALLBACK - Erro cr√≠tico:', error);
                }
            }
            
            async init() {
                console.log('üöÄ SETTINGS MANAGER - Iniciando processo de inicializa√ß√£o...');
                console.log('üìã SETTINGS MANAGER - Estado inicial do init():', {
                    timestamp: new Date().toISOString(),
                    currentSection: this.currentSection,
                    hasSupabase: !!this.supabase,
                    hasRestaurant: !!this.currentRestaurant,
                    location: window.location.href
                });
                
                console.time('‚è±Ô∏è SETTINGS MANAGER - Tempo total de inicializa√ß√£o');
                
                try {
                    console.log('üîê SETTINGS MANAGER - Verificando status de autentica√ß√£o...');
                    console.time('‚è±Ô∏è SETTINGS MANAGER - Verifica√ß√£o de autentica√ß√£o');
                    
                    // Verificar autentica√ß√£o
                    const isAuthenticated = SECURE_INSTANCE_MANAGER.isAuthenticated();
                    console.log(`üîç SETTINGS MANAGER - Status de autentica√ß√£o: ${isAuthenticated}`);
                    console.timeEnd('‚è±Ô∏è SETTINGS MANAGER - Verifica√ß√£o de autentica√ß√£o');
                    
                    if (!isAuthenticated) {
                        console.log('‚ùå SETTINGS MANAGER - Usu√°rio n√£o autenticado. Redirecionando para login...');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    console.log('‚úÖ SETTINGS MANAGER - Usu√°rio j√° autenticado');

                    // Inicializar Supabase (evitar m√∫ltiplos clientes)
                    console.log('üîí SETTINGS MANAGER - Verificando cliente Supabase...');
                    console.time('‚è±Ô∏è SETTINGS MANAGER - Inicializa√ß√£o do Supabase');
                    
                    if (!this.supabase) {
                        console.log('üì° SETTINGS MANAGER - Cliente Supabase n√£o encontrado, carregando configura√ß√µes...');
                        console.log('‚ö° SETTINGS MANAGER - Iniciando fetchPublicConfig()...');
                        
                        const config = await fetchPublicConfig();
                        console.log('‚úÖ SETTINGS MANAGER - fetchPublicConfig() conclu√≠do');
                        console.log('üìä SETTINGS MANAGER - Configura√ß√µes recebidas:', {
                            hasSupabaseUrl: !!config?.supabaseUrl,
                            hasSupabaseKey: !!config?.supabaseAnonKey,
                            hasEvolution: !!config?.evolution,
                            hasMapbox: !!config?.mapbox,
                            hasOpenAI: !!config?.openai
                        });
                        
                        if (!config || !config.supabaseUrl || !config.supabaseAnonKey) {
                            console.error('‚ùå SETTINGS MANAGER - Configura√ß√µes inv√°lidas recebidas:', config);
                            throw new Error('N√£o foi poss√≠vel carregar as configura√ß√µes seguras do servidor');
                        }
                        
                        console.log('‚úÖ SETTINGS MANAGER - Configura√ß√µes v√°lidas recebidas');
                        
                        // Usar cliente Supabase do secureSupabase se dispon√≠vel para evitar m√∫ltiplas inst√¢ncias
                        if (window.secureSupabase) {
                            console.log('üîß SETTINGS MANAGER - Usando cliente Supabase singleton...');
                            this.supabase = await window.secureSupabase.getClient();
                            console.log('‚úÖ SETTINGS MANAGER - Cliente Supabase singleton obtido');
                        } else {
                            console.log('üîß SETTINGS MANAGER - Criando novo cliente Supabase...');
                            this.supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                            console.log('‚úÖ SETTINGS MANAGER - Novo cliente Supabase criado');
                        }
                        
                        if (!this.supabase) {
                            console.error('‚ùå SETTINGS MANAGER - Falha ao obter cliente Supabase');
                            throw new Error('Erro ao inicializar conex√£o com o banco de dados');
                        }
                        
                        console.log('üéØ SETTINGS MANAGER - Cliente Supabase inicializado com sucesso');
                    } else {
                        console.log('‚úÖ SETTINGS MANAGER - Cliente Supabase j√° dispon√≠vel');
                    }
                    
                    console.timeEnd('‚è±Ô∏è SETTINGS MANAGER - Inicializa√ß√£o do Supabase');
                    
                    // Sistema de proxy ativo - credenciais n√£o necess√°rias no frontend
                    console.log('üì± SETTINGS MANAGER - Sistema de proxy Evolution API ativo');
                    console.time('‚è±Ô∏è SETTINGS MANAGER - Verifica√ß√£o Evolution API');
                    console.log('‚úÖ SETTINGS MANAGER - Evolution API dispon√≠vel via proxy');
                    console.timeEnd('‚è±Ô∏è SETTINGS MANAGER - Verifica√ß√£o Evolution API');
                    
                    console.log('üéß SETTINGS MANAGER - Configurando event listeners...');
                    console.time('‚è±Ô∏è SETTINGS MANAGER - Setup Event Listeners');
                    this.setupEventListeners();
                    console.timeEnd('‚è±Ô∏è SETTINGS MANAGER - Setup Event Listeners');
                    
                    console.log('‚öôÔ∏è SETTINGS MANAGER - Carregando configura√ß√µes...');
                    console.time('‚è±Ô∏è SETTINGS MANAGER - Carregamento de configura√ß√µes');
                    await this.loadSettings();
                    console.timeEnd('‚è±Ô∏è SETTINGS MANAGER - Carregamento de configura√ß√µes');
                    
                    console.log('üìÖ SETTINGS MANAGER - Configurando grade de hor√°rios...');
                    this.setupScheduleGrid();
                    
                    console.timeEnd('‚è±Ô∏è SETTINGS MANAGER - Tempo total de inicializa√ß√£o');
                    
                    console.log('üéâ SETTINGS MANAGER - Inicializa√ß√£o conclu√≠da com sucesso!');
                    console.log('üìä SETTINGS MANAGER - Resumo da inicializa√ß√£o:', {
                        timestamp: new Date().toISOString(),
                        status: 'success',
                        section: this.currentSection,
                        hasSupabase: !!this.supabase,
                        hasRestaurant: !!this.currentRestaurant,
                        evolutionConfigured: true, // Sistema de proxy sempre dispon√≠vel
                        totalComponents: ['supabase', 'evolution', 'eventListeners', 'settings', 'scheduleGrid'].length
                    });
                    
                } catch (error) {
                    console.error('üí• SETTINGS MANAGER - ERRO CR√çTICO na inicializa√ß√£o:', error);
                    console.error('üîç SETTINGS MANAGER - Stack trace:', error.stack);
                    console.error('üìä SETTINGS MANAGER - Estado no momento do erro:', {
                        timestamp: new Date().toISOString(),
                        currentSection: this.currentSection,
                        hasSupabase: !!this.supabase,
                        hasRestaurant: !!this.currentRestaurant,
                        location: window.location.href
                    });
                    this.showNotification('Erro ao carregar configura√ß√µes', 'error');
                }
            }
            
            async loadSettings() {
                console.log('üîÑ SETTINGS MANAGER - Iniciando carregamento de configura√ß√µes...');
                console.log('üìã SETTINGS MANAGER - Estado inicial loadSettings():', {
                    timestamp: new Date().toISOString(),
                    hasSupabase: !!this.supabase,
                    currentSection: this.currentSection
                });
                
                console.time('‚è±Ô∏è SETTINGS MANAGER - Tempo total loadSettings');
                
                try {
                    console.log('üîç SETTINGS MANAGER - Obtendo dados da inst√¢ncia...');
                    console.time('‚è±Ô∏è SETTINGS MANAGER - Obten√ß√£o de dados da inst√¢ncia');
                    
                    // Primeira tentativa: obter inst√¢ncia corretamente
                    let instance = getInstanceData();
                    console.log('üìã SETTINGS MANAGER - Dados da inst√¢ncia (primeira tentativa):', instance);
                    
                    // Se o token cont√©m JSON, fazer parse
                    if (instance && instance.token && typeof instance.token === 'string' && instance.token.startsWith('{')) {
                        console.log('üîß SETTINGS MANAGER - Token cont√©m JSON, fazendo parse...');
                        try {
                            const parsedToken = JSON.parse(instance.token);
                            console.log('üìú SETTINGS MANAGER - Token parseado:', parsedToken);
                            instance = {
                                instanceId: parsedToken.instanceId,
                                instanceName: parsedToken.instanceName,
                                token: parsedToken.token,
                                type: parsedToken.type || 'restaurant',
                                userEmail: parsedToken.userEmail,
                                restaurantId: parsedToken.restaurantId
                            };
                            console.log('‚úÖ SETTINGS MANAGER - Inst√¢ncia corrigida ap√≥s parse:', instance);
                        } catch (error) {
                            console.error('‚ùå SETTINGS MANAGER - Erro ao fazer parse do token JSON:', error);
                            console.error('üîç SETTINGS MANAGER - Token original:', instance.token);
                        }
                    }
                    
                    if (!instance || !instance.restaurantId) {
                        console.warn('‚ö†Ô∏è SETTINGS MANAGER - Inst√¢ncia do restaurante n√£o encontrada');
                        console.log('üîß SETTINGS MANAGER - Usando configura√ß√µes padr√£o...');
                        // Definir dados padr√£o b√°sicos para permitir funcionamento da p√°gina
                        this.currentRestaurant = {
                            id: 'default',
                            name: 'Meu Restaurante',
                            phone: '',
                            email: '',
                            address: '',
                            city: '',
                            state: '',
                            zip_code: '',
                            business_type: 'restaurante',
                            business_hours: {},
                            api_assas: null
                        };
                        this.populateFormFields();
                        return;
                    }

                    console.log(`üîç Buscando dados do restaurante com ID: ${instance.restaurantId}`);
                    
                    const { data: restaurant, error } = await this.supabase
                        .from('restaurants')
                        .select('*')
                        .eq('id', instance.restaurantId)
                        .single();

                    console.log('üìä Resultado da consulta:', { restaurant, error });

                    if (error) {
                        console.error('‚ùå Erro ao buscar dados do restaurante:', error);
                        // Se n√£o encontrar o restaurante, usar dados padr√£o
                        this.currentRestaurant = {
                            id: instance.restaurantId,
                            name: instance.instanceName || 'Meu Restaurante',
                            phone: '',
                            email: instance.userEmail || '',
                            address: '',
                            city: '',
                            state: '',
                            zip_code: '',
                            business_type: 'restaurante',
                            business_hours: {},
                            api_assas: null
                        };
                        console.log('üìù Usando dados padr√£o para o restaurante:', this.currentRestaurant);
                    } else {
                        this.currentRestaurant = restaurant;
                        console.log('‚úÖ Dados do restaurante carregados com sucesso:', restaurant);
                    }

                    this.originalRestaurantData = { ...this.currentRestaurant };
                    
                    // Popular os formul√°rios com os dados carregados
                    this.populateFormFields();
                    
                    console.log('‚úÖ Dados do restaurante carregados:', restaurant);
                    
                    // Atualizar nome no sidebar
                    const restaurantNameEl = document.getElementById('restaurantName');
                    if (restaurantNameEl && this.currentRestaurant) {
                        restaurantNameEl.textContent = this.currentRestaurant.name || 'Meu Restaurante';
                        console.log('üè™ Nome do restaurante atualizado no sidebar:', this.currentRestaurant.name);
                    }
                    
                    console.log('‚úÖ Dados do restaurante processados com sucesso!');
                    
                    // Carregar formas de pagamento customizadas
                    await loadCustomPaymentMethods();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados do restaurante:', error);
                    this.showNotification('Erro ao carregar dados do restaurante: ' + error.message, 'error');
                }
            }
            
            // M√©todo para popular todos os formul√°rios com dados do restaurante
            populateFormFields() {
                if (!this.currentRestaurant) {
                    console.log('‚ö†Ô∏è Nenhum dado de restaurante dispon√≠vel para popular formul√°rios');
                    return;
                }
                
                const restaurant = this.currentRestaurant;
                console.log('üìÑ Populando formul√°rios com dados:', restaurant);
                
                // Usar m√©todos existentes para popular formul√°rios
                this.populateRestaurantForm(restaurant);
                this.populateDeliveryForm(restaurant);
                this.populateTimingForm(restaurant);
                this.populateBusinessHoursForm(restaurant.business_hours || {});
                
                console.log('‚úÖ Formul√°rios populados com sucesso!');
            }

            populateRestaurantForm(restaurant) {
                document.getElementById('restaurantNameInput').value = restaurant.name || '';
                document.getElementById('ownerName').value = restaurant.owner_name || '';
                document.getElementById('ownerCpf').value = restaurant.owner_cpf || '';
                document.getElementById('ownerPhone').value = restaurant.owner_phone || '';
                document.getElementById('cnpj').value = restaurant.cnpj || '';
                document.getElementById('businessType').value = restaurant.business_type_id || '';
                document.getElementById('address').value = restaurant.address || '';
                document.getElementById('city').value = restaurant.city || '';
                document.getElementById('state').value = restaurant.state || '';
                document.getElementById('zipCode').value = restaurant.zip_code || '';
            }


            populateDeliveryForm(restaurant) {
                document.getElementById('deliveryFee').value = restaurant.minimum_delivery_fee || 8.00;
                document.getElementById('deliveryFeePerKm').value = restaurant.delivery_fee_per_km || 2.50;
                document.getElementById('minimumDistance').value = restaurant.minimum_distance_km || 3.0;
                document.getElementById('deliveryRadius').value = restaurant.delivery_radius || 10.0;
            }
            
            populateTimingForm(restaurant) {
                document.getElementById('minimumOrderEdit').value = restaurant.minimum_order || 0.00;
                document.getElementById('preparationTimeEdit').value = restaurant.preparation_time || 30;
            }

            populateBusinessHoursForm(businessHours) {
                const days = [
                    { key: 'monday', name: 'Segunda-feira' },
                    { key: 'tuesday', name: 'Ter√ßa-feira' },
                    { key: 'wednesday', name: 'Quarta-feira' },
                    { key: 'thursday', name: 'Quinta-feira' },
                    { key: 'friday', name: 'Sexta-feira' },
                    { key: 'saturday', name: 'S√°bado' },
                    { key: 'sunday', name: 'Domingo' }
                ];

                const grid = document.getElementById('scheduleGrid');
                grid.innerHTML = '';

                days.forEach(day => {
                    const dayData = businessHours[day.key] || { open: '08:00', close: '18:00', closed: false };
                    
                    const dayConfig = document.createElement('div');
                    dayConfig.className = 'schedule-day';
                    dayConfig.innerHTML = `
                        <label class="day-label">${day.name}</label>
                        <div class="schedule-inputs">
                            <input type="time" class="form-input" data-day="${day.key}" data-type="open" value="${dayData.open}" ${dayData.closed ? 'disabled' : ''}>
                            <input type="time" class="form-input" data-day="${day.key}" data-type="close" value="${dayData.close}" ${dayData.closed ? 'disabled' : ''}>
                            <label class="form-label">
                                <input type="checkbox" data-day="${day.key}" data-type="closed" ${dayData.closed ? 'checked' : ''}>
                                Fechado
                            </label>
                        </div>
                    `;
                    
                    grid.appendChild(dayConfig);
                });

                // Adicionar event listeners para os toggles
                grid.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const day = this.dataset.day;
                        const timeInputs = grid.querySelectorAll(`input[data-day="${day}"][data-type="open"], input[data-day="${day}"][data-type="close"]`);
                        timeInputs.forEach(input => {
                            input.disabled = this.checked;
                        });
                    });
                });
            }
            
            setupEventListeners() {
                // Aguardar DOM completamente carregado para configurar navega√ß√£o
                setTimeout(() => {
                    const tabs = document.querySelectorAll('.settings-tab');
                    console.log(`üîß Encontrados ${tabs.length} tabs para configurar`);
                    
                    tabs.forEach((tab, index) => {
                        if (tab && tab.dataset && tab.dataset.tab) {
                            tab.addEventListener('click', (e) => {
                                e.preventDefault();
                                const tabId = e.target.dataset.tab || e.currentTarget.dataset.tab;
                                console.log(`üîß Clique na tab: ${tabId}`);
                                this.switchSection(tabId);
                            });
                            console.log(`‚úÖ Tab ${index + 1} configurada: ${tab.dataset.tab}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Tab ${index + 1} sem dataset.tab v√°lido`);
                        }
                    });
                }, 150);
                
                // Aguardar DOM completamente carregado antes de adicionar listeners dos formul√°rios
                setTimeout(() => {
                    // Formul√°rios
                    const restaurantForm = document.getElementById('restaurantForm');
                    if (restaurantForm) {
                        restaurantForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            this.saveRestaurantSettings();
                        });
                    }
                    
                    const scheduleForm = document.getElementById('scheduleForm');
                    if (scheduleForm) {
                        scheduleForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            this.saveScheduleSettings();
                        });
                    }
                    
                    const deliveryForm = document.getElementById('deliveryForm');
                    if (deliveryForm) {
                        deliveryForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            this.saveDeliverySettings();
                        });
                    }
                    
                    const timingForm = document.getElementById('timingForm');
                    if (timingForm) {
                        timingForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            this.saveTimingSettings();
                        });
                    }
                    
                    const paymentsForm = document.getElementById('paymentsForm');
                    if (paymentsForm) {
                        console.log('üîß Configurando event listener para paymentsForm');
                        paymentsForm.addEventListener('submit', (e) => {
                            console.log('üîß Event listener de paymentsForm executado!');
                            e.preventDefault();
                            this.savePaymentSettings();
                        });
                    } else {
                        console.error('‚ùå Formul√°rio paymentsForm n√£o encontrado!');
                    }
                    
                    const paymentMethodForm = document.getElementById('paymentMethodForm');
                    if (paymentMethodForm) {
                        paymentMethodForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            saveCustomPaymentMethod();
                        });
                    }
                    
                }, 100);
                
                // Detectar mudan√ßas n√£o salvas
                document.addEventListener('input', () => {
                    this.hasUnsavedChanges = true;
                });
            }
            
            switchSection(sectionId) {
                try {
                    // Atualizar navega√ß√£o
                    document.querySelectorAll('.settings-tab').forEach(tab => {
                        if (tab && tab.classList) {
                            tab.classList.remove('active');
                        }
                    });
                    
                    const activeTab = document.querySelector(`[data-tab="${sectionId}"]`);
                    if (activeTab && activeTab.classList) {
                        activeTab.classList.add('active');
                    } else {
                        console.warn(`‚ö†Ô∏è Tab com data-tab="${sectionId}" n√£o encontrada`);
                    }
                    
                    // Atualizar conte√∫do
                    document.querySelectorAll('.settings-section').forEach(section => {
                        if (section && section.classList) {
                            section.classList.remove('active');
                        }
                    });
                    
                    const activeSection = document.getElementById(`${sectionId}-section`);
                    if (activeSection && activeSection.classList) {
                        activeSection.classList.add('active');
                    } else {
                        console.warn(`‚ö†Ô∏è Se√ß√£o com id="${sectionId}-section" n√£o encontrada`);
                    }
                    
                    this.currentSection = sectionId;
                    console.log(`‚úÖ Se√ß√£o alterada para: ${sectionId}`);
                    
                    // Verificar status WhatsApp imediatamente ao acessar se√ß√£o de integra√ß√µes
                    if (sectionId === 'integrations') {
                        console.log('üîç Se√ß√£o de integra√ß√µes acessada, verificando status WhatsApp...');
                        setTimeout(async () => {
                            await initializeWhatsAppStatus();
                            // For√ßar atualiza√ß√£o do status visual na se√ß√£o de integra√ß√µes
                            await updateIntegrationsStatus();
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao trocar se√ß√£o:', error);
                }
            }
            
            async saveRestaurantSettings() {
                try {
                    const restaurantData = {
                        name: document.getElementById('restaurantNameInput').value,
                        owner_name: document.getElementById('ownerName').value,
                        owner_cpf: document.getElementById('ownerCpf').value || null,
                        owner_phone: document.getElementById('ownerPhone').value,
                        cnpj: document.getElementById('cnpj').value || null,
                        business_type_id: document.getElementById('businessType').value || null,
                        address: document.getElementById('address').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        zip_code: document.getElementById('zipCode').value,
                        updated_at: new Date().toISOString()
                    };

                    // Salvar hor√°rios de funcionamento
                    const businessHours = {};
                    const grid = document.getElementById('scheduleGrid');
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    
                    days.forEach(day => {
                        const openInput = grid.querySelector(`input[data-day="${day}"][data-type="open"]`);
                        const closeInput = grid.querySelector(`input[data-day="${day}"][data-type="close"]`);
                        const closedCheckbox = grid.querySelector(`input[data-day="${day}"][data-type="closed"]`);
                        
                        businessHours[day] = {
                            open: openInput.value,
                            close: closeInput.value,
                            closed: closedCheckbox.checked
                        };
                    });

                    restaurantData.business_hours = businessHours;

                    const { error } = await this.supabase
                        .from('restaurants')
                        .update(restaurantData)
                        .eq('id', this.currentRestaurant.id);

                    if (error) throw error;

                    // Atualizar dados locais
                    this.currentRestaurant = { ...this.currentRestaurant, ...restaurantData };
                    this.originalRestaurantData = { ...this.currentRestaurant };
                    
                    // Atualizar nome no sidebar
                    document.getElementById('restaurantName').textContent = restaurantData.name;
                    
                    this.hasUnsavedChanges = false;
                    this.showNotification('Informa√ß√µes do restaurante salvas!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
                    this.showNotification('Erro ao salvar configura√ß√µes: ' + error.message, 'error');
                }
            }
            
            async saveScheduleSettings() {
                try {
                    const scheduleData = this.getScheduleData();
                    
                    const { error } = await this.supabase
                        .from('restaurants')
                        .update({ 
                            business_hours: scheduleData,
                            updated_at: new Date().toISOString() 
                        })
                        .eq('id', this.currentRestaurant.id);
                    
                    if (error) throw error;
                    
                    this.currentRestaurant.business_hours = scheduleData;
                    this.hasUnsavedChanges = false;
                    this.showNotification('Hor√°rios de funcionamento salvos!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar hor√°rios:', error);
                    this.showNotification('Erro ao salvar hor√°rios: ' + error.message, 'error');
                }
            }
            
            getScheduleData() {
                const scheduleData = {};
                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                
                days.forEach(day => {
                    const isOpenCheckbox = document.getElementById(`${day}Open`);
                    const openTimeInput = document.getElementById(`${day}OpenTime`);
                    const closeTimeInput = document.getElementById(`${day}CloseTime`);
                    
                    if (isOpenCheckbox && openTimeInput && closeTimeInput) {
                        const isOpen = isOpenCheckbox.checked;
                        scheduleData[day] = {
                            is_open: isOpen,
                            open_time: isOpen ? openTimeInput.value : null,
                            close_time: isOpen ? closeTimeInput.value : null
                        };
                    }
                });
                
                return scheduleData;
            }
            
            async saveTimingSettings() {
                try {
                    const timingData = {
                        minimum_order: parseFloat(document.getElementById('minimumOrderEdit').value) || 0.00,
                        preparation_time: parseInt(document.getElementById('preparationTimeEdit').value) || 30,
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await this.supabase
                        .from('restaurants')
                        .update(timingData)
                        .eq('id', this.currentRestaurant.id);
                    
                    if (error) throw error;
                    
                    this.currentRestaurant = { ...this.currentRestaurant, ...timingData };
                    this.hasUnsavedChanges = false;
                    this.showNotification('Configura√ß√µes de tempo de entrega salvas!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar tempo de entrega:', error);
                    this.showNotification('Erro ao salvar tempo de entrega: ' + error.message, 'error');
                }
            }
            
            async savePaymentSettings() {
                try {
                    const paymentMethods = {
                        cash: {
                            enabled: document.getElementById('acceptCash').checked,
                            needs_change: document.getElementById('needChange').checked
                        },
                        card: {
                            enabled: document.getElementById('acceptCard').checked,
                            debit: document.getElementById('acceptDebit').checked,
                            credit: document.getElementById('acceptCredit').checked
                        },
                        pix: {
                            enabled: document.getElementById('acceptPix').checked,
                            key: document.getElementById('pixKey').value || null
                        }
                    };
                    
                    const paymentData = {
                        payment_methods: paymentMethods,
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await this.supabase
                        .from('restaurants')
                        .update(paymentData)
                        .eq('id', this.currentRestaurant.id);
                    
                    if (error) throw error;
                    
                    this.currentRestaurant = { ...this.currentRestaurant, ...paymentData };
                    this.hasUnsavedChanges = false;
                    this.showNotification('Configura√ß√µes de pagamento salvas com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar configura√ß√µes de pagamento:', error);
                    this.showNotification('Erro ao salvar configura√ß√µes de pagamento: ' + error.message, 'error');
                }
            }
            
            async saveDeliverySettings() {
                try {
                    const deliveryData = {
                        minimum_delivery_fee: parseFloat(document.getElementById('deliveryFee').value),
                        delivery_fee_per_km: parseFloat(document.getElementById('deliveryFeePerKm').value),
                        minimum_distance_km: parseFloat(document.getElementById('minimumDistance').value),
                        delivery_radius: parseFloat(document.getElementById('deliveryRadius').value),
                        minimum_order: parseFloat(document.getElementById('minimumOrder').value),
                        preparation_time: parseInt(document.getElementById('preparationTime').value),
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await this.supabase
                        .from('restaurants')
                        .update(deliveryData)
                        .eq('id', this.currentRestaurant.id);
                    
                    if (error) throw error;
                    
                    this.currentRestaurant = { ...this.currentRestaurant, ...deliveryData };
                    this.hasUnsavedChanges = false;
                    this.showNotification('Configura√ß√µes de entrega salvas!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar configura√ß√µes de entrega:', error);
                    this.showNotification('Erro ao salvar configura√ß√µes de entrega: ' + error.message, 'error');
                }
            }
            
            
            setupScheduleGrid() {
                // A grid ser√° carregada em populateBusinessHoursForm
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }
        
        // ===== FUN√á√ïES DE STATUS =====
        async function checkAsaasStatus() {
            try {
                console.log('üîç CONFIGURA√á√ïES - Verificando status do Asaas...');
                
                // Usar getInstanceData() mais robusta (baseada no teste.html)
                const instance = getInstanceData();
                const restaurant = settingsManager?.currentRestaurant;
                
                if (!instance || (!instance.restaurantId && !instance.instanceId)) {
                    console.log('‚ÑπÔ∏è CONFIGURA√á√ïES - Inst√¢ncia n√£o configurada para Asaas');
                    updateAsaasIntegrationStatus('N√£o configurado', 'warning');
                    return;
                }

                if (!restaurant) {
                    console.error('‚ùå CONFIGURA√á√ïES - Erro: dados do restaurante n√£o encontrados');
                    updateAsaasIntegrationStatus('Desconectado', 'danger');
                    return;
                }

                if (restaurant && restaurant.api_assas !== null && restaurant.api_assas !== '') {
                    console.log('‚úÖ CONFIGURA√á√ïES - Asaas conectado - API key configurada');
                    updateAsaasIntegrationStatus('Conectado', 'success');
                } else {
                    console.log('‚ö†Ô∏è CONFIGURA√á√ïES - Asaas n√£o configurado');  
                    updateAsaasIntegrationStatus('Desconectado', 'danger');
                }
                
            } catch (error) {
                console.error('‚ùå CONFIGURA√á√ïES - Erro ao verificar status Asaas:', error);
                updateAsaasIntegrationStatus('Desconectado', 'danger');
            }
        }

        // ===== FUN√á√ÉO PARA CARREGAR TIPOS DE NEG√ìCIO =====
        async function loadBusinessTypes() {
            try {
                console.log('üè™ CONFIGURA√á√ïES - Carregando tipos de neg√≥cio...');
                
                const response = await fetch('/api/business-types');
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar tipos de neg√≥cio');
                }
                
                const data = await response.json();
                const businessTypes = data.businessTypes || [];
                
                console.log('‚úÖ CONFIGURA√á√ïES - Tipos de neg√≥cio carregados:', businessTypes.length);
                
                // Selecionar o elemento select
                const selectElement = document.getElementById('businessType');
                
                if (!selectElement) {
                    console.error('‚ùå CONFIGURA√á√ïES - Select de tipo de neg√≥cio n√£o encontrado');
                    return;
                }
                
                // Limpar op√ß√µes existentes
                selectElement.innerHTML = '';
                
                // Adicionar op√ß√£o padr√£o
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecionar...';
                selectElement.appendChild(defaultOption);
                
                // Adicionar cada tipo de neg√≥cio
                businessTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.name;
                    if (type.description) {
                        option.title = type.description;
                    }
                    selectElement.appendChild(option);
                });
                
                console.log('‚úÖ CONFIGURA√á√ïES - Select de tipo de neg√≥cio populado com sucesso');
                
            } catch (error) {
                console.error('‚ùå CONFIGURA√á√ïES - Erro ao carregar tipos de neg√≥cio:', error);
                
                // Em caso de erro, adicionar uma op√ß√£o gen√©rica
                const selectElement = document.getElementById('businessType');
                if (selectElement) {
                    selectElement.innerHTML = '<option value="">Erro ao carregar tipos</option>';
                }
            }
        }

        // ===== INICIALIZA√á√ÉO =====
        let settingsManager;
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìã CONFIGURA√á√ïES - Iniciando carregamento da p√°gina...');
            const initStartTime = Date.now();
            try {
                console.log('üöÄ CONFIGURA√á√ïES - Executando inicializa√ß√£o completa...');
                
                // ===== CONFIGURAR EVENT LISTENERS DOS BOT√ïES =====
                console.log('üîó CONFIGURA√á√ïES - Configurando event listeners dos bot√µes...');
                
                // Bot√£o WhatsApp
                const btnWhatsApp = document.getElementById('configure-whatsapp');
                if (btnWhatsApp) {
                    btnWhatsApp.addEventListener('click', openWhatsAppModal);
                    console.log('‚úÖ CONFIGURA√á√ïES - Event listener WhatsApp configurado');
                } else {
                    console.error('‚ùå CONFIGURA√á√ïES - Bot√£o WhatsApp n√£o encontrado');
                }
                
                // Bot√£o Asaas
                const btnAsaas = document.getElementById('btnConfigureAsaas');
                if (btnAsaas) {
                    btnAsaas.addEventListener('click', configureAsaas);
                    console.log('‚úÖ CONFIGURA√á√ïES - Event listener Asaas configurado');
                } else {
                    console.error('‚ùå CONFIGURA√á√ïES - Bot√£o Asaas n√£o encontrado');
                }
                
                // Carregar tipos de neg√≥cio primeiro
                console.log('üè™ CONFIGURA√á√ïES - Carregando tipos de neg√≥cio...');
                console.time('‚è±Ô∏è CONFIGURA√á√ïES - Tipos de Neg√≥cio');
                await loadBusinessTypes();
                console.timeEnd('‚è±Ô∏è CONFIGURA√á√ïES - Tipos de Neg√≥cio');
                
                // Inicializar o gerenciador de configura√ß√µes
                settingsManager = new SettingsManager();
                await settingsManager.init();
                
                // CORRE√á√ÉO: Configurar nome da inst√¢ncia WhatsApp automaticamente
                console.log('üì± CONFIGURA√á√ïES - Configurando nome da inst√¢ncia WhatsApp...');
                console.time('‚è±Ô∏è CONFIGURA√á√ïES - Configura√ß√£o WhatsApp');
                await initializeWhatsAppInstanceName();
                console.timeEnd('‚è±Ô∏è CONFIGURA√á√ïES - Configura√ß√£o WhatsApp');
                
                // Inicializar status do WhatsApp quando a p√°gina carrega
                console.log('üöÄ CONFIGURA√á√ïES - Inicializando status WhatsApp...');
                console.time('‚è±Ô∏è CONFIGURA√á√ïES - Status WhatsApp');
                await initializeWhatsAppStatus();
                console.timeEnd('‚è±Ô∏è CONFIGURA√á√ïES - Status WhatsApp');
                
                // Verificar status do Asaas quando a p√°gina carrega
                console.log('üöÄ CONFIGURA√á√ïES - Verificando status Asaas...');
                console.time('‚è±Ô∏è CONFIGURA√á√ïES - Status Asaas');
                await checkAsaasStatus();
                console.timeEnd('‚è±Ô∏è CONFIGURA√á√ïES - Status Asaas');
                
                // Atualizar status visual inicial
                console.log('üé® CONFIGURA√á√ïES - Atualizando status visual das integra√ß√µes...');
                console.time('‚è±Ô∏è CONFIGURA√á√ïES - Atualiza√ß√£o visual');
                await updateIntegrationsStatus();
                console.timeEnd('‚è±Ô∏è CONFIGURA√á√ïES - Atualiza√ß√£o visual');
                
                // Iniciar monitoramento em tempo real do WhatsApp em background
                console.log('‚è∞ CONFIGURA√á√ïES - Iniciando monitoramento em tempo real do WhatsApp...');
                startBackgroundStatusMonitoring();
                
                // Verificar status do Asaas periodicamente (a cada 30 segundos)
                console.log('‚è∞ CONFIGURA√á√ïES - Configurando verifica√ß√£o peri√≥dica do Asaas (30s)...');
                setInterval(async () => {
                    await checkAsaasStatus();
                    await updateIntegrationsStatus();
                }, 30000);
                
                console.log('üéâ CONFIGURA√á√ïES - P√°gina carregada com sucesso!');
                console.log('üìä CONFIGURA√á√ïES - Resumo final da inicializa√ß√£o:', {
                    timestamp: new Date().toISOString(),
                    status: 'completed',
                    components: ['settingsManager', 'whatsapp', 'asaas', 'integrations'],
                    totalTime: Date.now() - initStartTime
                });
                
            } catch (error) {
                console.error('üí• CONFIGURA√á√ïES - ERRO CR√çTICO na inicializa√ß√£o da p√°gina:', error);
                console.error('üîç CONFIGURA√á√ïES - Stack trace:', error.stack);
            }
        });
        
        // ===== FUN√á√ïES GLOBAIS =====
        
        // ===== VARI√ÅVEIS GLOBAIS WHATSAPP =====
        let currentEvolutionInstance = null;
        let qrCodeData = null;
        let csrfToken = null;
        let whatsappStatusInterval = null;
        let evolutionConfig = {};
        
        // Controle de monitoramento singleton
        let backgroundStatusInterval = null;
        let isModalMonitoring = false;
        let isBackgroundMonitoring = false;

        // ===== IMPORTANTE: NOME DA INST√ÇNCIA DEVE SER EXATO =====
        // O nome da inst√¢ncia Evolution deve ser ID√äNTICO ao nome na tabela restaurants
        // SEM substituir espa√ßos, caracteres especiais ou fazer qualquer modifica√ß√£o
        // Exemplo: "TATA Lanches" permanece como "TATA Lanches" (com espa√ßo)
        function getExactInstanceName(instanceName) {
            if (!instanceName) return 'restaurante';
            
            // Retornar o nome EXATO sem nenhuma modifica√ß√£o
            console.log(`üìù Usando nome EXATO da tabela: "${instanceName}"`);
            
            return instanceName;
        }

        // ===== FUN√á√ÉO PARA CARREGAR CONFIGURA√á√ÉO EVOLUTION =====
        async function loadEvolutionConfig() {
            try {
                const response = await fetch('/api/config/evolution', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro ao carregar configura√ß√£o: ${response.status}`);
                }

                evolutionConfig = await response.json();
                console.log('‚úÖ Configura√ß√£o Evolution carregada:', evolutionConfig);
                return evolutionConfig;
                
            } catch (error) {
                console.error('Erro ao carregar configura√ß√£o Evolution:', error);
                throw error;
            }
        }

        // ===== FUN√á√ÉO PARA VERIFICAR SE INST√ÇNCIA EXISTE =====
        async function checkInstanceExists(instanceName) {
            try {
                console.log(`üîç Verificando se inst√¢ncia "${instanceName}" existe...`);

                const response = await fetch(`/api/evolution/check-instance/${instanceName}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.exists) {
                    console.log('‚úÖ Inst√¢ncia j√° existe:', result.data);
                    return { exists: true, data: result.data };
                } else {
                    console.log('‚ö†Ô∏è Inst√¢ncia n√£o existe');
                    return { exists: false };
                }

            } catch (error) {
                console.error('‚ùå Erro ao verificar inst√¢ncia:', error);
                return { exists: false, error: error.message };
            }
        }

        // ===== FUN√á√ÉO PRINCIPAL PARA CONFIGURAR WHATSAPP =====
        async function configureWhatsApp() {
            console.log('üì± Iniciando configura√ß√£o WhatsApp...');
            
            try {
                // 1. Obter dados da inst√¢ncia
                const instanceData = getInstanceData();
                if (!instanceData) {
                    settingsManager.showNotification('Inst√¢ncia n√£o encontrada. Fa√ßa login novamente.', 'error');
                    return;
                }
                
                // 2. Configurar nome da inst√¢ncia - usar nome EXATO da tabela restaurants
                const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
                const rawInstanceName = instance.instanceName || 'restaurante';
                // Usar nome EXATO sem normaliza√ß√£o
                whatsappInstanceName = rawInstanceName;
                
                console.log(`üìù Nome EXATO da inst√¢ncia: "${whatsappInstanceName}"`);
                
                // 3. Verificar se inst√¢ncia existe no Evolution
                const checkResult = await checkInstanceExists(whatsappInstanceName);
                
                // 4. Processar baseado na resposta
                if (!checkResult.exists) {
                    // Inst√¢ncia n√£o existe - mostrar modal
                    console.log('‚ÑπÔ∏è WHATSAPP - Inst√¢ncia n√£o existe, mostrando modal...');
                    document.getElementById('modalInstanceName').textContent = whatsappInstanceName;
                    document.getElementById('instanceNotFoundModal').style.display = 'flex';
                    return;
                }
                
                // 5. Verificar estado da conex√£o
                const response = await fetch(`/api/evolution/connectionState/${whatsappInstanceName}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                console.log(`üì° WHATSAPP - Status HTTP: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                
                const result = await response.json();
                const state = result.instance?.state || 'unknown';
                
                console.log(`üìä WHATSAPP - Estado da inst√¢ncia: ${state}`);
                
                if (state === 'open') {
                    // WhatsApp j√° conectado - mostrar modal de gerenciamento
                    settingsManager.showNotification('WhatsApp j√° est√° conectado!', 'success');
                    updateWhatsAppStatus('Conectado', 'success');
                    await openWhatsAppModalForManagement();
                } else {
                    // Inst√¢ncia existe mas n√£o conectada - mostrar QR Code diretamente
                    console.log('‚ö†Ô∏è Inst√¢ncia existe mas n√£o conectada. Mostrando QR code...');
                    document.getElementById('qrcodeModal').style.display = 'flex';
                    document.getElementById('qrcodeLoader').style.display = 'block';
                    document.getElementById('qrcodeImage').style.display = 'none';
                    await fetchQRCode();
                    startConnectionPolling();
                }
                
            } catch (error) {
                console.error('Erro ao configurar WhatsApp:', error);
                settingsManager.showNotification('Erro ao configurar WhatsApp: ' + error.message, 'error');
            }
        }

        // ===== FUN√á√ïES AUXILIARES =====
        function getInstanceData() {
            try {
                // 1. Verificar COOKIE
                const cookie = document.cookie.split('; ').find(row => row.startsWith('timepulse_instance_token='));
                
                if (cookie) {
                    try {
                        const cookieValue = decodeURIComponent(cookie.split('=')[1]);
                        const tokenData = JSON.parse(cookieValue);
                        return tokenData;
                    } catch (e) {
                        console.error('Error parsing cookie:', e);
                    }
                }
                
                // 2. Verificar LOCAL STORAGE
                const localStorageData = localStorage.getItem('timepulse_instance_token');
                if (localStorageData) {
                    try {
                        const tokenData = JSON.parse(decodeURIComponent(localStorageData));
                        return tokenData;
                    } catch (e) {
                        console.error('Error parsing localStorage:', e);
                    }
                }
                
                // 3. Verificar SESSION STORAGE
                const sessionStorageData = sessionStorage.getItem('timepulse_instance_token');
                if (sessionStorageData) {
                    try {
                        const tokenData = JSON.parse(decodeURIComponent(sessionStorageData));
                        return tokenData;
                    } catch (e) {
                        console.error('Error parsing sessionStorage:', e);
                    }
                }
                
                return null;
            } catch (error) {
                console.error('getInstanceData error:', error);
                return null;
            }
        }

        async function getCSRFToken() {
            try {
                const response = await fetch('/api/csrf-token', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                
                const result = await response.json();
                csrfToken = result.csrfToken;
                return csrfToken;
            } catch (error) {
                console.error('Erro ao obter token CSRF:', error);
                throw error;
            }
        }

        async function checkWhatsAppInstanceStatus() {
            try {
                // Usar nome EXATO da inst√¢ncia (sem modifica√ß√µes)
                const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
                const exactName = instance.instanceName || 'restaurante';
                whatsappInstanceName = exactName;
                
                console.log(`üîç WHATSAPP - Verificando status da inst√¢ncia EXATA: "${exactName}"`);
                
                const response = await fetch(`/api/evolution/connectionState/${encodeURIComponent(exactName)}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                console.log(`üì° WHATSAPP - Status HTTP: ${response.status}`);
                
                if (response.status === 404) {
                    console.log('‚ÑπÔ∏è WHATSAPP - Inst√¢ncia n√£o existe, precisa ser criada');
                    return 'not_exists';
                }
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                
                const result = await response.json();
                const state = result.instance?.state || 'unknown';
                
                console.log(`üìä WHATSAPP - Estado da inst√¢ncia: ${state}`);
                
                if (state === 'open') {
                    return 'connected';
                } else if (state === 'connecting') {
                    return 'connecting';
                } else if (state === 'close') {
                    return 'disconnected';
                } else {
                    return 'unknown';
                }
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro ao verificar status:', error);
                return 'not_exists';
            }
        }

        async function createWhatsAppInstanceAndShowModal() {
            try {
                // Informar que a inst√¢ncia ainda n√£o foi criada
                updateWhatsAppStatus('Inst√¢ncia n√£o criada', 'warning');
                
                // Criar inst√¢ncia automaticamente
                await createWhatsAppInstance();
                
                // Abrir modal com QR code
                await openWhatsAppModalForConnection();
                
            } catch (error) {
                console.error('Erro ao criar inst√¢ncia:', error);
                settingsManager.showNotification('Erro ao criar inst√¢ncia WhatsApp: ' + error.message, 'error');
            }
        }

        async function createWhatsAppInstance() {
            try {
                // Usar nome EXATO da inst√¢ncia
                const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
                const exactName = instance.instanceName || 'restaurante';
                whatsappInstanceName = exactName;
                
                console.log(`üì§ Criando inst√¢ncia com nome EXATO: "${exactName}"`);
                
                const instanceConfig = {
                    instanceName: exactName,
                    qrcode: true,
                    integration: "WHATSAPP-BAILEYS",
                    webhook: {
                        url: "https://n8n.timepulseai.com.br/webhook/7398cf3b-43ae-4d12-9f0b-443e3b66dfd1",
                        byEvents: true,
                        events: [
                            "APPLICATION_STARTUP",
                            "MESSAGES_UPDATE", 
                            "MESSAGES_UPSERT",
                            "PRESENCE_UPDATE",
                            "QRCODE_UPDATED"
                        ]
                    }
                };
                
                // Usar endpoint simplificado sem CSRF
                const response = await fetch('/api/evolution/create-instance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(instanceConfig)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    console.error('‚ùå Erro ao criar inst√¢ncia:', result);
                    throw new Error(result.error || result.message || `Erro HTTP ${response.status}`);
                }
                
                console.log('‚úÖ Inst√¢ncia criada com sucesso:', result);
                
                currentEvolutionInstance = {
                    name: normalizedName,
                    data: result
                };
                
                updateWhatsAppStatus('Inst√¢ncia criada', 'info');
                
                return result;
                
            } catch (error) {
                console.error('‚ùå Erro ao criar inst√¢ncia:', error);
                throw error;
            }
        }

        function updateWhatsAppStatus(status, type = 'info') {
            const statusElement = document.getElementById('whatsappStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = 'integration-status';
                
                if (type === 'success') {
                    statusElement.classList.add('status-connected');
                } else if (type === 'warning') {
                    statusElement.classList.add('status-warning');
                } else if (type === 'error') {
                    statusElement.classList.add('status-error');
                }
            }
        }
        
        // ===== FUN√á√ïES PARA ABRIR MODAIS WHATSAPP =====
        async function openWhatsAppModalForConnection() {
            try {
                // PARAR monitoramento em background ANTES de abrir modal
                console.log('‚è∏Ô∏è Pausando monitoramento em background para abrir modal...');
                stopBackgroundStatusMonitoring();
                
                openWhatsAppModal();
                
                // PRIMEIRO: Verificar se j√° est√° conectado
                console.log('üîç [MODAL] Verificando status antes de gerar QR Code...');
                const currentStatus = await checkWhatsAppInstanceStatus();
                console.log(`üìä [MODAL] Status atual: ${currentStatus}`);
                
                if (currentStatus === 'connected') {
                    // J√Å EST√Å CONECTADO - Ocultar QR Code e mostrar mensagem de sucesso
                    console.log('‚úÖ [MODAL] WhatsApp j√° conectado! Ocultando QR Code...');
                    
                    const qrcodeSection = document.getElementById('modal-qrcodeSection');
                    if (qrcodeSection) {
                        qrcodeSection.style.display = 'none';
                    }
                    
                    updateConnectionStatus('WhatsApp j√° est√° conectado!', 'success');
                    settingsManager.showNotification('WhatsApp j√° est√° conectado!', 'success');
                    
                    // Atualizar status no modal
                    const modalInstanceStatus = document.getElementById('modal-instanceStatus');
                    if (modalInstanceStatus) {
                        modalInstanceStatus.innerHTML = '<span class="status-badge status-success">‚úÖ Conectado</span>';
                    }
                    
                    // Fechar modal automaticamente ap√≥s 2 segundos
                    setTimeout(() => {
                        closeWhatsAppModal();
                    }, 2000);
                    
                    return;
                }
                
                // N√ÉO EST√Å CONECTADO - Gerar QR Code e iniciar monitoramento
                console.log('üîÑ [MODAL] WhatsApp n√£o conectado, gerando QR Code...');
                
                // Exibir se√ß√£o do QR Code
                const qrcodeSection = document.getElementById('modal-qrcodeSection');
                if (qrcodeSection) {
                    qrcodeSection.style.display = 'block';
                }
                
                // Conectar para gerar QR code
                const response = await fetch(`/api/evolution/instance/connect/${whatsappInstanceName}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.base64 || result.code) {
                    // Exibir QR Code na se√ß√£o correta
                    const qrcodeImage = document.getElementById('modal-qrcodeImage');
                    if (qrcodeImage && result.base64) {
                        qrcodeImage.src = result.base64;
                        qrcodeImage.style.display = 'block';
                    }
                    
                    // Tamb√©m usar a fun√ß√£o displayQRCode existente para compatibilidade
                    await displayQRCode(result);
                    
                    // Iniciar monitoramento em tempo real
                    startConnectionMonitoring();
                } else {
                    throw new Error('QR Code n√£o gerado');
                }
                
            } catch (error) {
                console.error('Erro ao abrir modal de conex√£o:', error);
                settingsManager.showNotification('Erro ao gerar QR Code: ' + error.message, 'error');
            }
        }


        async function openWhatsAppModalForReconnection() {
            openWhatsAppModal();
            
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (qrDisplay) {
                qrDisplay.innerHTML = `
                    <div class="connection-warning">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h4>WhatsApp Desconectado</h4>
                        <p>Clique em "Reconectar" para gerar um novo QR Code.</p>
                        <button class="btn btn-primary" onclick="reconnectWhatsApp()">Reconectar WhatsApp</button>
                    </div>
                `;
            }
        }

        async function openWhatsAppModalWithError() {
            openWhatsAppModal();
            
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (qrDisplay) {
                qrDisplay.innerHTML = `
                    <div class="connection-error">
                        <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                        <h4>Erro na Conex√£o</h4>
                        <p>N√£o foi poss√≠vel verificar o status do WhatsApp.</p>
                        <button class="btn btn-primary" onclick="createWhatsAppInstanceAndShowModal()">Tentar Novamente</button>
                    </div>
                `;
            }
        }

        async function displayQRCode(result) {
            const qrCodeContainer = document.getElementById('qrCodeDisplay');
            if (!qrCodeContainer) {
                console.error('‚ùå QR Code container n√£o encontrado');
                return;
            }
            
            console.log('üì± Exibindo QR Code...', result);
            qrCodeContainer.innerHTML = '';
            
            if (result.base64) {
                console.log('‚úÖ Usando QR Code base64 da Evolution API');
                
                // Criar imagem com base64 fornecido pela API
                const img = document.createElement('img');
                img.src = result.base64;
                img.style.width = '300px';
                img.style.height = '300px';
                img.style.border = '2px solid #007bff';
                img.style.borderRadius = '8px';
                img.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                img.alt = 'QR Code para conectar WhatsApp';
                qrCodeContainer.appendChild(img);
                
            } else if (result.code && typeof QRCode !== 'undefined') {
                console.log('‚úÖ Gerando QR Code com biblioteca QRCode.js');
                
                // Usar biblioteca QRCode.js se dispon√≠vel
                const canvas = document.createElement('canvas');
                qrCodeContainer.appendChild(canvas);
                
                try {
                    await QRCode.toCanvas(canvas, result.code, {
                        width: 300,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    });
                    console.log('‚úÖ QR Code gerado com biblioteca QRCode.js');
                } catch (qrError) {
                    console.error(`‚ùå Erro ao gerar QR com biblioteca: ${qrError.message}`);
                    
                    // Fallback: mostrar c√≥digo como texto se falhou
                    qrCodeContainer.removeChild(canvas);
                    displayQRCodeAsText(result.code, qrCodeContainer);
                }
                
            } else if (result.code) {
                console.log('‚ö†Ô∏è QRCode.js n√£o dispon√≠vel, exibindo c√≥digo como texto');
                displayQRCodeAsText(result.code, qrCodeContainer);
                
            } else {
                console.error('‚ùå Nem base64 nem code encontrado no resultado');
                qrCodeContainer.innerHTML = `
                    <div class="connection-error">
                        <i class="fas fa-times-circle text-danger" style="font-size: 2rem;"></i>
                        <h5>Erro ao gerar QR Code</h5>
                        <p>Dados do QR Code n√£o foram recebidos corretamente.</p>
                    </div>
                `;
            }
        }

        function displayQRCodeAsText(code, container) {
            // Fallback: mostrar c√≥digo como texto se biblioteca n√£o estiver dispon√≠vel
            const codeDiv = document.createElement('div');
            codeDiv.style.padding = '20px';
            codeDiv.style.border = '2px solid #007bff';
            codeDiv.style.borderRadius = '8px';
            codeDiv.style.backgroundColor = '#f8f9fa';
            codeDiv.style.fontFamily = 'monospace';
            codeDiv.style.fontSize = '12px';
            codeDiv.style.wordBreak = 'break-all';
            codeDiv.style.textAlign = 'left';
            codeDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <strong>üì± C√≥digo QR (texto):</strong><br>
                    <small style="color: #666;">Escaneie com WhatsApp ou use app gerador QR</small>
                </div>
                <code style="display: block; white-space: pre-wrap;">${code}</code>
            `;
            container.appendChild(codeDiv);
        }

        function startConnectionMonitoring() {
            // Evitar m√∫ltiplos intervalos
            if (isModalMonitoring) {
                console.log('‚è≠Ô∏è [MODAL] Monitoramento j√° est√° ativo, pulando...');
                return;
            }
            
            // Parar intervalo anterior se existir (seguran√ßa extra)
            if (whatsappStatusInterval) {
                clearInterval(whatsappStatusInterval);
                whatsappStatusInterval = null;
            }
            
            console.log('üîÑ [MODAL] Iniciando monitoramento em tempo real...');
            isModalMonitoring = true;
            
            whatsappStatusInterval = setInterval(async () => {
                try {
                    const status = await checkWhatsAppInstanceStatus();
                    console.log(`üîÑ [REAL-TIME] Status atual: ${status}`);
                    
                    // Atualizar status no modal (dentro do modal)
                    const modalInstanceStatus = document.getElementById('modal-instanceStatus');
                    if (modalInstanceStatus) {
                        if (status === 'connected') {
                            modalInstanceStatus.innerHTML = '<span class="status-badge status-success">‚úÖ Conectado</span>';
                        } else if (status === 'connecting') {
                            modalInstanceStatus.innerHTML = '<span class="status-badge status-warning">üîÑ Conectando...</span>';
                        } else if (status === 'disconnected') {
                            modalInstanceStatus.innerHTML = '<span class="status-badge status-warning">‚ö†Ô∏è Desconectado</span>';
                        } else {
                            modalInstanceStatus.innerHTML = '<span class="status-badge status-error">‚ùå N√£o existe</span>';
                        }
                    }
                    
                    // Atualizar status fora do modal (na p√°gina principal)
                    updateWhatsAppStatus(
                        status === 'connected' ? 'Conectado' :
                        status === 'connecting' ? 'Conectando...' :
                        status === 'disconnected' ? 'Desconectado' : 'Inst√¢ncia n√£o criada',
                        status === 'connected' ? 'success' :
                        status === 'connecting' ? 'warning' :
                        status === 'disconnected' ? 'warning' : 'error'
                    );
                    
                    // Se conectado: ocultar QR Code e instru√ß√µes E fechar modal
                    if (status === 'connected') {
                        console.log('‚úÖ [REAL-TIME] WhatsApp conectado! Ocultando QR Code...');
                        
                        // Ocultar se√ß√£o do QR Code completamente
                        const qrcodeSection = document.getElementById('modal-qrcodeSection');
                        if (qrcodeSection) {
                            qrcodeSection.style.display = 'none';
                        }
                        
                        // Mostrar mensagem de sucesso
                        updateConnectionStatus('WhatsApp conectado com sucesso!', 'success');
                        settingsManager.showNotification('WhatsApp conectado com sucesso!', 'success');
                        
                        // Parar monitoramento do modal ANTES de fechar
                        clearInterval(whatsappStatusInterval);
                        whatsappStatusInterval = null;
                        
                        // Fechar modal automaticamente ap√≥s 2 segundos
                        // isModalMonitoring ser√° setado para false dentro de closeWhatsAppModal
                        setTimeout(() => {
                            closeWhatsAppModal();
                        }, 2000);
                    }
                } catch (error) {
                    console.error('‚ùå [REAL-TIME] Erro ao verificar status:', error);
                }
            }, 3000); // Verificar a cada 3 segundos
        }

        function updateConnectionStatus(message, type) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                const icon = type === 'success' ? 'fa-check-circle text-success' : 
                           type === 'warning' ? 'fa-exclamation-triangle text-warning' :
                           type === 'error' ? 'fa-times-circle text-danger' : 'fa-circle text-info';
                
                statusElement.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            }
        }

        async function reconnectWhatsApp() {
            try {
                updateConnectionStatus('Reconectando WhatsApp...', 'info');
                
                const response = await fetch(`/api/evolution/instance/connect/${whatsappInstanceName}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                
                const result = await response.json();
                await displayQRCode(result);
                startConnectionMonitoring();
                
            } catch (error) {
                console.error('Erro ao reconectar:', error);
                updateConnectionStatus('Erro ao reconectar', 'error');
            }
        }

        function openWhatsAppModal() {
            const modal = document.getElementById('whatsappModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // Fun√ß√£o para monitoramento cont√≠nuo fora do modal (singleton)
        function startBackgroundStatusMonitoring() {
            // Evitar m√∫ltiplos intervalos
            if (isBackgroundMonitoring) {
                console.log('‚è≠Ô∏è [BACKGROUND] Monitoramento j√° est√° ativo, pulando...');
                return;
            }
            
            // Parar monitoramento anterior se existir (seguran√ßa extra)
            if (backgroundStatusInterval) {
                clearInterval(backgroundStatusInterval);
                backgroundStatusInterval = null;
            }
            
            console.log('üîÑ [BACKGROUND] Iniciando monitoramento cont√≠nuo do status WhatsApp...');
            isBackgroundMonitoring = true;
            
            backgroundStatusInterval = setInterval(async () => {
                try {
                    const status = await checkWhatsAppInstanceStatus();
                    
                    // Atualizar apenas o status da p√°gina principal
                    updateWhatsAppStatus(
                        status === 'connected' ? 'Conectado' :
                        status === 'connecting' ? 'Conectando...' :
                        status === 'disconnected' ? 'Desconectado' : 'Inst√¢ncia n√£o criada',
                        status === 'connected' ? 'success' :
                        status === 'connecting' ? 'warning' :
                        status === 'disconnected' ? 'warning' : 'error'
                    );
                    
                    console.log(`üîÑ [BACKGROUND] Status atualizado: ${status}`);
                } catch (error) {
                    console.error('‚ùå [BACKGROUND] Erro ao verificar status:', error);
                }
            }, 10000); // Verificar a cada 10 segundos em background
        }
        
        // Fun√ß√£o para parar monitoramento em background
        function stopBackgroundStatusMonitoring() {
            if (backgroundStatusInterval) {
                clearInterval(backgroundStatusInterval);
                backgroundStatusInterval = null;
                isBackgroundMonitoring = false;
                console.log('‚èπÔ∏è [BACKGROUND] Monitoramento parado');
            }
        }

        async function closeWhatsAppModal() {
            const modal = document.getElementById('whatsappModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Parar monitoramento do modal
            if (whatsappStatusInterval) {
                clearInterval(whatsappStatusInterval);
                whatsappStatusInterval = null;
            }
            isModalMonitoring = false;
            console.log('‚èπÔ∏è [MODAL] Monitoramento do modal parado');
            
            // Atualizar status do WhatsApp na se√ß√£o de Integra√ß√µes
            console.log('üîÑ Atualizando status do WhatsApp na p√°gina principal...');
            await initializeWhatsAppStatus();
            
            // Garantir que monitoramento em background esteja ativo
            if (!isBackgroundMonitoring) {
                console.log('‚ñ∂Ô∏è [MODAL] Retomando monitoramento em background...');
                startBackgroundStatusMonitoring();
            } else {
                console.log('‚úÖ [MODAL] Monitoramento em background j√° ativo');
            }
        }

        // ===== INICIALIZA√á√ÉO DO STATUS WHATSAPP =====
        async function initializeWhatsAppStatus() {
            try {
                const instanceData = getInstanceData();
                if (!instanceData || !instanceData.instanceName) {
                    updateWhatsAppStatus('N√£o autenticado', 'error');
                    return;
                }
                
                // Usar nome EXATO da inst√¢ncia sem qualquer normaliza√ß√£o
                whatsappInstanceName = instanceData.instanceName || 'restaurante-principal';
                console.log(`üîç WHATSAPP - Verificando status da inst√¢ncia: ${whatsappInstanceName}`);
                
                const status = await checkWhatsAppInstanceStatus();
                
                if (status === 'connected') {
                    updateWhatsAppStatus('Conectado', 'success');
                } else if (status === 'connecting') {
                    updateWhatsAppStatus('Conectando...', 'warning');
                } else if (status === 'disconnected') {
                    updateWhatsAppStatus('Desconectado', 'warning');
                } else {
                    updateWhatsAppStatus('Inst√¢ncia n√£o criada', 'warning');
                }
                
            } catch (error) {
                console.error('Erro ao inicializar status WhatsApp:', error);
                updateWhatsAppStatus('Erro ao verificar', 'error');
            }
        }

        function configureAsaas() {
            openAsaasModal();
        }
        
        function configureSMTP() {
            settingsManager.showNotification('Configura√ß√£o de SMTP ser√° implementada em breve!', 'info');
        }
        
        function changePassword() {
            settingsManager.showNotification('Altera√ß√£o de senha ser√° implementada em breve!', 'info');
        }
        
        function exportData() {
            settingsManager.showNotification('Exporta√ß√£o de dados ser√° implementada em breve!', 'info');
        }
        
        async function signOut() {
            // Usar modal padr√£o de confirma√ß√£o
            if (await showCustomConfirmation('Deseja realmente sair?', 'Sair')) {
                try {
                    // 1. PRIMEIRO: Fazer logout do Supabase
                    if (window.supabase) {
                        await window.supabase.auth.signOut();
                        console.log('‚úÖ Logout do Supabase realizado');
                    }
                    
                    // 2. Limpar dados locais
                    if (window.SECURE_INSTANCE_MANAGER) {
                        window.SECURE_INSTANCE_MANAGER.logout();
                    } else {
                        // Fallback manual
                        document.cookie.split(";").forEach(function(c) { 
                            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                        });
                        localStorage.clear();
                        sessionStorage.clear();
                    }
                } catch (error) {
                    console.error('Erro durante logout:', error);
                }
                window.location.href = 'login.html';
            }
        }
        
        // Modal de confirma√ß√£o padr√£o para todo o sistema
        function showCustomConfirmation(message, title = 'Confirma√ß√£o') {
            return new Promise((resolve) => {
                const modalHtml = `
                        <div class="modal" id="customConfirmationDialog" style="z-index: 16000; display:flex;">
                            <div class="modal-content" style="max-width: 400px;">
                                <div class="modal-header"><h3>${title}</h3><button class="modal-close">&times;</button></div>
                                <div class="modal-body" style="text-align: center; padding: 2rem;"><p>${message}</p></div>
                                <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: center; gap: 1rem;">
                                    <button class="btn btn-secondary" id="cancelConfirmBtn">Cancelar</button>
                                    <button class="btn btn-primary" id="confirmConfirmBtn">Confirmar</button>
                                </div>
                            </div>
                        </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const dialog = document.getElementById('customConfirmationDialog');
                const close = () => { dialog.remove(); resolve(false); };
                const confirm = () => { dialog.remove(); resolve(true); };
                dialog.querySelector('.modal-close').onclick = close;
                dialog.querySelector('#cancelConfirmBtn').onclick = close;
                dialog.querySelector('#confirmConfirmBtn').onclick = confirm;
            });
        }

        // Adicionar event listener espec√≠fico para o bot√£o de logout
        document.addEventListener('DOMContentLoaded', function() {
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üö™ Bot√£o sair clicado - iniciando signOut()');
                    signOut();
                });
            }
        });
        
        // ===== FUN√á√ïES PARA FORMAS DE PAGAMENTO =====
        let currentEditingPaymentMethod = null;
        
        function openPaymentMethodModal(paymentMethod = null) {
            const modal = document.getElementById('paymentMethodModal');
            const title = document.getElementById('paymentMethodModalTitle');
            const form = document.getElementById('paymentMethodForm');
            
            if (paymentMethod) {
                // Editando forma de pagamento existente
                title.textContent = 'Editar Forma de Pagamento';
                document.getElementById('paymentMethodName').value = paymentMethod.name;
                document.getElementById('paymentMethodDescription').value = paymentMethod.description || '';
                document.getElementById('paymentMethodRequiresChange').checked = paymentMethod.requires_change;
                document.getElementById('paymentMethodIcon').value = paymentMethod.icon;
                currentEditingPaymentMethod = paymentMethod;
            } else {
                // Adicionando nova forma de pagamento
                title.textContent = 'Adicionar Forma de Pagamento';
                form.reset();
                currentEditingPaymentMethod = null;
            }
            
            modal.classList.add('show');
        }
        
        function closePaymentMethodModal() {
            const modal = document.getElementById('paymentMethodModal');
            const form = document.getElementById('paymentMethodForm');
            modal.classList.remove('show');
            form.reset();
            currentEditingPaymentMethod = null;
        }
        
        async function saveCustomPaymentMethod() {
            try {
                const name = document.getElementById('paymentMethodName').value.trim();
                const description = document.getElementById('paymentMethodDescription').value.trim();
                const requiresChange = document.getElementById('paymentMethodRequiresChange').checked;
                const icon = document.getElementById('paymentMethodIcon').value;
                
                if (!name) {
                    settingsManager.showNotification('Nome da forma de pagamento √© obrigat√≥rio', 'error');
                    return;
                }
                
                const paymentMethodData = {
                    restaurant_id: settingsManager.currentRestaurant.id,
                    name,
                    description: description || null,
                    requires_change: requiresChange,
                    icon,
                    enabled: true
                };
                
                let result;
                if (currentEditingPaymentMethod) {
                    // Atualizar existente
                    result = await settingsManager.supabase
                        .from('custom_payment_methods')
                        .update(paymentMethodData)
                        .eq('id', currentEditingPaymentMethod.id);
                } else {
                    // Criar novo
                    result = await settingsManager.supabase
                        .from('custom_payment_methods')
                        .insert(paymentMethodData);
                }
                
                if (result.error) throw result.error;
                
                settingsManager.showNotification(
                    currentEditingPaymentMethod ? 'Forma de pagamento atualizada!' : 'Forma de pagamento adicionada!', 
                    'success'
                );
                
                closePaymentMethodModal();
                await loadCustomPaymentMethods();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar forma de pagamento:', error);
                settingsManager.showNotification('Erro ao salvar forma de pagamento: ' + error.message, 'error');
            }
        }
        
        async function loadCustomPaymentMethods() {
            try {
                if (!settingsManager.currentRestaurant) return;
                
                const { data: paymentMethods, error } = await settingsManager.supabase
                    .from('custom_payment_methods')
                    .select('*')
                    .eq('restaurant_id', settingsManager.currentRestaurant.id)
                    .order('display_order', { ascending: true });
                
                if (error) throw error;
                
                const container = document.getElementById('customPaymentMethodsList');
                
                if (!paymentMethods || paymentMethods.length === 0) {
                    container.innerHTML = '<p class="text-muted">Nenhuma forma de pagamento customizada cadastrada.</p>';
                    return;
                }
                
                container.innerHTML = paymentMethods.map(method => `
                    <div class="custom-method-item">
                        <div class="custom-method-info">
                            <div class="method-icon">
                                <i class="fas ${method.icon}"></i>
                            </div>
                            <div class="method-details">
                                <h4>${method.name}</h4>
                                <p>${method.description || 'Sem descri√ß√£o'}</p>
                                <span class="method-status ${method.enabled ? 'enabled' : 'disabled'}">
                                    ${method.enabled ? 'Ativo' : 'Inativo'}
                                </span>
                                ${method.requires_change ? '<small class="text-muted"> ‚Ä¢ Aceita troco</small>' : ''}
                            </div>
                        </div>
                        <div class="custom-method-actions">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="togglePaymentMethodStatus('${method.id}', ${!method.enabled})">
                                <i class="fas fa-${method.enabled ? 'pause' : 'play'}"></i>
                                ${method.enabled ? 'Desativar' : 'Ativar'}
                            </button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="editPaymentMethod('${method.id}')">
                                <i class="fas fa-edit"></i>
                                Editar
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deletePaymentMethod('${method.id}', '${method.name}')">
                                <i class="fas fa-trash"></i>
                                Excluir
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar formas de pagamento:', error);
                settingsManager.showNotification('Erro ao carregar formas de pagamento: ' + error.message, 'error');
            }
        }
        
        async function togglePaymentMethodStatus(methodId, enabled) {
            try {
                const { error } = await settingsManager.supabase
                    .from('custom_payment_methods')
                    .update({ enabled })
                    .eq('id', methodId);
                
                if (error) throw error;
                
                settingsManager.showNotification(
                    `Forma de pagamento ${enabled ? 'ativada' : 'desativada'}!`, 
                    'success'
                );
                
                await loadCustomPaymentMethods();
                
            } catch (error) {
                console.error('‚ùå Erro ao alterar status:', error);
                settingsManager.showNotification('Erro ao alterar status: ' + error.message, 'error');
            }
        }
        
        async function editPaymentMethod(methodId) {
            try {
                const { data: method, error } = await settingsManager.supabase
                    .from('custom_payment_methods')
                    .select('*')
                    .eq('id', methodId)
                    .single();
                
                if (error) throw error;
                
                openPaymentMethodModal(method);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar forma de pagamento:', error);
                settingsManager.showNotification('Erro ao carregar forma de pagamento: ' + error.message, 'error');
            }
        }
        
        async function deletePaymentMethod(methodId, methodName) {
            if (!confirm(`Tem certeza que deseja excluir a forma de pagamento "${methodName}"?`)) {
                return;
            }
            
            try {
                const { error } = await settingsManager.supabase
                    .from('custom_payment_methods')
                    .delete()
                    .eq('id', methodId);
                
                if (error) throw error;
                
                settingsManager.showNotification('Forma de pagamento exclu√≠da!', 'success');
                
                await loadCustomPaymentMethods();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir forma de pagamento:', error);
                settingsManager.showNotification('Erro ao excluir forma de pagamento: ' + error.message, 'error');
            }
        }
        

        // ===== INTEGRA√á√ÉO WHATSAPP =====
        
        // Configura√ß√£o da Evolution API (usando sistema de proxy seguro)
        let EVOLUTION_API = {
            serverUrl: null,
            apiKey: null,
            
            // M√©todo para verificar se est√° configurado (sempre true com proxy)
            isConfigured: function() {
                return true; // Sempre configurado via proxy do servidor
            },
            
            // M√©todo para construir URL segura (deprecated - usar proxy)
            buildUrl: function(endpoint) {
                console.log('‚ÑπÔ∏è EVOLUTION_API.buildUrl √© deprecated - usar endpoints /api/evolution/*');
                return null; // For√ßar uso do sistema de proxy
            }
        };

        let whatsappInstanceName = null;
        let modalUpdateInterval = null; // Intervalo para atualizar todo o modal
        let qrCodePolling = null;
        let webhookUrl = null;

        // Inicializar nome da inst√¢ncia WhatsApp automaticamente
        async function initializeWhatsAppInstanceName() {
            try {
                console.log('üîÑ Inicializando nome da inst√¢ncia WhatsApp...');
                
                // Tentar obter nome do restaurante
                const restaurantName = await getRestaurantNameFromDatabase();
                
                if (restaurantName && restaurantName.trim()) {
                    // Usar nome EXATO da tabela restaurants (preserva mai√∫sculas/min√∫sculas)
                    whatsappInstanceName = restaurantName;
                    console.log(`‚úÖ Nome EXATO da tabela restaurants: "${whatsappInstanceName}"`);
                } else {
                    // Fallback - usar nome padr√£o
                    whatsappInstanceName = 'timepulse_default';
                    console.log(`‚ö†Ô∏è Usando nome padr√£o da inst√¢ncia: ${whatsappInstanceName}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar nome da inst√¢ncia:', error);
                whatsappInstanceName = 'timepulse_default';
                console.log(`‚ö†Ô∏è Usando nome padr√£o por erro: ${whatsappInstanceName}`);
            }
        }

        // Abrir modal de configura√ß√£o WhatsApp
        async function openWhatsAppModal() {
            try {
                // 1. Verificar autentica√ß√£o
                const currentInstance = getInstanceData();
                if (!currentInstance || (!currentInstance.restaurantId && !currentInstance.instanceId)) {
                    settingsManager.showNotification('Erro: Fa√ßa login primeiro para configurar o WhatsApp', 'error');
                    return;
                }
                
                // 2. Obter e normalizar nome da inst√¢ncia
                const restaurantName = await getRestaurantNameFromDatabase();
                if (!restaurantName) {
                    settingsManager.showNotification('Erro: Nome do restaurante n√£o encontrado', 'error');
                    return;
                }
                
                const rawRestaurantName = restaurantName || 'timepulse_default';
                // Usar o nome EXATO da tabela 'restaurants' sem normaliza√ß√£o
                whatsappInstanceName = rawRestaurantName;
                
                console.log(`üì± MODAL - Nome EXATO da tabela restaurants: "${whatsappInstanceName}"`);
                
                // 3. Mostrar modal
                document.getElementById('whatsappModal').style.display = 'flex';
                
                // 4. Atualizar nome da inst√¢ncia no modal
                document.getElementById('modal-instanceName').textContent = whatsappInstanceName;
                
                // 5. Verificar se inst√¢ncia existe (primeira vez)
                await checkInstanceExistsModal(whatsappInstanceName);
                
                // Modal fica est√°tico - sem atualiza√ß√µes autom√°ticas
                // A verifica√ß√£o peri√≥dica acontece em segundo plano (a cada 5s) e n√£o afeta o modal aberto
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal WhatsApp:', error);
                settingsManager.showNotification('Erro ao carregar configura√ß√µes WhatsApp', 'error');
            }
        }

        // Buscar nome do restaurante no banco de dados
        async function getRestaurantNameFromDatabase() {
            try {
                // Verificar se h√° inst√¢ncia conectada primeiro
                const instance = getInstanceData();
                if (!instance) {
                    throw new Error('Nenhuma inst√¢ncia conectada');
                }

                // Se tem instanceName, usar como primeira op√ß√£o (mais confi√°vel)
                if (instance.instanceName && instance.instanceName.trim()) {
                    console.log('Usando instanceName:', instance.instanceName);
                    return instance.instanceName;
                }

                // Tentar buscar no Supabase como segunda op√ß√£o
                if (instance.restaurantId) {
                    try {
                        const supabase = settingsManager.supabase;
                        if (!supabase) {
                            throw new Error('Supabase n√£o dispon√≠vel');
                        }

                        console.log('Buscando restaurante com ID:', instance.restaurantId);

                        // Verificar se o cliente Supabase est√° corretamente configurado
                        if (!window.validateSupabaseConfig()) {
                            throw new Error('Configura√ß√£o Supabase inv√°lida');
                        }

                        // Buscar o nome do restaurante na tabela restaurants
                        const { data: restaurant, error } = await supabase
                            .from('restaurants')
                            .select('name')
                            .eq('id', instance.restaurantId)
                            .single();

                        if (error) {
                            console.warn('Erro ao buscar no Supabase:', error);
                            throw new Error(`Supabase error: ${error.message}`);
                        }

                        if (restaurant && restaurant.name) {
                            return restaurant.name;
                        }
                        
                    } catch (supabaseError) {
                        console.warn('Falha ao buscar no Supabase:', supabaseError);
                        // Continuar para pr√≥ximas op√ß√µes
                    }
                }

                // Fallback final - usar um nome padr√£o baseado no ID da inst√¢ncia
                if (instance.instanceId) {
                    const fallbackName = `Restaurante_${instance.instanceId.substring(0, 8)}`;
                    console.log('Usando nome padr√£o como fallback:', fallbackName);
                    return fallbackName;
                }

                throw new Error('N√£o foi poss√≠vel determinar o nome do restaurante');

            } catch (error) {
                console.error('Erro ao buscar nome do restaurante:', error);
                
                // √öltimo fallback - nome gen√©rico
                return 'Meu Restaurante';
            }
        }

        // Fechar modal WhatsApp
        function closeWhatsAppModal() {
            document.getElementById('whatsappModal').style.display = 'none';
            
            // Parar polling do QR code
            if (qrCodePolling) {
                clearInterval(qrCodePolling);
                qrCodePolling = null;
            }
            
            // Parar atualiza√ß√£o autom√°tica do modal
            stopModalAutoUpdate();
        }

        // ========== NOVAS FUN√á√ïES DO MODAL ==========
        
        // Iniciar atualiza√ß√£o autom√°tica do modal a cada 5 segundos
        function startModalAutoUpdate() {
            // Parar intervalo anterior se existir
            stopModalAutoUpdate();
            
            console.log('üîÑ Iniciando atualiza√ß√£o autom√°tica do modal WhatsApp a cada 5 segundos...');
            
            modalUpdateInterval = setInterval(async () => {
                console.log('‚è∞ MODAL AUTO-UPDATE - Atualizando informa√ß√µes...');
                
                if (whatsappInstanceName) {
                    await checkInstanceExistsModal(whatsappInstanceName);
                }
            }, 5000); // 5 segundos
        }
        
        // Parar atualiza√ß√£o autom√°tica do modal
        function stopModalAutoUpdate() {
            if (modalUpdateInterval) {
                clearInterval(modalUpdateInterval);
                modalUpdateInterval = null;
                console.log('üõë Atualiza√ß√£o autom√°tica do modal parada');
            }
        }
        
        // Verificar estado de conex√£o da inst√¢ncia
        async function checkConnectionState(instanceName) {
            try {
                console.log(`üîç Verificando connection state da inst√¢ncia EXATA "${instanceName}"...`);
                
                const response = await fetch(`/api/evolution/connection-state/${encodeURIComponent(instanceName)}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Erro ao verificar connection state:', response.status);
                    return 'unknown';
                }
                
                const result = await response.json();
                console.log('üìä Connection state resultado:', result);
                
                return result.state || 'unknown'; // Retorna: 'open', 'close', 'connecting', ou 'unknown'
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar connection state:', error);
                return 'unknown';
            }
        }
        
        // Verificar se inst√¢ncia existe no modal
        async function checkInstanceExistsModal(instanceName) {
            try {
                console.log(`üîç MODAL - Verificando se inst√¢ncia EXATA "${instanceName}" existe...`);

                const response = await fetch(`/api/evolution/check-instance/${encodeURIComponent(instanceName)}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });

                const result = await response.json();
                
                const statusElement = document.getElementById('modal-instanceStatus');
                const createBtn = document.getElementById('modal-createInstanceBtn');
                const generateBtn = document.getElementById('modal-generateQRBtn');
                const alertsDiv = document.getElementById('modal-alerts');
                
                // Limpar alertas anteriores
                alertsDiv.innerHTML = '';

                // Verificar se a resposta da API foi bem-sucedida
                if (!response.ok) {
                    // Erro 404 ou erro de API - tratar como "inst√¢ncia n√£o existe"
                    console.warn('‚ö†Ô∏è MODAL - Erro da API (tratando como inst√¢ncia n√£o existente):', response.status, result);
                    statusElement.innerHTML = '<span style="color: #856404; font-weight: bold;">‚ö†Ô∏è N√£o criada</span>';
                    createBtn.style.display = 'block';  // MOSTRAR bot√£o de criar
                    generateBtn.style.display = 'none';
                    
                    alertsDiv.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                            ‚ö†Ô∏è Inst√¢ncia "${instanceName}" n√£o foi encontrada no Evolution API.<br>
                            <small>Clique no bot√£o abaixo para criar a inst√¢ncia. ${response.status === 404 ? 'A API retornou erro 404.' : `C√≥digo HTTP: ${response.status}`}</small>
                        </div>
                    `;
                    return;
                }

                // Resposta bem-sucedida - verificar se inst√¢ncia existe
                if (result.exists === true) {
                    console.log('‚úÖ MODAL - Inst√¢ncia j√° existe:', result.data);
                    
                    // Verificar estado de conex√£o da inst√¢ncia
                    console.log('üîç MODAL - Verificando estado de conex√£o...');
                    const connectionState = await checkConnectionState(instanceName);
                    
                    if (connectionState === 'open') {
                        // Inst√¢ncia conectada - mostrar informa√ß√µes e bot√£o de configura√ß√µes
                        console.log('‚úÖ MODAL - Inst√¢ncia CONECTADA! Mostrando informa√ß√µes e configura√ß√µes...');
                        
                        // Atualizar status para Conectado
                        statusElement.innerHTML = '<span style="color: #155724; font-weight: bold;">‚úÖ Conectado</span>';
                        
                        // Ocultar bot√µes de criar/gerar
                        createBtn.style.display = 'none';
                        generateBtn.style.display = 'none';
                        
                        // Ocultar alertas
                        alertsDiv.innerHTML = '';
                        alertsDiv.style.display = 'none';
                        
                        // Ocultar se√ß√£o do QR Code
                        const qrcodeSection = document.getElementById('modal-qrcodeSection');
                        if (qrcodeSection) {
                            qrcodeSection.style.display = 'none';
                        }
                        
                        // Mostrar bot√£o de configura√ß√µes
                        const settingsBtn = document.getElementById('modal-settingsBtn');
                        if (settingsBtn) {
                            settingsBtn.style.display = 'block';
                        }
                        
                        console.log('‚úÖ Modal atualizado - informa√ß√µes vis√≠veis, QR Code oculto');
                    } else if (connectionState === 'connecting') {
                        // Inst√¢ncia conectando
                        console.log('üîÑ MODAL - Inst√¢ncia CONECTANDO...');
                        statusElement.innerHTML = '<span style="color: #856404; font-weight: bold;">üîÑ Conectando...</span>';
                        createBtn.style.display = 'none';
                        generateBtn.style.display = 'block';
                        
                        alertsDiv.innerHTML = `
                            <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                                üîÑ WhatsApp em processo de conex√£o...<br>
                                <small>Se necess√°rio, clique no bot√£o abaixo para gerar um novo QR Code.</small>
                            </div>
                        `;
                    } else {
                        // Inst√¢ncia criada mas n√£o conectada (close ou unknown)
                        console.log('‚ö†Ô∏è MODAL - Inst√¢ncia N√ÉO conectada. Estado:', connectionState);
                        statusElement.innerHTML = '<span style="color: #155724; font-weight: bold;">‚úÖ Criada</span>';
                        createBtn.style.display = 'none';
                        generateBtn.style.display = 'block';
                        
                        alertsDiv.innerHTML = `
                            <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                                ‚úÖ Inst√¢ncia "${instanceName}" j√° est√° criada no Evolution!<br>
                                <small>Clique no bot√£o abaixo para gerar o QR Code e conectar o WhatsApp.</small>
                            </div>
                        `;
                    }
                } else if (result.exists === false) {
                    console.log('‚ö†Ô∏è MODAL - Inst√¢ncia n√£o existe');
                    statusElement.innerHTML = '<span style="color: #721c24; font-weight: bold;">‚ùå N√£o criada</span>';
                    createBtn.style.display = 'block';
                    generateBtn.style.display = 'none';
                    
                    alertsDiv.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                            ‚ö†Ô∏è Inst√¢ncia "${instanceName}" n√£o encontrada no Evolution.<br>
                            <small>Clique no bot√£o abaixo para criar a inst√¢ncia.</small>
                        </div>
                    `;
                } else {
                    // Resposta sem flag exists - erro inesperado
                    console.warn('‚ö†Ô∏è MODAL - Resposta sem flag exists:', result);
                    statusElement.innerHTML = '<span style="color: #721c24; font-weight: bold;">‚ùå Erro</span>';
                    createBtn.style.display = 'none';
                    generateBtn.style.display = 'none';
                    
                    alertsDiv.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                            ‚ùå Resposta inv√°lida da API. Tente novamente ou contacte o suporte.
                        </div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå MODAL - Erro ao verificar inst√¢ncia:', error);
                const statusElement = document.getElementById('modal-instanceStatus');
                const alertsDiv = document.getElementById('modal-alerts');
                
                statusElement.innerHTML = '<span style="color: #721c24; font-weight: bold;">‚ùå Erro</span>';
                
                alertsDiv.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                        ‚ùå Erro de conex√£o: ${error.message}<br>
                        <small>Verifique sua conex√£o com a internet e tente novamente.</small>
                    </div>
                `;
            }
        }

        // Criar inst√¢ncia no modal
        async function createEvolutionInstanceModal() {
            try {
                const createBtn = document.getElementById('modal-createInstanceBtn');
                const loader = document.getElementById('modal-loader');
                const alertsDiv = document.getElementById('modal-alerts');

                // Desabilitar bot√£o e mostrar loader
                createBtn.disabled = true;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando inst√¢ncia...';
                loader.style.display = 'block';

                // Preparar dados para criar inst√¢ncia com nome EXATO
                const requestBody = {
                    instanceName: whatsappInstanceName,
                    integration: 'WHATSAPP-BAILEYS',
                    qrcode: true,
                    webhook: {
                        url: 'https://n8n.timepulseai.com.br/webhook/7398cf3b-43ae-4d12-9f0b-443e3b66dfd1',
                        byEvents: true,
                        events: ['APPLICATION_STARTUP', 'MESSAGES_UPDATE', 'MESSAGES_UPSERT', 'PRESENCE_UPDATE', 'QRCODE_UPDATED']
                    }
                };

                console.log('üì§ MODAL - Criando inst√¢ncia com nome EXATO:', whatsappInstanceName, requestBody);

                const response = await fetch('/api/evolution/create-instance', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                loader.style.display = 'none';

                if (response.ok) {
                    createBtn.innerHTML = '<i class="fas fa-check"></i> Inst√¢ncia criada com sucesso!';
                    createBtn.style.background = '#28a745';
                    
                    // Verificar QR code
                    const qrCodeSrc = result.qrcode?.base64 || result.qrcode?.code || result.base64 || result.code;
                    
                    if (qrCodeSrc) {
                        const qrcodeSection = document.getElementById('modal-qrcodeSection');
                        const qrcodeImage = document.getElementById('modal-qrcodeImage');
                        const finalSrc = qrCodeSrc.startsWith('data:image') ? qrCodeSrc : 'data:image/png;base64,' + qrCodeSrc;
                        
                        qrcodeImage.src = finalSrc;
                        qrcodeSection.style.display = 'block';
                        console.log('‚úÖ MODAL - QR Code exibido!');
                    }
                    
                    // Atualizar status
                    document.getElementById('modal-instanceStatus').innerHTML = '<span style="color: #155724; font-weight: bold;">‚úÖ Criada</span>';
                    
                    // Ocultar bot√£o e mostrar sucesso
                    setTimeout(() => {
                        createBtn.style.display = 'none';
                        document.getElementById('modal-generateQRBtn').style.display = 'block';
                    }, 3000);
                    
                    alertsDiv.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                            ‚úÖ Inst√¢ncia "${whatsappInstanceName}" criada com sucesso!
                        </div>
                    `;
                    
                } else {
                    throw new Error(result.error || 'Erro ao criar inst√¢ncia');
                }

            } catch (error) {
                console.error('‚ùå MODAL - Erro ao criar inst√¢ncia:', error);
                
                const createBtn = document.getElementById('modal-createInstanceBtn');
                const loader = document.getElementById('modal-loader');
                const alertsDiv = document.getElementById('modal-alerts');
                
                loader.style.display = 'none';
                createBtn.innerHTML = '‚ùå Erro ao criar inst√¢ncia';
                createBtn.style.background = '#dc3545';
                
                alertsDiv.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                        ‚ùå ${error.message || 'Erro desconhecido'}<br>
                        <small>Verifique se as credenciais da Evolution API est√£o corretas</small>
                    </div>
                `;
                
                setTimeout(() => {
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'üöÄ Criar Inst√¢ncia no Evolution';
                    createBtn.style.background = '#28a745';
                }, 3000);
            }
        }

        // Vari√°vel de controle para evitar m√∫ltiplas requisi√ß√µes
        let isGeneratingQRCode = false;
        let lastQRCodeRequest = 0;

        // Gerar QR Code no modal
        async function generateQRCodeModal() {
            try {
                // Verificar se j√° est√° gerando um QR Code
                if (isGeneratingQRCode) {
                    console.warn('‚ö†Ô∏è MODAL - J√° existe uma requisi√ß√£o de QR Code em andamento');
                    return;
                }

                // Rate limiting: m√≠nimo de 5 segundos entre requisi√ß√µes
                const now = Date.now();
                const timeSinceLastRequest = now - lastQRCodeRequest;
                const minInterval = 5000; // 5 segundos

                if (timeSinceLastRequest < minInterval) {
                    const waitTime = Math.ceil((minInterval - timeSinceLastRequest) / 1000);
                    document.getElementById('modal-alerts').innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                            ‚è±Ô∏è Aguarde ${waitTime} segundos antes de tentar novamente
                        </div>
                    `;
                    return;
                }

                const generateBtn = document.getElementById('modal-generateQRBtn');
                const loader = document.getElementById('modal-loader');
                const qrcodeSection = document.getElementById('modal-qrcodeSection');
                const qrcodeImage = document.getElementById('modal-qrcodeImage');

                // Marcar como em andamento
                isGeneratingQRCode = true;
                lastQRCodeRequest = now;

                // Desabilitar bot√£o e mostrar loader
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando QR Code...';
                loader.style.display = 'block';
                qrcodeSection.style.display = 'none';

                console.log('üì± MODAL - Gerando QR Code para nome EXATO:', whatsappInstanceName);

                const response = await fetch(`/api/evolution/instance/connect/${encodeURIComponent(whatsappInstanceName)}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });

                const result = await response.json();
                loader.style.display = 'none';

                if (response.ok) {
                    generateBtn.innerHTML = '<i class="fas fa-check"></i> QR Code gerado!';
                    generateBtn.style.background = '#28a745';
                    
                    // Verificar QR code
                    const qrCodeSrc = result.qrcode?.base64 || result.qrcode?.code || result.base64 || result.code;
                    
                    if (qrCodeSrc) {
                        const finalSrc = qrCodeSrc.startsWith('data:image') ? qrCodeSrc : 'data:image/png;base64,' + qrCodeSrc;
                        qrcodeImage.src = finalSrc;
                        qrcodeSection.style.display = 'block';
                        console.log('‚úÖ MODAL - QR Code exibido!');
                        
                        // Limpar alertas anteriores
                        document.getElementById('modal-alerts').innerHTML = '';
                    } else {
                        document.getElementById('modal-alerts').innerHTML = `
                            <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                                ‚ö†Ô∏è WhatsApp pode j√° estar conectado. Verifique o status da conex√£o.
                            </div>
                        `;
                    }
                    
                    setTimeout(() => {
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = 'üì± Gerar QR Code para Conectar';
                        generateBtn.style.background = '#007bff';
                        isGeneratingQRCode = false;
                    }, 3000);

                } else if (response.status === 429) {
                    // Tratamento espec√≠fico para erro 429
                    throw new Error('Muitas requisi√ß√µes. Aguarde alguns segundos e tente novamente.');
                } else {
                    throw new Error(result.error || 'Erro ao gerar QR Code');
                }

            } catch (error) {
                console.error('‚ùå MODAL - Erro ao gerar QR Code:', error);
                
                const generateBtn = document.getElementById('modal-generateQRBtn');
                const loader = document.getElementById('modal-loader');
                
                loader.style.display = 'none';
                generateBtn.innerHTML = '‚ùå Erro';
                generateBtn.style.background = '#dc3545';
                
                // Mensagem de erro espec√≠fica para 429
                const errorMessage = error.message || 'Erro desconhecido';
                const waitMessage = errorMessage.includes('Muitas requisi√ß√µes') ? 
                    '<br><small><strong>Aguarde 10 segundos antes de tentar novamente</strong></small>' : 
                    '<br><small>Verifique se as credenciais da Evolution API est√£o corretas</small>';
                
                document.getElementById('modal-alerts').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                        ‚ùå ${errorMessage}${waitMessage}
                    </div>
                `;
                
                // Tempo de espera maior em caso de erro 429
                const waitTime = errorMessage.includes('Muitas requisi√ß√µes') ? 10000 : 5000;
                
                setTimeout(() => {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = 'üì± Gerar QR Code para Conectar';
                    generateBtn.style.background = '#007bff';
                    isGeneratingQRCode = false;
                }, waitTime);
            }
        }

        // ========== FUN√á√ïES DO MODAL DE CONFIGURA√á√ïES WHATSAPP ==========
        
        // Abrir modal de configura√ß√µes do WhatsApp
        async function openWhatsAppSettingsModal() {
            try {
                console.log('‚öôÔ∏è Abrindo modal de configura√ß√µes WhatsApp...');
                
                // Mostrar modal
                document.getElementById('whatsappSettingsModal').style.display = 'flex';
                document.getElementById('settings-instanceName').textContent = whatsappInstanceName;
                
                // Carregar configura√ß√µes atuais
                await loadWhatsAppSettings();
                
            } catch (error) {
                console.error('‚ùå Erro ao abrir modal de configura√ß√µes:', error);
                alert('Erro ao carregar configura√ß√µes: ' + error.message);
            }
        }
        
        // Fechar modal de configura√ß√µes
        function closeWhatsAppSettingsModal() {
            document.getElementById('whatsappSettingsModal').style.display = 'none';
        }
        
        // Carregar configura√ß√µes atuais do WhatsApp
        async function loadWhatsAppSettings() {
            try {
                console.log('üì• Carregando configura√ß√µes da inst√¢ncia EXATA:', whatsappInstanceName);
                
                const response = await fetch(`/api/evolution/check-instance/${encodeURIComponent(whatsappInstanceName)}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar configura√ß√µes');
                }
                
                const result = await response.json();
                
                if (result.exists && result.data && result.data.Setting) {
                    const settings = result.data.Setting;
                    console.log('‚úÖ Configura√ß√µes carregadas:', settings);
                    
                    // Atualizar switches com valores atuais
                    document.getElementById('setting-rejectCall').checked = settings.rejectCall || false;
                    document.getElementById('setting-groupsIgnore').checked = settings.groupsIgnore || false;
                    document.getElementById('setting-alwaysOnline').checked = settings.alwaysOnline || false;
                    document.getElementById('setting-readMessages').checked = settings.readMessages || false;
                    document.getElementById('setting-syncFullHistory').checked = settings.syncFullHistory || false;
                    document.getElementById('setting-readStatus').checked = settings.readStatus || false;
                    
                    console.log('‚úÖ Configura√ß√µes aplicadas aos switches');
                } else {
                    console.warn('‚ö†Ô∏è Nenhuma configura√ß√£o encontrada');
                    // Deixar todos os switches desligados (valores padr√£o)
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
                document.getElementById('settings-alerts').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                        ‚ùå Erro ao carregar configura√ß√µes: ${error.message}
                    </div>
                `;
            }
        }
        
        // Atualizar uma configura√ß√£o espec√≠fica
        async function updateWhatsAppSetting(settingName, value) {
            try {
                console.log(`üîÑ Atualizando ${settingName} para ${value}...`);
                
                const loader = document.getElementById('settings-loader');
                loader.style.display = 'block';
                
                // Evolution API exige TODOS os campos obrigat√≥rios juntos
                // Coletar valores atuais de todos os checkboxes
                const allSettings = {
                    rejectCall: document.getElementById('setting-rejectCall').checked,
                    msgCall: "Desculpe, n√£o posso atender liga√ß√µes no momento. Por favor, envie uma mensagem de texto",
                    groupsIgnore: document.getElementById('setting-groupsIgnore').checked,
                    alwaysOnline: document.getElementById('setting-alwaysOnline').checked,
                    readMessages: document.getElementById('setting-readMessages').checked,
                    readStatus: document.getElementById('setting-readStatus').checked,
                    syncFullHistory: document.getElementById('setting-syncFullHistory').checked
                };
                
                // Atualizar o campo espec√≠fico que foi alterado
                allSettings[settingName] = value;
                
                console.log('üì§ Enviando TODAS as configura√ß√µes:', allSettings);
                
                const response = await fetch(`/api/evolution/update-settings/${whatsappInstanceName}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(allSettings)
                });
                
                loader.style.display = 'none';
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                    console.error('‚ùå Resposta de erro:', errorData);
                    throw new Error(errorData.error || 'Erro ao atualizar configura√ß√£o');
                }
                
                const result = await response.json();
                console.log('‚úÖ Configura√ß√£o atualizada:', result);
                
                // Mostrar mensagem de sucesso tempor√°ria
                const alertsDiv = document.getElementById('settings-alerts');
                alertsDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                        ‚úÖ Configura√ß√£o salva com sucesso!
                    </div>
                `;
                
                // Limpar mensagem ap√≥s 3 segundos
                setTimeout(() => {
                    alertsDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar configura√ß√£o:', error);
                
                document.getElementById('settings-loader').style.display = 'none';
                document.getElementById('settings-alerts').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                        ‚ùå Erro ao salvar: ${error.message}
                    </div>
                `;
            }
        }

        // Carregar webhook URL do banco de dados
        async function loadWebhookFromDatabase() {
            try {
                // Usar URL padr√£o diretamente pois tabela webhooks n√£o existe
                webhookUrl = 'https://n8n.timepulseai.com.br/webhook/7398cf3b-43ae-4d12-9f0b-443e3b66dfd1';
                console.log('‚úÖ Webhook URL configurada:', webhookUrl);
            } catch (error) {
                console.error('Erro ao configurar webhook:', error);
                webhookUrl = 'https://n8n.timepulseai.com.br/webhook/7398cf3b-43ae-4d12-9f0b-443e3b66dfd1';
            }
        }

        // Verificar se inst√¢ncia j√° existe e status de conex√£o
        async function checkExistingInstance() {
            try {
                updateConnectionStatus('Verificando inst√¢ncia existente...', 'warning');
                
                // Primeiro buscar TODAS as inst√¢ncias para verificar estrutura correta
                const response = await fetch(`/api/evolution/instance/fetchInstances`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const instances = await response.json();
                    console.log('Todas as inst√¢ncias:', instances);
                    
                    // Verificar se √© um array e encontrar nossa inst√¢ncia
                    let existingInstance = null;
                    if (Array.isArray(instances)) {
                        existingInstance = instances.find(inst => {
                            // Tentar diferentes estruturas poss√≠veis da API
                            const instanceName = inst.instanceName || inst.instance?.instanceName || inst.name;
                            return instanceName === whatsappInstanceName;
                        });
                    }
                    
                    if (existingInstance) {
                        console.log('Inst√¢ncia encontrada:', existingInstance);
                        
                        // Verificar status de conex√£o
                        const status = existingInstance.connectionStatus || 'close';
                        console.log('üîç Status da conex√£o detectado:', status);
                        
                        if (status === 'open') {
                            // WhatsApp j√° conectado
                            console.log('‚úÖ WhatsApp j√° est√° conectado! Mostrando estado conectado...');
                            showConnectedState(existingInstance);
                        } else {
                            // Inst√¢ncia existe mas n√£o est√° conectada - gerar QR code
                            console.log('‚ö†Ô∏è Inst√¢ncia existe mas n√£o conectada. Gerando QR code...');
                            await connectExistingInstance();
                        }
                    } else {
                        // Inst√¢ncia n√£o existe, criar nova
                        console.log('Nenhuma inst√¢ncia encontrada, criando nova...');
                        await createNewInstance();
                    }
                } else if (response.status === 404) {
                    // 404 significa que n√£o h√° inst√¢ncias
                    console.log('Inst√¢ncia n√£o encontrada (404)');
                    updateConnectionStatus('Inst√¢ncia n√£o encontrada', 'warning');
                    // Ap√≥s mostrar o status, aguardar um momento e ent√£o criar nova inst√¢ncia
                    setTimeout(async () => {
                        console.log('Criando nova inst√¢ncia...');
                        await createNewInstance();
                    }, 1500);
                } else {
                    // Outros erros
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }
            } catch (error) {
                console.error('Erro ao verificar inst√¢ncia:', error);
                updateConnectionStatus('Erro ao verificar inst√¢ncia. Tente novamente.', 'danger');
                settingsManager.showNotification('Erro ao conectar com a API Evolution. Verifique a conectividade.', 'error');
            }
        }

        // Criar nova inst√¢ncia WhatsApp
        async function createNewInstance() {
            try {
                console.log('üÜï WHATSAPP - Criando nova inst√¢ncia na Evolution API...');
                
                const instanceData = {
                    instanceName: whatsappInstanceName,
                    qrcode: true,
                    integration: "WHATSAPP-BAILEYS",
                    webhook: {
                        url: "https://n8n.timepulseai.com.br/webhook/7398cf3b-43ae-4d12-9f0b-443e3b66dfd1",
                        byEvents: false,
                        base64: false,
                        headers: {
                            "Content-Type": "application/json"
                        },
                        events: [
                            "APPLICATION_STARTUP",
                            "QRCODE_UPDATED",
                            "MESSAGES_UPDATE",
                            "MESSAGES_UPSERT",
                            "PRESENCE_UPDATE",
                            "CONNECTION_UPDATE"
                        ]
                    }
                };

                const response = await fetch(`/api/evolution/instance/create`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(instanceData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Inst√¢ncia criada:', result);
                    updateConnectionStatus('Inst√¢ncia criada com sucesso. Conectando...', 'success');
                    
                    // Aguardar um pouco antes de tentar conectar
                    setTimeout(() => {
                        connectExistingInstance();
                    }, 2000);
                } else if (response.status === 403) {
                    // 403 provavelmente significa que a inst√¢ncia j√° existe
                    console.log('Inst√¢ncia j√° existe (403). Tentando conectar...');
                    updateConnectionStatus('Inst√¢ncia j√° existe. Conectando...', 'warning');
                    await connectExistingInstance();
                } else {
                    const errorText = await response.text();
                    console.error('Erro na cria√ß√£o:', errorText);
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Erro ao criar inst√¢ncia:', error);
                updateConnectionStatus('Erro ao criar inst√¢ncia WhatsApp', 'danger');
                settingsManager.showNotification('Erro ao criar inst√¢ncia WhatsApp. Verifique as configura√ß√µes.', 'error');
            }
        }

        // Conectar inst√¢ncia existente e gerar QR Code
        async function connectExistingInstance() {
            try {
                console.log('üîó WHATSAPP - Conectando inst√¢ncia existente e gerando QR Code...');
                
                const response = await fetch(`/api/evolution/instance/connect/${whatsappInstanceName}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Resposta de conex√£o recebida:', result);
                    
                    if (result.base64) {
                        // Usar o campo base64 que j√° cont√©m o data URL completo
                        console.log('üì± Usando QR Code base64 da resposta');
                        displayQRCodeFromBase64(result.base64);
                        startQRCodePolling();
                    } else if (result.code) {
                        console.log('üî¢ Usando c√≥digo QR da resposta');
                        await displayQRCode(result);
                        startQRCodePolling();
                    } else if (result.pairingCode) {
                        console.log('üîê Usando c√≥digo de pareamento');
                        displayPairingCode(result.pairingCode);
                        startQRCodePolling();
                    } else {
                        console.warn('‚ö†Ô∏è Resposta sem QR Code ou c√≥digo de pareamento:', result);
                        throw new Error('Resposta da API n√£o cont√©m QR Code nem c√≥digo de pareamento');
                    }
                } else {
                    // Capturar erro detalhado da resposta
                    let errorMessage = `Erro HTTP ${response.status}: ${response.statusText}`;
                    
                    try {
                        const errorResponse = await response.text();
                        if (errorResponse) {
                            errorMessage += ` - ${errorResponse}`;
                        }
                    } catch (parseError) {
                        console.warn('N√£o foi poss√≠vel ler corpo da resposta de erro:', parseError);
                    }
                    
                    console.error(`‚ùå Erro na API Evolution:`, errorMessage);
                    throw new Error(errorMessage);
                }
            } catch (error) {
                // Melhor tratamento de erro com mensagem detalhada
                const errorMsg = error?.message || error?.toString() || 'Erro desconhecido na conex√£o';
                console.error('‚ùå Erro ao conectar inst√¢ncia:', {
                    message: errorMsg,
                    error: error,
                    stack: error?.stack
                });
                
                updateConnectionStatus(`Erro ao conectar: ${errorMsg}`, 'danger');
                
                // Mostrar erro no modal tamb√©m
                const qrDisplay = document.getElementById('qrCodeDisplay');
                if (qrDisplay) {
                    qrDisplay.innerHTML = `
                        <div class="connection-error">
                            <i class="fas fa-times-circle text-danger" style="font-size: 2rem; margin-bottom: 15px;"></i>
                            <h5>Erro na Conex√£o</h5>
                            <p class="text-muted">${errorMsg}</p>
                            <button class="btn btn-primary btn-sm" onclick="connectExistingInstance()">
                                <i class="fas fa-redo"></i> Tentar Novamente
                            </button>
                        </div>
                    `;
                }
                
                throw error; // Re-throw para que outras fun√ß√µes possam capturar
            }
        }

        // Exibir QR Code (para campo base64 completo)
        function displayQRCodeFromBase64(base64DataUrl) {
            const qrDisplay = document.getElementById('qrCodeDisplay');
            qrDisplay.innerHTML = `
                <img src="${base64DataUrl}" alt="QR Code WhatsApp" style="width: 100%; max-width: 300px; border-radius: 8px;">
                <p class="qr-refresh-info">
                    <i class="fas fa-info-circle"></i>
                    QR Code atualiza automaticamente
                </p>
            `;
            updateConnectionStatus('Escaneie o QR Code com seu WhatsApp', 'warning');
        }

        // Exibir QR Code simples (backup function)
        function displayQRCodeSimple(base64Code) {
            const qrDisplay = document.getElementById('qrCodeDisplay');
            qrDisplay.innerHTML = `
                <img src="data:image/png;base64,${base64Code}" alt="QR Code WhatsApp" style="width: 100%; max-width: 300px; border-radius: 8px;">
                <p class="qr-refresh-info">
                    <i class="fas fa-info-circle"></i>
                    QR Code atualiza automaticamente
                </p>
            `;
            updateConnectionStatus('Escaneie o QR Code com seu WhatsApp', 'warning');
        }

        // Exibir c√≥digo de pareamento
        function displayPairingCode(pairingCode) {
            const qrDisplay = document.getElementById('qrCodeDisplay');
            qrDisplay.innerHTML = `
                <div class="pairing-code-display">
                    <h3>C√≥digo de Pareamento</h3>
                    <div class="pairing-code">${pairingCode}</div>
                    <p>Digite este c√≥digo no WhatsApp Web</p>
                </div>
            `;
            updateConnectionStatus('Use o c√≥digo de pareamento no WhatsApp', 'info');
        }

        // Iniciar polling do QR Code
        function startQRCodePolling() {
            console.log('üîÑ Iniciando polling de QR code (verifica√ß√£o a cada 10 segundos)');
            
            qrCodePolling = setInterval(async () => {
                try {
                    const response = await fetch(`/api/evolution/connectionState/${whatsappInstanceName}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const status = await response.json();
                        
                        if (status.instance && status.instance.state === 'open') {
                            // Conectado com sucesso
                            console.log('‚úÖ WhatsApp conectado! Parando polling e carregando perfil...');
                            clearInterval(qrCodePolling);
                            qrCodePolling = null;
                            
                            // Buscar informa√ß√µes do perfil e mostrar estado conectado
                            await fetchProfileInfo();
                        } else {
                            // N√£o conectado - recarregar QR code
                            console.log('üîÑ Recarregando QR code automaticamente...');
                            await refreshQRCode();
                        }
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }, 10000); // Alterado para 10 segundos conforme solicitado
        }

        // Recarregar QR code quando n√£o conectado
        async function refreshQRCode() {
            try {
                const response = await fetch(`/api/evolution/instance/connect/${whatsappInstanceName}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.base64) {
                        displayQRCodeFromBase64(result.base64);
                    } else if (result.code) {
                        await displayQRCode(result);
                    }
                }
            } catch (error) {
                console.error('Erro ao recarregar QR code:', error);
            }
        }

        // Buscar informa√ß√µes do perfil conectado
        async function fetchProfileInfo() {
            try {
                if (!whatsappInstanceName) {
                    console.log('‚ö†Ô∏è Nome da inst√¢ncia n√£o configurado para buscar perfil');
                    return null;
                }
                
                const response = await fetch(`/api/evolution/instance/fetchInstances`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const instances = await response.json();
                    const instance = instances.find(inst => inst.name === whatsappInstanceName);
                    
                    if (instance && instance.connectionStatus === 'open') {
                        showConnectedState(instance);
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar informa√ß√µes do perfil:', error);
            }
        }

        // Mostrar estado conectado
        function showConnectedState(instanceInfo) {
            console.log('üéâ Exibindo estado conectado do WhatsApp:', instanceInfo);
            updateConnectionStatus('WhatsApp conectado com sucesso!', 'success');
            
            // Garantir que o polling seja parado
            if (qrCodePolling) {
                console.log('‚èπÔ∏è Parando polling de QR code...');
                clearInterval(qrCodePolling);
                qrCodePolling = null;
                console.log('‚úÖ Polling interrompido com sucesso');
            }
            
            // Atualizar √°rea do QR Code para mostrar estado conectado
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (qrDisplay) {
                const profileName = instanceInfo.profileName || instanceInfo.name || 'Nome n√£o dispon√≠vel';
                const phoneNumber = instanceInfo.ownerJid ? instanceInfo.ownerJid.replace('@s.whatsapp.net', '') : 'N√∫mero n√£o dispon√≠vel';
                
                qrDisplay.innerHTML = `
                    <div class="whatsapp-connected text-center">
                        <i class="fab fa-whatsapp" style="font-size: 48px; color: #25D366; margin-bottom: 15px;"></i>
                        <h5 style="color: #25D366; margin-bottom: 10px;">‚úÖ WhatsApp Conectado!</h5>
                        <div class="connection-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p><strong>Inst√¢ncia:</strong> ${whatsappInstanceName}</p>
                            <p><strong>Perfil:</strong> ${profileName}</p>
                            <p><strong>N√∫mero:</strong> ${phoneNumber}</p>
                        </div>
                        <p class="text-muted">Sua inst√¢ncia est√° ativa e funcionando perfeitamente!</p>
                        <button class="btn btn-warning btn-sm mt-2" onclick="disconnectWhatsApp()">
                            <i class="fas fa-unlink"></i> Desconectar
                        </button>
                    </div>
                `;
            }
            
            // Mostrar informa√ß√µes do perfil se os elementos existirem
            const connectionInfo = document.getElementById('connectionInfo');
            const profilePicture = document.getElementById('profilePicture');
            const profileName = document.getElementById('profileName');
            const profilePhone = document.getElementById('profilePhone');
            const profileStatus = document.getElementById('profileStatus');

            if (profileName) profileName.textContent = instanceInfo.profileName || instanceInfo.name || 'Nome n√£o dispon√≠vel';
            if (profilePhone) profilePhone.textContent = instanceInfo.ownerJid ? instanceInfo.ownerJid.replace('@s.whatsapp.net', '') : 'N√∫mero n√£o dispon√≠vel';
            if (profileStatus) profileStatus.textContent = instanceInfo.profileStatus || 'Conectado';
            
            if (profilePicture && instanceInfo.profilePicUrl) {
                profilePicture.src = instanceInfo.profilePicUrl;
                profilePicture.style.display = 'block';
            } else if (profilePicture) {
                profilePicture.style.display = 'none';
            }

            if (connectionInfo) connectionInfo.style.display = 'block';
            
            // Ocultar QR code e mostrar configura√ß√µes se os elementos existirem
            const connectionStep = document.getElementById('whatsappConnectionStep');
            const settingsStep = document.getElementById('whatsappSettingsStep');
            
            if (connectionStep) connectionStep.style.display = 'none';
            if (settingsStep) settingsStep.style.display = 'block';
            
            // Atualizar status na p√°gina principal
            updateMainPageStatus('Conectado');
            
            // Carregar configura√ß√µes atuais
            loadCurrentSettings(instanceInfo);
        }

        // Atualizar status de conex√£o
        function updateConnectionStatus(message, type) {
            const statusElement = document.getElementById('connectionStatus');
            const iconClass = type === 'success' ? 'text-success' : 
                           type === 'danger' ? 'text-danger' : 
                           type === 'info' ? 'text-info' : 'text-warning';
            
            statusElement.innerHTML = `
                <i class="fas fa-circle ${iconClass}"></i>
                <span>${message}</span>
            `;
        }

        // Atualizar status na p√°gina principal
        function updateMainPageStatus(status) {
            console.log('üîÑ Atualizando status na p√°gina principal:', status);
            
            // Atualizar TODOS os elementos com ID whatsappStatus
            const statusElements = document.querySelectorAll('#whatsappStatus');
            statusElements.forEach((statusElement, index) => {
                if (statusElement) {
                    statusElement.textContent = status;
                    statusElement.className = status === 'Conectado' ? 'integration-status connected' : 'integration-status';
                    console.log(`‚úÖ Status atualizado no elemento ${index + 1}`);
                }
            });
            
            // Atualizar na p√°gina principal (se estiver aberta em outra aba)
            try {
                if (window.opener && !window.opener.closed) {
                    const parentStatus = window.opener.document.getElementById('whatsappStatus');
                    if (parentStatus) {
                        parentStatus.textContent = status;
                        parentStatus.className = status === 'Conectado' ? 'integration-status connected' : 'integration-status';
                        console.log('‚úÖ Status atualizado na p√°gina principal');
                    }
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è N√£o foi poss√≠vel atualizar p√°gina principal (normal se modal)');
            }
        }

        // Atualizar especificamente o status na se√ß√£o de integra√ß√µes
        async function updateIntegrationsStatus() {
            try {
                console.log('üîÑ Atualizando status da se√ß√£o de integra√ß√µes...');
                
                if (!whatsappInstanceName) {
                    console.log('‚ÑπÔ∏è Nome da inst√¢ncia WhatsApp n√£o configurado');
                    updateMainPageStatus('N√£o configurado');
                    return;
                }
                
                // A Evolution API √© configurada via proxy no servidor, n√£o precisa verificar aqui
                
                // Verificar status atual do WhatsApp via proxy usando nome EXATO
                const response = await fetch(`/api/evolution/connectionState/${encodeURIComponent(whatsappInstanceName)}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const result = await response.json();
                        const state = result.instance?.state || 'unknown';
                        
                        if (state === 'open') {
                            console.log('‚úÖ WhatsApp conectado - atualizando status na se√ß√£o integra√ß√µes');
                            updateMainPageStatus('Conectado');
                        } else if (state === 'connecting') {
                            console.log('üîÑ WhatsApp conectando - atualizando status na se√ß√£o integra√ß√µes');
                            updateMainPageStatus('Conectando...');
                        } else {
                            console.log('‚ö†Ô∏è WhatsApp desconectado - atualizando status na se√ß√£o integra√ß√µes');
                            updateMainPageStatus('Desconectado');
                        }
                    } else {
                        console.log('‚ö†Ô∏è Resposta n√£o √© JSON v√°lido - definindo status como desconectado');
                        updateMainPageStatus('Desconectado');
                    }
                } else if (response.status === 404) {
                    console.log('‚ÑπÔ∏è Inst√¢ncia n√£o existe - definindo status como n√£o configurado');
                    updateMainPageStatus('N√£o configurado');
                } else if (response.status === 503) {
                    console.log('‚ö†Ô∏è Servi√ßo temporariamente indispon√≠vel (503) - definindo status como desconectado');
                    updateMainPageStatus('Desconectado');
                } else if (response.status === 401) {
                    console.log('üîê N√£o autorizado (401) - verificando sess√£o');
                    updateMainPageStatus('N√£o configurado');
                } else {
                    console.log(`‚ùå Erro na API (${response.status}) - definindo status como desconectado`);
                    updateMainPageStatus('Desconectado');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar status para integra√ß√µes:', error);
                updateMainPageStatus('Desconectado');
            }
        }

        // Carregar configura√ß√µes atuais
        async function loadCurrentSettings(instanceInfo) {
            console.log('üìã Carregando configura√ß√µes salvas para a inst√¢ncia:', instanceInfo?.name);
            
            try {
                // Tentar carregar configura√ß√µes salvas localmente
                const savedConfig = localStorage.getItem('whatsapp_settings_' + whatsappInstanceName);
                let settings = null;
                
                if (savedConfig) {
                    const configData = JSON.parse(savedConfig);
                    settings = configData.settings;
                    console.log('üì± Configura√ß√µes encontradas localmente:', settings);
                } else {
                    console.log('‚ÑπÔ∏è Nenhuma configura√ß√£o salva encontrada, usando padr√µes');
                }
                
                // Se n√£o encontrou configura√ß√µes salvas, usar padr√µes
                if (!settings) {
                    settings = {
                        rejectCalls: true,
                        ignoreGroups: true,
                        alwaysOnline: false,
                        readMessages: false,
                        readStatus: false,
                        syncFullHistory: false
                    };
                    console.log('‚öôÔ∏è Aplicando configura√ß√µes padr√£o:', settings);
                }
                
                // Aplicar configura√ß√µes nos checkboxes com verifica√ß√£o de exist√™ncia
                const elements = {
                    rejectCalls: document.getElementById('rejectCalls'),
                    ignoreGroups: document.getElementById('ignoreGroups'),
                    alwaysOnline: document.getElementById('alwaysOnline'),
                    readMessages: document.getElementById('readMessages'),
                    readStatus: document.getElementById('readStatus'),
                    syncFullHistory: document.getElementById('syncFullHistory')
                };
                
                Object.keys(elements).forEach(key => {
                    if (elements[key]) {
                        elements[key].checked = settings[key] || false;
                    }
                });
                
                console.log('‚úÖ Configura√ß√µes aplicadas na interface');
                settingsManager.showNotification('Configura√ß√µes WhatsApp carregadas!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
                // Aplicar valores padr√£o em caso de erro total
                const defaults = {
                    rejectCalls: true,
                    ignoreGroups: true,
                    alwaysOnline: false,
                    readMessages: false,
                    readStatus: false,
                    syncFullHistory: false
                };
                
                Object.keys(defaults).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) element.checked = defaults[key];
                });
                
                console.log('‚ö†Ô∏è Configura√ß√µes padr√£o aplicadas devido ao erro');
            }
        }

        // Salvar configura√ß√µes WhatsApp
        async function saveWhatsAppSettings() {
            try {
                const settings = {
                    ignoreGroups: document.getElementById('ignoreGroups').checked,
                    alwaysOnline: document.getElementById('alwaysOnline').checked,
                    readMessages: document.getElementById('readMessages').checked,
                    syncFullHistory: document.getElementById('syncFullHistory').checked,
                    readStatus: document.getElementById('readStatus').checked,
                    rejectCalls: document.getElementById('rejectCalls').checked
                };

                // Aplicar configura√ß√µes na inst√¢ncia
                await updateInstanceSettings(settings);
                
                // Salvar configura√ß√µes no banco de dados
                await saveSettingsToDatabase(settings);
                
                settingsManager.showNotification('Configura√ß√µes WhatsApp salvas com sucesso!', 'success');
                closeWhatsAppModal();
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
                settingsManager.showNotification('Erro ao salvar configura√ß√µes WhatsApp', 'error');
            }
        }

        // Atualizar configura√ß√µes da inst√¢ncia
        async function updateInstanceSettings(settings) {
            try {
                console.log('üìã Aplicando configura√ß√µes na inst√¢ncia:', settings);
                console.log('‚ÑπÔ∏è Nota: API Evolution n√£o possui endpoint para atualizar configura√ß√µes p√≥s-conex√£o');
                console.log('üí° Configura√ß√µes ser√£o aplicadas apenas na pr√≥xima cria√ß√£o da inst√¢ncia');
                
                // As configura√ß√µes da Evolution API s√£o aplicadas apenas durante a cria√ß√£o da inst√¢ncia
                // N√£o existe endpoint para atualizar configura√ß√µes de uma inst√¢ncia j√° conectada
                console.log('‚úÖ Configura√ß√µes ser√£o salvas no banco de dados para futura refer√™ncia');
                
            } catch (error) {
                console.error('‚ùå Erro ao processar configura√ß√µes da inst√¢ncia:', error);
            }
        }

        // Salvar configura√ß√µes no banco de dados
        async function saveSettingsToDatabase(settings) {
            try {
                console.log('üíæ Salvando configura√ß√µes WhatsApp localmente...');
                
                // Salvar configura√ß√µes no localStorage como fallback
                const configData = {
                    settings: settings,
                    instanceName: whatsappInstanceName,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('whatsapp_settings_' + whatsappInstanceName, JSON.stringify(configData));
                console.log('‚úÖ Configura√ß√µes salvas localmente com sucesso');
                
                // Tentar salvar no Supabase (opcional)
                try {
                    const supabase = settingsManager.supabase;
                    if (supabase) {
                        const instance = getInstanceData();
                        
                        // Verificar se a tabela existe primeiro
                        const { data, error } = await supabase
                            .from('restaurants') // Usar tabela que sabemos que existe
                            .select('whatsapp_settings')
                            .eq('id', instance.restaurantId)
                            .single();

                        if (!error) {
                            // Atualizar campo whatsapp_settings na tabela restaurants
                            await supabase
                                .from('restaurants')
                                .update({ 
                                    whatsapp_settings: settings,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', instance.restaurantId);
                                
                            console.log('‚úÖ Configura√ß√µes tamb√©m salvas no banco de dados');
                        }
                    }
                } catch (dbError) {
                    console.log('‚ÑπÔ∏è Configura√ß√µes salvas localmente (banco indispon√≠vel)');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
                throw error;
            }
        }

        // Fun√ß√£o duplicada removida - usando apenas a vers√£o correta que usa proxy

        // Gerar QR Code automaticamente para reconex√£o
        async function generateQRCodeForReconnection() {
            try {
                console.log('üîÑ Gerando QR Code automaticamente para reconex√£o...');
                
                // Verificar se o modal est√° aberto antes de tentar gerar QR Code
                const modal = document.getElementById('whatsappModal');
                const qrDisplay = document.getElementById('qrCodeDisplay');
                
                // Se o modal n√£o estiver aberto, n√£o gerar QR Code (para n√£o interferir)
                if (!modal || modal.style.display === 'none') {
                    console.log('‚ÑπÔ∏è Modal n√£o est√° aberto, QR Code ser√° gerado quando necess√°rio');
                    return;
                }
                
                // Se j√° h√° QR Code sendo exibido, n√£o interferir
                if (qrDisplay && qrDisplay.innerHTML.includes('img')) {
                    console.log('‚ÑπÔ∏è QR Code j√° est√° sendo exibido');
                    return;
                }
                
                // CORRE√á√ÉO: For√ßar exibi√ß√£o da tela do QR Code antes de gerar
                console.log('üîÑ For√ßando exibi√ß√£o da tela do QR Code...');
                resetToQRCodeView();
                
                // Aguardar um pouco para garantir que a interface foi atualizada
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Tentar conectar e gerar novo QR Code
                await connectExistingInstance();
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar QR Code autom√°tico:', error);
                console.log('‚ÑπÔ∏è QR Code ser√° gerado quando o usu√°rio abrir as configura√ß√µes WhatsApp');
            }
        }

        // Fun√ß√£o duplicada removida - usando apenas a vers√£o nova que est√° acima
        
        // Abrir modal apropriado baseado no status da inst√¢ncia
        async function openWhatsAppModalBasedOnStatus(status) {
            console.log(`üö™ WHATSAPP - Abrindo modal para status: ${status}`);
            
            switch (status) {
                case 'not_configured':
                case 'not_exists':
                    console.log('üÜï WHATSAPP - Abrindo modal de configura√ß√£o inicial');
                    await openWhatsAppModalForSetup();
                    break;
                    
                case 'disconnected':
                    console.log('üîó WHATSAPP - Abrindo modal de reconex√£o');
                    await openWhatsAppModalForReconnection();
                    break;
                    
                case 'connected':
                    console.log('‚öôÔ∏è WHATSAPP - Abrindo modal de gerenciamento');
                    await openWhatsAppModalForManagement();
                    break;
                    
                case 'connecting':
                    console.log('‚è≥ WHATSAPP - Abrindo modal de status de conex√£o');
                    await openWhatsAppModalForConnecting();
                    break;
                    
                case 'api_error':
                default:
                    console.log('‚ùå WHATSAPP - Abrindo modal com erro da API');
                    await openWhatsAppModalWithError();
                    break;
            }
        }
        
        // Modal para configura√ß√£o inicial (inst√¢ncia n√£o existe)
        async function openWhatsAppModalForSetup() {
            console.log('üÜï WHATSAPP - Configurando modal para setup inicial...');
            
            try {
                // Carregar dados b√°sicos
                await loadWebhookFromDatabase();
                const restaurantName = await getRestaurantNameFromDatabase();
                
                if (!restaurantName) {
                    settingsManager.showNotification('Erro: Nome do restaurante n√£o encontrado. Verifique se est√° logado corretamente.', 'error');
                    return;
                }
                
                whatsappInstanceName = restaurantName;
                
                // Mostrar modal
                document.getElementById('whatsappModal').style.display = 'flex';
                
                // Configurar interface para setup inicial
                document.getElementById('qrCodeDisplay').innerHTML = `
                    <div class="setup-message">
                        <div class="setup-icon">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <h3>Configurar WhatsApp</h3>
                        <p>Vamos conectar sua conta do WhatsApp com o sistema.</p>
                        <p><strong>Nome da inst√¢ncia:</strong> ${whatsappInstanceName}</p>
                        <button class="btn btn-primary" onclick="startWhatsAppSetup()" style="margin-top: 15px;">
                            <i class="fas fa-qrcode"></i> Gerar QR Code
                        </button>
                    </div>
                `;
                
                // Configurar bot√µes do modal
                document.getElementById('connectWhatsAppBtn').style.display = 'none';
                document.getElementById('disconnectWhatsAppBtn').style.display = 'none';
                
                console.log('‚úÖ WHATSAPP - Modal configurado para setup inicial');
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro no setup inicial:', error);
                settingsManager.showNotification('Erro ao configurar WhatsApp: ' + error.message, 'error');
            }
        }
        
        // Modal para reconex√£o (inst√¢ncia existe mas est√° desconectada)
        async function openWhatsAppModalForReconnection() {
            console.log('üîó WHATSAPP - Configurando modal para reconex√£o...');
            
            try {
                // Mostrar modal
                document.getElementById('whatsappModal').style.display = 'flex';
                
                // Configurar interface para reconex√£o
                document.getElementById('qrCodeDisplay').innerHTML = `
                    <div class="reconnection-message">
                        <div class="reconnection-icon">
                            <i class="fas fa-wifi" style="color: #orange;"></i>
                        </div>
                        <h3>WhatsApp Desconectado</h3>
                        <p>Sua inst√¢ncia do WhatsApp foi desconectada.</p>
                        <p>Clique no bot√£o abaixo para reconectar.</p>
                        <button class="btn btn-warning" onclick="reconnectWhatsApp()" style="margin-top: 15px;">
                            <i class="fas fa-qrcode"></i> Reconectar WhatsApp
                        </button>
                    </div>
                `;
                
                // Configurar bot√µes do modal (verificar se existem primeiro)
                const connectBtn = document.getElementById('connectWhatsAppBtn');
                const disconnectBtn = document.getElementById('disconnectWhatsAppBtn');
                
                if (connectBtn) {
                    connectBtn.style.display = 'none';
                }
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'block';
                }
                
                // Carregar configura√ß√µes atuais
                await loadWhatsAppSettings();
                
                console.log('‚úÖ WHATSAPP - Modal configurado para reconex√£o');
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro na reconex√£o:', error);
                settingsManager.showNotification('Erro ao configurar reconex√£o: ' + error.message, 'error');
            }
        }
        
        // Modal para gerenciamento (inst√¢ncia conectada)
        async function openWhatsAppModalForManagement() {
            console.log('‚öôÔ∏è WHATSAPP - Configurando modal para gerenciamento...');
            
            try {
                // Mostrar modal
                document.getElementById('whatsappModal').style.display = 'flex';
                
                // ALTERNAR PARA O STEP DE CONFIGURA√á√ïES
                const connectionStep = document.getElementById('whatsappConnectionStep');
                const settingsStep = document.getElementById('whatsappSettingsStep');
                
                if (connectionStep) {
                    connectionStep.style.display = 'none';
                    connectionStep.classList.remove('active');
                    console.log('‚úÖ Step de conex√£o oculto');
                }
                
                if (settingsStep) {
                    settingsStep.style.display = 'block';
                    settingsStep.classList.add('active');
                    console.log('‚úÖ Step de configura√ß√µes mostrado');
                }
                
                // Carregar configura√ß√µes atuais
                await loadWhatsAppSettings();
                
                // Atualizar status visual
                updateMainPageStatus('Conectado');
                
                console.log('‚úÖ WHATSAPP - Modal configurado para gerenciamento');
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro no gerenciamento:', error);
                settingsManager.showNotification('Erro ao carregar configura√ß√µes: ' + error.message, 'error');
            }
        }
        
        // Modal para status de conex√£o (conectando)
        async function openWhatsAppModalForConnecting() {
            console.log('‚è≥ WHATSAPP - Configurando modal para conex√£o em progresso...');
            
            try {
                // Mostrar modal
                document.getElementById('whatsappModal').style.display = 'flex';
                
                // Configurar interface para status de conex√£o
                document.getElementById('qrCodeDisplay').innerHTML = `
                    <div class="connecting-message">
                        <div class="connecting-icon">
                            <i class="fas fa-spinner fa-spin" style="color: #007bff;"></i>
                        </div>
                        <h3>Conectando...</h3>
                        <p>Sua inst√¢ncia do WhatsApp est√° se conectando.</p>
                        <p>Aguarde alguns instantes...</p>
                        <div class="progress" style="margin-top: 15px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: 100%"></div>
                        </div>
                    </div>
                `;
                
                // Configurar bot√µes do modal (verificar se existem primeiro)
                const connectBtn = document.getElementById('connectWhatsAppBtn');
                const disconnectBtn = document.getElementById('disconnectWhatsAppBtn');
                
                if (connectBtn) {
                    connectBtn.style.display = 'none';
                }
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'block';
                }
                
                // Verificar status periodicamente
                const checkConnectionStatus = setInterval(async () => {
                    const status = await checkWhatsAppInstanceStatus();
                    if (status === 'connected') {
                        clearInterval(checkConnectionStatus);
                        await openWhatsAppModalForManagement();
                    } else if (status === 'disconnected') {
                        clearInterval(checkConnectionStatus);
                        await openWhatsAppModalForReconnection();
                    }
                }, 3000);
                
                console.log('‚úÖ WHATSAPP - Modal configurado para status de conex√£o');
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro no status de conex√£o:', error);
                settingsManager.showNotification('Erro ao verificar status: ' + error.message, 'error');
            }
        }
        
        // Modal com erro da API
        async function openWhatsAppModalWithError() {
            console.log('‚ùå WHATSAPP - Configurando modal com erro da API...');
            
            try {
                // Verificar se os elementos existem antes de tentar us√°-los
                const modal = document.getElementById('whatsappModal');
                const qrDisplay = document.getElementById('qrCodeDisplay');
                const connectBtn = document.getElementById('connectWhatsAppBtn');
                const disconnectBtn = document.getElementById('disconnectWhatsAppBtn');
                
                if (!modal) {
                    console.error('‚ùå WHATSAPP - Modal n√£o encontrado');
                    return;
                }
                
                if (!qrDisplay) {
                    console.error('‚ùå WHATSAPP - Elemento qrCodeDisplay n√£o encontrado');
                    return;
                }
                
                // Mostrar modal
                modal.style.display = 'flex';
                
                // Configurar interface para erro
                qrDisplay.innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        </div>
                        <h3>Erro na API</h3>
                        <p>N√£o foi poss√≠vel conectar com a API Evolution.</p>
                        <p>Verifique sua conex√£o e tente novamente.</p>
                        <button class="btn btn-danger" onclick="location.reload()" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </div>
                `;
                
                // Configurar bot√µes do modal (se existirem)
                if (connectBtn) connectBtn.style.display = 'none';
                if (disconnectBtn) disconnectBtn.style.display = 'none';
                
                console.log('‚úÖ WHATSAPP - Modal configurado para erro da API');
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro ao configurar modal de erro:', error);
                console.error('üîç WHATSAPP - Stack trace do erro:', error.stack);
                
                // Fallback: mostrar notifica√ß√£o se modal falhar
                if (typeof settingsManager !== 'undefined' && settingsManager.showNotification) {
                    settingsManager.showNotification('Erro ao configurar modal WhatsApp. Recarregue a p√°gina.', 'error');
                }
            }
        }
        
        // Criar inst√¢ncia diretamente na Evolution API usando curl especificado
        async function createWhatsAppInstanceDirectly() {
            console.log('üÜï WHATSAPP - Criando inst√¢ncia diretamente na Evolution API...');
            
            try {
                // Mostrar modal com progress
                document.getElementById('whatsappModal').style.display = 'flex';
                document.getElementById('qrCodeDisplay').innerHTML = `
                    <div class="setup-progress">
                        <div class="spinner"></div>
                        <h3>Configurando WhatsApp</h3>
                        <p>Criando inst√¢ncia <strong>${whatsappInstanceName}</strong> na Evolution API...</p>
                    </div>
                `;
                
                // Dados exatos conforme especificado pelo usu√°rio
                const instanceData = {
                    instanceName: whatsappInstanceName,
                    qrcode: true,
                    integration: "WHATSAPP-BAILEYS",
                    webhook: {
                        url: "https://n8n.timepulseai.com.br/webhook/7398cf3b-43ae-4d12-9f0b-443e3b66dfd1",
                        byEvents: false,
                        base64: false,
                        headers: {
                            "Content-Type": "application/json"
                        },
                        events: [
                            "APPLICATION_STARTUP",
                            "MESSAGES_UPDATE",
                            "MESSAGES_UPSERT",
                            "PRESENCE_UPDATE",
                            "QRCODE_UPDATED"
                        ]
                    }
                };
                
                console.log('üì§ WHATSAPP - Enviando dados para cria√ß√£o:', instanceData);
                
                // Fazer requisi√ß√£o POST para criar inst√¢ncia
                const response = await fetch(`/api/evolution/instance/create`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(instanceData)
                });
                
                console.log(`üì• WHATSAPP - Resposta da cria√ß√£o: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ WHATSAPP - Inst√¢ncia criada com sucesso:', result);
                    
                    // Atualizar UI
                    document.getElementById('qrCodeDisplay').innerHTML = `
                        <div class="setup-progress">
                            <div class="spinner"></div>
                            <h3>WhatsApp Configurado</h3>
                            <p>Gerando QR Code para conex√£o...</p>
                        </div>
                    `;
                    
                    // Aguardar um momento antes de conectar
                    setTimeout(async () => {
                        await connectExistingInstance();
                    }, 2000);
                    
                } else if (response.status === 403 || response.status === 409) {
                    // Inst√¢ncia j√° existe, tentar conectar
                    console.log('‚ÑπÔ∏è WHATSAPP - Inst√¢ncia j√° existe, conectando...');
                    document.getElementById('qrCodeDisplay').innerHTML = `
                        <div class="setup-progress">
                            <div class="spinner"></div>
                            <h3>WhatsApp Detectado</h3>
                            <p>Inst√¢ncia j√° existe, gerando QR Code...</p>
                        </div>
                    `;
                    
                    setTimeout(async () => {
                        await connectExistingInstance();
                    }, 1000);
                    
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå WHATSAPP - Erro na cria√ß√£o:', errorText);
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro ao criar inst√¢ncia:', error);
                document.getElementById('qrCodeDisplay').innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        </div>
                        <h3>Erro ao Criar Inst√¢ncia</h3>
                        <p>N√£o foi poss√≠vel criar a inst√¢ncia <strong>${whatsappInstanceName}</strong> na Evolution API.</p>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <button class="btn btn-primary" onclick="createWhatsAppInstanceDirectly()" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        // Iniciar setup do WhatsApp (criar inst√¢ncia e gerar QR Code)
        async function startWhatsAppSetup() {
            console.log('üÜï WHATSAPP - Iniciando setup do WhatsApp...');
            await createAndConnectWhatsAppInstance();
        }
        
        // Reconectar WhatsApp existente
        async function reconnectWhatsApp() {
            console.log('üîó WHATSAPP - Reconectando WhatsApp...');
            
            try {
                document.getElementById('qrCodeDisplay').innerHTML = `
                    <div class="reconnect-progress">
                        <div class="spinner"></div>
                        <p>Gerando novo QR Code...</p>
                    </div>
                `;
                
                // Conectar inst√¢ncia existente
                await connectExistingInstance();
                
            } catch (error) {
                console.error('‚ùå WHATSAPP - Erro na reconex√£o:', error);
                settingsManager.showNotification('Erro ao reconectar: ' + error.message, 'error');
            }
        }

        // Desconectar WhatsApp
        async function disconnectWhatsApp() {
            if (!confirm('Tem certeza que deseja desconectar o WhatsApp? Voc√™ precisar√° escanear o QR Code novamente.')) {
                return;
            }
            
            try {
                updateConnectionStatus('Desconectando WhatsApp...', 'warning');
                
                const response = await fetch(`/api/evolution/instance/logout/${whatsappInstanceName}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    console.log('WhatsApp desconectado com sucesso');
                    
                    // Parar polling do QR code se estiver rodando
                    if (qrCodePolling) {
                        clearInterval(qrCodePolling);
                        qrCodePolling = null;
                    }
                    
                    // Resetar para tela inicial do QR Code
                    resetToQRCodeView();
                    
                    // Atualizar status
                    updateMainPageStatus('Desconectado');
                    
                    // N√£o fechar modal - manter aberto para reconex√£o
                    // document.getElementById('whatsappModal').style.display = 'none';
                    
                    settingsManager.showNotification('WhatsApp desconectado com sucesso', 'success');
                } else {
                    throw new Error('Erro ao desconectar');
                }
            } catch (error) {
                console.error('Erro ao desconectar WhatsApp:', error);
                updateConnectionStatus('Erro ao desconectar WhatsApp', 'danger');
                settingsManager.showNotification('Erro ao desconectar WhatsApp', 'error');
            }
        }

        // Resetar interface para tela inicial do QR Code
        function resetToQRCodeView() {
            console.log('üîÑ Resetando para tela do QR Code...');
            
            // For√ßar a exibi√ß√£o da tela de conex√£o (QR Code)
            const connectionStep = document.getElementById('whatsappConnectionStep');
            const settingsStep = document.getElementById('whatsappSettingsStep');
            
            if (connectionStep) {
                connectionStep.style.display = 'block';
                connectionStep.classList.add('active');
                console.log('‚úÖ Tela de conex√£o exibida');
            }
            
            if (settingsStep) {
                settingsStep.style.display = 'none';
                settingsStep.classList.remove('active');
                console.log('‚úÖ Tela de configura√ß√µes oculta');
            }
            
            // Resetar conte√∫do do QR Code para estado inicial
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (qrDisplay) {
                qrDisplay.innerHTML = `
                    <div class="qr-container">
                        <div class="qr-code-display">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Aguardando nova conex√£o...</p>
                            </div>
                        </div>
                        <div class="qr-instructions">
                            <h6><i class="fas fa-mobile-alt"></i> Como conectar:</h6>
                            <ol>
                                <li>Abra o WhatsApp no seu celular</li>
                                <li>Toque em <strong>Menu</strong> ou <strong>Configura√ß√µes</strong></li>
                                <li>Toque em <strong>Aparelhos conectados</strong></li>
                                <li>Toque em <strong>Conectar um aparelho</strong></li>
                                <li>Aponte o celular para esta tela para capturar o c√≥digo</li>
                            </ol>
                        </div>
                    </div>
                `;
                console.log('‚úÖ Conte√∫do do QR Code resetado');
            }
            
            // Resetar status de conex√£o
            updateConnectionStatus('WhatsApp desconectado. Clique em "Conectar WhatsApp" para reconectar.', 'info');
            
            // Ocultar informa√ß√µes do perfil
            const connectionInfo = document.getElementById('connectionInfo');
            if (connectionInfo) {
                connectionInfo.style.display = 'none';
                console.log('‚úÖ Informa√ß√µes do perfil ocultadas');
            }
            
            // For√ßar atualiza√ß√£o visual da interface
            setTimeout(() => {
                if (connectionStep) connectionStep.style.display = 'block';
                if (settingsStep) settingsStep.style.display = 'none';
                console.log('üîÑ For√ßando atualiza√ß√£o visual final');
            }, 100);
            
            console.log('‚úÖ Interface resetada para QR Code');
        }
    </script>
    
    <style>
        /* ===== VARI√ÅVEIS CSS ===== */
        :root {
            --primary-color: #28a745;
            --primary-color-dark: #1e7e34;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --text-secondary: #6c757d;
            --text-muted: #9ca3af;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Font sizes */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            
            /* Border radius */
            --border-radius: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Transitions */
            --transition: all 0.3s ease;
        }

        /* ===== RESET E BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            flex-shrink: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .restaurant-name {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
            flex: 1;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            color: #6c757d;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #495057;
            text-decoration: none;
            transition: none;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--primary-color);
        }
        
        .nav-link.active .nav-icon {
            color: var(--primary-color);
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            color: #6c757d;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-email {
            font-size: 0.8rem;
            color: #6c757d;
        }


        /* ===== CONTE√öDO PRINCIPAL ===== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 0;
            transition: none;
        }

        .main-header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-menu .user-avatar {
            cursor: pointer;
        }

        /* ===== √ÅREA DE CONTE√öDO ===== */
        .content-area {
            padding: 2rem;
        }

        /* ===== NAVEGA√á√ÉO DAS CONFIGURA√á√ïES ===== */
        .settings-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .settings-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .settings-tab:hover {
            background: #f8f9fa;
        }
        
        .settings-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* ===== CONTE√öDO DAS CONFIGURA√á√ïES ===== */
        .settings-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .settings-section {
            display: none;
        }
        
        .settings-section.active {
            display: block;
        }
        
        .section-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section-header h2 {
            margin: 0 0 0.5rem 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
        }
        
        .section-header p {
            margin: 0;
            color: #6c757d;
        }
        
        .settings-form {
            max-width: 800px;
        }
        
        /* ===== FORMUL√ÅRIOS ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .form-input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section h3 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.2rem;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        
        
        /* ===== HOR√ÅRIOS ===== */
        .schedule-grid {
            display: grid;
            gap: 1rem;
        }
        
        .schedule-day {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .day-label {
            font-weight: 600;
            color: #333;
        }
        
        .schedule-inputs {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        /* ===== M√âTODOS DE PAGAMENTO ===== */
        .payment-methods {
            display: grid;
            gap: 1.5rem;
        }
        
        .payment-method {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .method-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .method-header i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .method-options {
            margin-left: 2rem;
            display: grid;
            gap: 0.5rem;
        }
        
        
        /* ===== INTEGRA√á√ïES ===== */
        .integrations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .integration-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .integration-header {
            margin-bottom: 1rem;
        }
        
        .integration-header i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .integration-header h3 {
            margin: 0.5rem 0;
            color: #333;
        }
        
        .integration-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #f8d7da;
            color: #721c24;
        }
        
        .integration-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        /* ===== SEGURAN√áA ===== */
        .security-options {
            display: grid;
            gap: 1.5rem;
        }
        
        .security-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .security-card.danger {
            border-color: #dc3545;
            background: #f8f9fa;
        }
        
        .security-card h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .security-card p {
            margin: 0;
            color: #6c757d;
        }
        
        /* ===== BOT√ïES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-color-dark);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        /* ===== NOTIFICA√á√ïES ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 10000;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid #28a745;
        }
        
        .notification.error {
            border-left: 4px solid #dc3545;
        }
        
        .notification.info {
            border-left: 4px solid #17a2b8;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .notification-content i {
            font-size: 1.25rem;
        }
        
        .notification.success .notification-content i {
            color: #28a745;
        }
        
        .notification.error .notification-content i {
            color: #dc3545;
        }
        
        .notification.info .notification-content i {
            color: #17a2b8;
        }
        
        .text-muted {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .readonly-notice {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            color: #6c757d;
            font-style: italic;
            margin-top: 1rem;
        }

        .readonly-notice i {
            color: #17a2b8;
            font-size: 1.1rem;
        }
        
        /* ===== MODAL ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            width: 100%;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background-color: #f8f9fa;
            color: var(--dark-color);
        }
        
        .modal-form {
            padding: 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* ===== PAGAMENTOS CUSTOMIZADOS ===== */
        .custom-payment-methods {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }
        
        .section-header-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .section-header-inline h3 {
            margin: 0;
            color: #333;
            font-size: 1.1rem;
        }
        
        .custom-methods-list {
            display: grid;
            gap: 1rem;
        }
        
        .custom-method-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .custom-method-item:hover {
            background: #e9ecef;
        }
        
        .custom-method-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .custom-method-info .method-icon {
            font-size: 1.25rem;
            color: var(--primary-color);
            width: 30px;
            text-align: center;
        }
        
        .custom-method-info .method-details h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            color: #333;
        }
        
        .custom-method-info .method-details p {
            margin: 0;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .custom-method-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .method-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .method-status.enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .method-status.disabled {
            background: #f8d7da;
            color: #721c24;
        }

        /* ===== MODAL WHATSAPP ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-title .text-success {
            color: #25D366 !important;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .modal-close:hover {
            background-color: #f8f9fa;
            color: var(--dark-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        /* ===== QR CODE E CONEX√ÉO ===== */
        .qr-container {
            text-align: center;
        }

        .qr-code-display {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            text-align: center;
        }

        .loading-spinner i {
            font-size: 2rem;
            color: #25D366;
            margin-bottom: 1rem;
        }

        .loading-spinner p {
            color: #6c757d;
            margin: 0;
        }

        .qr-instructions {
            text-align: left;
            background: #e8f5e8;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #25D366;
        }

        .qr-instructions h6 {
            color: #155724;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qr-instructions ol {
            margin: 0;
            padding-left: 1.5rem;
        }

        .qr-instructions li {
            margin-bottom: 0.5rem;
            color: #155724;
        }

        .qr-refresh-info {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* ===== STATUS DE CONEX√ÉO ===== */
        .connection-status {
            padding: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .status-indicator i {
            font-size: 0.75rem;
        }

        .status-indicator span {
            font-weight: 500;
            color: #333;
        }

        .connection-info {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #c3e6cb;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-picture {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #25D366;
        }

        .profile-details h6 {
            margin: 0 0 0.25rem 0;
            color: #155724;
            font-weight: 600;
        }

        .profile-details p {
            margin: 0 0 0.25rem 0;
            color: #155724;
            font-size: 0.875rem;
        }

        /* ===== C√ìDIGO DE PAREAMENTO ===== */
        .pairing-code-display {
            text-align: center;
        }

        .pairing-code-display h3 {
            color: #25D366;
            margin-bottom: 1rem;
        }

        .pairing-code {
            font-size: 2rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #25D366;
            background: #e8f5e8;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            letter-spacing: 0.25rem;
        }

        /* ===== CONFIGURA√á√ïES WHATSAPP ===== */
        .whatsapp-step {
            animation: fadeIn 0.3s ease;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .setting-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .setting-item:hover {
            background: #e9ecef;
            border-color: #25D366;
        }

        .form-check {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
        }

        .form-check-input {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            accent-color: #25D366;
        }

        .form-check-label {
            flex: 1;
        }

        .form-check-label strong {
            display: block;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .form-check-label small {
            color: #6c757d;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* ===== STATUS NA P√ÅGINA PRINCIPAL ===== */
        .integration-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* ===== TOGGLE SWITCHES ===== */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 24px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .setting-item {
            transition: transform 0.2s;
        }

        .setting-item:hover {
            transform: translateX(2px);
        }

        /* ===== RESPONSIVO ===== */
        @media (max-width: 768px) {
            .modal-container {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }

            .modal-body {
                padding: 1rem;
            }

            .qr-code-display {
                padding: 1rem;
                min-height: 250px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .profile-info {
                flex-direction: column;
                text-align: center;
            }

            .modal-footer {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-footer .btn {
                width: 100%;
            }
        }

        /* ===== ANIMA√á√ïES ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .content-area {
                padding: 1rem;
            }
            
            .settings-nav {
                flex-wrap: wrap;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .schedule-day {
                grid-template-columns: 1fr;
            }
            
            .schedule-inputs {
                flex-direction: column;
                align-items: stretch;
            }
            
            .security-card {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* ===== MODAL ASAAS ===== */
        .asaas-info {
            margin-bottom: 2rem;
        }

        .info-card {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
        }

        .info-card i {
            font-size: 1.5rem;
            margin-top: 0.25rem;
        }

        .info-card h6 {
            margin: 0 0 0.5rem 0;
            color: #1976d2;
            font-weight: 600;
        }

        .info-card p {
            margin: 0;
            color: #555;
            line-height: 1.5;
        }

        .asaas-form .form-group {
            margin-bottom: 1.5rem;
        }

        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container .form-input {
            padding-right: 3rem;
            flex: 1;
        }

        .password-toggle-btn {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s ease;
        }

        .password-toggle-btn:hover {
            color: var(--primary-color);
        }

        .form-help {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .form-help i {
            color: var(--primary-color);
        }

        .asaas-status {
            margin-top: 1rem;
            padding: 1rem;
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
        }

        .asaas-status .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .asaas-status .status-indicator i {
            font-size: 0.8rem;
        }

        /* Menu Hamburger para Mobile */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10000;
            align-items: center;
            padding: 0;
            justify-content: flex-start;
        }

        .hamburger-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 60px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .mobile-logo {
            height: 40px;
            width: auto;
            margin: 0 auto;
            display: block;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .sidebar-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsivo para Mobile */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }

            .sidebar {
                transform: translateX(-100%);
                z-index: 9999;
                width: 280px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
                margin-top: 60px;
            }

            .page-header {
                padding: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .sidebar-header img {
                height: 120px;
                max-width: 150px;
            }
        }

        @media (max-width: 380px) {
            .main-content {
                padding: 0.75rem;
            }
        }
    </style>
    
    <script>
        // ===== MODAL ASAAS =====
        
        // Abrir modal de configura√ß√£o Asaas
        async function openAsaasModal() {
            try {
                // Verificar se o usu√°rio est√° logado
                const currentInstance = getInstanceData();
                if (!currentInstance || (!currentInstance.restaurantId && !currentInstance.instanceId)) {
                    settingsManager.showNotification('Erro: Fa√ßa login primeiro para configurar o Asaas', 'error');
                    return;
                }
                
                // Mostrar modal
                document.getElementById('asaasModal').style.display = 'flex';
                
                // Carregar configura√ß√µes existentes
                await loadAsaasSettings();
                
            } catch (error) {
                console.error('Erro ao abrir modal Asaas:', error);
                settingsManager.showNotification('Erro ao carregar configura√ß√µes Asaas', 'error');
            }
        }

        // Fechar modal de configura√ß√£o Asaas
        function closeAsaasModal() {
            document.getElementById('asaasModal').style.display = 'none';
            
            // Limpar campos
            document.getElementById('asaasApiKey').value = '';
            document.getElementById('asaasConnectionStatus').style.display = 'none';
            
            // Resetar visibilidade
            const input = document.getElementById('asaasApiKey');
            const icon = document.getElementById('asaasToggleIcon');
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }

        // Alternar visibilidade da API Key
        function toggleAsaasApiKeyVisibility() {
            const input = document.getElementById('asaasApiKey');
            const icon = document.getElementById('asaasToggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Carregar configura√ß√µes Asaas do banco de dados
        async function loadAsaasSettings() {
            try {
                const currentInstance = getInstanceData();
                if (!currentInstance || (!currentInstance.restaurantId && !currentInstance.instanceId)) {
                    return;
                }
                
                console.log('Carregando configura√ß√µes Asaas...');
                
                // Buscar dados da tabela restaurants coluna api_assas
                const { data, error } = await settingsManager.supabase
                    .from('restaurants')
                    .select('api_assas')
                    .eq('id', currentInstance.restaurantId)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (data && data.api_assas) {
                    // Preencher campo com a API Key existente
                    document.getElementById('asaasApiKey').value = data.api_assas;
                    
                    // Mostrar status de conex√£o
                    document.getElementById('asaasConnectionStatus').style.display = 'block';
                    
                    // Atualizar status na p√°gina de integra√ß√µes
                    updateAsaasIntegrationStatus('Conectado', 'success');
                    
                    console.log('‚úÖ Configura√ß√µes Asaas carregadas');
                } else {
                    console.log('Nenhuma configura√ß√£o Asaas encontrada');
                    updateAsaasIntegrationStatus('Desconectado', 'warning');
                }
                
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes Asaas:', error);
                settingsManager.showNotification('Erro ao carregar configura√ß√µes Asaas', 'error');
            }
        }

        // Salvar configura√ß√µes Asaas
        async function saveAsaasSettings() {
            try {
                const currentInstance = getInstanceData();
                if (!currentInstance || (!currentInstance.restaurantId && !currentInstance.instanceId)) {
                    settingsManager.showNotification('Erro: Usu√°rio n√£o est√° logado', 'error');
                    return;
                }
                
                const apiKey = document.getElementById('asaasApiKey').value.trim();
                
                if (!apiKey) {
                    settingsManager.showNotification('Por favor, insira a API Key do Asaas', 'error');
                    return;
                }
                
                console.log('Salvando configura√ß√µes Asaas...');
                settingsManager.showNotification('Salvando configura√ß√µes Asaas...', 'info');
                
                // Atualizar na tabela restaurants coluna api_assas
                const { error } = await settingsManager.supabase
                    .from('restaurants')
                    .update({ 
                        api_assas: apiKey,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentInstance.restaurantId);
                
                if (error) throw error;
                
                console.log('‚úÖ Configura√ß√µes Asaas salvas com sucesso');
                settingsManager.showNotification('Configura√ß√µes Asaas salvas com sucesso!', 'success');
                
                // Mostrar status de conex√£o no modal
                document.getElementById('asaasConnectionStatus').style.display = 'block';
                
                // Atualizar status na p√°gina de integra√ß√µes
                updateAsaasIntegrationStatus('Conectado', 'success');
                
                // Fechar modal ap√≥s 2 segundos
                setTimeout(() => {
                    closeAsaasModal();
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes Asaas:', error);
                settingsManager.showNotification('Erro ao salvar configura√ß√µes Asaas', 'error');
            }
        }


        // Atualizar status da integra√ß√£o Asaas na p√°gina principal
        function updateAsaasIntegrationStatus(status, type) {
            const statusElement = document.getElementById('asaasStatus');
            if (statusElement) {
                statusElement.textContent = status;
                // USAR A MESMA L√ìGICA DO WHATSAPP: integration-status connected
                statusElement.className = status === 'Conectado' ? 'integration-status connected' : 'integration-status';
            }
        }

        // ===== FUN√á√ïES DOS NOVOS MODAIS EVOLUTION =====
        
        // Vari√°veis globais para QR Code
        let qrCodePollingInterval = null;
        let currentQRCodeData = null;

        // Fechar modal de inst√¢ncia n√£o encontrada
        function closeInstanceNotFoundModal() {
            document.getElementById('instanceNotFoundModal').style.display = 'none';
        }

        // Fechar modal de sucesso
        function closeInstanceSuccessModal() {
            document.getElementById('instanceSuccessModal').style.display = 'none';
        }

        // Fechar modal de QR Code
        function closeQRCodeModal() {
            document.getElementById('qrcodeModal').style.display = 'none';
            
            // Parar polling
            if (qrCodePollingInterval) {
                clearInterval(qrCodePollingInterval);
                qrCodePollingInterval = null;
            }
        }

        // Criar inst√¢ncia a partir do modal
        async function createInstanceFromModal() {
            try {
                // Fechar modal de "n√£o encontrada"
                closeInstanceNotFoundModal();
                
                // Mostrar loading
                settingsManager.showNotification('Criando inst√¢ncia WhatsApp...', 'info');
                
                // Obter dados da inst√¢ncia
                const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
                const instanceName = (instance.instanceName || 'restaurante').toLowerCase().replace(/[^a-z0-9_]/g, '_');
                
                // Preparar dados para criar inst√¢ncia (formato correto da Evolution API)
                const requestBody = {
                    instanceName: instanceName,
                    integration: 'WHATSAPP-BAILEYS',
                    qrcode: true,
                    webhook: {
                        url: 'https://n8n.timepulseai.com.br/webhook/7398cf3b-43ae-4d12-9f0b-443e3b66dfd1',
                        byEvents: true,
                        events: [
                            'APPLICATION_STARTUP',
                            'MESSAGES_UPDATE',
                            'MESSAGES_UPSERT',
                            'PRESENCE_UPDATE',
                            'QRCODE_UPDATED'
                        ]
                    }
                };
                
                console.log('üì§ Criando inst√¢ncia:', requestBody);
                
                // Fazer requisi√ß√£o via backend
                const response = await fetch('/api/evolution/create-instance', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Inst√¢ncia criada com sucesso:', result);
                    
                    // Salvar dados do QR Code
                    currentQRCodeData = result.qrcode || result;
                    
                    // Mostrar modal de sucesso
                    document.getElementById('instanceSuccessModal').style.display = 'flex';
                    
                } else {
                    throw new Error(result.error || 'Erro ao criar inst√¢ncia');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao criar inst√¢ncia:', error);
                settingsManager.showNotification('Erro ao criar inst√¢ncia: ' + error.message, 'error');
            }
        }

        // Mostrar modal de QR Code
        async function showQRCodeModal() {
            try {
                // Fechar modal de sucesso
                closeInstanceSuccessModal();
                
                // Abrir modal de QR Code
                document.getElementById('qrcodeModal').style.display = 'flex';
                
                // Resetar estado
                document.getElementById('qrcodeLoader').style.display = 'block';
                document.getElementById('qrcodeImage').style.display = 'none';
                
                // Se j√° temos o QR Code, mostrar imediatamente
                if (currentQRCodeData && currentQRCodeData.base64) {
                    displayQRCode(currentQRCodeData.base64);
                } else {
                    // Buscar QR Code da API
                    await fetchQRCode();
                }
                
                // Iniciar polling de status
                startConnectionPolling();
                
            } catch (error) {
                console.error('‚ùå Erro ao mostrar QR Code:', error);
                settingsManager.showNotification('Erro ao carregar QR Code', 'error');
            }
        }

        // Buscar QR Code da API
        async function fetchQRCode() {
            try {
                const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
                const instanceName = instance.instanceName || 'restaurante';
                
                const response = await fetch(`/api/evolution/instance/connect/${instanceName}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok && result.base64) {
                    displayQRCode(result.base64);
                } else {
                    throw new Error('QR Code n√£o encontrado na resposta');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar QR Code:', error);
                document.getElementById('qrcodeLoader').innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #dc3545; font-size: 48px;"></i><p style="margin-top: 15px; color: #dc3545;">Erro ao carregar QR Code</p>';
            }
        }

        // Exibir QR Code
        function displayQRCode(base64Data) {
            const qrcodeImage = document.getElementById('qrcodeImage');
            qrcodeImage.src = base64Data;
            qrcodeImage.style.display = 'block';
            document.getElementById('qrcodeLoader').style.display = 'none';
        }

        // Iniciar polling de status de conex√£o
        function startConnectionPolling() {
            // Limpar polling anterior se existir
            if (qrCodePollingInterval) {
                clearInterval(qrCodePollingInterval);
            }
            
            // Verificar a cada 3 segundos
            qrCodePollingInterval = setInterval(async () => {
                try {
                    const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
                    const instanceName = (instance.instanceName || 'restaurante').toLowerCase().replace(/[^a-z0-9_]/g, '_');
                    
                    const response = await fetch(`/api/evolution/connectionState/${instanceName}`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const state = result.instance?.state || 'unknown';
                        
                        if (state === 'open') {
                            // Conectado com sucesso!
                            clearInterval(qrCodePollingInterval);
                            qrCodePollingInterval = null;
                            
                            // Atualizar UI
                            document.getElementById('connectionStatus').innerHTML = `
                                <div class="alert alert-success" style="padding: 10px;">
                                    <i class="fas fa-check-circle"></i> WhatsApp conectado com sucesso!
                                </div>
                            `;
                            
                            // Fechar modal ap√≥s 2 segundos
                            setTimeout(() => {
                                closeQRCodeModal();
                                settingsManager.showNotification('WhatsApp conectado com sucesso!', 'success');
                                updateWhatsAppStatus('Conectado', 'success');
                            }, 2000);
                        }
                    }
                    
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }, 3000);
        }

        // Controle do status do WhatsApp baseado no teste
        async function updateWhatsAppStatus() {
            try {
                const instanceData = window.getInstanceData ? window.getInstanceData() : null;
                if (!instanceData?.restaurantId) return;

                const response = await fetch(`/api/trial-status/${instanceData.restaurantId}`);
                
                if (!response.ok) {
                    console.log(`‚ö†Ô∏è Erro na API de trial status (${response.status})`);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.log('‚ö†Ô∏è Resposta da API de trial status n√£o √© JSON v√°lido');
                    return;
                }

                const trialData = await response.json();

                const configureBtn = document.getElementById('configure-whatsapp');
                const trialWarning = document.getElementById('whatsapp-trial-warning');
                const statusBadge = document.querySelector('#whatsapp-status .status-badge');

                if (trialData.subscription_status === 'active' || trialData.subscription_status === 'trial') {
                    // Assinatura ativa ou teste - desbloquear funcionalidade
                    configureBtn.disabled = false;
                    configureBtn.innerHTML = '<i class="fas fa-cog"></i> Configurar';
                    trialWarning.style.display = 'none';
                    
                    // Verificar estado de conex√£o do WhatsApp para atualizar badge corretamente
                    try {
                        const exactName = instanceData.instanceName || 'restaurante';
                        const whatsappResponse = await fetch(`/api/evolution/connectionState/${exactName}`, {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                        if (whatsappResponse.ok) {
                            const whatsappData = await whatsappResponse.json();
                            const state = whatsappData.instance?.state || 'unknown';
                            
                            if (state === 'open') {
                                statusBadge.textContent = 'Conectado';
                                statusBadge.className = 'status-badge status-success';
                            } else {
                                statusBadge.textContent = 'Desconectado';
                                statusBadge.className = 'status-badge status-warning';
                            }
                        } else {
                            statusBadge.textContent = 'N√£o configurado';
                            statusBadge.className = 'status-badge status-warning';
                        }
                    } catch (err) {
                        console.error('Erro ao verificar conex√£o WhatsApp:', err);
                        statusBadge.textContent = 'Desconectado';
                        statusBadge.className = 'status-badge status-warning';
                    }
                } else {
                    // Teste expirado ou status n√£o permitido - bloquear funcionalidade
                    configureBtn.disabled = true;
                    configureBtn.innerHTML = '<i class="fas fa-lock"></i> Bloqueado';
                    trialWarning.style.display = 'block';
                    statusBadge.textContent = 'Bloqueado';
                    statusBadge.className = 'status-badge status-blocked';
                }
            } catch (error) {
                console.error('Erro ao atualizar status do WhatsApp:', error);
            }
        }

        // Inicializar controle de status na carga da p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            updateWhatsAppStatus();
        });

        // Fun√ß√£o para controlar o menu mobile
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // Fechar menu ao clicar em um link (em mobile)
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        toggleMobileMenu();
                    }
                });
            });
        });

        
    </script>
</body>
</html>