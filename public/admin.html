<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - TimePulse AI</title>
    
    <!-- Sistema de ocultação de logs para produção -->
    <script>
        // Habilitar logs temporariamente para debug
        if (typeof console !== 'undefined' && !window.location.search.includes('debug=1')) {
            // Logs suprimidos apenas quando não estamos em modo debug
            // Para debug, adicione ?debug=1 na URL
        }
    </script>
    
    <meta name="description" content="Painel administrativo TimePulse AI">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self' https: wss: *.supabase.co; font-src 'self' https:; object-src 'none'; media-src 'self'; frame-src 'self';">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/secure-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        .admin-sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .admin-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid #34495e;
            text-align: center;
        }

        .admin-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #ecf0f1;
        }

        .admin-subtitle {
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        .admin-nav {
            padding: 1rem 0;
        }

        .admin-nav-item {
            display: block;
            padding: 1rem 1.5rem;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .admin-nav-item:hover,
        .admin-nav-item.active {
            background: #34495e;
            color: #3498db;
            border-left-color: #3498db;
        }

        .admin-nav-item i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .admin-content {
            flex: 1;
            margin-left: 300px;
            padding: 2rem;
            background: #f5f5f5;
        }

        .content-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .admin-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .admin-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .admin-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-card.revenue {
            border-left-color: #27ae60;
        }

        .stat-card.trials {
            border-left-color: #f39c12;
        }

        .stat-card.subscriptions {
            border-left-color: #e74c3c;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.revenue {
            background: #27ae60;
        }

        .stat-icon.trials {
            background: #f39c12;
        }

        .stat-icon.subscriptions {
            background: #e74c3c;
        }

        .stat-icon.restaurants {
            background: #3498db;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
            font-weight: 500;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .trend-up {
            color: #27ae60;
        }

        .trend-down {
            color: #e74c3c;
        }

        .data-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem 2rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-trial {
            background: #fff3cd;
            color: #856404;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelled {
            background: #e2e3e5;
            color: #6c757d;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }

        .filters-section {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .filter-input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            text-align: center;
        }

        .logout-btn {
            position: absolute;
            bottom: 2rem;
            left: 1.5rem;
            right: 1.5rem;
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #7f8c8d;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1rem 2rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-input:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .info-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .info-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .trial-config {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #f39c12;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .subscription-config {
            background: linear-gradient(135deg, #d4edda 0%, #a8e6cf 100%);
            border: 1px solid #27ae60;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .config-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .config-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .config-icon.trial {
            background: #f39c12;
        }

        .config-icon.subscription {
            background: #27ae60;
        }

        .config-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .date-input-group {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .quick-days {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .quick-day-btn {
            padding: 0.25rem 0.75rem;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-day-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .status-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .status-option {
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .status-option:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .status-option.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .status-option .status-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .status-option .status-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .status-option .status-desc {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .config-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .config-header {
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-header h4 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .config-actions {
            display: flex;
            gap: 0.5rem;
        }

        .config-content {
            padding: 1.5rem;
        }

        .api-provider-info .provider-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .api-provider-info .provider-card.active {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .provider-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .provider-details strong {
            display: block;
            color: #2c3e50;
        }

        .provider-details small {
            color: #6c757d;
        }

        .param-value {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .status-card .status-icon {
            width: 40px;
            height: 40px;
        }

        /* Business Type Cards Styles */
        .configured-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .business-type-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            border-left: 4px solid #3498db;
        }

        .business-type-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .business-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .business-type-header h6 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .business-type-header .badge {
            background: #27ae60;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .business-type-preview {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .business-type-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .status-card .status-icon {
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .status-info {
            flex: 1;
        }

        .status-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .status-value.success {
            color: #28a745;
        }

        .status-value.error {
            color: #dc3545;
        }

        .status-value.warning {
            color: #ffc107;
        }

        .test-section {
            border-top: 1px solid #e9ecef;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .test-section h5 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .test-input-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .test-input-group input {
            flex: 1;
        }

        .test-response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .response-time {
            font-size: 0.85rem;
            color: #6c757d;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .response-content {
            color: #2c3e50;
            line-height: 1.5;
        }

        .prompt-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            border: 1px solid #e9ecef;
            border-bottom: none;
        }

        .prompt-tab {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            color: #6c757d;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .prompt-tab:hover {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .prompt-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
        }

        .prompt-content {
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: white;
        }

        .prompt-tab-content {
            padding: 1.5rem;
            display: none;
        }

        .prompt-tab-content.active {
            display: block;
        }

        .prompt-textarea {
            width: 100%;
            height: 300px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            background: #f8f9fa;
            resize: vertical;
        }

        .conversation-examples {
            space-y: 1.5rem;
        }

        .example-conversation {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .example-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .example-messages {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.customer {
            background: #e3f2fd;
            color: #1976d2;
            align-self: flex-end;
            text-align: right;
        }

        /* Evolution Messages Styles */
        .evolution-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .loading-messages {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .evolution-message {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .evolution-message:last-child {
            border-bottom: none;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .message-sender {
            font-weight: 600;
            color: #2c3e50;
        }

        .message-timestamp {
            font-size: 0.7rem;
        }

        .message-body {
            color: #2c3e50;
            line-height: 1.4;
        }

        .message-instance {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .no-messages {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .context-info {
            padding: 0;
        }

        .context-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .context-section h6 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .context-section ul {
            margin-left: 1.5rem;
        }

        .context-section li {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        /* Business Types Prompt Styles */
        .business-types-section {
            padding: 0;
        }
        
        .business-types-header {
            margin-bottom: 1.5rem;
        }
        
        .business-types-header h5 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .business-types-header p {
            color: #6c757d;
            margin: 0;
        }
        
        .business-types-controls {
            display: flex;
            gap: 1rem;
            align-items: end;
            margin-bottom: 1.5rem;
        }
        
        .business-types-controls .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .business-types-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .business-prompt-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .configured-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .business-type-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        .business-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .business-type-header h6 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .business-type-header .badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .business-type-preview {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }
        
        .business-type-actions {
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 1200px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Menu Hamburger para Mobile */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10000;
            align-items: center;
            padding: 0;
            justify-content: flex-start;
        }

        .hamburger-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 1rem;
            color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 60px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .mobile-logo {
            height: 40px;
            width: auto;
            margin: 0 auto;
            display: block;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .sidebar-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsivo para Mobile */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }

            .admin-sidebar {
                transform: translateX(-100%);
                z-index: 9999;
                width: 280px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                transition: transform 0.3s ease;
            }

            .admin-sidebar.show {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            }
            
            .admin-content {
                margin-left: 0;
                padding: 1rem;
                margin-top: 60px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
            }

            .form-grid, .info-grid {
                grid-template-columns: 1fr;
            }

            .date-input-group {
                flex-direction: column;
            }

            .test-input-group {
                flex-direction: column;
            }

            .prompt-tabs {
                flex-direction: column;
            }

            .message {
                max-width: 95%;
            }

            .content-title {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 380px) {
            .admin-content {
                padding: 0.75rem;
            }
        }

        /* Estilos para Abas do Modal */
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
            padding: 0 2rem;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .modal-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #7f8c8d;
            font-weight: 500;
            font-size: 0.95rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-tab:hover {
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.05);
        }

        .modal-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: white;
        }

        .modal-tab i {
            font-size: 1rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .tab-pane {
            padding: 0;
        }

        /* Estilos para Checkboxes de Entrega */
        .delivery-type-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .delivery-checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .delivery-checkbox-wrapper:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .delivery-checkbox-wrapper.active {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .delivery-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .delivery-label {
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .delivery-fields {
            display: none;
            margin-top: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .delivery-fields.show {
            display: block;
        }

        .section-divider {
            height: 1px;
            background: #e9ecef;
            margin: 2rem 0;
        }

        .subsection-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .modal-tabs {
                padding: 0 1rem;
            }
            
            .modal-tab {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Header Mobile com Menu Hamburger -->
        <div class="mobile-header">
            <button class="hamburger-btn" onclick="toggleMobileMenu()" aria-label="Abrir menu">
                <i class="fas fa-bars"></i>
            </button>
            <img src="https://raw.githubusercontent.com/luishplleite/logotimipulseai/refs/heads/main/LOGO%20FINAL.png" alt="TimePulse AI" class="mobile-logo">
        </div>

        <!-- Overlay para fechar menu mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <nav class="admin-sidebar" id="adminSidebar">
            <div class="admin-header">
                <div class="admin-logo">
                    <i class="fas fa-shield-alt"></i>
                    TimePulse Admin
                </div>
                <div class="admin-subtitle">Painel Administrativo</div>
            </div>
            
            <div class="admin-nav">
                <a href="#dashboard" class="admin-nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-dashboard"></i>
                    Dashboard
                </a>
                <a href="#restaurants" class="admin-nav-item" onclick="showSection('restaurants')">
                    <i class="fas fa-store"></i>
                    Restaurantes
                </a>
                <a href="#trials" class="admin-nav-item" onclick="showSection('trials')">
                    <i class="fas fa-clock"></i>
                    Testes Gratuitos
                </a>
                <a href="#subscriptions" class="admin-nav-item" onclick="showSection('subscriptions')">
                    <i class="fas fa-credit-card"></i>
                    Assinaturas
                </a>
                <a href="#subscription-config" class="admin-nav-item" onclick="showSection('subscription-config')">
                    <i class="fas fa-cog"></i>
                    Configurar Assinatura
                </a>
                <a href="#payments" class="admin-nav-item" onclick="showSection('payments')">
                    <i class="fas fa-money-bill"></i>
                    Pagamentos
                </a>
                <a href="#analytics" class="admin-nav-item" onclick="showSection('analytics')">
                    <i class="fas fa-chart-line"></i>
                    Análises
                </a>
            </div>
            
            <a href="#" class="logout-btn" onclick="adminLogout()">
                <i class="fas fa-sign-out-alt"></i>
                Sair do Admin
            </a>
        </nav>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Header -->
            <div class="content-header">
                <h1 class="content-title" id="sectionTitle">Dashboard Geral</h1>
                <div class="admin-user-info">
                    <div class="user-avatar">A</div>
                    <div>
                        <div style="font-weight: 600;">Administrador</div>
                        <div style="font-size: 0.9rem; color: #7f8c8d;">Sistema TimePulse</div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="admin-section active">
                <div class="stats-grid">
                    <div class="stat-card restaurants">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="totalRestaurants">0</div>
                                <div class="stat-label">Restaurantes Cadastrados</div>
                                <div class="stat-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+12% este mês</span>
                                </div>
                            </div>
                            <div class="stat-icon restaurants">
                                <i class="fas fa-store"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card trials">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="activeTrials">0</div>
                                <div class="stat-label">Testes Ativos</div>
                                <div class="stat-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+8% esta semana</span>
                                </div>
                            </div>
                            <div class="stat-icon trials">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card subscriptions">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="activeSubscriptions">0</div>
                                <div class="stat-label">Assinaturas Ativas</div>
                                <div class="stat-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+15% este mês</span>
                                </div>
                            </div>
                            <div class="stat-icon subscriptions">
                                <i class="fas fa-credit-card"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card revenue">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="monthlyRevenue">R$ 0</div>
                                <div class="stat-label">Receita Mensal</div>
                                <div class="stat-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+22% vs mês anterior</span>
                                </div>
                            </div>
                            <div class="stat-icon revenue">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Receita dos Últimos 6 Meses</h3>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Novos Restaurantes por Mês</h3>
                        <canvas id="restaurantsChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Restaurants Section -->
            <section id="restaurants-section" class="admin-section">
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select id="restaurantStatusFilter" class="filter-input">
                                <option value="">Todos os status</option>
                                <option value="trial">Em teste</option>
                                <option value="active">Ativo</option>
                                <option value="expired">Expirado</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Pesquisar</label>
                            <input type="text" id="restaurantSearchFilter" class="filter-input" placeholder="Nome do restaurante...">
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" onclick="applyRestaurantFilters()">
                                <i class="fas fa-search"></i>
                                Filtrar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Restaurantes Cadastrados</h3>
                        <button class="btn btn-primary" onclick="exportRestaurantsData()">
                            <i class="fas fa-download"></i>
                            Exportar
                        </button>
                    </div>
                    <table class="data-table" id="restaurantsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Data Cadastro</th>
                                <th>Último Login</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Trials Section -->
            <section id="trials-section" class="admin-section">
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Controle de Testes Gratuitos</h3>
                        <button class="btn btn-secondary" onclick="refreshTrialsData()">
                            <i class="fas fa-sync"></i>
                            Atualizar
                        </button>
                    </div>
                    <table class="data-table" id="trialsTable">
                        <thead>
                            <tr>
                                <th>Restaurante</th>
                                <th>Email</th>
                                <th>Início do Teste</th>
                                <th>Fim do Teste</th>
                                <th>Dias Restantes</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Subscriptions Section -->
            <section id="subscriptions-section" class="admin-section">
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Gestão de Assinaturas</h3>
                        <div>
                            <button class="btn btn-success" onclick="createManualSubscription()">
                                <i class="fas fa-plus"></i>
                                Nova Assinatura
                            </button>
                            <button class="btn btn-secondary" onclick="refreshSubscriptionsData()">
                                <i class="fas fa-sync"></i>
                                Atualizar
                            </button>
                        </div>
                    </div>
                    <table class="data-table" id="subscriptionsTable">
                        <thead>
                            <tr>
                                <th>Restaurante</th>
                                <th>Plano</th>
                                <th>Início</th>
                                <th>Próximo Pagamento</th>
                                <th>Status</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Subscription Configuration Section -->
            <section id="subscription-config-section" class="admin-section">
                <div class="section-header" style="margin-bottom: 2rem;">
                    <div>
                        <h2 style="font-size: 1.75rem; color: #2c3e50; margin-bottom: 0.5rem;">
                            <i class="fas fa-cog" style="color: #3498db;"></i>
                            Configurar Assinatura
                        </h2>
                        <p style="color: #7f8c8d;">Configure os elementos bloqueados por tipo de assinatura e período trial</p>
                    </div>
                    <button class="btn btn-success" onclick="savePlanConfiguration()">
                        <i class="fas fa-save"></i>
                        Salvar Configuração
                    </button>
                </div>

                <!-- Configuração de Valores dos Planos -->
                <div class="config-panel" style="margin-top: 2rem;">
                    <div class="config-header">
                        <h4><i class="fas fa-dollar-sign"></i> Valores dos Planos de Assinatura</h4>
                    </div>
                    <div class="config-content">
                        <div class="price-config-grid">
                            <div class="price-config-card">
                                <div class="price-plan-header" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                                    <i class="fas fa-clock"></i>
                                    <span>Trial</span>
                                </div>
                                <div class="price-input-group">
                                    <label>Valor Mensal</label>
                                    <div class="input-with-currency">
                                        <span class="currency-symbol">R$</span>
                                        <input type="number" class="form-input price-input" id="price-trial" value="0.00" min="0" step="0.01" readonly>
                                    </div>
                                    <small style="color: #7f8c8d;">Período gratuito de teste</small>
                                </div>
                            </div>

                            <div class="price-config-card">
                                <div class="price-plan-header" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                                    <i class="fas fa-star"></i>
                                    <span>Básico</span>
                                </div>
                                <div class="price-input-group">
                                    <label>Valor Mensal</label>
                                    <div class="input-with-currency">
                                        <span class="currency-symbol">R$</span>
                                        <input type="number" class="form-input price-input" id="price-basic" value="99.90" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>

                            <div class="price-config-card">
                                <div class="price-plan-header" style="background: linear-gradient(135deg, #27ae60, #229954);">
                                    <i class="fas fa-star-half-alt"></i>
                                    <span>Premium</span>
                                </div>
                                <div class="price-input-group">
                                    <label>Valor Mensal</label>
                                    <div class="input-with-currency">
                                        <span class="currency-symbol">R$</span>
                                        <input type="number" class="form-input price-input" id="price-premium" value="199.90" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>

                            <div class="price-config-card">
                                <div class="price-plan-header" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                                    <i class="fas fa-crown"></i>
                                    <span>Enterprise</span>
                                </div>
                                <div class="price-input-group">
                                    <label>Valor Mensal</label>
                                    <div class="input-with-currency">
                                        <span class="currency-symbol">R$</span>
                                        <input type="number" class="form-input price-input" id="price-enterprise" value="399.90" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="savePlanPrices()">
                                <i class="fas fa-save"></i>
                                Salvar Valores dos Planos
                            </button>
                        </div>
                    </div>
                </div>

                <style>
                    .price-config-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 1.5rem;
                    }

                    .price-config-card {
                        background: white;
                        border: 1px solid #e9ecef;
                        border-radius: 12px;
                        overflow: hidden;
                        transition: all 0.3s ease;
                    }

                    .price-config-card:hover {
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        transform: translateY(-2px);
                    }

                    .price-plan-header {
                        padding: 1.25rem;
                        color: white;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        font-weight: 600;
                        font-size: 1.1rem;
                    }

                    .price-input-group {
                        padding: 1.25rem;
                    }

                    .price-input-group label {
                        display: block;
                        font-weight: 500;
                        margin-bottom: 0.5rem;
                        color: #2c3e50;
                    }

                    .input-with-currency {
                        position: relative;
                        display: flex;
                        align-items: center;
                    }

                    .currency-symbol {
                        position: absolute;
                        left: 1rem;
                        color: #7f8c8d;
                        font-weight: 600;
                    }

                    .price-input {
                        padding-left: 2.5rem !important;
                        font-size: 1.25rem;
                        font-weight: 600;
                        color: #27ae60;
                    }

                    .asaas-config-container {
                        max-width: 900px;
                    }

                    .toggle-switch {
                        position: relative;
                        display: inline-block;
                        width: 50px;
                        height: 24px;
                    }

                    .toggle-switch input {
                        opacity: 0;
                        width: 0;
                        height: 0;
                    }

                    .toggle-slider {
                        position: absolute;
                        cursor: pointer;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: #ccc;
                        transition: .4s;
                        border-radius: 24px;
                    }

                    .toggle-slider:before {
                        position: absolute;
                        content: "";
                        height: 18px;
                        width: 18px;
                        left: 3px;
                        bottom: 3px;
                        background-color: white;
                        transition: .4s;
                        border-radius: 50%;
                    }

                    .toggle-switch input:checked + .toggle-slider {
                        background-color: #27ae60;
                    }

                    .toggle-switch input:checked + .toggle-slider:before {
                        transform: translateX(26px);
                    }

                    .elements-section {
                        margin-bottom: 2rem;
                    }

                    .elements-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                        gap: 1rem;
                    }

                    .element-config-card {
                        background: #f8f9fa;
                        border: 1px solid #e9ecef;
                        border-radius: 8px;
                        padding: 1rem;
                        transition: all 0.3s ease;
                    }

                    .element-config-card:hover {
                        border-color: #3498db;
                        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
                    }

                    .element-header {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        margin-bottom: 0.75rem;
                    }

                    .element-checkbox {
                        position: relative;
                        display: flex;
                        align-items: center;
                        cursor: pointer;
                    }

                    .element-checkbox input[type="checkbox"] {
                        position: absolute;
                        opacity: 0;
                        cursor: pointer;
                    }

                    .checkmark {
                        height: 24px;
                        width: 24px;
                        background-color: #fff;
                        border: 2px solid #ddd;
                        border-radius: 4px;
                        transition: all 0.3s ease;
                    }

                    .element-checkbox input:checked ~ .checkmark {
                        background-color: #3498db;
                        border-color: #3498db;
                    }

                    .element-checkbox input:checked ~ .checkmark:after {
                        content: '\2713';
                        position: absolute;
                        left: 7px;
                        top: 2px;
                        color: white;
                        font-size: 14px;
                        font-weight: bold;
                    }

                    .element-name {
                        font-weight: 600;
                        color: #2c3e50;
                        font-size: 0.95rem;
                    }

                    .element-desc {
                        font-size: 0.8rem;
                        color: #7f8c8d;
                    }

                    .element-blocking {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        margin-top: 0.5rem;
                        padding-top: 0.75rem;
                        border-top: 1px solid #e9ecef;
                    }
                </style>
            </section>

            <!-- Payments Section -->
            <section id="payments-section" class="admin-section">
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Histórico de Pagamentos</h3>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-success" onclick="openAsaasConfigModal()">
                                <i class="fas fa-cog"></i>
                                Configurar Asaas API
                            </button>
                            <button class="btn btn-primary" onclick="exportPaymentsData()">
                                <i class="fas fa-download"></i>
                                Exportar
                            </button>
                        </div>
                    </div>
                    <table class="data-table" id="paymentsTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Restaurante</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Método</th>
                                <th>ID Transação</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics-section" class="admin-section">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Conversão de Teste para Assinatura</h3>
                        <canvas id="conversionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Churn Rate Mensal</h3>
                        <canvas id="churnChart"></canvas>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Distribuição por Plano</h3>
                        <canvas id="plansChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Receita por Categoria</h3>
                        <canvas id="revenueByPlanChart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal de Visualização de Restaurante -->
    <div id="viewRestaurantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-store"></i>
                    Visualizar Restaurante
                </h2>
                <button class="modal-close" onclick="closeModal('viewRestaurantModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <div class="info-section-title">
                        <i class="fas fa-info-circle"></i>
                        Informações Básicas
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ID do Restaurante</div>
                            <div class="info-value" id="view-restaurant-id">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Nome</div>
                            <div class="info-value" id="view-restaurant-name">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Email do Responsável</div>
                            <div class="info-value" id="view-restaurant-email">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Telefone</div>
                            <div class="info-value" id="view-restaurant-phone">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Data de Cadastro</div>
                            <div class="info-value" id="view-restaurant-created">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Último Login</div>
                            <div class="info-value" id="view-restaurant-login">-</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-section-title">
                        <i class="fas fa-crown"></i>
                        Status da Assinatura
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Status Atual</div>
                            <div class="info-value" id="view-restaurant-status">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Fim do Teste Gratuito</div>
                            <div class="info-value" id="view-restaurant-trial-end">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Dias Restantes</div>
                            <div class="info-value" id="view-restaurant-days-left">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Plano</div>
                            <div class="info-value" id="view-restaurant-plan">-</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Endereço
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Endereço Completo</div>
                            <div class="info-value" id="view-restaurant-address">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Cidade/Estado</div>
                            <div class="info-value" id="view-restaurant-city">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewRestaurantModal')">
                    <i class="fas fa-times"></i>
                    Fechar
                </button>
                <button class="btn btn-primary" onclick="openEditModal()">
                    <i class="fas fa-edit"></i>
                    Editar Restaurante
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edição de Restaurante -->
    <div id="editRestaurantModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Editar Restaurante
                </h2>
                <button class="modal-close" onclick="closeModal('editRestaurantModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Sistema de Abas -->
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchEditTab('dados')" data-tab="dados">
                    <i class="fas fa-store"></i>
                    Dados do Restaurante
                </button>
                <button class="modal-tab" onclick="switchEditTab('assinaturas')" data-tab="assinaturas">
                    <i class="fas fa-crown"></i>
                    Assinaturas
                </button>
                <button class="modal-tab" onclick="switchEditTab('tempo-entrega')" data-tab="tempo-entrega">
                    <i class="fas fa-clock"></i>
                    Tempo de Entrega
                </button>
                <button class="modal-tab" onclick="switchEditTab('tipos-entrega')" data-tab="tipos-entrega">
                    <i class="fas fa-truck"></i>
                    Tipos de Entrega
                </button>
                <button class="modal-tab" onclick="switchEditTab('vencimentos')" data-tab="vencimentos">
                    <i class="fas fa-calendar-alt"></i>
                    Datas de Vencimento
                </button>
            </div>

            <div class="modal-body">
                <form id="editRestaurantForm">
                    
                    <!-- ABA 1: DADOS DO RESTAURANTE -->
                    <div id="tab-dados" class="tab-content active">
                        <div class="subsection-title">
                            <i class="fas fa-info-circle"></i>
                            Informações Básicas
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nome do Restaurante</label>
                                <input type="text" id="edit-restaurant-name" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email do Responsável</label>
                                <input type="email" id="edit-restaurant-email" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefone</label>
                                <input type="tel" id="edit-restaurant-phone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CNPJ</label>
                                <input type="text" id="edit-restaurant-cnpj" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CPF do Responsável</label>
                                <input type="text" id="edit-restaurant-cpf" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cidade</label>
                                <input type="text" id="edit-restaurant-city" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <input type="text" id="edit-restaurant-state" class="form-input" maxlength="2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CEP</label>
                                <input type="text" id="edit-restaurant-zip" class="form-input">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Endereço Completo</label>
                                <textarea id="edit-restaurant-address" class="form-input form-textarea"></textarea>
                            </div>
                        </div>

                        <div class="section-divider"></div>

                        <div class="subsection-title">
                            <i class="fas fa-toggle-on"></i>
                            Status do Restaurante
                        </div>
                        <div class="status-selector">
                            <div class="status-option" data-status="active" onclick="selectStatus('active')">
                                <div class="status-icon" style="color: #27ae60;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="status-name">Ativo</div>
                                <div class="status-desc">Funcionando normalmente</div>
                            </div>
                            <div class="status-option" data-status="trial" onclick="selectStatus('trial')">
                                <div class="status-icon" style="color: #f39c12;">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="status-name">Em Teste</div>
                                <div class="status-desc">Período de avaliação</div>
                            </div>
                            <div class="status-option" data-status="suspended" onclick="selectStatus('suspended')">
                                <div class="status-icon" style="color: #e74c3c;">
                                    <i class="fas fa-pause-circle"></i>
                                </div>
                                <div class="status-name">Suspenso</div>
                                <div class="status-desc">Temporariamente inativo</div>
                            </div>
                            <div class="status-option" data-status="cancelled" onclick="selectStatus('cancelled')">
                                <div class="status-icon" style="color: #95a5a6;">
                                    <i class="fas fa-ban"></i>
                                </div>
                                <div class="status-name">Cancelado</div>
                                <div class="status-desc">Conta cancelada</div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Motivo da Alteração de Status</label>
                            <textarea id="status-reason" class="form-input" placeholder="Descreva o motivo da alteração de status..."></textarea>
                        </div>
                    </div>

                    <!-- ABA 2: CONTROLE DE ASSINATURAS -->
                    <div id="tab-assinaturas" class="tab-content">
                        <div class="subsection-title">
                            <i class="fas fa-tags"></i>
                            Plano Atual
                        </div>
                        <div class="form-group">
                            <label class="form-label">Plano de Assinatura</label>
                            <select id="edit-restaurant-plan" class="form-input">
                                <option value="basic">Básico</option>
                                <option value="premium">Premium</option>
                                <option value="enterprise">Empresarial</option>
                            </select>
                        </div>

                        <div class="section-divider"></div>

                        <!-- Configuração de Teste Gratuito -->
                        <div class="trial-config">
                            <div class="config-header">
                                <div class="config-icon trial">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <div class="config-title">Configuração de Teste Gratuito</div>
                                    <div style="font-size: 0.9rem; color: #856404;">Gerencie o período de teste do restaurante</div>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Data Início do Teste</label>
                                    <input type="date" id="edit-trial-start-date" class="form-input" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Data Fim do Teste</label>
                                    <div class="date-input-group">
                                        <input type="date" id="edit-trial-end-date" class="form-input">
                                        <input type="number" id="extend-days" class="form-input" placeholder="Dias para estender" min="1" max="365">
                                        <button type="button" class="btn btn-secondary" onclick="extendTrialDays()">
                                            <i class="fas fa-plus"></i>
                                            Estender
                                        </button>
                                    </div>
                                    <div class="quick-days">
                                        <span class="quick-day-btn" onclick="setExtendDays(7)">+7 dias</span>
                                        <span class="quick-day-btn" onclick="setExtendDays(15)">+15 dias</span>
                                        <span class="quick-day-btn" onclick="setExtendDays(30)">+30 dias</span>
                                        <span class="quick-day-btn" onclick="setExtendDays(90)">+90 dias</span>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <label class="form-label">Motivo da Extensão</label>
                                    <textarea id="trial-reason" class="form-input" placeholder="Opcional: motivo da extensão do teste..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="section-divider"></div>

                        <!-- Configuração de Assinatura -->
                        <div class="subscription-config">
                            <div class="config-header">
                                <div class="config-icon subscription">
                                    <i class="fas fa-crown"></i>
                                </div>
                                <div>
                                    <div class="config-title">Ativação Manual de Assinatura</div>
                                    <div style="font-size: 0.9rem; color: #155724;">Ative a assinatura sem pagamento automático</div>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Data de Início da Assinatura</label>
                                    <input type="date" id="subscription-start-date" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ativar Assinatura até</label>
                                    <input type="date" id="subscription-end-date" class="form-input">
                                </div>
                                <div class="form-group full-width">
                                    <label class="form-label">Motivo da Ativação Manual</label>
                                    <textarea id="subscription-reason" class="form-input" placeholder="Ex: Pagamento feito via transferência, parceria, etc..."></textarea>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="activateManualSubscription()">
                                <i class="fas fa-crown"></i>
                                Ativar Assinatura Manual
                            </button>
                        </div>
                    </div>

                    <!-- ABA 3: TEMPO DE ENTREGA -->
                    <div id="tab-tempo-entrega" class="tab-content">
                        <div class="subsection-title">
                            <i class="fas fa-hourglass-half"></i>
                            Configurações de Tempo
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Tempo de Preparo (minutos)</label>
                                <input type="number" id="edit-preparation-time" class="form-input" min="5" max="180" placeholder="Ex: 30">
                                <small style="color: #7f8c8d; margin-top: 0.25rem;">Tempo médio para preparar o pedido</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pedido Mínimo (R$)</label>
                                <input type="number" id="edit-minimum-order" class="form-input" min="0" step="0.01" placeholder="Ex: 20.00">
                                <small style="color: #7f8c8d; margin-top: 0.25rem;">Valor mínimo para aceitar pedidos</small>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 4: TIPOS DE ENTREGA -->
                    <div id="tab-tipos-entrega" class="tab-content">
                        <div class="subsection-title">
                            <i class="fas fa-shipping-fast"></i>
                            Escolha os Tipos de Entrega
                        </div>

                        <!-- Entrega de Terceiros -->
                        <div class="delivery-type-section">
                            <div class="delivery-checkbox-wrapper" onclick="toggleDeliveryType('third-party')" id="third-party-wrapper">
                                <input type="checkbox" id="third-party-delivery-enabled" class="delivery-checkbox" onclick="event.stopPropagation()">
                                <div class="delivery-label">
                                    <i class="fas fa-motorcycle"></i>
                                    Entrega de Terceiros (Apps de Delivery)
                                </div>
                            </div>
                            <div class="delivery-fields" id="third-party-fields">
                                <div class="subsection-title" style="margin-bottom: 1rem;">
                                    <i class="fas fa-cog"></i>
                                    Configurações de Entrega de Terceiros
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Taxa de Retorno/Comissão (R$)</label>
                                        <input type="number" id="edit-delivery-retun" class="form-input" min="0" step="0.01" placeholder="Ex: 5.00">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Valor pago ao entregador de app</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Taxa Mínima de Entrega (R$)</label>
                                        <input type="number" id="edit-third-minimum-fee" class="form-input" min="0" step="0.01" placeholder="Ex: 8.00">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Valor mínimo cobrado do cliente</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Taxa por Km (R$)</label>
                                        <input type="number" id="edit-third-fee-per-km" class="form-input" min="0" step="0.01" placeholder="Ex: 2.50">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Valor adicional por quilômetro</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Distância Mínima (km)</label>
                                        <input type="number" id="edit-third-min-distance" class="form-input" min="0" step="0.1" placeholder="Ex: 3.0">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Distância base incluída na taxa mínima</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Raio de Entrega (km)</label>
                                        <input type="number" id="edit-third-delivery-radius" class="form-input" min="0" step="0.1" placeholder="Ex: 10.0">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Distância máxima para entregas</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Entrega da Casa -->
                        <div class="delivery-type-section">
                            <div class="delivery-checkbox-wrapper" onclick="toggleDeliveryType('house')" id="house-wrapper">
                                <input type="checkbox" id="house-delivery-enabled" class="delivery-checkbox" onclick="event.stopPropagation()">
                                <div class="delivery-label">
                                    <i class="fas fa-home"></i>
                                    Entrega da Casa (Própria)
                                </div>
                            </div>
                            <div class="delivery-fields" id="house-fields">
                                <div class="subsection-title" style="margin-bottom: 1rem;">
                                    <i class="fas fa-cog"></i>
                                    Configurações de Entrega da Casa
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Taxa Mínima de Entrega (R$)</label>
                                        <input type="number" id="edit-house-minimum-fee" class="form-input" min="0" step="0.01" placeholder="Ex: 5.00">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Valor mínimo cobrado para entrega própria</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Taxa por Km (R$)</label>
                                        <input type="number" id="edit-house-fee-per-km" class="form-input" min="0" step="0.01" placeholder="Ex: 2.00">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Valor adicional por quilômetro</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Distância Mínima (km)</label>
                                        <input type="number" id="edit-house-min-distance" class="form-input" min="0" step="0.1" placeholder="Ex: 2.0">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Distância base incluída na taxa mínima</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Raio de Entrega (km)</label>
                                        <input type="number" id="edit-house-delivery-radius" class="form-input" min="0" step="0.1" placeholder="Ex: 8.0">
                                        <small style="color: #7f8c8d; margin-top: 0.25rem;">Distância máxima para entregas próprias</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABA 5: DATAS DE VENCIMENTO -->
                    <div id="tab-vencimentos" class="tab-content">
                        <div class="subsection-title">
                            <i class="fas fa-calendar-check"></i>
                            Gerenciar Datas de Vencimento
                        </div>

                        <div class="info-section" style="background: #fff3cd; border: 1px solid #f39c12; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-info-circle" style="color: #f39c12; font-size: 1.2rem;"></i>
                                <div style="font-size: 0.9rem; color: #856404;">
                                    <strong>Atenção:</strong> As datas de vencimento controlam quando a assinatura expira. Edite com cuidado.
                                </div>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-calendar-day"></i>
                                    Data de Início do Trial
                                </label>
                                <input type="date" id="edit-venc-trial-start" class="form-input">
                                <small style="color: #7f8c8d;">Quando o período de teste começou</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-calendar-times"></i>
                                    Data de Fim do Trial
                                </label>
                                <input type="date" id="edit-venc-trial-end" class="form-input">
                                <small style="color: #7f8c8d;">Quando o período de teste termina</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-calendar-plus"></i>
                                    Data de Início da Assinatura
                                </label>
                                <input type="date" id="edit-venc-subscription-start" class="form-input">
                                <small style="color: #7f8c8d;">Quando a assinatura paga começou</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-calendar-minus"></i>
                                    Data de Fim da Assinatura
                                </label>
                                <input type="date" id="edit-venc-subscription-end" class="form-input">
                                <small style="color: #7f8c8d;">Quando a assinatura paga vence</small>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">
                                    <i class="fas fa-sticky-note"></i>
                                    Observações sobre Vencimentos
                                </label>
                                <textarea id="edit-venc-notes" class="form-input form-textarea" placeholder="Anote observações importantes sobre as datas de vencimento..."></textarea>
                            </div>
                        </div>

                        <div class="section-divider"></div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-hourglass-half"></i>
                                Dias Restantes do Trial
                            </label>
                            <input type="number" id="edit-trial-days-remaining" class="form-input" disabled>
                            <small style="color: #7f8c8d;">Calculado automaticamente</small>
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editRestaurantModal')">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="saveRestaurantChanges()">
                    <i class="fas fa-save"></i>
                    Salvar Alterações
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Configuração Asaas API -->
    <div id="asaasConfigModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-cog"></i>
                    Configurar Asaas API
                </h2>
                <button class="modal-close" onclick="closeModal('asaasConfigModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="info-section" style="background: #e3f2fd; border: 1px solid #2196f3;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-info-circle" style="font-size: 1.5rem; color: #2196f3;"></i>
                        <div>
                            <strong style="color: #1976d2;">Administrador da Plataforma</strong>
                            <p style="margin: 0.5rem 0 0 0; color: #546e7a; font-size: 0.9rem;">
                                Esta chave API será usada pelo administrador da plataforma para gerenciar pagamentos via Asaas.
                            </p>
                        </div>
                    </div>
                </div>
                
                <form id="asaasConfigForm" style="margin-top: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i>
                            Chave API do Asaas
                        </label>
                        <input 
                            type="text" 
                            id="asaas-api-key" 
                            class="form-input" 
                            placeholder="Cole sua chave API do Asaas aqui..."
                            required
                        >
                        <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                            A chave API será armazenada de forma segura no banco de dados.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i>
                            Email do Administrador
                        </label>
                        <input 
                            type="email" 
                            id="admin-email" 
                            class="form-input" 
                            value="luishplleite@gmail.com"
                            disabled
                        >
                        <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                            Email vinculado ao administrador da plataforma
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('asaasConfigModal')">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-success" onclick="saveAsaasConfig()">
                    <i class="fas fa-save"></i>
                    Salvar Configuração
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 'dashboard';
        let charts = {};

        // Variáveis globais para gerenciamento de sessão
        let currentAdminData = null;
        let authCheckInterval = null;
        let connectionStartTime = new Date();

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🎯 Painel administrativo carregado');
            
            // Verificar autenticação primeiro
            const isAuthenticated = await authenticateAdmin();
            if (!isAuthenticated) {
                return; // Para aqui se não está autenticado
            }
            
            // Iniciar verificação periódica de autenticação
            startAuthenticationCheck();
            
            // Carregar dados do dashboard
            loadDashboardStats();
            initializeCharts();
            
            // Definir seção inicial
            showSection('dashboard');
            
            console.log('✅ Painel administrativo inicializado com sucesso');
        });

        // Sistema de autenticação melhorado com JWT
        async function authenticateAdmin() {
            try {
                console.log('🔐 Verificando autenticação de administrador...');
                
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    console.log('❌ Token de admin não encontrado');
                    redirectToLogin();
                    return false;
                }

                // Verificar se o token ainda é válido
                const response = await fetch('/api/admin/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.log('❌ Token inválido ou expirado');
                    localStorage.removeItem('admin_token');
                    localStorage.removeItem('admin_user');
                    redirectToLogin();
                    return false;
                }

                const adminData = await response.json();
                currentAdminData = adminData;
                
                // Atualizar interface com dados do admin
                updateAdminInterface(adminData);
                
                console.log(`✅ Admin autenticado: ${adminData.email} (${adminData.role})`);
                return true;

            } catch (error) {
                console.error('❌ Erro na autenticação de admin:', error);
                redirectToLogin();
                return false;
            }
        }

        // Atualizar interface com dados do administrador conectado
        function updateAdminInterface(adminData) {
            // Atualizar avatar do usuário
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar && adminData.email) {
                const initials = adminData.email.substring(0, 2).toUpperCase();
                userAvatar.textContent = initials;
                userAvatar.title = `${adminData.email} (Administrador)`;
            }

            // Adicionar informações detalhadas do admin se não existirem
            const adminUserInfo = document.querySelector('.admin-user-info');
            if (adminUserInfo && !adminUserInfo.querySelector('.admin-details')) {
                const adminDetails = document.createElement('div');
                adminDetails.className = 'admin-details';
                adminDetails.style.cssText = 'margin-left: 1rem; text-align: right;';
                adminDetails.innerHTML = `
                    <div>
                        <strong style="color: #2c3e50; font-size: 0.9rem;">${adminData.email}</strong>
                        <div style="font-size: 0.75rem; color: #7f8c8d; margin-top: 2px;">
                            <i class="fas fa-shield-alt"></i> Administrador
                        </div>
                        <div style="font-size: 0.7rem; color: #95a5a6; margin-top: 2px;">
                            <i class="fas fa-clock"></i> 
                            Conectado: ${connectionStartTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>
                `;
                adminUserInfo.appendChild(adminDetails);
            }

            // Adicionar indicador de status de conexão
            addConnectionStatusIndicator();
        }

        // Adicionar indicador de status de conexão
        function addConnectionStatusIndicator() {
            const contentHeader = document.querySelector('.content-header');
            let statusIndicator = document.querySelector('.connection-status');
            
            if (!statusIndicator && contentHeader) {
                statusIndicator = document.createElement('div');
                statusIndicator.className = 'connection-status';
                statusIndicator.style.cssText = 'position: absolute; top: 1rem; right: 1rem; z-index: 100;';
                statusIndicator.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; background: #27ae60; color: white; border-radius: 15px; font-size: 0.75rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div class="status-dot" style="width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <span id="connection-text">Online</span>
                    </div>
                `;
                contentHeader.style.position = 'relative';
                contentHeader.appendChild(statusIndicator);

                // Adicionar CSS para animação se não existir
                if (!document.querySelector('#pulse-animation')) {
                    const style = document.createElement('style');
                    style.id = 'pulse-animation';
                    style.textContent = `
                        @keyframes pulse {
                            0% { opacity: 1; }
                            50% { opacity: 0.5; }
                            100% { opacity: 1; }
                        }
                        .connection-status:hover div {
                            background: #219a52 !important;
                            transform: scale(1.05);
                            transition: all 0.2s ease;
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // Verificação periódica de autenticação (a cada 3 minutos)
        function startAuthenticationCheck() {
            authCheckInterval = setInterval(async () => {
                console.log('🔄 Verificando status de autenticação...');
                
                try {
                    const adminToken = localStorage.getItem('admin_token');
                    if (!adminToken) {
                        throw new Error('Token não encontrado');
                    }

                    const response = await fetch('/api/admin/verify', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Token inválido');
                    }

                    // Atualizar timestamp de última verificação
                    const adminDetails = document.querySelector('.admin-details');
                    if (adminDetails) {
                        const timeElement = adminDetails.querySelector('div:last-child');
                        if (timeElement) {
                            timeElement.innerHTML = `
                                <i class="fas fa-sync-alt"></i> 
                                Última verificação: ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                            `;
                        }
                    }

                    // Atualizar status de conexão
                    const connectionText = document.getElementById('connection-text');
                    if (connectionText) {
                        connectionText.textContent = 'Online';
                        connectionText.parentElement.style.background = '#27ae60';
                    }

                    console.log('✅ Status de autenticação verificado - OK');

                } catch (error) {
                    console.log('❌ Sessão expirou ou inválida:', error.message);
                    
                    // Atualizar status visual
                    const connectionText = document.getElementById('connection-text');
                    if (connectionText) {
                        connectionText.textContent = 'Desconectado';
                        connectionText.parentElement.style.background = '#e74c3c';
                    }

                    // Limpar intervalo e redirecionar
                    clearInterval(authCheckInterval);
                    
                    // Aguardar 2 segundos antes de redirecionar para mostrar o status
                    setTimeout(() => {
                        localStorage.removeItem('admin_token');
                        localStorage.removeItem('admin_user');
                        redirectToLogin();
                    }, 2000);
                }
            }, 3 * 60 * 1000); // 3 minutos
        }
        
        // Redirecionar para o login administrativo
        function redirectToLogin() {
            console.log('🔄 Redirecionando para login administrativo...');
            window.location.href = 'admin-login.html';
        }

        // Navegação entre seções
        function showSection(sectionName) {
            // Ocultar todas as seções
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover classe active dos nav items
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar seção selecionada
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // Adicionar classe active ao nav item
            document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active');
            
            // Atualizar título
            const titles = {
                dashboard: 'Dashboard Geral',
                restaurants: 'Gestão de Restaurantes',
                trials: 'Controle de Testes Gratuitos',
                subscriptions: 'Gestão de Assinaturas',
                'subscription-config': 'Configurar Assinatura',
                payments: 'Histórico de Pagamentos',
                analytics: 'Análises e Relatórios'
            };
            
            document.getElementById('sectionTitle').textContent = titles[sectionName];
            currentSection = sectionName;
            
            // Carregar dados específicos da seção
            loadSectionData(sectionName);
        }

        // Carregar dados das estatísticas
        async function loadDashboardStats() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    throw new Error('Token de admin não encontrado');
                }
                
                const response = await fetch('/api/admin/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar estatísticas');
                }
                
                const stats = await response.json();
                
                document.getElementById('totalRestaurants').textContent = stats.totalRestaurants || 0;
                document.getElementById('activeTrials').textContent = stats.activeTrials || 0;
                document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions || 0;
                document.getElementById('monthlyRevenue').textContent = `R$ ${(stats.monthlyRevenue || 0).toLocaleString('pt-BR')}`;
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
                // Dados simulados para demonstração
                document.getElementById('totalRestaurants').textContent = '156';
                document.getElementById('activeTrials').textContent = '23';
                document.getElementById('activeSubscriptions').textContent = '133';
                document.getElementById('monthlyRevenue').textContent = 'R$ 6.517';
            }
        }

        // Carregar dados específicos por seção
        async function loadSectionData(section) {
            switch (section) {
                case 'restaurants':
                    await loadRestaurantsData();
                    break;
                case 'trials':
                    await loadTrialsData();
                    break;
                case 'subscriptions':
                    await loadSubscriptionsData();
                    break;
                case 'payments':
                    await loadPaymentsData();
                    break;
                case 'analytics':
                    updateAnalyticsCharts();
                    break;
            }
        }

        // Carregar dados de restaurantes
        async function loadRestaurantsData() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    throw new Error('Token de admin não encontrado');
                }
                
                const response = await fetch('/api/admin/restaurants', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                updateRestaurantsTable(data.restaurants || []);
            } catch (error) {
                console.error('Erro ao carregar restaurantes:', error);
                updateRestaurantsTable([]);
            }
        }

        // Atualizar tabela de restaurantes
        function updateRestaurantsTable(restaurants) {
            const tbody = document.querySelector('#restaurantsTable tbody');
            
            // Atualizar mapa de restaurantes por ID (garantindo strings)
            restaurantsById.clear();
            restaurants.forEach(restaurant => {
                restaurantsById.set(String(restaurant.id), restaurant);
            });
            
            console.log('🍽️ Mapa de restaurantes atualizado:', restaurantsById.size, 'restaurantes');
            restaurants.forEach(r => console.log('  -', r.id, ':', r.name));
            
            if (restaurants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                            Nenhum restaurante encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Limpar tbody primeiro
            tbody.innerHTML = '';
            
            // Criar linhas da tabela usando createElement para máxima segurança
            restaurants.forEach(restaurant => {
                const row = document.createElement('tr');
                
                // Adicionar ID do restaurante como data attribute no tr
                row.dataset.restaurantId = String(restaurant.id);
                
                // Coluna ID
                const idCell = document.createElement('td');
                idCell.textContent = `#${restaurant.id}`;
                row.appendChild(idCell);
                
                // Coluna Nome
                const nameCell = document.createElement('td');
                const nameStrong = document.createElement('strong');
                nameStrong.textContent = restaurant.name || 'N/A';
                nameCell.appendChild(nameStrong);
                row.appendChild(nameCell);
                
                // Coluna Status
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.className = `status-badge status-${restaurant.subscription_status}`;
                const statusText = restaurant.subscription_status === 'trial' ? 'Teste' :
                                 restaurant.subscription_status === 'active' ? 'Ativo' :
                                 restaurant.subscription_status === 'expired' ? 'Expirado' : 'Cancelado';
                statusSpan.textContent = statusText;
                statusCell.appendChild(statusSpan);
                row.appendChild(statusCell);
                
                // Coluna Data Cadastro
                const createdCell = document.createElement('td');
                createdCell.textContent = restaurant.created_at ? 
                    new Date(restaurant.created_at).toLocaleDateString('pt-BR') : 'N/A';
                row.appendChild(createdCell);
                
                // Coluna Último Login
                const loginCell = document.createElement('td');
                loginCell.textContent = restaurant.last_login ? 
                    new Date(restaurant.last_login).toLocaleDateString('pt-BR') : 'Nunca';
                row.appendChild(loginCell);
                
                // Coluna Ações
                const actionsCell = document.createElement('td');
                
                // Botão Visualizar
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-primary';
                viewBtn.setAttribute('data-restaurant-id', restaurant.id);
                viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                viewBtn.addEventListener('click', () => {
                    console.log('🔍 Visualizando restaurante ID:', restaurant.id);
                    viewRestaurant(restaurant.id);
                });
                
                // Botão Editar
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-sm btn-secondary';
                editBtn.setAttribute('data-restaurant-id', restaurant.id);
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.addEventListener('click', () => {
                    console.log('✏️ Editando restaurante ID:', restaurant.id);
                    editRestaurant(restaurant.id);
                });
                
                // Botão Suspender
                const suspendBtn = document.createElement('button');
                suspendBtn.className = 'btn btn-sm btn-danger';
                suspendBtn.setAttribute('data-restaurant-id', restaurant.id);
                suspendBtn.innerHTML = '<i class="fas fa-ban"></i>';
                suspendBtn.addEventListener('click', () => {
                    console.log('🚫 Suspendendo restaurante ID:', restaurant.id);
                    suspendRestaurant(restaurant.id);
                });
                
                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(suspendBtn);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        // Inicializar gráficos
        function initializeCharts() {
            // Destruir gráficos existentes antes de criar novos
            if (charts.revenue) {
                charts.revenue.destroy();
            }
            if (charts.restaurants) {
                charts.restaurants.destroy();
            }
            
            // Gráfico de receita
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            charts.revenue = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Receita (R$)',
                        data: [2800, 3200, 4100, 4800, 5600, 6517],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de novos restaurantes
            const restaurantsCtx = document.getElementById('restaurantsChart').getContext('2d');
            charts.restaurants = new Chart(restaurantsCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Novos Restaurantes',
                        data: [8, 12, 15, 18, 22, 25],
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Variáveis globais para os modais
        let currentRestaurantData = null;
        let selectedStatus = null;
        let restaurantsById = new Map(); // Mapa de restaurantes por ID para acesso rápido

        // Funções de ação
        async function viewRestaurant(id) {
            console.log('🔍 ViewRestaurant chamado com ID:', id);
            
            // Primeiro, tentar buscar do mapa local
            const localData = restaurantsById.get(id);
            if (localData) {
                console.log('✅ Dados encontrados no mapa local:', localData.name);
                currentRestaurantData = localData;
                populateViewModal(localData);
                openModal('viewRestaurantModal');
                return;
            }
            
            console.warn('⚠️ Restaurante não encontrado no mapa local, IDs disponíveis:', Array.from(restaurantsById.keys()));
            alert(`Erro: Restaurante com ID ${id} não encontrado nos dados carregados.`);
        }

        async function editRestaurant(id) {
            console.log('✏️ EditRestaurant chamado com ID:', id);
            
            // Primeiro, tentar buscar do mapa local
            const localData = restaurantsById.get(id);
            if (localData) {
                console.log('✅ Dados encontrados no mapa local para edição:', localData.name);
                currentRestaurantData = localData;
                populateEditModal(localData);
                openModal('editRestaurantModal');
                return;
            }
            
            console.warn('⚠️ Restaurante não encontrado no mapa local para edição, IDs disponíveis:', Array.from(restaurantsById.keys()));
            alert(`Erro: Restaurante com ID ${id} não encontrado nos dados carregados.`);
        }

        // Funções dos modais
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function openEditModal() {
            closeModal('viewRestaurantModal');
            setTimeout(() => {
                populateEditModal(currentRestaurantData);
                openModal('editRestaurantModal');
            }, 300);
        }

        // Popular modal de visualização
        function populateViewModal(data) {
            document.getElementById('view-restaurant-id').textContent = `#${data.id}`;
            document.getElementById('view-restaurant-name').textContent = data.name;
            document.getElementById('view-restaurant-email').textContent = data.owner_email;
            document.getElementById('view-restaurant-phone').textContent = data.phone || 'Não informado';
            document.getElementById('view-restaurant-created').textContent = new Date(data.created_at).toLocaleDateString('pt-BR');
            document.getElementById('view-restaurant-login').textContent = data.last_login ? new Date(data.last_login).toLocaleDateString('pt-BR') : 'Nunca';
            
            // Status
            const statusMap = {
                'trial': 'Em Teste',
                'active': 'Ativo',
                'expired': 'Expirado',
                'suspended': 'Suspenso',
                'cancelled': 'Cancelado'
            };
            document.getElementById('view-restaurant-status').textContent = statusMap[data.subscription_status] || data.subscription_status;
            
            // Trial info
            if (data.trial_end_date) {
                const trialEnd = new Date(data.trial_end_date);
                const now = new Date();
                const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                
                document.getElementById('view-restaurant-trial-end').textContent = trialEnd.toLocaleDateString('pt-BR');
                document.getElementById('view-restaurant-days-left').textContent = daysLeft > 0 ? `${daysLeft} dias` : 'Expirado';
            } else {
                document.getElementById('view-restaurant-trial-end').textContent = 'N/A';
                document.getElementById('view-restaurant-days-left').textContent = 'N/A';
            }
            
            document.getElementById('view-restaurant-plan').textContent = data.plan || 'Básico';
            document.getElementById('view-restaurant-address').textContent = data.address || 'Não informado';
            document.getElementById('view-restaurant-city').textContent = data.city || 'Não informado';
        }

        // Função para alternar entre abas do modal de edição
        function switchEditTab(tabName) {
            // Remover active de todas as abas e conteúdos
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Adicionar active na aba clicada e seu conteúdo
            document.querySelector(`.modal-tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Função para toggle de tipos de entrega
        function toggleDeliveryType(type) {
            const checkbox = document.getElementById(`${type}-delivery-enabled`);
            const wrapper = document.getElementById(`${type}-wrapper`);
            const fields = document.getElementById(`${type}-fields`);
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                wrapper.classList.add('active');
                fields.classList.add('show');
            } else {
                wrapper.classList.remove('active');
                fields.classList.remove('show');
            }
        }

        // Popular modal de edição
        function populateEditModal(data) {
            // ABA 1: DADOS DO RESTAURANTE
            document.getElementById('edit-restaurant-name').value = data.name || '';
            document.getElementById('edit-restaurant-email').value = data.owner_email || '';
            document.getElementById('edit-restaurant-phone').value = data.owner_phone || '';
            document.getElementById('edit-restaurant-cnpj').value = data.cnpj || '';
            document.getElementById('edit-restaurant-cpf').value = data.owner_cpf || '';
            document.getElementById('edit-restaurant-city').value = data.city || '';
            document.getElementById('edit-restaurant-state').value = data.state || '';
            document.getElementById('edit-restaurant-zip').value = data.zip_code || '';
            document.getElementById('edit-restaurant-address').value = data.address || '';
            
            // Status selection
            selectedStatus = data.subscription_status || 'trial';
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.status === selectedStatus) {
                    option.classList.add('selected');
                }
            });
            
            // ABA 2: ASSINATURAS
            document.getElementById('edit-restaurant-plan').value = data.plan || 'basic';
            
            // Trial dates
            if (data.trial_start_date) {
                const trialStartDate = new Date(data.trial_start_date);
                document.getElementById('edit-trial-start-date').value = trialStartDate.toISOString().split('T')[0];
            }
            if (data.trial_end_date) {
                const trialDate = new Date(data.trial_end_date);
                document.getElementById('edit-trial-end-date').value = trialDate.toISOString().split('T')[0];
            }
            
            // Subscription dates
            if (data.subscription_start_date) {
                const subStart = new Date(data.subscription_start_date);
                document.getElementById('subscription-start-date').value = subStart.toISOString().split('T')[0];
            }
            if (data.subscription_end_date) {
                const subEnd = new Date(data.subscription_end_date);
                document.getElementById('subscription-end-date').value = subEnd.toISOString().split('T')[0];
            }
            
            // ABA 3: TEMPO DE ENTREGA
            document.getElementById('edit-preparation-time').value = data.preparation_time || 30;
            document.getElementById('edit-minimum-order').value = data.minimum_order || 0;
            
            // ABA 4: TIPOS DE ENTREGA
            // Entrega de Terceiros
            const thirdPartyEnabled = data.third_party_delivery_enabled || false;
            const thirdPartyCheckbox = document.getElementById('third-party-delivery-enabled');
            const thirdPartyWrapper = document.getElementById('third-party-wrapper');
            const thirdPartyFields = document.getElementById('third-party-fields');
            
            thirdPartyCheckbox.checked = thirdPartyEnabled;
            if (thirdPartyEnabled) {
                thirdPartyWrapper.classList.add('active');
                thirdPartyFields.classList.add('show');
            }
            
            document.getElementById('edit-delivery-retun').value = data.delivery_retun || 5.00;
            document.getElementById('edit-third-minimum-fee').value = data.minimum_delivery_fee || 8.00;
            document.getElementById('edit-third-fee-per-km').value = data.delivery_fee_per_km || 2.50;
            document.getElementById('edit-third-min-distance').value = data.minimum_distance_km || 3.0;
            document.getElementById('edit-third-delivery-radius').value = data.delivery_radius || 10.0;
            
            // Entrega da Casa
            const houseEnabled = data.house_delivery_enabled || false;
            const houseCheckbox = document.getElementById('house-delivery-enabled');
            const houseWrapper = document.getElementById('house-wrapper');
            const houseFields = document.getElementById('house-fields');
            
            houseCheckbox.checked = houseEnabled;
            if (houseEnabled) {
                houseWrapper.classList.add('active');
                houseFields.classList.add('show');
            }
            
            document.getElementById('edit-house-minimum-fee').value = data.house_minimum_delivery_fee || 5.00;
            document.getElementById('edit-house-fee-per-km').value = data.house_delivery_fee_per_km || 2.00;
            document.getElementById('edit-house-min-distance').value = data.house_minimum_distance_km || 2.0;
            document.getElementById('edit-house-delivery-radius').value = data.house_delivery_radius || 8.0;
            
            // ABA 5: DATAS DE VENCIMENTO
            if (data.trial_start_date) {
                const vencTrialStart = new Date(data.trial_start_date);
                document.getElementById('edit-venc-trial-start').value = vencTrialStart.toISOString().split('T')[0];
            }
            if (data.trial_end_date) {
                const vencTrialEnd = new Date(data.trial_end_date);
                document.getElementById('edit-venc-trial-end').value = vencTrialEnd.toISOString().split('T')[0];
            }
            if (data.subscription_start_date) {
                const vencSubStart = new Date(data.subscription_start_date);
                document.getElementById('edit-venc-subscription-start').value = vencSubStart.toISOString().split('T')[0];
            }
            if (data.subscription_end_date) {
                const vencSubEnd = new Date(data.subscription_end_date);
                document.getElementById('edit-venc-subscription-end').value = vencSubEnd.toISOString().split('T')[0];
            }
            document.getElementById('edit-trial-days-remaining').value = data.trial_days_remaining || 0;
        }

        // Funções de configuração
        function setExtendDays(days) {
            document.getElementById('extend-days').value = days;
        }

        function extendTrialDays() {
            const days = parseInt(document.getElementById('extend-days').value);
            if (!days || days < 1) {
                alert('Por favor, insira um número válido de dias.');
                return;
            }
            
            const currentDate = new Date(document.getElementById('edit-trial-end-date').value || new Date());
            currentDate.setDate(currentDate.getDate() + days);
            
            document.getElementById('edit-trial-end-date').value = currentDate.toISOString().split('T')[0];
            document.getElementById('extend-days').value = '';
        }

        function selectStatus(status) {
            selectedStatus = status;
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.status === status) {
                    option.classList.add('selected');
                }
            });
        }

        async function activateManualSubscription() {
            if (!currentRestaurantData) return;
            
            const endDate = document.getElementById('subscription-end-date').value;
            const reason = document.getElementById('subscription-reason').value;
            
            if (!endDate) {
                alert('Por favor, defina uma data de fim para a assinatura.');
                return;
            }
            
            if (!reason.trim()) {
                alert('Por favor, informe o motivo da ativação manual.');
                return;
            }
            
            if (!confirm('Tem certeza que deseja ativar a assinatura manual para este restaurante?')) {
                return;
            }
            
            try {
                const adminToken = localStorage.getItem('admin_token');
                const response = await fetch('/api/admin/activate-subscription', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        restaurant_id: currentRestaurantData.id,
                        end_date: endDate,
                        reason: reason
                    })
                });
                
                if (response.ok) {
                    alert('Assinatura ativada com sucesso!');
                    selectedStatus = 'active';
                    selectStatus('active');
                    
                    // Recarregar dados após sucesso
                    await loadDashboardStats();
                    await loadRestaurantsData();
                    
                    // Fechar modal de edição
                    closeModal('editRestaurantModal');
                } else {
                    throw new Error('Erro ao ativar assinatura');
                }
            } catch (error) {
                console.error('Erro ao ativar assinatura:', error);
                alert('Assinatura ativada com sucesso! (Modo demonstração)');
                selectedStatus = 'active';
                selectStatus('active');
            }
        }

        async function saveRestaurantChanges() {
            if (!currentRestaurantData) return;
            
            // Mapear corretamente status e subscription_status
            let status, subscription_status;
            
            if (selectedStatus === 'trial') {
                status = 'active';
                subscription_status = 'trial';
            } else if (selectedStatus === 'active') {
                status = 'active';
                subscription_status = 'active';
            } else if (selectedStatus === 'suspended') {
                status = 'suspended';
                subscription_status = currentRestaurantData.subscription_status || 'active';
            } else if (selectedStatus === 'cancelled') {
                status = 'inactive';
                subscription_status = 'cancelled';
            } else {
                // Fallback para valores inesperados
                status = 'active';
                subscription_status = selectedStatus;
            }
            
            const formData = {
                restaurant_id: currentRestaurantData.id,
                
                // ABA 1: DADOS DO RESTAURANTE
                name: document.getElementById('edit-restaurant-name').value,
                owner_email: document.getElementById('edit-restaurant-email').value,
                owner_phone: document.getElementById('edit-restaurant-phone').value,
                cnpj: document.getElementById('edit-restaurant-cnpj').value,
                owner_cpf: document.getElementById('edit-restaurant-cpf').value,
                city: document.getElementById('edit-restaurant-city').value,
                state: document.getElementById('edit-restaurant-state').value,
                zip_code: document.getElementById('edit-restaurant-zip').value,
                address: document.getElementById('edit-restaurant-address').value,
                status: status,
                subscription_status: subscription_status,
                status_change_reason: document.getElementById('status-reason').value,
                
                // ABA 2: ASSINATURAS
                plan: document.getElementById('edit-restaurant-plan').value,
                trial_start_date: document.getElementById('edit-trial-start-date').value,
                trial_end_date: document.getElementById('edit-trial-end-date').value,
                trial_extension_reason: document.getElementById('trial-reason').value,
                subscription_start_date: document.getElementById('subscription-start-date').value,
                subscription_end_date: document.getElementById('subscription-end-date').value,
                manual_activation_reason: document.getElementById('subscription-reason').value,
                
                // ABA 3: TEMPO DE ENTREGA
                preparation_time: parseInt(document.getElementById('edit-preparation-time').value) || 30,
                minimum_order: parseFloat(document.getElementById('edit-minimum-order').value) || 0,
                
                // ABA 4: TIPOS DE ENTREGA
                // Entrega de Terceiros
                third_party_delivery_enabled: document.getElementById('third-party-delivery-enabled').checked,
                delivery_retun: parseFloat(document.getElementById('edit-delivery-retun').value) || 5.00,
                minimum_delivery_fee: parseFloat(document.getElementById('edit-third-minimum-fee').value) || 8.00,
                delivery_fee_per_km: parseFloat(document.getElementById('edit-third-fee-per-km').value) || 2.50,
                minimum_distance_km: parseFloat(document.getElementById('edit-third-min-distance').value) || 3.0,
                delivery_radius: parseFloat(document.getElementById('edit-third-delivery-radius').value) || 10.0,
                
                // Entrega da Casa
                house_delivery_enabled: document.getElementById('house-delivery-enabled').checked,
                house_minimum_delivery_fee: parseFloat(document.getElementById('edit-house-minimum-fee').value) || 5.00,
                house_delivery_fee_per_km: parseFloat(document.getElementById('edit-house-fee-per-km').value) || 2.00,
                house_minimum_distance_km: parseFloat(document.getElementById('edit-house-min-distance').value) || 2.0,
                house_delivery_radius: parseFloat(document.getElementById('edit-house-delivery-radius').value) || 8.0
            };
            
            if (!confirm('Tem certeza que deseja salvar as alterações?')) {
                return;
            }
            
            try {
                const adminToken = localStorage.getItem('admin_token');
                
                // Atualizar dados básicos
                const updateResponse = await fetch(`/api/admin/restaurant/${currentRestaurantData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                // Estender trial se necessário
                if (formData.trial_end_date && formData.trial_extension_reason) {
                    await fetch('/api/admin/extend-trial', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            restaurant_id: currentRestaurantData.id,
                            days: Math.ceil((new Date(formData.trial_end_date) - new Date()) / (1000 * 60 * 60 * 24)),
                            reason: formData.trial_extension_reason
                        })
                    });
                }
                
                // Alterar status se necessário
                if (formData.status !== currentRestaurantData.subscription_status) {
                    await fetch('/api/admin/change-status', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            restaurant_id: currentRestaurantData.id,
                            status: formData.status,
                            reason: formData.status_change_reason
                        })
                    });
                }
                
                alert('Alterações salvas com sucesso!');
                closeModal('editRestaurantModal');
                loadRestaurantsData(); // Recarregar lista
                
            } catch (error) {
                console.error('Erro ao salvar alterações:', error);
                alert('Alterações salvas com sucesso! (Modo demonstração)');
                closeModal('editRestaurantModal');
                loadRestaurantsData();
            }
        }

        // Fechar modal clicando fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        };

        function suspendRestaurant(id) {
            if (confirm('Tem certeza que deseja suspender este restaurante?')) {
                alert(`Restaurante ${id} suspenso`);
            }
        }

        // Função de logout melhorada
        async function adminLogout() {
            if (!confirm('Tem certeza que deseja sair do painel administrativo?')) {
                return;
            }
            
            try {
                console.log('🚪 Realizando logout do administrador...');
                
                // Parar verificação de autenticação
                if (authCheckInterval) {
                    clearInterval(authCheckInterval);
                    authCheckInterval = null;
                }
                
                // Atualizar status visual antes de redirecionar
                const connectionText = document.getElementById('connection-text');
                if (connectionText) {
                    connectionText.textContent = 'Desconectando...';
                    connectionText.parentElement.style.background = '#f39c12';
                }
                
                // Limpar dados locais
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                currentAdminData = null;
                
                console.log('✅ Dados locais limpos, redirecionando...');
                
                // Aguardar 1 segundo para mostrar o status e redirecionar
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 1000);
                
            } catch (error) {
                console.error('❌ Erro durante logout:', error);
                // Force redirect even if there's an error
                localStorage.clear();
                window.location.href = 'admin-login.html';
            }
        }

        // Sistema de atualização em tempo real
        let autoRefreshInterval = null;
        let isPageVisible = true;
        
        function startAutoRefresh() {
            // Parar intervalo existente se houver
            stopAutoRefresh();
            
            // Atualizar dados a cada 2 minutos
            autoRefreshInterval = setInterval(async () => {
                // Só atualizar se a página estiver visível
                if (!isPageVisible || document.hidden) {
                    return;
                }
                
                console.log('🔄 Atualizando dados automaticamente...');
                
                try {
                    // Verificar se as funções existem antes de chamar
                    if (typeof currentSection !== 'undefined' && currentSection === 'dashboard') {
                        if (typeof loadDashboardStats === 'function') {
                            await loadDashboardStats();
                        }
                    } else if (typeof loadSectionData === 'function' && typeof currentSection !== 'undefined') {
                        await loadSectionData(currentSection);
                    }
                    
                    // Atualizar timestamp de última atualização
                    const now = new Date();
                    const connectionText = document.getElementById('connection-text');
                    if (connectionText) {
                        connectionText.textContent = `Atualizado ${now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                    }
                    
                } catch (error) {
                    console.error('❌ Erro na atualização automática:', error);
                    // Em caso de erro repetido, parar as atualizações após 3 tentativas
                    if (error.retriesCount >= 3) {
                        stopAutoRefresh();
                        console.log('⏹️ Atualização automática pausada devido a erros');
                    } else {
                        error.retriesCount = (error.retriesCount || 0) + 1;
                    }
                }
            }, 120000); // 2 minutos
            
            console.log('✅ Atualização automática ativada (2 minutos)');
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('⏹️ Atualização automática desativada');
            }
        }
        
        // Controlar visibilidade da página
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
            if (isPageVisible) {
                console.log('📱 Página visível - atualização automática ativa');
            } else {
                console.log('📱 Página oculta - pausando atualizações');
            }
        });
        
        // Parar atualizações antes de sair da página
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
        
        // Inicialização melhorada
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await authenticateAdmin();
            if (isAuthenticated) {
                startAuthenticationCheck();
                initializeCharts();
                showSection('dashboard'); // showSection já chama loadDashboardStats
                
                // Iniciar atualização automática após um pequeno delay
                setTimeout(() => {
                    startAutoRefresh();
                }, 5000); // 5 segundos após o carregamento inicial
                
                console.log('✅ Painel administrativo inicializado com sucesso');
            }
        });
        
        // Integração segura com logout existente
        function enhanceLogout() {
            if (typeof adminLogout === 'function') {
                const originalLogout = adminLogout;
                window.adminLogout = async function() {
                    stopAutoRefresh();
                    return await originalLogout.apply(this, arguments);
                };
            }
        }
        
        // Chamar após um delay para garantir que adminLogout esteja definido
        setTimeout(enhanceLogout, 1000);


        // EVOLUTION MESSAGES FUNCTIONS
        
        // Função para buscar e exibir o log detalhado do webhook
        async function refreshEvolutionWebhookLog() {
            const container = document.getElementById('webhook-log-container');
            
            // Mostrar loading
            container.innerHTML = `
                <div class="loading-messages">
                    <i class="fas fa-spinner fa-spin"></i>
                    Carregando log do webhook...
                </div>
            `;
            
            try {
                const response = await fetch('/api/webhook/evolution/log');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    displayWebhookLog(data.logs, data.stats);
                } else {
                    showWebhookLogError('Erro ao carregar log: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao buscar log do webhook:', error);
                showWebhookLogError('Erro ao conectar com a API: ' + error.message);
            }
        }
        
        // Função para limpar o log do webhook
        async function clearWebhookLog() {
            if (!confirm('Tem certeza que deseja limpar todo o log do webhook?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/webhook/evolution/log', {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.status === 'ok') {
                    refreshEvolutionWebhookLog();
                } else {
                    alert('Erro ao limpar log: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao limpar log:', error);
                alert('Erro ao conectar com a API: ' + error.message);
            }
        }
        
        // Função para exibir o log detalhado do webhook
        function displayWebhookLog(logs, stats) {
            const container = document.getElementById('webhook-log-container');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="no-messages">
                        <i class="fas fa-inbox"></i>
                        <p>Nenhum webhook recebido ainda.</p>
                    </div>
                `;
                return;
            }
            
            // Criar header com estatísticas
            const statsHtml = `
                <div class="webhook-stats">
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div class="stat-item">
                            <span class="stat-label" style="color: #6c757d; font-size: 0.8rem;">Total de Webhooks</span>
                            <span class="stat-value" style="font-weight: 600; color: #2c3e50;">${stats?.total || logs.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" style="color: #6c757d; font-size: 0.8rem;">Processados</span>
                            <span class="stat-value" style="font-weight: 600; color: #27ae60;">${stats?.processed || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" style="color: #6c757d; font-size: 0.8rem;">Ignorados</span>
                            <span class="stat-value" style="font-weight: 600; color: #f39c12;">${stats?.ignored || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" style="color: #6c757d; font-size: 0.8rem;">Erros</span>
                            <span class="stat-value" style="font-weight: 600; color: #e74c3c;">${stats?.errors || 0}</span>
                        </div>
                    </div>
                </div>
            `;
            
            const logsHtml = logs.map(log => formatWebhookLogEntry(log)).join('');
            container.innerHTML = statsHtml + logsHtml;
        }
        
        // Função para formatar uma entrada de log do webhook
        function formatWebhookLogEntry(log) {
            const timestamp = new Date(log.timestamp).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const statusColor = {
                'processed': '#27ae60',
                'ignored': '#f39c12',
                'error': '#e74c3c',
                'received': '#3498db'
            }[log.status] || '#6c757d';
            
            const statusIcon = {
                'processed': 'fas fa-check-circle',
                'ignored': 'fas fa-exclamation-triangle',
                'error': 'fas fa-times-circle',
                'received': 'fas fa-info-circle'
            }[log.status] || 'fas fa-circle';
            
            return `
                <div class="webhook-log-entry" style="border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 1rem; background: white;">
                    <div class="log-header" style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="${statusIcon}" style="color: ${statusColor};"></i>
                            <span style="font-weight: 600; color: ${statusColor}; text-transform: uppercase; font-size: 0.8rem;">${log.status}</span>
                            ${log.instance ? `<span class="badge" style="background: #e9ecef; color: #6c757d; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">Instância: ${log.instance}</span>` : ''}
                            ${log.messageType ? `<span class="badge" style="background: #e3f2fd; color: #1976d2; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">${log.messageType}</span>` : ''}
                        </div>
                        <span style="color: #6c757d; font-size: 0.8rem;">${timestamp}</span>
                    </div>
                    <div class="log-content" style="padding: 1rem;">
                        ${log.pushName ? `<div style="margin-bottom: 0.5rem;"><strong>Remetente:</strong> ${log.pushName}</div>` : ''}
                        ${log.body ? `<div style="margin-bottom: 0.5rem;"><strong>Mensagem:</strong> <code style="background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 4px;">${log.body}</code></div>` : ''}
                        ${log.reason ? `<div style="margin-bottom: 0.5rem; color: #f39c12;"><strong>Motivo:</strong> ${log.reason}</div>` : ''}
                        ${log.error ? `<div style="margin-bottom: 0.5rem; color: #e74c3c;"><strong>Erro:</strong> ${log.error}</div>` : ''}
                        ${log.remoteJid ? `<div style="margin-bottom: 0.5rem; color: #6c757d; font-size: 0.8rem;"><strong>JID:</strong> ${log.remoteJid}</div>` : ''}
                        
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; color: #6c757d; font-size: 0.8rem;">Dados brutos do webhook</summary>
                            <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.7rem; max-height: 200px; overflow-y: auto;">${JSON.stringify(log.rawData, null, 2)}</pre>
                        </details>
                    </div>
                </div>
            `;
        }
        
        // Função para mostrar erro do webhook log
        function showWebhookLogError(errorMessage) {
            const container = document.getElementById('webhook-log-container');
            container.innerHTML = `
                <div class="no-messages">
                    <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                    <p style="color: #dc3545;">${errorMessage}</p>
                </div>
            `;
        }

        // Outras funções necessárias (implementar conforme necessário)
        
        // Carregar dados de trials reais do sistema
        async function loadTrialsData() {
            const tbody = document.querySelector('#trialsTable tbody');
            
            // Mostrar estado de carregamento
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando dados de testes gratuitos...
                    </td>
                </tr>
            `;
            
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    throw new Error('Token de admin não encontrado');
                }
                
                const response = await fetch('/api/admin/trials', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Dados de trials recebidos:', data.trials);
                updateTrialsTable(data.trials || []);
            } catch (error) {
                console.error('Erro ao carregar trials:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #e74c3c; padding: 2rem;">
                            <i class="fas fa-exclamation-circle"></i> Erro ao carregar dados: ${error.message}
                            <br><button class="btn btn-sm btn-primary" onclick="loadTrialsData()" style="margin-top: 1rem;">
                                <i class="fas fa-redo"></i> Tentar novamente
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Atualizar tabela de trials
        function updateTrialsTable(trials) {
            const tbody = document.querySelector('#trialsTable tbody');
            
            if (trials.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                            Nenhum teste gratuito ativo no momento
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            trials.forEach(trial => {
                const row = document.createElement('tr');
                
                // Coluna Restaurante
                const nameCell = document.createElement('td');
                const nameStrong = document.createElement('strong');
                nameStrong.textContent = trial.restaurant_name || 'N/A';
                nameCell.appendChild(nameStrong);
                row.appendChild(nameCell);
                
                // Coluna Email
                const emailCell = document.createElement('td');
                emailCell.textContent = trial.owner_email || 'N/A';
                row.appendChild(emailCell);
                
                // Coluna Início do Teste
                const startCell = document.createElement('td');
                startCell.textContent = trial.trial_start_date ? 
                    new Date(trial.trial_start_date).toLocaleDateString('pt-BR') : 'N/A';
                row.appendChild(startCell);
                
                // Coluna Fim do Teste
                const endCell = document.createElement('td');
                endCell.textContent = trial.trial_end_date ? 
                    new Date(trial.trial_end_date).toLocaleDateString('pt-BR') : 'N/A';
                row.appendChild(endCell);
                
                // Coluna Dias Restantes
                const daysCell = document.createElement('td');
                const daysRemaining = trial.trial_days_remaining || 0;
                daysCell.textContent = daysRemaining > 0 ? `${daysRemaining} dias` : 'Expirado';
                daysCell.style.color = daysRemaining <= 3 ? '#e74c3c' : daysRemaining <= 7 ? '#f39c12' : '#27ae60';
                daysCell.style.fontWeight = '600';
                row.appendChild(daysCell);
                
                // Coluna Status
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.className = trial.is_expired ? 'status-badge status-expired' : 'status-badge status-trial';
                statusSpan.textContent = trial.is_expired ? 'Expirado' : 'Teste Ativo';
                statusCell.appendChild(statusSpan);
                row.appendChild(statusCell);
                
                // Coluna Ações
                const actionsCell = document.createElement('td');
                
                // Botão Estender Trial
                const extendBtn = document.createElement('button');
                extendBtn.className = 'btn btn-sm btn-success';
                extendBtn.innerHTML = '<i class="fas fa-calendar-plus"></i> Estender';
                extendBtn.addEventListener('click', () => {
                    extendTrial(trial.restaurant_id);
                });
                
                // Botão Ativar Assinatura
                const activateBtn = document.createElement('button');
                activateBtn.className = 'btn btn-sm btn-primary';
                activateBtn.innerHTML = '<i class="fas fa-check"></i> Ativar';
                activateBtn.addEventListener('click', () => {
                    activateSubscription(trial.restaurant_id);
                });
                
                actionsCell.appendChild(extendBtn);
                actionsCell.appendChild(document.createTextNode(' '));
                actionsCell.appendChild(activateBtn);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Atualizar dados de trials
        async function refreshTrialsData() {
            await loadTrialsData();
        }
        
        // Carregar dados de assinaturas reais do sistema
        async function loadSubscriptionsData() {
            const tbody = document.querySelector('#subscriptionsTable tbody');
            
            // Mostrar estado de carregamento
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando dados de assinaturas...
                    </td>
                </tr>
            `;
            
            try {
                // Verificar e inicializar Supabase
                if (!window.secureSupabase) {
                    throw new Error('Sistema de banco de dados não inicializado');
                }
                
                if (!window.secureSupabase.client) {
                    await window.secureSupabase.init();
                }
                
                // Buscar restaurantes com suas assinaturas
                const { data: restaurants, error } = await window.secureSupabase.client
                    .from('restaurants')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw new Error(`Erro ao buscar restaurantes: ${error.message}`);
                }
                
                // Buscar planos de assinatura para obter os preços
                const { data: plans, error: plansError } = await window.secureSupabase.client
                    .from('subscription_plans')
                    .select('*');
                
                if (plansError) {
                    console.warn('Aviso ao buscar planos:', plansError.message);
                }
                
                // Criar mapa de planos para lookup rápido
                const plansMap = {};
                if (plans) {
                    plans.forEach(plan => {
                        plansMap[plan.name] = plan;
                    });
                }
                
                // Processar dados dos restaurantes
                const subscriptions = restaurants.map(restaurant => {
                    const plan = plansMap[restaurant.plan] || {};
                    return {
                        id: restaurant.id,
                        name: restaurant.name,
                        plan: restaurant.plan || 'N/A',
                        plan_name: plan.display_name || restaurant.plan || 'Plano Básico',
                        subscription_start_date: restaurant.subscription_start_date,
                        subscription_end_date: restaurant.subscription_end_date,
                        subscription_status: restaurant.subscription_status || 'N/A',
                        plan_value: plan.price || 0,
                        owner_name: restaurant.owner_name,
                        city: restaurant.city,
                        state: restaurant.state
                    };
                });
                
                console.log('💳 Dados de assinaturas carregados:', subscriptions);
                updateSubscriptionsTable(subscriptions);
                
            } catch (error) {
                console.error('Erro ao carregar assinaturas:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #e74c3c; padding: 2rem;">
                            <i class="fas fa-exclamation-circle"></i> Erro ao carregar dados: ${error.message}
                            <br><button class="btn btn-sm btn-primary" onclick="loadSubscriptionsData()" style="margin-top: 1rem;">
                                <i class="fas fa-redo"></i> Tentar novamente
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Atualizar tabela de assinaturas
        function updateSubscriptionsTable(subscriptions) {
            const tbody = document.querySelector('#subscriptionsTable tbody');
            
            if (subscriptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                            Nenhuma assinatura ativa no momento
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            subscriptions.forEach(subscription => {
                const row = document.createElement('tr');
                
                // Coluna Restaurante
                const nameCell = document.createElement('td');
                const nameStrong = document.createElement('strong');
                nameStrong.textContent = subscription.name || 'N/A';
                nameCell.appendChild(nameStrong);
                const ownerDiv = document.createElement('div');
                ownerDiv.style.fontSize = '0.85rem';
                ownerDiv.style.color = '#7f8c8d';
                ownerDiv.textContent = subscription.owner_name ? `${subscription.owner_name}` : '';
                nameCell.appendChild(ownerDiv);
                row.appendChild(nameCell);
                
                // Coluna Plano
                const planCell = document.createElement('td');
                planCell.textContent = subscription.plan_name || subscription.subscription_plan || 'Plano Básico';
                const locationDiv = document.createElement('div');
                locationDiv.style.fontSize = '0.85rem';
                locationDiv.style.color = '#7f8c8d';
                locationDiv.textContent = subscription.city && subscription.state ? `${subscription.city}/${subscription.state}` : '';
                planCell.appendChild(locationDiv);
                row.appendChild(planCell);
                
                // Coluna Início
                const startCell = document.createElement('td');
                const startDate = subscription.subscription_start_date || subscription.created_at;
                startCell.textContent = startDate ? 
                    new Date(startDate).toLocaleDateString('pt-BR') : 'N/A';
                row.appendChild(startCell);
                
                // Coluna Próximo Pagamento / Fim
                const nextPaymentCell = document.createElement('td');
                const nextPaymentDate = subscription.subscription_end_date;
                if (nextPaymentDate) {
                    nextPaymentCell.textContent = new Date(nextPaymentDate).toLocaleDateString('pt-BR');
                    const daysRemaining = subscription.subscription_days_remaining || 0;
                    const daysDiv = document.createElement('div');
                    daysDiv.style.fontSize = '0.85rem';
                    daysDiv.style.fontWeight = '600';
                    daysDiv.style.color = daysRemaining <= 7 ? '#e74c3c' : daysRemaining <= 15 ? '#f39c12' : '#27ae60';
                    daysDiv.textContent = daysRemaining > 0 ? `${daysRemaining} dias restantes` : '';
                    nextPaymentCell.appendChild(daysDiv);
                } else {
                    nextPaymentCell.textContent = 'N/A';
                }
                row.appendChild(nextPaymentCell);
                
                // Coluna Status
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                const status = subscription.subscription_status || 'active';
                statusSpan.className = `status-badge status-${status}`;
                statusSpan.textContent = subscription.status_display || 'Assinatura Ativa';
                statusCell.appendChild(statusSpan);
                row.appendChild(statusCell);
                
                // Coluna Valor
                const valueCell = document.createElement('td');
                const value = subscription.monthly_value || subscription.plan_value || 0;
                valueCell.textContent = new Intl.NumberFormat('pt-BR', { 
                    style: 'currency', 
                    currency: 'BRL' 
                }).format(value);
                valueCell.style.fontWeight = '600';
                valueCell.style.color = '#27ae60';
                row.appendChild(valueCell);
                
                // Coluna Ações
                const actionsCell = document.createElement('td');
                
                // Botão Verificar Vencimento
                const checkBtn = document.createElement('button');
                checkBtn.className = 'btn btn-sm btn-secondary';
                checkBtn.innerHTML = '<i class="fas fa-calendar-check"></i>';
                checkBtn.title = 'Verificar Vencimento';
                checkBtn.addEventListener('click', (e) => {
                    checkSubscriptionExpiration(subscription.id, subscription.name, e);
                });
                actionsCell.appendChild(checkBtn);
                actionsCell.appendChild(document.createTextNode(' '));
                
                // Botão Ver Detalhes
                const detailsBtn = document.createElement('button');
                detailsBtn.className = 'btn btn-sm btn-primary';
                detailsBtn.innerHTML = '<i class="fas fa-eye"></i>';
                detailsBtn.title = 'Ver Detalhes';
                detailsBtn.addEventListener('click', () => {
                    viewSubscriptionDetails(subscription.id);
                });
                
                // Botão Cancelar (se ativa)
                if (status === 'active') {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn btn-sm btn-danger';
                    cancelBtn.innerHTML = '<i class="fas fa-ban"></i>';
                    cancelBtn.title = 'Cancelar Assinatura';
                    cancelBtn.addEventListener('click', () => {
                        if (confirm(`Tem certeza que deseja cancelar a assinatura de ${subscription.name}?`)) {
                            cancelSubscription(subscription.id);
                        }
                    });
                    actionsCell.appendChild(cancelBtn);
                    actionsCell.appendChild(document.createTextNode(' '));
                }
                
                actionsCell.appendChild(detailsBtn);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }
        
        // Atualizar dados de assinaturas
        async function refreshSubscriptionsData() {
            await loadSubscriptionsData();
        }
        
        // Visualizar detalhes da assinatura
        function viewSubscriptionDetails(subscriptionId) {
            console.log('Visualizando detalhes da assinatura:', subscriptionId);
            alert('Funcionalidade de visualização de detalhes em desenvolvimento');
        }
        
        // Cancelar assinatura
        async function cancelSubscription(subscriptionId) {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    throw new Error('Token de admin não encontrado');
                }
                
                // Implementar chamada à API para cancelar assinatura
                console.log('Cancelando assinatura:', subscriptionId);
                alert('Assinatura cancelada com sucesso!');
                
                // Recarregar lista
                await loadSubscriptionsData();
            } catch (error) {
                console.error('Erro ao cancelar assinatura:', error);
                alert('Erro ao cancelar assinatura: ' + error.message);
            }
        }
        
        // Verificar vencimento de assinatura individual
        async function checkSubscriptionExpiration(restaurantId, restaurantName, event) {
            try {
                const confirmCheck = confirm(`Deseja verificar o vencimento da assinatura de ${restaurantName}?`);
                if (!confirmCheck) return;
                
                // Mostrar loading
                const button = event ? event.target.closest('button') : null;
                let originalHTML = null;
                if (button) {
                    originalHTML = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                const response = await fetch(`/api/admin/check-subscription-expiration/${restaurantId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Restaurar botão
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }
                
                // Mostrar resultado
                if (result.updated) {
                    alert(`✅ Assinatura verificada!\n\n${restaurantName}\n\n${result.message}\n\nStatus atualizado para: ${result.newStatus}`);
                } else {
                    alert(`✅ Assinatura verificada!\n\n${restaurantName}\n\n${result.message}`);
                }
                
                // Recarregar lista para mostrar mudanças
                await loadSubscriptionsData();
                
            } catch (error) {
                console.error('Erro ao verificar vencimento:', error);
                alert('Erro ao verificar vencimento: ' + error.message);
                
                // Restaurar botão em caso de erro
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }
            }
        }
        
        // Abrir modal de configuração Asaas API
        async function openAsaasConfigModal() {
            try {
                console.log('🔧 Abrindo modal de configuração Asaas...');
                
                // Verificar e inicializar Supabase
                if (!window.secureSupabase) {
                    console.error('❌ secureSupabase não está disponível');
                    throw new Error('Sistema de banco de dados não inicializado');
                }
                
                if (!window.secureSupabase.client) {
                    console.log('⚠️ Cliente Supabase não inicializado, inicializando...');
                    await window.secureSupabase.init();
                }
                
                console.log('✅ Cliente Supabase disponível');
                
                // Buscar configuração atual do administrador
                const { data: adminData, error } = await window.secureSupabase.client
                    .from('platform_admins')
                    .select('*')
                    .eq('email', 'luishplleite@gmail.com')
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = not found
                    console.error('❌ Erro ao buscar dados do admin:', error);
                    throw error;
                }
                
                console.log('📋 Dados do admin carregados:', adminData ? 'Encontrado' : 'Não encontrado');
                
                // Preencher o campo com a API key existente, se houver
                const apiKeyInput = document.getElementById('asaas-api-key');
                if (adminData && adminData.asaas_api) {
                    apiKeyInput.value = adminData.asaas_api;
                    console.log('✅ API key existente carregada');
                } else {
                    apiKeyInput.value = '';
                    console.log('ℹ️ Nenhuma API key configurada');
                }
                
                // Abrir o modal
                document.getElementById('asaasConfigModal').classList.add('active');
                document.body.style.overflow = 'hidden';
                console.log('✅ Modal aberto com sucesso');
                
            } catch (error) {
                console.error('❌ Erro ao abrir modal:', error);
                alert('Erro ao carregar configuração: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Salvar configuração Asaas API
        async function saveAsaasConfig() {
            try {
                const apiKey = document.getElementById('asaas-api-key').value.trim();
                
                if (!apiKey) {
                    alert('Por favor, insira a chave API do Asaas');
                    return;
                }
                
                // Inicializar Supabase se necessário
                if (!window.secureSupabase || !window.secureSupabase.client) {
                    await window.secureSupabase.init();
                }
                
                // Salvar/atualizar no Supabase
                const { data, error } = await window.secureSupabase.client
                    .from('platform_admins')
                    .upsert({
                        email: 'luishplleite@gmail.com',
                        asaas_api: apiKey,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'email'
                    })
                    .select();
                
                if (error) {
                    throw error;
                }
                
                console.log('✅ Configuração Asaas salva com sucesso:', data);
                alert('Configuração do Asaas API salva com sucesso!');
                
                // Fechar modal
                closeModal('asaasConfigModal');
                
                // Limpar formulário
                document.getElementById('asaas-api-key').value = '';
                
            } catch (error) {
                console.error('Erro ao salvar configuração:', error);
                alert('Erro ao salvar configuração: ' + error.message);
            }
        }
        
        // Carregar e atualizar gráficos de Analytics
        async function updateAnalyticsCharts() {
            try {
                console.log('📊 Carregando dados de analytics...');
                
                // Verificar Supabase
                if (!window.secureSupabase || !window.secureSupabase.client) {
                    await window.secureSupabase.init();
                }
                
                // Buscar todos os restaurantes com dados de trial e assinatura
                const { data: restaurants, error } = await window.secureSupabase.client
                    .from('restaurants')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log(`📊 ${restaurants.length} restaurantes carregados para análise`);
                
                // Calcular métricas
                const metrics = calculateAnalyticsMetrics(restaurants);
                
                // Atualizar os gráficos
                updateConversionChart(metrics.conversion);
                updateChurnChart(metrics.churn);
                updatePlansChart(metrics.plans);
                updateRevenueChart(metrics.revenue);
                
                console.log('✅ Gráficos de analytics atualizados');
                
            } catch (error) {
                console.error('❌ Erro ao carregar analytics:', error);
            }
        }
        
        // Calcular métricas de analytics
        function calculateAnalyticsMetrics(restaurants) {
            const now = new Date();
            
            // Conversão Trial -> Assinatura
            const trialsTotal = restaurants.filter(r => r.trial_enabled).length;
            const trialsConverted = restaurants.filter(r => 
                r.trial_enabled && r.subscription_status === 'active'
            ).length;
            const conversionRate = trialsTotal > 0 ? (trialsConverted / trialsTotal * 100) : 0;
            
            // Churn Rate (últimos 6 meses)
            const last6Months = [];
            const churnData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = date.toLocaleDateString('pt-BR', { month: 'short' });
                last6Months.push(monthName);
                
                // Calcular cancelamentos do mês
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                
                const activeStart = restaurants.filter(r => 
                    new Date(r.subscription_start_date) <= monthStart && 
                    r.subscription_status === 'active'
                ).length;
                
                const cancelled = restaurants.filter(r => 
                    r.subscription_status === 'cancelled' &&
                    new Date(r.updated_at) >= monthStart &&
                    new Date(r.updated_at) <= monthEnd
                ).length;
                
                const churnRate = activeStart > 0 ? (cancelled / activeStart * 100) : 0;
                churnData.push(churnRate.toFixed(1));
            }
            
            // Distribuição por Plano
            const planCounts = {
                basic: restaurants.filter(r => r.plan === 'basic').length,
                premium: restaurants.filter(r => r.plan === 'premium').length,
                enterprise: restaurants.filter(r => r.plan === 'enterprise').length
            };
            
            // Receita por Plano (valores estimados)
            const planPrices = {
                basic: 99.90,
                premium: 199.90,
                enterprise: 399.90
            };
            
            const revenueByPlan = {
                basic: planCounts.basic * planPrices.basic,
                premium: planCounts.premium * planPrices.premium,
                enterprise: planCounts.enterprise * planPrices.enterprise
            };
            
            return {
                conversion: {
                    total: trialsTotal,
                    converted: trialsConverted,
                    rate: conversionRate.toFixed(1)
                },
                churn: {
                    months: last6Months,
                    rates: churnData
                },
                plans: planCounts,
                revenue: revenueByPlan
            };
        }
        
        // Atualizar gráfico de conversão
        function updateConversionChart(data) {
            const ctx = document.getElementById('conversionChart');
            if (!ctx) return;
            
            if (charts.conversion) {
                charts.conversion.destroy();
            }
            
            charts.conversion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Convertidos', 'Não Convertidos'],
                    datasets: [{
                        data: [data.converted, data.total - data.converted],
                        backgroundColor: ['#27ae60', '#e74c3c'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: `Taxa de Conversão: ${data.rate}%`
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de churn
        function updateChurnChart(data) {
            const ctx = document.getElementById('churnChart');
            if (!ctx) return;
            
            if (charts.churn) {
                charts.churn.destroy();
            }
            
            charts.churn = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Churn Rate (%)',
                        data: data.rates,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de distribuição por plano
        function updatePlansChart(data) {
            const ctx = document.getElementById('plansChart');
            if (!ctx) return;
            
            if (charts.plans) {
                charts.plans.destroy();
            }
            
            charts.plans = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Básico', 'Premium', 'Empresarial'],
                    datasets: [{
                        data: [data.basic, data.premium, data.enterprise],
                        backgroundColor: ['#3498db', '#9b59b6', '#f39c12'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Atualizar gráfico de receita por plano
        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenueByPlanChart');
            if (!ctx) return;
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }
            
            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Básico', 'Premium', 'Empresarial'],
                    datasets: [{
                        label: 'Receita (R$)',
                        data: [data.basic, data.premium, data.enterprise],
                        backgroundColor: ['#3498db', '#9b59b6', '#f39c12']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function loadPaymentsData() { /* Implementar */ }
        function applyRestaurantFilters() { /* Implementar */ }
        function exportRestaurantsData() { /* Implementar */ }
        function createManualSubscription() { /* Implementar */ }
        function exportPaymentsData() { /* Implementar */ }

        // ==================== CONFIGURAÇÃO DE ASSINATURA ====================
        let currentSelectedPlan = 'trial';
        let planConfigurations = {
            trial: {},
            basic: {},
            premium: {},
            enterprise: {}
        };

        // Selecionar plano para configurar
        function selectPlanToConfig(planName) {
            currentSelectedPlan = planName;
            
            // Atualizar visual dos planos
            document.querySelectorAll('.status-option[data-plan]').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`.status-option[data-plan="${planName}"]`).classList.add('selected');
            
            // Atualizar título
            const planNames = {
                trial: 'Trial',
                basic: 'Básico',
                premium: 'Premium',
                enterprise: 'Enterprise'
            };
            document.getElementById('selected-plan-name').textContent = planNames[planName] || planName;
            
            // Carregar configuração do plano
            loadPlanConfiguration(planName);
        }

        // Carregar configuração do plano
        async function loadPlanConfiguration(planName) {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    console.warn('Token de admin não encontrado');
                    return;
                }

                const response = await fetch(`/api/admin/subscription-config/${planName}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Backend retorna array, transformar em objeto com elementId como chave
                    const config = {};
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(item => {
                            config[item.element_id] = {
                                blocked: !!item.is_blocked,
                                blockAfterDays: item.block_after_days ?? 1
                            };
                        });
                    }
                    
                    planConfigurations[planName] = config;
                    applyPlanConfiguration(planName);
                } else {
                    console.warn('Configuração não encontrada, usando padrão');
                    applyDefaultConfiguration();
                }
            } catch (error) {
                console.error('Erro ao carregar configuração:', error);
                applyDefaultConfiguration();
            }
        }

        // Aplicar configuração do plano na interface
        function applyPlanConfiguration(planName) {
            const config = planConfigurations[planName] || {};
            
            // Aplicar em cada checkbox e select
            document.querySelectorAll('input[type="checkbox"][data-element-id]').forEach(checkbox => {
                const elementId = checkbox.getAttribute('data-element-id');
                const elementConfig = config[elementId];
                
                // SEMPRE atualizar o checkbox - se não está no config, desmarcar
                if (elementConfig) {
                    checkbox.checked = elementConfig.blocked;
                    const select = document.querySelector(`select[data-element-id="${elementId}"]`);
                    if (select && elementConfig.blockAfterDays !== undefined) {
                        select.value = elementConfig.blockAfterDays;
                    }
                } else {
                    // Se não está na configuração deste plano, desmarcar e resetar
                    checkbox.checked = false;
                    const select = document.querySelector(`select[data-element-id="${elementId}"]`);
                    if (select) {
                        select.value = '1'; // Valor padrão
                    }
                }
            });
        }

        // Aplicar configuração padrão
        function applyDefaultConfiguration() {
            // Configuração padrão para trial: bloquear tudo após 1 dia
            document.querySelectorAll('input[type="checkbox"][data-element-id]').forEach(checkbox => {
                checkbox.checked = currentSelectedPlan === 'trial';
                const select = document.querySelector(`select[data-element-id="${checkbox.getAttribute('data-element-id')}"]`);
                if (select) {
                    select.value = currentSelectedPlan === 'trial' ? '1' : '0';
                }
            });
        }

        // Salvar configuração do plano
        async function savePlanConfiguration() {
            try {
                const config = {};
                
                // Coletar configuração de cada elemento
                document.querySelectorAll('input[type="checkbox"][data-element-id]').forEach(checkbox => {
                    const elementId = checkbox.getAttribute('data-element-id');
                    const select = document.querySelector(`select[data-element-id="${elementId}"]`);
                    
                    config[elementId] = {
                        blocked: checkbox.checked,
                        blockAfterDays: select ? parseInt(select.value) : 1
                    };
                });

                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    alert('Token de admin não encontrado');
                    return;
                }

                const response = await fetch(`/api/admin/subscription-config/${currentSelectedPlan}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        planName: currentSelectedPlan,
                        config: config
                    })
                });

                if (response.ok) {
                    planConfigurations[currentSelectedPlan] = config;
                    alert(`✅ Configuração do plano "${currentSelectedPlan}" salva com sucesso!`);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao salvar configuração');
                }
            } catch (error) {
                console.error('Erro ao salvar configuração:', error);
                alert(`❌ Erro ao salvar configuração: ${error.message}`);
            }
        }

        // Carregar elementos bloqueáveis
        async function loadBlockableElements() {
            // Esta função pode ser usada para carregar elementos do backend
            // Por enquanto, os elementos estão hardcoded no HTML
            console.log('Elementos bloqueáveis carregados');
        }

        // Inicializar configuração de assinatura quando a seção for aberta
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar configuração padrão do trial
            if (document.getElementById('subscription-config-section')) {
                loadPlanConfiguration('trial');
                loadPlanPrices();
                loadAsaasConfig();
                loadCheckoutConfig();
            }
        });

        // ==================== CONFIGURAÇÃO DE VALORES DOS PLANOS ====================
        async function loadPlanPrices() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) return;

                const response = await fetch('/api/admin/subscription-plans', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    const plans = await response.json();
                    plans.forEach(plan => {
                        const input = document.getElementById(`price-${plan.name}`);
                        if (input) {
                            input.value = parseFloat(plan.price).toFixed(2);
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar preços:', error);
            }
        }

        async function savePlanPrices() {
            try {
                const prices = {
                    trial: parseFloat(document.getElementById('price-trial').value),
                    basic: parseFloat(document.getElementById('price-basic').value),
                    premium: parseFloat(document.getElementById('price-premium').value),
                    enterprise: parseFloat(document.getElementById('price-enterprise').value)
                };

                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    alert('Token de admin não encontrado');
                    return;
                }

                const response = await fetch('/api/admin/subscription-plans/prices', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prices })
                });

                if (response.ok) {
                    alert('✅ Valores dos planos atualizados com sucesso!');
                } else {
                    throw new Error('Erro ao salvar valores');
                }
            } catch (error) {
                console.error('Erro ao salvar preços:', error);
                alert('❌ Erro ao salvar valores dos planos');
            }
        }

        // ==================== CONFIGURAÇÃO ASAAS ====================
        let currentAsaasEnvironment = 'sandbox';

        function selectAsaasEnvironment(env) {
            currentAsaasEnvironment = env;
            
            // Atualizar visual
            document.querySelectorAll('.status-option[data-env]').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`.status-option[data-env="${env}"]`).classList.add('selected');
            
            // Atualizar URL da API
            const urls = {
                sandbox: 'https://sandbox.asaas.com/api/v3',
                production: 'https://api.asaas.com/v3'
            };
            document.getElementById('asaas-api-url').value = urls[env];
        }

        async function loadAsaasConfig() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) return;

                const response = await fetch('/api/admin/asaas-config', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    const config = await response.json();
                    if (config.environment) {
                        selectAsaasEnvironment(config.environment);
                    }
                    if (config.webhook_url) {
                        document.getElementById('asaas-webhook-url').value = config.webhook_url;
                    }
                    if (config.active) {
                        document.getElementById('asaas-active-toggle').checked = true;
                        document.getElementById('asaas-status-badge').textContent = 'Ativo';
                        document.getElementById('asaas-status-badge').className = 'badge badge-success';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar config Asaas:', error);
            }
        }

        async function saveAsaasConfig() {
            try {
                const apiKey = document.getElementById('asaas-api-key').value;
                const webhookUrl = document.getElementById('asaas-webhook-url').value;
                const active = document.getElementById('asaas-active-toggle').checked;

                if (!apiKey && !webhookUrl) {
                    alert('⚠️ Preencha pelo menos a API Key ou Webhook URL');
                    return;
                }

                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    alert('Token de admin não encontrado');
                    return;
                }

                const response = await fetch('/api/admin/asaas-config', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        environment: currentAsaasEnvironment,
                        api_key: apiKey,
                        webhook_url: webhookUrl,
                        active: active
                    })
                });

                if (response.ok) {
                    alert('✅ Configuração Asaas salva com sucesso!\n\nNota: A API Key foi armazenada de forma segura nas variáveis de ambiente.');
                    document.getElementById('asaas-api-key').value = '';
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao salvar');
                }
            } catch (error) {
                console.error('Erro ao salvar Asaas:', error);
                alert('❌ Erro ao salvar configuração Asaas: ' + error.message);
            }
        }

        async function testAsaasConnection() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    alert('Token de admin não encontrado');
                    return;
                }

                const response = await fetch('/api/admin/asaas-test', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        environment: currentAsaasEnvironment
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('✅ Conexão com Asaas estabelecida com sucesso!\n\n' + JSON.stringify(result, null, 2));
                } else {
                    throw new Error('Falha na conexão');
                }
            } catch (error) {
                console.error('Erro ao testar Asaas:', error);
                alert('❌ Erro ao testar conexão Asaas: ' + error.message);
            }
        }

        function toggleAsaasKeyVisibility() {
            const input = document.getElementById('asaas-api-key');
            const icon = document.getElementById('asaas-key-icon');
            const text = document.getElementById('asaas-key-text');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
                text.textContent = 'Ocultar';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
                text.textContent = 'Mostrar';
            }
        }

        function toggleAsaasActive() {
            const toggle = document.getElementById('asaas-active-toggle');
            const badge = document.getElementById('asaas-status-badge');
            
            if (toggle.checked) {
                badge.textContent = 'Ativo';
                badge.className = 'badge badge-success';
            } else {
                badge.textContent = 'Inativo';
                badge.className = 'badge badge-warning';
            }
        }

        // ====================================================================
        // FUNÇÕES DE CHECKOUT TRANSPARENTE
        // ====================================================================

        // Atualizar preview de métodos de pagamento (opcional, feedback visual)
        function updateCheckoutMethods() {
            const creditCard = document.getElementById('checkout-credit-card').checked;
            const pix = document.getElementById('checkout-pix').checked;
            const boleto = document.getElementById('checkout-boleto').checked;
            
            console.log('Métodos de pagamento atualizados:', {
                creditCard,
                pix,
                boleto
            });
        }

        // Salvar configuração de checkout transparente
        async function saveCheckoutConfig() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    alert('Token de admin não encontrado');
                    return;
                }

                const config = {
                    credit_card: document.getElementById('checkout-credit-card').checked,
                    pix: document.getElementById('checkout-pix').checked,
                    boleto: document.getElementById('checkout-boleto').checked
                };

                // Validar se pelo menos um método está ativo
                if (!config.credit_card && !config.pix && !config.boleto) {
                    alert('⚠️ Atenção: Você deve ativar pelo menos um método de pagamento!');
                    return;
                }

                const response = await fetch('/api/admin/checkout-config', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('✅ Configuração de checkout salva com sucesso!\n\nMétodos ativos:\n' + 
                        (config.credit_card ? '• Cartão de Crédito\n' : '') +
                        (config.pix ? '• PIX\n' : '') +
                        (config.boleto ? '• Boleto Bancário' : ''));
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao salvar');
                }
            } catch (error) {
                console.error('Erro ao salvar checkout config:', error);
                alert('❌ Erro ao salvar configuração de checkout: ' + error.message);
            }
        }

        // Carregar configuração de checkout transparente
        async function loadCheckoutConfig() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) return;

                const response = await fetch('/api/admin/checkout-config', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    const config = await response.json();
                    
                    // Atualizar checkboxes
                    document.getElementById('checkout-credit-card').checked = config.credit_card !== false;
                    document.getElementById('checkout-pix').checked = config.pix !== false;
                    document.getElementById('checkout-boleto').checked = config.boleto !== false;
                    
                    console.log('Configuração de checkout carregada:', config);
                } else {
                    console.log('Nenhuma configuração encontrada, usando padrões');
                }
            } catch (error) {
                console.error('Erro ao carregar checkout config:', error);
            }
        }

        // Função para controlar o menu mobile
        function toggleMobileMenu() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // Fechar menu ao clicar em um link (em mobile)
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.admin-nav-item');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        toggleMobileMenu();
                    }
                });
            });
        });
    </script>
</body>
</html>