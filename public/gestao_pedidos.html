<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Pedidos - TimePulse AI</title>
    
    <!-- Sistema de oculta√ß√£o de logs para produ√ß√£o - TEMPORARIAMENTE DESABILITADO PARA DEBUG -->
    <script>
        // Debug mode - logs habilitados temporariamente
        console.log('üîß DEBUG MODE: Console logs habilitados');
    </script>
    <meta name="description" content="Gerencie pedidos, acompanhe entregas e controle seu neg√≥cio">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self' https: wss: *.supabase.co; font-src 'self' https:; object-src 'none'; media-src 'self'; frame-src 'none'; script-src-attr 'unsafe-inline';"
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/secure-config.js"></script>
    <!-- Sistema de Teste Gratuito -->
    <script src="js/trial-countdown.js"></script>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        /* Gest√£o de pedidos - styles espec√≠ficos da p√°gina */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .restaurant-name {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
            overflow-y: auto;
            flex: 1;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            color: #6c757d;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #495057;
            text-decoration: none;
            transition: var(--transition);
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(40, 167, 69, 0.1); /* Cor transparente do verde */
            color: var(--primary-color);
        }
        
        .nav-link.active .nav-icon {
            color: var(--primary-color);
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            color: #6c757d; /* √çcones escuros por padr√£o */
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            transition: var(--transition);
        }

        /* --- Altera√ß√µes aqui para o fundo branco e sombra do cabe√ßalho da p√°gina --- */
        .page-header {
            background: white; /* Fundo branco */
            color: #333; /* Cor do texto para contraste */
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); /* Sombra mais pronunciada */
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color); /* Mant√©m a cor verde para o t√≠tulo */
        }
        
        .page-title i {
            margin-right: 1rem;
            color: var(--primary-color);
        }
        
        .page-header-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .page-subtitle {
            font-size: 1rem;
            opacity: 0.8;
            color: #6c757d; /* Cor do subt√≠tulo para contraste */
        }
        /* --- Fim das altera√ß√µes --- */

        .page-title i {
            margin-right: 1rem;
            color: var(--primary-color);
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 1rem;
        }

        .page-actions {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filters-section {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .filter-input, .form-input {
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: var(--transition);
            width: 100%;
        }

        .filter-input:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #ced4da;
            color: var(--dark-color);
        }

        .btn-outline:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            min-width: auto;
        }

        .item-actions-cell {
            text-align: center;
            white-space: nowrap;
        }

        .orders-section {
            padding: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-header-left h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .section-header-left h2 i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .section-header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .online-toggle, .fullscreen-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            white-space: nowrap;
        }

        .online-toggle.online {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .online-toggle.offline {
            border-color: #6c757d;
            color: #6c757d;
        }

        /* Fullscreen Mode */
        body.fullscreen-mode {
            overflow: hidden;
        }

        body.fullscreen-mode .sidebar {
            display: none !important;
        }

        body.fullscreen-mode .sidebar-overlay {
            display: none !important;
        }

        body.fullscreen-mode .main-content {
            margin-left: 0;
            padding: 1rem;
            width: 100vw;
            height: 100vh;
        }

        body.fullscreen-mode .page-header {
            border-radius: 0;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
        }

        body.fullscreen-mode .orders-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Modais no modo fullscreen */
        body.fullscreen-mode .modal {
            z-index: 10000;
            position: fixed;
        }

        body.fullscreen-mode .modal-content {
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        body.fullscreen-mode .modal-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sector-filters {
            margin-bottom: 2rem;
        }

        .sector-filters-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sector-filter-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            background: white;
            color: var(--dark-color);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .sector-filter-btn.active {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .sector-filter-btn:hover:not(.active) {
            border-color: var(--primary-color);
            background-color: rgba(25, 118, 210, 0.05);
        }

        .orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .order-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 200px;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-color);
        }

        .order-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .status-novo { background: #fff3cd; color: #856404; }
        .status-aceito { background: #d1ecf1; color: #0c5460; }
        .status-preparo { background: #d1ecf1; color: #0c5460; }
        .status-pronto { background: #d4edda; color: #155724; }
        .status-saiu_entrega { background: #e2e3e5; color: #383d41; }
        .status-entregue { background: #d4edda; color: #155724; }
        .status-Aberta { background: #cce7ff; color: #004085; }
        .status-encerrado { background: #f8f9fa; color: #6c757d; }
        .status-rejeitado { background: #f8d7da; color: #721c24; }
        .status-cancelado { background: #f8d7da; color: #721c24; }

        .order-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .order-type-icon {
            padding: 0.5rem;
            border-radius: 50%;
            background: rgba(25, 118, 210, 0.1);
            color: var(--primary-color);
        }

        .order-customer {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .order-details {
            margin: 1rem 0;
            flex: 1;
        }

        .order-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #6c757d;
        }

        .order-detail i {
            width: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            margin-top: auto;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .order-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: #6c757d;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            max-width: 98vw;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            width: 100%;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: #f8f9fa;
            color: var(--dark-color);
        }

        .modal-body {
            padding: 1rem;
        }
        
        .delivery-modal .modal-body {
            padding: 0.75rem 1rem;
        }

        .order-type-selection {
            text-align: center;
        }

        .order-type-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .order-type-subtitle {
            color: #6c757d;
            margin-bottom: 2rem;
        }

        .order-type-buttons {
            display: grid;
            gap: 1rem;
        }

        .order-type-btn {
            padding: 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .order-type-btn:hover {
            border-color: var(--primary-color);
            background-color: rgba(25, 118, 210, 0.05);
        }

        .order-type-btn.delivery:hover { border-color: #007bff; background-color: rgba(0, 123, 255, 0.05); }
        .order-type-btn.balcao:hover { border-color: #fd7e14; background-color: rgba(253, 126, 20, 0.05); }
        .order-type-btn.mesa:hover { border-color: #28a745; background-color: rgba(40, 167, 69, 0.05); }

        .order-type-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .order-type-btn.delivery .order-type-icon { color: #007bff; }
        .order-type-btn.balcao .order-type-icon { color: #fd7e14; }
        .order-type-btn.mesa .order-type-icon { color: #28a745; }

        .order-type-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .order-type-description {
            color: #6c757d;
            line-height: 1.5;
        }

        .new-order-notification-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            display: none;
        }

        .new-order-notification-modal.show {
            display: block;
            animation: bounceIn 0.5s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            60% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .new-order-notification-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-width: 300px;
            max-width: 90vw;
            border-left: 5px solid var(--success-color);
        }

        .new-order-notification-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .new-order-notification-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .new-order-notification-subtitle {
            color: #6c757d;
            margin-bottom: 1.5rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
        }

        .form-section h4 {
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .form-text {
            margin-bottom: 1rem;
        }

        .add-ons-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .add-on-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .add-on-item:hover {
            background-color: #f8f9fa;
        }

        .add-on-item input {
            margin-right: 0.75rem;
        }

        .add-on-item label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            cursor: pointer;
            margin: 0;
        }

        .add-on-name {
            font-weight: 500;
        }

        .add-on-price {
            color: var(--success-color);
            font-weight: 600;
        }

        #activateSoundBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        }

        /* Estilos espec√≠ficos para o modal de delivery atualizado */
        .delivery-modal .modal-content,
        #balcaoOrderModal .modal-content,
        #mesaOrderModal .modal-content {
            max-width: 95vw;
        }

        .delivery-form-section {
            margin-bottom: 0.75rem;
        }

        .delivery-form-section h4 {
            margin-bottom: 0.5rem;
            color: var(--success-color);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Layout compacto em 2 colunas para desktop */
        @media (min-width: 769px) {
            .delivery-compact-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
            
            .delivery-compact-grid > .delivery-form-section {
                margin-bottom: 0;
            }
        }

        .delivery-form-grid {
            display: grid;
            gap: 0.5rem;
        }

        @media (min-width: 769px) {
            .delivery-form-grid-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .delivery-form-grid-3 {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .delivery-form-grid-4 {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }

        .delivery-info-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            margin-bottom: 0;
        }

        .delivery-metrics {
            display: grid;
            gap: 0.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        @media (min-width: 769px) {
            .delivery-metrics {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .metric-item {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .metric-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-container input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .fee-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fee-input-container span {
            font-weight: 500;
        }

        .fee-input {
            width: 100px;
            text-align: right;
        }

        .delivery-total-section {
            background: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .delivery-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .delivery-total-row:last-child {
            margin-bottom: 0;
            font-size: 1.1rem;
            font-weight: 600;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .delivery-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .delivery-items-table th, .delivery-items-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .delivery-items-table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
        }

        .delivery-items-table tbody td {
            vertical-align: middle;
        }

        .no-items-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .delivery-items-table tbody tr.empty-row {
            height: 60px;
        }

        .delivery-items-table tbody tr.empty-row td {
            border: none;
            background: transparent;
        }

        .highlighted-field {
            background-color: #d4edda !important;
            border-color: var(--success-color) !important;
        }

        .modal-body-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .product-list-container {
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            max-height: 40vh;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
        }

        .product-list-item {
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            background-color: #fff;
        }
        
        .product-list-item:hover {
            background-color: #f8f9fa;
        }

        .product-list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.25rem;
        }

        .product-list-item .product-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .product-list-item .product-price {
            font-weight: 500;
            color: var(--primary-color);
        }

        .product-list-item-description {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .items-table th, .items-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .items-table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .item-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            transition: color 0.2s;
        }
        
        .item-action-btn:hover {
            color: #212529;
        }

        .item-actions .delete:hover { color: var(--danger-color); }
        .item-actions .edit:hover { color: var(--info-color); }

        .route-info-grid {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            text-align: center;
        }
        
        .route-metric {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            flex: 1;
        }

        .route-metric-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }

        .route-metric-value {
            font-size: 1rem;
            font-weight: 600;
        }
        
        /* Estilos espec√≠ficos para o modal de delivery atualizado */
        .delivery-modal .modal-content,
        #balcaoOrderModal .modal-content,
        #mesaOrderModal .modal-content {
            max-width: 95vw;
        }

        .delivery-form-section {
            margin-bottom: 1.5rem;
        }

        .delivery-form-section h4 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
        }

        .delivery-form-grid {
            display: grid;
            gap: 0.5rem;
        }

        @media (min-width: 769px) {
            .delivery-form-grid-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .delivery-form-grid-3 {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .delivery-form-grid-4 {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }

        .delivery-info-section {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .delivery-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .metric-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-container input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .fee-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fee-input-container span {
            font-weight: 500;
        }

        .fee-input {
            width: 100px;
            text-align: right;
        }

        .delivery-total-section {
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1rem;
        }

        .delivery-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .delivery-total-row:last-child {
            margin-bottom: 0;
            font-size: 1.1rem;
            font-weight: 600;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .delivery-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .delivery-items-table th, .delivery-items-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .delivery-items-table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .delivery-items-table tbody td {
            vertical-align: middle;
        }

        .no-items-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .highlighted-field {
            background-color: #d4edda !important;
            border-color: var(--success-color) !important;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .product-search-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .product-search-price {
            color: var(--primary-color);
            font-weight: 500;
        }

        .product-search-category {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .product-search-container {
            position: relative;
        }

        .search-result-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        .notification.info {
            background-color: var(--info-color);
        }

        /* Menu Hamburger para Mobile */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10000;
            align-items: center;
            padding: 0;
            justify-content: flex-start;
        }

        .hamburger-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 60px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .mobile-logo {
            height: 40px;
            width: auto;
            margin: 0 auto;
            display: block;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .sidebar-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsivo para Mobile (Galaxy S25 e similares - 360px-428px) */
        @media (max-width: 768px) {
            /* Mostrar header mobile */
            .mobile-header {
                display: flex;
            }

            /* Ajustar sidebar para mobile */
            .sidebar {
                transform: translateX(-100%);
                z-index: 9999;
                width: 280px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            }

            /* Ajustar main content */
            .main-content {
                margin-left: 0;
                padding: 1rem;
                margin-top: 60px;
            }

            /* Ocultar page header em mobile */
            .page-header {
                display: none;
            }

            /* Ocultar filtros em mobile */
            .filters-section {
                display: none;
            }

            /* Se√ß√£o de pedidos - 2 cards lado a lado */
            .orders-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                padding: 0;
            }

            /* Ajustar cards de pedidos para mobile */
            .order-card {
                padding: 0.75rem;
                min-height: auto;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
                margin-bottom: 0.75rem;
            }

            .order-number {
                font-size: 1rem;
            }

            .order-status {
                padding: 0.2rem 0.5rem;
                font-size: 0.65rem;
            }

            .order-customer {
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }

            .order-detail {
                font-size: 0.75rem;
                margin-bottom: 0.35rem;
            }

            .order-footer {
                padding-top: 0.75rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .order-total {
                font-size: 1.1rem;
            }

            .order-time {
                font-size: 0.75rem;
            }

            /* Ajustar bot√µes */
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .btn-sm {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }

            /* Ajustar se√ß√£o de filtros de setor */
            .sector-filters {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .sector-filter-btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            /* Modais */
            .delivery-form-grid-2,
            .delivery-form-grid-3,
            .delivery-form-grid-4 {
                grid-template-columns: 1fr;
            }
            
            .delivery-form-grid-4 > div[style*="grid-column"] {
                grid-column: span 1 !important;
            }

            .delivery-compact-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .delivery-metrics {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .modal-body-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .modal-content {
                max-width: 100vw;
                max-height: 100vh;
                height: 100vh;
                margin: 0;
                border-radius: 0;
            }

            .modal {
                padding: 0;
            }

            .delivery-modal .modal-content,
            #balcaoOrderModal .modal-content,
            #mesaOrderModal .modal-content {
                max-width: 100vw;
                height: 100vh;
            }

            .modal-header h3 {
                font-size: 1.25rem;
            }

            .order-list-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .order-main-info {
                width: 100%;
                flex-direction: column;
                gap: 1rem;
            }

            .order-meta {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            /* Ajustar logo no header mobile */
            .sidebar-header img {
                height: 120px;
                max-width: 150px;
            }

            /* Bot√µes de a√ß√£o na p√°gina */
            .page-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .page-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Ajustes espec√≠ficos para telas muito pequenas (< 380px) */
        @media (max-width: 380px) {
            .orders-container {
                grid-template-columns: 1fr;
            }

            .order-card {
                padding: 1rem;
            }

            .order-number {
                font-size: 1.1rem;
            }

            .order-total {
                font-size: 1.2rem;
            }
        }

        /* WhatsApp Status Indicator */
        .whatsapp-status-indicator {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-right: 0.5rem;
            font-size: 0.85rem;
            color: #6c757d;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .whatsapp-status-indicator i {
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }

        .whatsapp-status-indicator.connected {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .whatsapp-status-indicator.connected i {
            color: #25D366;
        }

        .whatsapp-status-indicator.disconnected {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .whatsapp-status-indicator.disconnected i {
            color: #dc3545;
        }

        .whatsapp-status-indicator.checking {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .whatsapp-status-indicator.checking i {
            color: #ffc107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Header Mobile com Menu Hamburger -->
        <div class="mobile-header">
            <button class="hamburger-btn" onclick="toggleMobileMenu()" aria-label="Abrir menu">
                <i class="fas fa-bars"></i>
            </button>
            <img src="https://raw.githubusercontent.com/luishplleite/logotimipulseai/refs/heads/main/LOGO%20FINAL.png" alt="TimePulse AI" class="mobile-logo">
        </div>

        <!-- Overlay para fechar menu mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo brand-name" style="text-align: center;"><img src="https://raw.githubusercontent.com/luishplleite/logotimipulseai/refs/heads/main/LOGO%20FINAL.png" alt="TimePulse AI" style="height: 200px; width: auto; max-width: 220px;"></div>
                <div class="restaurant-name restaurant-brand" id="restaurantName">Carregando...</div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="dashboard.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="gestao_pedidos.html" class="nav-link active">
                        <span class="nav-icon">üì¶</span>
                        Pedidos
                    </a>
                    <a href="cozinha.html" class="nav-link">
                        <span class="nav-icon">üë®‚Äçüç≥</span>
                        Cozinha
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Gest√£o</div>
                    <a href="cardapio.html" class="nav-link">
                        <span class="nav-icon">üçΩÔ∏è</span>
                        Card√°pio
                    </a>
                    <a href="gestao_entregadores.html" class="nav-link">
                        <span class="nav-icon">üèçÔ∏è</span>
                        Entregadores
                    </a>
                    <a href="clientes.html" class="nav-link">
                        <span class="nav-icon">üë•</span>
                        Clientes
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Relat√≥rios</div>
                    <a href="relatorios.html" class="nav-link">
                        <span class="nav-icon">üìà</span>
                        An√°lises
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Comercial</div>
                    <a href="assinaturas.html" class="nav-link">
                        <span class="nav-icon">üí≥</span>
                        Assinaturas
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Sistema</div>
                    <a href="configuracoes.html" class="nav-link">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        Configura√ß√µes
                    </a>
                    <a href="ajuda.html" class="nav-link">
                        <span class="nav-icon">‚ùì</span>
                        Ajuda
                    </a>
                    <a href="#" class="nav-link" id="logoutButton">
                        <span class="nav-icon">üö™</span>
                        Sair
                    </a>
                </div>
            </div>
        </nav>

        <main class="main-content" id="mainContent">
            <header class="page-header" id="pageHeader">
                <div class="page-header-text">
                    <h1 class="page-title">
                        <i class="fas fa-shopping-cart"></i>
                        Gest√£o de Pedidos
                    </h1>
                    <p class="page-subtitle">Acompanhe e gerencie todos os pedidos em tempo real</p>
                </div>
                <div class="page-actions">
                </div>
            </header>

            <div class="filters-section" id="filtersSection">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="filter-input">
                            <option value="">Todos os status</option>
                            <option value="novo">Novo</option>
                            <option value="aceito">Aceito</option>
                            <option value="preparo">Em Preparo</option>
                            <option value="pronto">Pronto</option>
                            <option value="saiu_entrega">Saiu para Entrega</option>
                            <option value="Aberta">Aberta (Mesa)</option>
                            <option value="encerrado">Encerrado</option>
                            <option value="rejeitado">Rejeitado</option>
                            <option value="entregue">Entregue</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Buscar</label>
                        <input type="text" id="searchInput" class="filter-input" placeholder="Cliente, telefone ou n√∫mero do pedido">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Data</label>
                        <input type="date" id="dateFilter" class="filter-input">
                    </div>
                    
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search"></i>
                            Filtrar
                        </button>
                    </div>
                    
                    <div class="filter-group">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="orders-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2>
                            <i class="fas fa-list"></i>
                            Pedidos Recentes (<span id="ordersCount">0</span>)
                        </h2>
                        <div class="section-actions">
                            <button class="btn btn-primary btn-sm" onclick="openOrderTypeSelectionModal()">
                                <i class="fas fa-plus"></i>
                                Novo Pedido
                            </button>
                            
                            <button class="btn btn-secondary btn-sm" onclick="refreshOrders()">
                                <i class="fas fa-sync-alt"></i>
                                Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="section-header-right">
                        <div class="whatsapp-status-indicator" id="whatsappStatusIndicator">
                            <i class="fab fa-whatsapp" id="whatsappIcon"></i>
                            <span id="whatsappStatusText">Verificando...</span>
                        </div>
                        <button class="online-toggle" id="onlineToggle" onclick="toggleOnlineStatus()">
                            <i class="fas fa-circle" id="onlineIcon"></i>
                            <span id="onlineText">Carregando...</span>
                        </button>
                        <button class="fullscreen-toggle" id="fullscreenToggle" onclick="toggleFullscreen()">
                            <i class="fas fa-expand" id="fullscreenIcon"></i>
                            <span id="fullscreenText">Tela Cheia</span>
                        </button>
                    </div>
                </div>

                <div class="sector-filters">
                    <div class="sector-filters-container">
                        <button class="sector-filter-btn active" data-sector="todos" onclick="filterBySector('todos')">
                            <i class="fas fa-th-large"></i>
                            <span>TODOS</span>
                        </button>
                        <button class="sector-filter-btn" data-sector="delivery" onclick="filterBySector('delivery')">
                            <i class="fas fa-motorcycle"></i>
                            <span>DELIVERY</span>
                        </button>
                        <button class="sector-filter-btn" data-sector="balcao" onclick="filterBySector('balcao')">
                            <i class="fas fa-shopping-bag"></i>
                            <span>BALC√ÉO</span>
                        </button>
                        <button class="sector-filter-btn" data-sector="mesa" onclick="filterBySector('mesa')">
                            <i class="fas fa-utensils"></i>
                            <span>MESA</span>
                        </button>
                    </div>
                </div>
                
                <div class="orders-container" id="ordersGrid">
                    <div class="loading" id="loadingState">
                        <i class="fas fa-spinner"></i>
                        <p>Carregando pedidos...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="orderTypeSelectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Pedido</h3>
                <button class="modal-close" onclick="closeOrderTypeSelectionModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="order-type-selection">
                    <h2 class="order-type-title">Escolha o tipo de pedido</h2>
                    <p class="order-type-subtitle">Selecione a modalidade do seu novo pedido</p>
                    
                    <div class="order-type-buttons">
                        <div class="order-type-btn delivery" onclick="selectOrderType('delivery')">
                            <div class="order-type-icon">
                                <i class="fas fa-motorcycle"></i>
                            </div>
                            <div class="order-type-name">Delivery</div>
                            <div class="order-type-description">
                                Pedido com entrega no endere√ßo do cliente. Inclui c√°lculo de frete e dados completos.
                            </div>
                        </div>
                        
                        <div class="order-type-btn balcao" onclick="selectOrderType('balcao')">
                            <div class="order-type-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="order-type-name">Balc√£o</div>
                            <div class="order-type-description">
                                Pedido para retirada no balc√£o. Cliente busca o pedido no estabelecimento.
                            </div>
                        </div>
                        
                        <div class="order-type-btn mesa" onclick="selectOrderType('mesa')">
                            <div class="order-type-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="order-type-name">Mesa</div>
                            <div class="order-type-description">
                                Pedido para consumo no local. Cliente √© atendido em uma mesa espec√≠fica.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="new-order-notification-modal" id="newOrderNotificationModal">
        <div class="new-order-notification-content">
            <div class="new-order-notification-icon">
                üîî
            </div>
            <div class="new-order-notification-title">
                NOVO PEDIDO!
            </div>
            <div class="new-order-notification-subtitle" id="newOrderDetails">
                Pedido recebido
            </div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-success" onclick="acceptNewOrderFromNotification()">
                    <i class="fas fa-check"></i>
                    Aceitar Pedido
                </button>
                <button class="btn btn-secondary" onclick="hideNewOrderNotification()" style="margin-left: 0.5rem;">
                    Ver Depois
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Novo Pedido - Delivery (Atualizado conforme a imagem) -->
    <div class="modal delivery-modal" id="deliveryOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-motorcycle"></i> Novo Pedido - Delivery</h3>
                <button class="modal-close" onclick="closeDeliveryOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="deliveryOrderForm">
                    <!-- Dados do Cliente - Layout Compacto -->
                    <div class="delivery-form-section">
                        <h4>üë§ Dados do Cliente</h4>
                        
                        <div class="delivery-form-grid delivery-form-grid-2">
                            <div>
                                <label class="filter-label">Telefone *</label>
                                <input type="tel" id="deliveryCustomerPhone" class="form-input" placeholder="(11) 99999-9999" required>
                            </div>
                            <div>
                                <label class="filter-label">Nome do Cliente *</label>
                                <input type="text" id="deliveryCustomerName" class="form-input" placeholder="Nome completo" required>
                            </div>
                        </div>

                        <div class="delivery-form-grid delivery-form-grid-4">
                            <div>
                                <label class="filter-label">CEP</label>
                                <input type="text" id="deliveryCep" class="form-input" placeholder="11065001" maxlength="8" onblur="pesquisacep(this.value, 'delivery')">
                            </div>
                            <div style="grid-column: span 2;">
                                <label class="filter-label">Rua</label>
                                <input type="text" id="deliveryRua" class="form-input" placeholder="Rua/Avenida" onchange="updateDeliveryAddress()">
                            </div>
                            <div>
                                <label class="filter-label">N√∫mero</label>
                                <input type="text" id="deliveryNumber" class="form-input" placeholder="551" onchange="updateDeliveryAddress()">
                            </div>
                        </div>

                        <div class="delivery-form-grid delivery-form-grid-4">
                            <div style="grid-column: span 2;">
                                <label class="filter-label">Bairro</label>
                                <input type="text" id="deliveryBairro" class="form-input highlighted-field" placeholder="Bairro" onchange="updateDeliveryAddress()">
                            </div>
                            <div>
                                <label class="filter-label">Cidade</label>
                                <input type="text" id="deliveryCidade" class="form-input" placeholder="Santos" readonly>
                            </div>
                            <div>
                                <label class="filter-label">UF</label>
                                <input type="text" id="deliveryUf" class="form-input" placeholder="SP" maxlength="2" readonly>
                            </div>
                        </div>
                        
                        <div class="delivery-form-grid">
                            <div>
                                <label class="filter-label">Complemento</label>
                                <input type="text" id="deliveryComplement" class="form-input" placeholder="Apto, Casa, etc." onchange="updateDeliveryAddress()">
                            </div>
                        </div>
                        <!-- Campo oculto para o endere√ßo completo -->
                        <input type="hidden" id="deliveryAddress">
                    </div>

                    <!-- Itens do Pedido -->
                    <div class="delivery-form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 style="margin: 0;">üõí Itens do Pedido</h4>
                            <button type="button" class="btn btn-primary btn-sm" onclick="openProductSelectionModal('delivery')">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                        
                        <div class="product-search-container">
                            <input type="text" id="deliveryProductSearch" class="form-input" placeholder="Buscar produto..." oninput="ordersManager.performProductSearch(this.value.trim(), 'delivery')" style="font-size: 0.9rem;">
                            <div id="deliverySearchResults" class="search-results"></div>
                        </div>
                        
                        <table class="delivery-items-table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qtd</th>
                                    <th>Pre√ßo</th>
                                    <th>Total</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="deliveryItemsTableBody">
                                <tr class="no-items-row">
                                    <td colspan="5" style="padding: 0.5rem; font-size: 0.85rem;">Nenhum item adicionado.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Grid de 2 colunas: Entrega e Pagamento -->
                    <div class="delivery-compact-grid">
                        <!-- C√°lculo de Entrega -->
                        <div class="delivery-form-section">
                            <h4>üöö C√°lculo de Entrega</h4>
                            
                            <div class="delivery-info-section">
                                <div>
                                    <label class="filter-label" style="font-size: 0.85rem;">Tipo de Entrega *</label>
                                    <select id="deliveryTypeSelect" class="form-input" onchange="updateDeliveryFeeByType()" required style="font-size: 0.85rem;">
                                        <option value="">Selecione...</option>
                                        <option value="third-party">üèçÔ∏è Terceiros</option>
                                        <option value="house">üè† Pr√≥pria</option>
                                    </select>
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="deliveryIncludeRoundtrip" onchange="updateDeliveryFeeByType()">
                                    <label for="deliveryIncludeRoundtrip" style="font-size: 0.85rem;">Ida e volta</label>
                                </div>
                                
                                <!-- Bot√£o para Calcular Taxa de Entrega -->
                                <div style="margin: 0.75rem 0;">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="manuallyCalculateDeliveryFee()" style="width: 100%; font-size: 0.85rem;">
                                        <i class="fas fa-calculator"></i> Calcular Taxa de Entrega
                                    </button>
                                    <div id="deliveryFeeCalculatedIndicator" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: var(--border-radius); font-size: 0.8rem; color: #155724;">
                                        <i class="fas fa-check-circle"></i> Taxa calculada com sucesso!
                                    </div>
                                </div>
                                
                                <div class="delivery-metrics">
                                    <div class="metric-item">
                                        <span class="metric-label">Dist√¢ncia</span>
                                        <span class="metric-value" id="deliveryDistanceDisplay">-- km</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Tempo Estimado</span>
                                        <span class="metric-value" id="deliveryDurationDisplay">-- min</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Taxa de Entrega</span>
                                        <span class="metric-value" id="deliveryFeeMetricDisplay">--</span>
                                    </div>
                                </div>
                                
                                <div class="fee-input-container">
                                    <span style="font-size: 0.85rem;">Taxa:</span>
                                    <span>R$</span>
                                    <input type="number" id="deliveryFee" class="form-input fee-input" value="8.00" step="0.01" min="0" style="font-size: 0.85rem;">
                                </div>
                            </div>
                        </div>

                        <!-- Forma de Pagamento -->
                        <div class="delivery-form-section">
                            <h4>üí≥ Pagamento</h4>
                            <div>
                                <label class="filter-label" style="font-size: 0.85rem;">Forma de Pagamento *</label>
                                <select id="deliveryPaymentMethod" class="form-input" onchange="toggleDeliveryChangeFields()" required style="font-size: 0.85rem;">
                                    <option value="">Selecione...</option>
                                    <option value="money">Dinheiro</option>
                                    <option value="card">Cart√£o</option>
                                    <option value="pix">PIX</option>
                                    <option value="voucher">Vale</option>
                                </select>
                            </div>
                            <div id="deliveryChangeFields" style="margin-top: 0.5rem; display: none;">
                                <div class="delivery-form-grid delivery-form-grid-2">
                                    <div>
                                        <label class="filter-label" style="font-size: 0.85rem;">Cliente paga:</label>
                                        <input type="number" id="deliveryChangeForAmount" class="form-input" step="0.01" placeholder="0,00" oninput="calculateDeliveryChange()" style="font-size: 0.85rem;">
                                    </div>
                                    <div>
                                        <label class="filter-label" style="font-size: 0.85rem;">Troco:</label>
                                        <input type="number" id="deliveryChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly style="font-size: 0.85rem;">
                                    </div>
                                </div>
                                <div id="deliveryChangeCalculation" style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: var(--border-radius); display: none; font-size: 0.85rem;">
                                    <strong>Troco: R$ <span id="deliveryChangeDisplay">0,00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total e Observa√ß√µes lado a lado -->
                    <div class="delivery-compact-grid">
                        <!-- Total -->
                        <div class="delivery-total-section" style="margin-top: 0;">
                            <div class="delivery-total-row" style="font-size: 0.85rem;">
                                <span>Subtotal:</span>
                                <span>R$ <span id="deliverySubtotalDisplay">0,00</span></span>
                            </div>
                            <div class="delivery-total-row" style="font-size: 0.85rem;">
                                <span>Taxa:</span>
                                <span>R$ <span id="deliveryFeeDisplayTotal">8,00</span></span>
                            </div>
                            <div class="delivery-total-row">
                                <span>Total:</span>
                                <span>R$ <input type="hidden" id="deliverySubtotal"><input type="hidden" id="deliveryTotal"><span id="deliveryTotalDisplay">8,00</span></span>
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="delivery-form-section" style="margin-top: 0;">
                            <label class="filter-label" style="font-size: 0.85rem;">üìù Observa√ß√µes</label>
                            <textarea id="deliveryOrderNotes" class="form-input" rows="3" placeholder="Observa√ß√µes especiais" style="font-size: 0.85rem; resize: vertical;"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            
            <div style="padding: 0.75rem 1rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; background: #f8f9fa;">
                <button class="btn btn-secondary" onclick="closeDeliveryOrderModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitDeliveryOrder()">
                    <i class="fas fa-check"></i> Criar Pedido
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="balcaoOrderModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-shopping-bag"></i> Novo Pedido - Balc√£o</h3>
                <button class="modal-close" onclick="closeBalcaoOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="balcaoOrderForm">
                    <div class="modal-body-grid">
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Dados do Cliente</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Nome do Cliente *</label>
                                <input type="text" id="balcaoCustomerName" class="form-input" placeholder="Nome completo" required>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Telefone</label>
                                <input type="tel" id="balcaoCustomerPhone" class="form-input" placeholder="(11) 99999-9999">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Previs√£o de Retirada</label>
                                <input type="time" id="balcaoPickupTime" class="form-input">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Forma de Pagamento *</label>
                                <select id="balcaoPaymentMethod" class="form-input" onchange="toggleBalcaoChangeFields()" required>
                                    <option value="">Selecione...</option>
                                    <option value="money">Dinheiro</option>
                                    <option value="card">Cart√£o</option>
                                    <option value="pix">PIX</option>
                                    <option value="voucher">Vale</option>
                                </select>
                            </div>
                            
                            <div id="balcaoChangeFields" style="margin-bottom: 1rem; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div>
                                        <label class="filter-label">Cliente paga:</label>
                                        <input type="number" id="balcaoChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateBalcaoChange()">
                                    </div>
                                    <div>
                                        <label class="filter-label">Troco:</label>
                                        <input type="number" id="balcaoChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                                    </div>
                                </div>
                                <div id="balcaoChangeCalculation" style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                                    <strong>Troco: R$ <span id="balcaoChangeDisplay">0,00</span></strong>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Observa√ß√µes</label>
                                <textarea id="balcaoNotes" class="form-input" rows="3" placeholder="Observa√ß√µes especiais"></textarea>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: var(--primary-color);">Itens do Pedido</h4>
                                <button type="button" class="btn btn-primary btn-sm" onclick="openProductSelectionModal('balcao')">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                            
                            <div class="product-search-container">
                                <input type="text" id="balcaoProductSearch" class="form-input" placeholder="Buscar produto (nome ou c√≥digo)..." oninput="ordersManager.performProductSearch(this.value.trim(), 'balcao')">
                                <div id="balcaoSearchResults" class="search-results"></div>
                            </div>
                            
                            <div style="border: 1px solid #e9ecef; border-radius: var(--border-radius); overflow: hidden;">
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Qtd</th>
                                            <th>Pre√ßo</th>
                                            <th>Total</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="balcaoItemsTableBody">
                                        <tr class="no-items-row">
                                            <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o bot√£o "Adicionar Item".</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--primary-color); color: white; border-radius: var(--border-radius); text-align: center;">
                                <h4 style="margin: 0; display: flex; justify-content: space-between;">
                                    <span>Total:</span>
                                    <span>R$ <input type="hidden" id="balcaoSubtotal"><input type="hidden" id="balcaoTotal"><span id="balcaoTotalDisplay">0,00</span></span>
                                </h4>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label class="filter-label">Observa√ß√µes do Pedido</label>
                        <textarea id="balcaoOrderNotes" class="form-input" rows="2" placeholder="Observa√ß√µes especiais"></textarea>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeBalcaoOrderModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitBalcaoOrder()">
                    <i class="fas fa-check"></i> Criar Pedido
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="mesaOrderModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-utensils"></i> Novo Pedido - Mesa</h3>
                <button class="modal-close" onclick="closeMesaOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="mesaOrderForm">
                    <div class="modal-body-grid">
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Informa√ß√µes da Mesa</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">N√∫mero da Mesa *</label>
                                <input type="text" id="mesaNumber" class="form-input" placeholder="N√∫mero da mesa" required onblur="checkMesaAvailability()">
                            </div>
                            
                            <div id="mesaAvailabilityMessage" style="display: none; margin-bottom: 1rem; padding: 1rem; border-radius: var(--border-radius);">
                                <!-- Dynamic content will be inserted here -->
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Nome do Cliente</label>
                                <input type="text" id="mesaCustomerName" class="form-input" placeholder="Nome (opcional)">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">N√∫mero de Pessoas</label>
                                <input type="number" id="mesaPeopleCount" class="form-input" min="1" max="20" placeholder="Quantas pessoas?">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Gar√ßom Respons√°vel</label>
                                <select id="mesaWaiter" class="form-input">
                                    <option value="">Selecione o gar√ßom</option>
                                    <option value="garcom1">Jo√£o Silva</option>
                                    <option value="garcom2">Maria Santos</option>
                                    <option value="garcom3">Pedro Costa</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Forma de Pagamento</label>
                                <select id="mesaPaymentMethod" class="form-input" onchange="toggleMesaChangeFields()">
                                    <option value="">Deixar para depois</option>
                                    <option value="money">Dinheiro</option>
                                    <option value="card">Cart√£o</option>
                                    <option value="pix">PIX</option>
                                    <option value="voucher">Vale</option>
                                </select>
                            </div>
                            
                            <div id="mesaChangeFields" style="margin-bottom: 1rem; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div>
                                        <label class="filter-label">Cliente paga:</label>
                                        <input type="number" id="mesaChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateMesaChange()">
                                    </div>
                                    <div>
                                        <label class="filter-label">Troco:</label>
                                        <input type="number" id="mesaChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                                    </div>
                                </div>
                                <div id="mesaChangeCalculation" style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                                    <strong>Troco: R$ <span id="mesaChangeDisplay">0,00</span></strong>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label class="filter-label">Observa√ß√µes</label>
                                <textarea id="mesaOrderNotes" class="form-input" rows="2" placeholder="Observa√ß√µes especiais"></textarea>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: var(--primary-color);">Itens do Pedido</h4>
                                <button type="button" class="btn btn-primary btn-sm" onclick="openProductSelectionModal('mesa')">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                            
                            <div class="product-search-container">
                                <input type="text" id="mesaProductSearch" class="form-input" placeholder="Buscar produto (nome ou c√≥digo)..." oninput="ordersManager.performProductSearch(this.value.trim(), 'mesa')">
                                <div id="mesaSearchResults" class="search-results"></div>
                            </div>
                            
                            <div style="border: 1px solid #e9ecef; border-radius: var(--border-radius); overflow: hidden;">
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Qtd</th>
                                            <th>Pre√ßo</th>
                                            <th>Total</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mesaItemsTableBody">
                                        <tr class="no-items-row">
                                            <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o bot√£o "Adicionar Item".</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="mesaServiceFeeSection" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <label for="mesaServiceFee">Taxa de Servi√ßo (10%):</label>
                                    <input type="checkbox" id="mesaServiceFee" checked>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--primary-color); color: white; border-radius: var(--border-radius); text-align: center;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Subtotal:</span>
                                    <span>R$ <span id="mesaSubtotalDisplay">0,00</span></span>
                                </div>
                                <div id="mesaServiceFeeDisplayDiv" style="display: flex; justify-content: space-between;">
                                    <span>Taxa de Servi√ßo:</span>
                                    <span>R$ <span id="mesaServiceFeeDisplay">0,00</span></span>
                                </div>
                                <hr style="margin: 0.5rem 0; border-color: rgba(255,255,255,0.3);">
                                <h4 style="margin: 0; display: flex; justify-content: space-between;">
                                    <span>Total:</span>
                                    <span>R$ <input type="hidden" id="mesaTotal"><span id="mesaTotalDisplay">0,00</span></span>
                                </h4>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label class="filter-label">Observa√ß√µes do Pedido</label>
                        <textarea id="mesaOrderNotesSecondary" class="form-input" rows="2" placeholder="Observa√ß√µes especiais"></textarea>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeMesaOrderModal()">Cancelar</button>
                <button class="btn btn-success" onclick="submitMesaOrder()">
                    <i class="fas fa-check"></i> Criar Pedido
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="productSelectionModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-shopping-cart"></i> Selecionar Produtos</h3>
                <button class="modal-close" onclick="closeProductSelectionModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <input type="text" id="productSearchInput" class="form-input" placeholder="Buscar produtos..." onkeyup="filterProducts()">
                </div>
                
                <div id="productCategories" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Product categories will be loaded here -->
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeProductSelectionModal()">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="orderDetailsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="orderDetailsTitle">Detalhes do Pedido</h3>
                <button class="modal-close" onclick="closeOrderDetailsModal()">&times;</button>
            </div>
            
            <div class="modal-body" id="orderDetailsBody">
                <!-- Order details will be populated here -->
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;" id="orderDetailsActions">
                <!-- Action buttons will be populated here -->
            </div>
        </div>
    </div>

    <div class="modal" id="addProductModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Adicionar Produto</h3>
                <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <input type="text" id="productSearchSecondary" class="form-input" placeholder="Buscar produtos...">
                </div>
                
                <div class="modal-body-grid">
                    <div>
                        <label class="filter-label">Categoria</label>
                        <select id="categoriesSelect" class="form-input">
                            <option value="">Carregando categorias...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="filter-label">Produto</label>
                        <select id="productsSelect" class="form-input" size="8">
                            <option value="">Carregando produtos...</option>
                        </select>
                    </div>
                </div>
                
                <div id="selectedProductSection" style="margin-top: 1.5rem; display: none;">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Produto Selecionado</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="filter-label">Nome do Produto</label>
                            <input type="text" id="selectedProductName" class="form-input" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">Quantidade</label>
                            <input type="number" id="selectedProductQuantity" class="form-input" value="1" min="1">
                        </div>
                        
                        <div>
                            <label class="filter-label">Pre√ßo Unit√°rio</label>
                            <input type="number" id="selectedProductPrice" class="form-input" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label class="filter-label">Observa√ß√µes</label>
                        <textarea id="selectedProductNotes" class="form-input" rows="2" placeholder="Observa√ß√µes especiais"></textarea>
                    </div>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeAddProductModal()">Cancelar</button>
                <button class="btn btn-success" id="addProductBtn" onclick="addProductToOrder()" disabled>
                    <i class="fas fa-check"></i> Adicionar Produto
                </button>
            </div>
        </div>
    </div>


    <div class="modal" id="delivererSelectionModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-motorcycle"></i> Selecionar Entregador</h3>
                <button class="modal-close" onclick="closeDelivererSelectionModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label class="filter-label">Tipo de Entrega *</label>
                    <select id="deliveryTypeSelectAssign" class="form-input" onchange="toggleDelivererSelection()" required>
                        <option value="">Selecione o tipo de entrega</option>
                        <option value="house">üè† Entrega da Casa (Pr√≥pria)</option>
                        <option value="third-party">üèçÔ∏è Entrega de Terceiros (Apps)</option>
                    </select>
                    <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                        Escolha quem far√° a entrega deste pedido
                    </small>
                </div>
                
                <div id="delivererSelectContainer" style="margin-bottom: 1.5rem; display: none;">
                    <label class="filter-label">Entregador</label>
                    <select id="delivererSelect" class="form-input">
                        <option value="">Carregando entregadores...</option>
                    </select>
                </div>
                
                <div id="thirdPartyInfo" style="display: none; padding: 1rem; background: #fff3cd; border-radius: var(--border-radius); border-left: 4px solid #ffc107;">
                    <p style="margin: 0; color: #856404;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Entrega de Terceiros:</strong> Este pedido ser√° entregue por um servi√ßo de delivery externo (iFood, Rappi, etc). 
                        N√£o √© necess√°rio selecionar um entregador.
                    </p>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeDelivererSelectionModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmDelivererSelection()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="paymentMethodModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> Forma de Pagamento</h3>
                <button class="modal-close" onclick="closePaymentMethodModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label class="filter-label">Como o cliente pagou?</label>
                    <select id="finalPaymentMethod" class="form-input" onchange="toggleFinalChangeFields()">
                        <option value="">Selecione a forma de pagamento</option>
                        <option value="money">Dinheiro</option>
                        <option value="card">Cart√£o</option>
                        <option value="pix">PIX</option>
                        <option value="voucher">Vale</option>
                    </select>
                </div>
                
                <div id="finalChangeFields" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label class="filter-label">Cliente pagou:</label>
                            <input type="number" id="finalChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateFinalChange()">
                        </div>
                        <div>
                            <label class="filter-label">Troco:</label>
                            <input type="number" id="finalChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                        </div>
                    </div>
                    <div id="finalChangeCalculation" style="padding: 1rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                        <strong>Troco: R$ <span id="finalChangeDisplay">0,00</span></strong>
                    </div>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closePaymentMethodModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmPaymentAndFinish()">
                    <i class="fas fa-check"></i> Finalizar Entrega
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="finalizarMesaModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-utensils"></i> Finalizar Mesa</h3>
                <button class="modal-close" onclick="closeFinalizarMesaModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="finalizarMesaForm">
                    <div style="margin-bottom: 1.5rem; text-align: center; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius);">
                        <h4 style="margin: 0; color: var(--primary-color);">Total: R$ <span id="mesaFinalTotalDisplay">0,00</span></h4>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label class="filter-label">Forma de Pagamento *</label>
                        <select id="mesaFinalPaymentMethod" class="form-input" onchange="toggleFinalMesaChangeFields()" required>
                            <option value="">Selecione a forma de pagamento</option>
                            <option value="money">Dinheiro</option>
                            <option value="card">Cart√£o</option>
                            <option value="pix">PIX</option>
                            <option value="voucher">Vale</option>
                        </select>
                    </div>
                    
                    <div id="mesaFinalChangeFields" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label class="filter-label">Cliente pagou:</label>
                                <input type="number" id="mesaFinalChangeForAmount" class="form-input" step="0.01" placeholder="0,00" onchange="calculateFinalMesaChange()">
                            </div>
                            <div>
                                <label class="filter-label">Troco:</label>
                                <input type="number" id="mesaFinalChangeAmount" class="form-input" step="0.01" placeholder="0,00" readonly>
                            </div>
                        </div>
                        <div id="mesaFinalChangeCalculation" style="padding: 1rem; background: #d4edda; border-radius: var(--border-radius); display: none;">
                            <strong>Troco: R$ <span id="mesaFinalChangeDisplay">0,00</span></strong>
                        </div>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeFinalizarMesaModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmMesaPaymentAndFinish()">
                    <i class="fas fa-check"></i> Encerrar Mesa
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="customerRegistrationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Cliente</h3>
                <button class="modal-close" onclick="closeCustomerRegistrationModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="customerRegistrationForm">
                    <div class="modal-body-grid">
                        <div>
                            <label class="filter-label">Nome Completo *</label>
                            <input type="text" id="newCustomerName" class="form-input" placeholder="Nome completo" required>
                        </div>
                        
                        <div>
                            <label class="filter-label">Telefone *</label>
                            <input type="tel" id="newCustomerPhone" class="form-input" placeholder="(11) 99999-9999" required>
                        </div>
                        
                        <div>
                            <label class="filter-label">E-mail</label>
                            <input type="email" id="newCustomerEmail" class="form-input" placeholder="email@exemplo.com">
                        </div>
                        
                        <div>
                            <label class="filter-label">Data de Nascimento</label>
                            <input type="date" id="newCustomerBirthDate" class="form-input">
                        </div>
                        
                        <div>
                            <label class="filter-label">CEP</label>
                            <input type="text" id="newCustomerCep" class="form-input" placeholder="00000-000" maxlength="9" oninput="formatCEP(this)" onblur="pesquisacep(this.value, 'newCustomer');">
                        </div>
                        
                        <div>
                            <label class="filter-label">Rua</label>
                            <input type="text" id="newCustomerRua" class="form-input" placeholder="Rua" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">N√∫mero</label>
                            <input type="text" id="newCustomerNumber" class="form-input" placeholder="N√∫mero">
                        </div>
                        
                        <div>
                            <label class="filter-label">Complemento</label>
                            <input type="text" id="newCustomerComplement" class="form-input" placeholder="Apto, Casa, etc.">
                        </div>
                        
                        <div>
                            <label class="filter-label">Bairro</label>
                            <input type="text" id="newCustomerBairro" class="form-input" placeholder="Bairro" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">Cidade</label>
                            <input type="text" id="newCustomerCidade" class="form-input" placeholder="Cidade" readonly>
                        </div>
                        
                        <div>
                            <label class="filter-label">UF</label>
                            <input type="text" id="newCustomerUf" class="form-input" placeholder="UF" maxlength="2" readonly>
                        </div>
                        
                        <div style="display: none;">
                            <input type="text" id="ibge" class="form-input">
                        </div>
                    </div>
                </form>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeCustomerRegistrationModal()">Cancelar</button>
                <button class="btn btn-success" onclick="handleCustomerRegistration(event)">
                    <i class="fas fa-check"></i> Cadastrar Cliente
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="addOnsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="addOnsModalTitle"><i class="fas fa-plus"></i> Adicionais</h3>
                <button class="modal-close" onclick="closeAddOnsModal()">&times;</button>
            </div>
            
            <div class="modal-body" id="addOnsModalBody">
                <div id="addOnsLoading" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Carregando adicionais...</p>
                </div>
                
                <div id="addOnsContent" style="display: none;">
                    <!-- Add-ons content will be populated here -->
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeAddOnsModal()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmAddOnsSelection()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Produto ao Pedido Existente -->
    <div class="modal" id="addProductToOrderModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Adicionar Produto ao Pedido</h3>
                <button class="modal-close" onclick="closeAddProductToOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <input type="text" id="productSearchAddToOrder" class="form-input" placeholder="Digite o nome do produto ou c√≥digo..." 
                           onkeyup="searchProductsForOrder(this.value)">
                </div>
                
                <div id="productsContainer">
                    <div id="productsByCategoryAddToOrder">
                        <!-- Produtos por categoria ser√£o carregados aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Pedido Completo -->
    <div class="modal" id="editOrderModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Editar Pedido</h3>
                <button class="modal-close" onclick="closeEditOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body" id="editOrderModalBody">
                <!-- Conte√∫do do pedido para edi√ß√£o ser√° carregado aqui -->
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeEditOrderModal()">Cancelar</button>
                <button class="btn btn-success" onclick="saveEditedOrder()">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Excluir Pedido com Confirma√ß√£o de Senha -->
    <div class="modal" id="deleteOrderModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Excluir Pedido</h3>
                <button class="modal-close" onclick="closeDeleteOrderModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <i class="fas fa-trash-alt" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.2rem; font-weight: 600; color: #dc3545;">
                        Aten√ß√£o! Esta a√ß√£o √© irrevers√≠vel!
                    </p>
                    <p>Voc√™ est√° prestes a excluir permanentemente este pedido.</p>
                    <p id="deleteOrderInfo" style="font-weight: 600; margin-top: 1rem;">
                        <!-- Informa√ß√µes do pedido ser√£o mostradas aqui -->
                    </p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label class="filter-label" style="color: #dc3545; font-weight: 600;">
                        <i class="fas fa-lock"></i> Digite "confirmar" para excluir permanentemente:
                    </label>
                    <input type="text" id="deleteOrderPassword" class="form-input" 
                           placeholder="Digite: confirmar" style="border-color: #dc3545;">
                    <small style="color: #6c757d; margin-top: 0.5rem; display: block;">
                        Esta a√ß√£o n√£o pode ser desfeita. Digite "confirmar" para prosseguir.
                    </small>
                </div>
            </div>
            
            <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeDeleteOrderModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDeleteOrder()">
                    <i class="fas fa-trash"></i> Confirmar Exclus√£o
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para editar item individual -->
    <div class="modal" id="editItemModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit" style="color: var(--primary-color);"></i> Editar Item</h3>
                <button class="modal-close" onclick="closeEditItemModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="editItemContent">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditItemModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveItemChanges()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <button id="activateSoundBtn" class="btn btn-warning" style="display: none;">
        <i class="fas fa-volume-up"></i>
        Ativar Som
    </button>

    <!-- Indicador de √°udio ativo -->
    <div id="audioIndicator" style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: none; background: var(--success-color); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.2); animation: pulse 2s infinite;">
        <i class="fas fa-volume-up"></i>
        Som Ativo
    </div>

    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>

  <script>
// ===== SISTEMA DE LOGS DETALHADOS ATIVADO =====
// Console habilitado para debug detalhado

// ===== CONFIGURA√á√ïES GLOBAIS E INICIALIZA√á√ÉO =====

// Inicializar configura√ß√µes usando nova API backend
let supabase;
let MAPBOX_ACCESS_TOKEN;

// ===== SISTEMA DE TOKEN MAPBOX =====
// Fun√ß√£o para garantir que o token do Mapbox esteja dispon√≠vel
window.ensureMapboxToken = (() => {
    let promise = null;
    
    return async () => {
        // Se j√° temos o token, retornar sucesso
        if (window.MAPBOX_ACCESS_TOKEN) {
            return true;
        }
        
        // Se j√° estamos carregando, aguardar o carregamento em andamento
        if (promise) {
            return promise;
        }
        
        // Iniciar carregamento do token
        promise = (async () => {
            try {
                
                const response = await fetch('/api/config/mapbox', {
                    method: 'GET',
                    cache: 'no-store',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro do servidor: ${response.status}`);
                }
                
                const config = await response.json();
                
                if (!config?.accessToken) {
                    throw new Error('Token de acesso n√£o encontrado na configura√ß√£o');
                }
                
                // Definir token globalmente
                window.MAPBOX_ACCESS_TOKEN = config.accessToken;
                MAPBOX_ACCESS_TOKEN = config.accessToken; // Garantir escopo local tamb√©m
                
                return config.accessToken;
                
            } catch (error) {
                promise = null; // Permitir nova tentativa
                throw new Error('N√£o foi poss√≠vel carregar a configura√ß√£o do Mapbox');
            }
        })();
        
        return promise;
    };
})();

// ===== SISTEMA DE LOGS DETALHADOS =====
const Logger = {
    log: (category, action, data = {}) => {
        const timestamp = new Date().toISOString();
        console.log(`[${timestamp}] [${category}] ${action}:`, data);
    },
    
    error: (category, action, error, data = {}) => {
        const timestamp = new Date().toISOString();
        console.error(`[${timestamp}] [${category}] ${action}:`, {
            error: error.message,
            stack: error.stack,
            data
        });
    },
    
    success: (category, action, data = {}) => {
        const timestamp = new Date().toISOString();
        console.log(`‚úÖ [${timestamp}] [${category}] ${action}:`, data);
    },
    
    api: (method, endpoint, status, duration = null) => {
        const timestamp = new Date().toISOString();
        console.log(`üì° [${timestamp}] API ${method} ${endpoint}:`, {
            status,
            duration: duration ? `${duration}ms` : null
        });
    }
};

async function initializeConfiguration() {
    try {
        
        // Buscar configura√ß√£o usando o sistema seguro
        Logger.log('CONFIG', 'Iniciando carregamento de configura√ß√µes do backend');
        const startTime = performance.now();
        const config = await fetchPublicConfig();
        const endTime = performance.now();
        const duration = (endTime - startTime).toFixed(2);
        
        if (!config) {
            throw new Error('N√£o foi poss√≠vel carregar a configura√ß√£o');
        }
        
        Logger.success('CONFIG', 'Configura√ß√£o carregada do backend', {
            duration: `${duration}ms`,
            endpoints: Object.keys(config).length,
            supabaseConfigured: !!(config.supabaseUrl && config.supabaseAnonKey),
            evolutionConfigured: !!(config.evolution?.serverUrl),
            mapboxConfigured: !!(config.mapbox?.accessToken)
        });

        // Inicializar Supabase
        if (config.supabaseUrl && config.supabaseAnonKey) {
            supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
            Logger.success('SUPABASE', 'Cliente inicializado com sucesso', {
                url: config.supabaseUrl,
                hasApiKey: !!config.supabaseAnonKey
            });
            Logger.log('SUPABASE', 'Testando conectividade...');
            try {
                const { data: testData, error: testError } = await supabase.from('restaurants').select('count', { count: 'exact', head: true });
                if (testError) {
                    Logger.error('SUPABASE', 'Teste de conectividade falhou', testError);
                } else {
                    Logger.success('SUPABASE', 'Conectividade OK', { database: 'restaurants' });
                }
            } catch (e) {
                Logger.error('SUPABASE', 'Erro no teste de conectividade', e);
            }
        } else {
            throw new Error('Configura√ß√£o do Supabase n√£o encontrada');
        }

        // Configurar Mapbox
        if (config.mapbox?.accessToken) {
            MAPBOX_ACCESS_TOKEN = config.mapbox.accessToken;
            Logger.success('MAPBOX', 'API configurada com sucesso', { hasAccessToken: true });
        } else {
            Logger.error('MAPBOX', 'Chave n√£o encontrada', new Error('C√°lculo de entrega ser√° desabilitado'));
            MAPBOX_ACCESS_TOKEN = null;
        }
        
        // Configurar Evolution API (WhatsApp)
        if (config.evolution?.serverUrl) {
            Logger.success('EVOLUTION', 'API configurada com sucesso', {
                serverUrl: config.evolution.serverUrl,
                configured: true
            });
        } else {
            Logger.error('EVOLUTION', 'API n√£o configurada', new Error('WhatsApp ser√° desabilitado'));
        }
        
        // Configurar OpenAI (IA)
        if (config.openai?.baseUrl) {
            Logger.success('OPENAI', 'API configurada com sucesso', {
                baseUrl: config.openai.baseUrl,
                model: config.openai.model
            });
        } else {
            Logger.error('OPENAI', 'API n√£o configurada', new Error('IA ser√° desabilitada'));
        }
        
        // Office Integrator removido
        
    } catch (error) {
        Logger.error('INIT', 'Falha na inicializa√ß√£o das configura√ß√µes', error, {
            url: window.location.href,
            timestamp: new Date().toISOString()
        });
        throw error;
    }
}

// ===== SISTEMA SIMPLIFICADO DE INST√ÇNCIA =====
function getInstanceData() {
    try {
        const cookie = document.cookie.split('; ').find(row => row.startsWith('timepulse_instance_token='));
        
        if (cookie) {
            try {
                const cookieValue = decodeURIComponent(cookie.split('=')[1]);
                const tokenData = JSON.parse(cookieValue);
                return tokenData;
            } catch (e) {
                console.error('Error parsing cookie:', e);
            }
        }
        
        const localStorageData = localStorage.getItem('timepulse_instance_token');
        if (localStorageData) {
            try {
                const tokenData = JSON.parse(decodeURIComponent(localStorageData));
                return tokenData;
            } catch (e) {
                console.error('Error parsing localStorage:', e);
            }
        }
        
        const sessionStorageData = sessionStorage.getItem('timepulse_instance_token');
        if (sessionStorageData) {
            try {
                const tokenData = JSON.parse(decodeURIComponent(sessionStorageData));
                return tokenData;
            } catch (e) {
                console.error('Error parsing sessionStorage:', e);
            }
        }
        
        return null;
    } catch (error) {
        console.error('getInstanceData error:', error);
        return null;
    }
}

function isAuthenticated() {
    const instanceData = getInstanceData();
    return instanceData && instanceData.instanceId && instanceData.restaurantId;
}

function requireAuth() {
    // Detectar ambiente de desenvolvimento
    const isDevelopment = window.location.hostname.includes('replit') || 
                         window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' ||
                         window.location.hostname.includes('replit.dev') ||
                         window.location.hostname.includes('repl.co');
    
    if (!isAuthenticated()) {
        if (isDevelopment) {
            console.log('üõ†Ô∏è BYPASS AUTH: Modo desenvolvimento ativo');
            return true; // Bypass para desenvolvimento
        } else {
            window.location.href = 'login.html';
            return false;
        }
    }
    return true;
}

function logout() {
    document.cookie = 'timepulse_instance_token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    window.location.href = 'login.html';
}

// ===== VARI√ÅVEIS GLOBAIS =====
let orders = [];
let filteredOrders = [];
let currentRestaurant = null;
let isFoodBusiness = false; // PADR√ÉO: false (mais seguro em caso de erro)
let businessTypeName = ''; // Nome do tipo de neg√≥cio
let realtimeSubscription = null;
let isFullscreenMode = false;
let isOnline = false;
let realtimeInterval = null;
let audioContext = null;
let newOrderOscillator = null;
let newOrderCheckInterval = null;
let currentNewOrderForNotification = null;
let audioContextResumed = false;
let soundLoopInterval = null;
let acceptedOrdersInterval = null;
let realTimeCheckInterval = null;
let lastKnownOrderCount = 0;
let currentSectorFilter = 'todos';
let currentOrderForProducts = null;
let currentEditingItem = null;
let products = [];
let selectedProduct = null;
let isNewOrderContext = false;
let currentOrderMode = 'delivery';
let currentOrderContext = 'delivery';
let newOrderItems = [];
let routeCalculationTimeout;
let currentOrderForMesaFinalization = null;
let currentOrderForPayment = null;
let deliverers = [];
let ordersManager;

// Vari√°veis globais para o alerta sonoro
let soundIntervals = {};
let newOrderSoundEnabled = true;
let audioIndicatorVisible = false;

// ===== VARI√ÅVEIS PARA ADICIONAIS =====
let currentProductForAddOns = null;
let currentOrderContextForAddOns = null;
let currentDeliveryCoordinates = null;
let currentEstimatedDeliveryTime = null;
let currentDeliveryDistance = null;
let deliveryFeeCalculated = false;

// Vari√°vel global para armazenar o contexto para o callback da busca de CEP
let currentCepContext = null;

// ===== FUN√á√ïES DO MAPBOX E GEOCODIFICA√á√ÉO =====
async function geocodeAddress(address) {
    try {
        // Garantir que o token do Mapbox esteja dispon√≠vel
        const token = await window.ensureMapboxToken();
        
        // Usar a vari√°vel global de forma segura
        const accessToken = window.MAPBOX_ACCESS_TOKEN || MAPBOX_ACCESS_TOKEN;
        
        if (!accessToken) {
            throw new Error('Chave do Mapbox n√£o configurada');
        }
        
        const encodedAddress = encodeURIComponent(address);
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodedAddress}.json?access_token=${accessToken}&country=br&limit=1`;

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Erro na geocodifica√ß√£o: ${response.status}`);
        }

        const data = await response.json();

        if (data.features && data.features.length > 0) {
            const coordinates = data.features[0].center;
            return {
                longitude: coordinates[0],
                latitude: coordinates[1],
                formatted_address: data.features[0].place_name
            };
        }
        throw new Error('Endere√ßo n√£o encontrado');
    } catch (error) {
        throw error;
    }
}

async function calculateRouteDistance(restaurantCoords, deliveryCoords, includeRoundtrip = false) {
    try {
        // Garantir que o token do Mapbox esteja dispon√≠vel
        const token = await window.ensureMapboxToken();
        
        // Usar a vari√°vel global de forma segura
        const accessToken = window.MAPBOX_ACCESS_TOKEN || MAPBOX_ACCESS_TOKEN;
        
        if (!accessToken) {
            throw new Error('Chave do Mapbox n√£o configurada');
        }
        
        let coordinates;

        if (includeRoundtrip) {
            coordinates = `${restaurantCoords.longitude},${restaurantCoords.latitude};${deliveryCoords.longitude},${deliveryCoords.latitude};${restaurantCoords.longitude},${restaurantCoords.latitude}`;
        } else {
            coordinates = `${restaurantCoords.longitude},${restaurantCoords.latitude};${deliveryCoords.longitude},${deliveryCoords.latitude}`;
        }

        const url = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${coordinates}?access_token=${accessToken}&geometries=geojson&overview=simplified`;

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Erro no c√°lculo da rota: ${response.status}`);
        }

        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
            const route = data.routes[0];
            return {
                distance: route.distance / 1000, // Converte de metros para km
                duration: route.duration / 60, // Converte de segundos para minutos
                geometry: route.geometry
            };
        }
        throw new Error('Rota n√£o encontrada');
    } catch (error) {
        throw error;
    }
}

function calculateDeliveryFee(distance, includeRoundtrip = false, deliveryType = 'third-party') {
    // Determinar as configura√ß√µes baseadas no tipo de entrega
    let minimumDistanceKm, minimumDeliveryFee, deliveryFeePerKm, deliveryReturnFee;
    
    if (deliveryType === 'house') {
        // Entrega Pr√≥pria (da Casa)
        minimumDistanceKm = parseFloat(currentRestaurant?.house_minimum_distance_km) || 2.0;
        minimumDeliveryFee = parseFloat(currentRestaurant?.house_minimum_delivery_fee) || 5.00;
        deliveryFeePerKm = parseFloat(currentRestaurant?.house_delivery_fee_per_km) || 2.00;
        deliveryReturnFee = 0; // Entrega pr√≥pria n√£o tem taxa de retorno
    } else {
        // Entrega de Terceiros (Apps de Delivery)
        minimumDistanceKm = parseFloat(currentRestaurant?.minimum_distance_km) || 3.0;
        minimumDeliveryFee = parseFloat(currentRestaurant?.minimum_delivery_fee) || 8.00;
        deliveryFeePerKm = parseFloat(currentRestaurant?.delivery_fee_per_km) || 2.50;
        deliveryReturnFee = parseFloat(currentRestaurant?.delivery_retun) || 5.00;
    }

    // Calcular taxa base
    let totalFee = minimumDeliveryFee;
    
    // Adicionar custo por km extra (acima da dist√¢ncia m√≠nima)
    if (distance > minimumDistanceKm) {
        const extraDistance = distance - minimumDistanceKm;
        totalFee += extraDistance * deliveryFeePerKm;
    }
    
    // Adicionar taxa de retorno se aplic√°vel (apenas para terceiros)
    if (includeRoundtrip && deliveryType === 'third-party' && deliveryReturnFee > 0) {
        totalFee += deliveryReturnFee;
    }
    
    return { totalFee: totalFee };
}

async function calculateDeliveryRoute() {
    const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
    const includeRoundtrip = document.getElementById('deliveryIncludeRoundtrip').checked;
    const deliveryTypeSelect = document.getElementById('deliveryTypeSelect');
    const deliveryType = deliveryTypeSelect?.value || 'third-party'; // Pegar tipo de entrega selecionado
    const deliveryFeeInput = document.getElementById('deliveryFee');
    const deliveryFeeDisplay = document.getElementById('deliveryFeeDisplay');
    const deliveryFeeDisplayTotal = document.getElementById('deliveryFeeDisplayTotal');
    const routeInfoContainer = document.querySelector('.delivery-metrics');

    if (!deliveryAddress || !currentRestaurant?.latitude || !currentRestaurant?.longitude) {
        if (routeInfoContainer) {
            routeInfoContainer.innerHTML = `
                <div class="metric-item">
                    <span class="metric-label">Dist√¢ncia</span>
                    <span class="metric-value">-- km</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Tempo Estimado</span>
                    <span class="metric-value">-- min</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Taxa de Entrega</span>
                    <span class="metric-value">--</span>
                </div>
            `;
        }
        if (deliveryFeeInput) deliveryFeeInput.value = '0.00';
        if (deliveryFeeDisplay) deliveryFeeDisplay.textContent = '0,00';
        if (deliveryFeeDisplayTotal) deliveryFeeDisplayTotal.textContent = '0,00';
        if (ordersManager) ordersManager.updateDeliveryOrderDisplays();
        return;
    }

    if (routeInfoContainer) {
        routeInfoContainer.innerHTML = `
            <div class="route-loading">
                <i class="fas fa-spinner fa-spin"></i>
                Calculando rota...
            </div>
        `;
    }
    if (deliveryFeeInput) deliveryFeeInput.value = '0.00';
    if (deliveryFeeDisplay) deliveryFeeDisplay.textContent = '0,00';
    if (deliveryFeeDisplayTotal) deliveryFeeDisplayTotal.textContent = '0,00';
    if (ordersManager) ordersManager.updateDeliveryOrderDisplays();

    try {
        const restaurantCoords = {
            longitude: currentRestaurant.longitude,
            latitude: currentRestaurant.latitude
        };
        const deliveryCoords = await geocodeAddress(deliveryAddress);

        const routeData = await calculateRouteDistance(restaurantCoords, deliveryCoords, includeRoundtrip);

        currentDeliveryDistance = routeData.distance;
        currentEstimatedDeliveryTime = routeData.duration;
        currentDeliveryCoordinates = deliveryCoords;
        deliveryFeeCalculated = true;

        // Calcular taxa de entrega usando o tipo selecionado (terceiros ou pr√≥pria)
        const fee = calculateDeliveryFee(routeData.distance, includeRoundtrip, deliveryType);

        if (deliveryFeeInput) deliveryFeeInput.value = fee.totalFee.toFixed(2);
        if (deliveryFeeDisplay) deliveryFeeDisplay.textContent = fee.totalFee.toFixed(2).replace('.', ',');
        if (deliveryFeeDisplayTotal) deliveryFeeDisplayTotal.textContent = fee.totalFee.toFixed(2).replace('.', ',');
        
        // Atualizar routeInfoContainer com os resultados (remover spinner)
        if (routeInfoContainer) {
            routeInfoContainer.innerHTML = `
                <div class="metric-item">
                    <span class="metric-label">Dist√¢ncia</span>
                    <span class="metric-value" id="deliveryDistanceDisplay">${routeData.distance.toFixed(1).replace('.', ',')} km</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Tempo Estimado</span>
                    <span class="metric-value" id="deliveryDurationDisplay">${Math.round(routeData.duration)} min</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Taxa de Entrega</span>
                    <span class="metric-value" id="deliveryFeeMetricDisplay">R$ ${fee.totalFee.toFixed(2).replace('.', ',')}</span>
                </div>
            `;
        }
        
        // Mostrar indicador de taxa calculada
        const indicator = document.getElementById('deliveryFeeCalculatedIndicator');
        if (indicator) indicator.style.display = 'block';
        
        if (ordersManager) ordersManager.updateDeliveryOrderDisplays();
    } catch (error) {
        deliveryFeeCalculated = false;
        const indicator = document.getElementById('deliveryFeeCalculatedIndicator');
        if (indicator) indicator.style.display = 'none';
        
        if (routeInfoContainer) {
            routeInfoContainer.innerHTML = `
                <div class="route-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao calcular rota. Verifique o endere√ßo.
                </div>
            `;
        }
    }
}

// Fun√ß√£o para calcular taxa de entrega manualmente (acionada pelo bot√£o)
async function manuallyCalculateDeliveryFee() {
    // Validar campos obrigat√≥rios
    const deliveryAddress = document.getElementById('deliveryAddress')?.value.trim();
    const deliveryType = document.getElementById('deliveryTypeSelect')?.value;
    
    if (!deliveryType) {
        if (ordersManager) ordersManager.showNotification('Selecione o tipo de entrega antes de calcular a taxa', 'warning');
        return;
    }
    
    if (!deliveryAddress) {
        if (ordersManager) ordersManager.showNotification('Preencha o endere√ßo de entrega antes de calcular a taxa', 'warning');
        return;
    }
    
    // Verificar se as coordenadas do restaurante existem
    if (!currentRestaurant?.latitude || !currentRestaurant?.longitude) {
        // Tentar fazer geocoding do endere√ßo do restaurante
        if (!currentRestaurant?.address) {
            if (ordersManager) ordersManager.showNotification('Endere√ßo do restaurante n√£o configurado. Por favor, configure o endere√ßo nas configura√ß√µes.', 'error');
            return;
        }
        
        try {
            if (ordersManager) ordersManager.showNotification('Buscando coordenadas do restaurante...', 'info');
            
            // Fazer geocoding do endere√ßo do restaurante
            const restaurantFullAddress = `${currentRestaurant.address}, ${currentRestaurant.city || ''}, ${currentRestaurant.state || ''}, Brasil`;
            const restaurantCoords = await geocodeAddress(restaurantFullAddress);
            
            if (!restaurantCoords || !restaurantCoords.latitude || !restaurantCoords.longitude) {
                if (ordersManager) ordersManager.showNotification('N√£o foi poss√≠vel localizar o endere√ßo do restaurante. Verifique o endere√ßo nas configura√ß√µes.', 'error');
                return;
            }
            
            // Salvar as coordenadas no banco de dados
            const { error: updateError } = await supabase
                .from('restaurants')
                .update({
                    latitude: restaurantCoords.latitude,
                    longitude: restaurantCoords.longitude
                })
                .eq('id', currentRestaurant.id);
            
            if (updateError) {
                console.error('Erro ao salvar coordenadas do restaurante:', updateError);
                if (ordersManager) ordersManager.showNotification('Erro ao salvar coordenadas do restaurante', 'error');
                return;
            }
            
            // Atualizar currentRestaurant com as novas coordenadas
            currentRestaurant.latitude = restaurantCoords.latitude;
            currentRestaurant.longitude = restaurantCoords.longitude;
            
            if (ordersManager) ordersManager.showNotification('Coordenadas do restaurante configuradas com sucesso!', 'success');
        } catch (error) {
            console.error('Erro ao geocodificar endere√ßo do restaurante:', error);
            if (ordersManager) ordersManager.showNotification('Erro ao buscar coordenadas do restaurante. Verifique o endere√ßo nas configura√ß√µes.', 'error');
            return;
        }
    }
    
    // Resetar o indicador enquanto calcula
    deliveryFeeCalculated = false;
    const indicator = document.getElementById('deliveryFeeCalculatedIndicator');
    if (indicator) indicator.style.display = 'none';
    
    // Chamar a fun√ß√£o de c√°lculo
    await calculateDeliveryRoute();
}

function pesquisacep(valor, context) {
    currentCepContext = context;
    const cepRegex = /^[0-9]{5}-?[0-9]{3}$/;
    valor = valor.replace(/\D/g, '');

    if (cepRegex.test(valor)) {
        limpa_formul√°rio_cep(context);

        const script = document.createElement('script');
        script.src = `https://viacep.com.br/ws/${valor}/json/?callback=meu_callback`;
        document.body.appendChild(script);
    } else {
        limpa_formul√°rio_cep(context);
        if (valor.length > 0) {
            if (ordersManager) ordersManager.showNotification('Formato de CEP inv√°lido.', 'warning');
        }
    }
}

function meu_callback(conteudo) {
    const context = currentCepContext;

    if (!("erro" in conteudo)) {
        if (context === 'delivery') {
            document.getElementById('deliveryRua').value = (conteudo.logradouro);
            document.getElementById('deliveryBairro').value = (conteudo.bairro);
            document.getElementById('deliveryCidade').value = (conteudo.localidade);
            document.getElementById('deliveryUf').value = (conteudo.uf);
            // Atualizar endere√ßo completo e calcular rota
            updateDeliveryAddress();
        } else if (context === 'newCustomer') {
            document.getElementById('newCustomerRua').value = (conteudo.logradouro);
            document.getElementById('newCustomerBairro').value = (conteudo.bairro);
            document.getElementById('newCustomerCidade').value = (conteudo.localidade);
            document.getElementById('newCustomerUf').value = (conteudo.uf);
        }
    } else {
        limpa_formul√°rio_cep(context);
        if (ordersManager) ordersManager.showNotification("CEP n√£o encontrado.", 'warning');
    }

    const scriptElements = document.getElementsByTagName('script');
    for (let i = 0; i < scriptElements.length; i++) {
        if (scriptElements[i].src.includes('viacep.com.br')) {
            document.body.removeChild(scriptElements[i]);
            break;
        }
    }
}

function limpa_formul√°rio_cep(context) {
    if (context === 'delivery') {
        document.getElementById('deliveryRua').value = "";
        document.getElementById('deliveryBairro').value = "";
        document.getElementById('deliveryCidade').value = "";
        document.getElementById('deliveryUf').value = "";
        document.getElementById('deliveryAddress').value = "";
    } else if (context === 'newCustomer') {
        document.getElementById('newCustomerRua').value = "";
        document.getElementById('newCustomerBairro').value = "";
        document.getElementById('newCustomerCidade').value = "";
        document.getElementById('newCustomerUf').value = "";
    }
}

// Fun√ß√£o para atualizar o endere√ßo completo e recalcular a rota
function updateDeliveryAddress() {
    const rua = document.getElementById('deliveryRua')?.value || '';
    const numero = document.getElementById('deliveryNumber')?.value || '';
    const complemento = document.getElementById('deliveryComplement')?.value || '';
    const bairro = document.getElementById('deliveryBairro')?.value || '';
    const cidade = document.getElementById('deliveryCidade')?.value || '';
    const uf = document.getElementById('deliveryUf')?.value || '';
    
    // Resetar flag de taxa calculada quando endere√ßo mudar
    deliveryFeeCalculated = false;
    const indicator = document.getElementById('deliveryFeeCalculatedIndicator');
    if (indicator) indicator.style.display = 'none';
    
    // Se tiver pelo menos rua, cidade e UF, monta o endere√ßo
    if (rua && cidade && uf) {
        // Monta o endere√ßo completo filtrando campos vazios
        const partes = [
            rua,
            numero,
            complemento,
            bairro,
            `${cidade} - ${uf}`
        ].filter(parte => parte && parte.trim() !== '');
        
        const enderecoCompleto = partes.join(', ');
        document.getElementById('deliveryAddress').value = enderecoCompleto;
        
        // N√ÉO recalcula automaticamente - usu√°rio deve clicar no bot√£o "Calcular Taxa de Entrega"
        // calculateDeliveryRoute();
    }
}

// ===== FUN√á√ÉO PARA VERIFICAR TIPO DE NEG√ìCIO E APLICAR UI CONDICIONAL =====
async function checkBusinessTypeAndApplyUI(restaurant) {
    try {
        console.log('üè™ Verificando tipo de neg√≥cio do restaurante...');
        
        // Se n√£o tiver business_type_id, mant√©m padr√£o false (n√£o aliment√≠cio)
        if (!restaurant.business_type_id) {
            console.log('‚ö†Ô∏è Restaurant sem business_type_id definido. Mantendo padr√£o (n√£o aliment√≠cio).');
            isFoodBusiness = false;
            businessTypeName = 'N√£o definido';
            applyBusinessTypeUI();
            return;
        }
        
        // Buscar informa√ß√µes do tipo de neg√≥cio
        const { data: businessType, error } = await supabase
            .from('business_types')
            .select('id, name, description, is_food_business')
            .eq('id', restaurant.business_type_id)
            .single();
        
        if (error) {
            console.error('‚ùå Erro ao buscar business_type:', error);
            console.log('‚ö†Ô∏è Mantendo padr√£o isFoodBusiness = false (mais seguro)');
            isFoodBusiness = false;
            applyBusinessTypeUI();
            return;
        }
        
        if (!businessType) {
            console.log('‚ö†Ô∏è Business type n√£o encontrado. Mantendo padr√£o (n√£o aliment√≠cio).');
            isFoodBusiness = false;
            applyBusinessTypeUI();
            return;
        }
        
        // Usar a propriedade is_food_business diretamente do banco
        businessTypeName = businessType.name;
        isFoodBusiness = businessType.is_food_business === true;
        
        console.log(`‚úÖ Tipo de neg√≥cio: ${businessTypeName}`);
        console.log(`üìä √â setor de alimentos: ${isFoodBusiness}`);
        
        // Aplicar mudan√ßas de UI baseado no tipo de neg√≥cio
        applyBusinessTypeUI();
        
    } catch (error) {
        console.error('‚ùå Erro ao verificar tipo de neg√≥cio:', error);
        console.log('‚ö†Ô∏è Mantendo padr√£o isFoodBusiness = false (mais seguro)');
        isFoodBusiness = false;
        applyBusinessTypeUI();
    }
}

// ===== FUN√á√ÉO PARA APLICAR UI BASEADO NO TIPO DE NEG√ìCIO =====
function applyBusinessTypeUI() {
    console.log('üé® Aplicando UI condicional baseada no tipo de neg√≥cio...');
    
    if (!isFoodBusiness) {
        console.log('üö´ Neg√≥cio N√ÉO √© do setor de alimentos. Ocultando elementos espec√≠ficos...');
        
        // 1. Ocultar bot√µes BALC√ÉO e MESA nos filtros de setor
        const balcaoFilterBtn = document.querySelector('.sector-filter-btn[data-sector="balcao"]');
        const mesaFilterBtn = document.querySelector('.sector-filter-btn[data-sector="mesa"]');
        
        if (balcaoFilterBtn) {
            balcaoFilterBtn.style.display = 'none';
            console.log('‚úÖ Bot√£o filtro BALC√ÉO ocultado');
        }
        
        if (mesaFilterBtn) {
            mesaFilterBtn.style.display = 'none';
            console.log('‚úÖ Bot√£o filtro MESA ocultado');
        }
        
        // 2. Ocultar op√ß√µes BALC√ÉO e MESA no modal de sele√ß√£o de tipo de pedido
        const balcaoTypeBtn = document.querySelector('.order-type-btn.balcao');
        const mesaTypeBtn = document.querySelector('.order-type-btn.mesa');
        
        if (balcaoTypeBtn) {
            balcaoTypeBtn.style.display = 'none';
            console.log('‚úÖ Op√ß√£o BALC√ÉO no modal ocultada');
        }
        
        if (mesaTypeBtn) {
            mesaTypeBtn.style.display = 'none';
            console.log('‚úÖ Op√ß√£o MESA no modal ocultada');
        }
        
        // 3. Ocultar menu "Cozinha" no menu lateral
        const cozinhaLink = document.querySelector('a[href="cozinha.html"]');
        if (cozinhaLink) {
            cozinhaLink.style.display = 'none';
            console.log('‚úÖ Menu Cozinha ocultado');
        }
        
        // 4. Renomear "Card√°pio" para "Produtos" no menu lateral
        const cardapioLink = document.querySelector('a[href="cardapio.html"]');
        if (cardapioLink) {
            const cardapioText = cardapioLink.querySelector('span:not(.nav-icon)');
            if (!cardapioText) {
                // Se n√£o houver span separado, procurar pelo texto direto
                const textNodes = Array.from(cardapioLink.childNodes).filter(node => node.nodeType === 3);
                textNodes.forEach(node => {
                    if (node.textContent.trim() === 'Card√°pio') {
                        node.textContent = node.textContent.replace('Card√°pio', 'Produtos');
                        console.log('‚úÖ "Card√°pio" renomeado para "Produtos"');
                    }
                });
            } else {
                cardapioText.textContent = 'Produtos';
                console.log('‚úÖ "Card√°pio" renomeado para "Produtos"');
            }
        }
        
        console.log('‚úÖ UI ajustada para neg√≥cio N√ÉO aliment√≠cio');
        
    } else {
        console.log('‚úÖ Neg√≥cio √© do setor de alimentos. UI padr√£o mantida.');
    }
}

// ===== CLASSE PRINCIPAL =====
class OrdersManager {
    constructor() {
        this.orders = [];
        this.filteredOrders = [];
        this.editingOrderId = null;
        this.updateInterval = null;
        this.currentSearchPhone = null;
        this.currentOrderForDelivery = null;
        this.deliverers = [];
        this.currentOrderForProducts = null;
        this.currentEditingItem = null;
        this.products = [];
        this.selectedProduct = null;
        this.isNewOrderContext = false;
        this.currentOrderMode = 'delivery';
        this.currentOrderContext = 'delivery';
        this.newOrderItems = [];
        this.currentOrderForMesaFinalization = null;
        this.currentOrderForPayment = null;
        this.shownNewOrderIds = new Set();
    }

    async init() {
        try {
            await this.loadRestaurantInfo();
            await this.loadOrders();
            await this.loadProducts();
            this.setupEventListeners();
            this.setupRealtimeUpdates();
            this.setupAutoRefresh();
            this.setupEnhancedRealTimeCheck();
            startNewOrderChecking();
            startAcceptedOrdersChecking();
        } catch (error) {
            this.showNotification('Erro ao carregar dados', 'error');
        }
    }

    async loadRestaurantInfo() {
        try {
            // Obt√©m dados da inst√¢ncia atual
            const currentInstance = getInstanceData();
            if (!currentInstance) {
                throw new Error('Inst√¢ncia n√£o encontrada na sess√£o. Redirecionando...');
            }
            const restaurantId = currentInstance.restaurantId;

            const { data: restaurant, error } = await supabase
                .from('restaurants')
                .select('*')
                .eq('id', restaurantId)
                .single();

            if (error) throw error;
            if (!restaurant) {
                throw new Error('Restaurante n√£o encontrado. Verifique o ID.');
            }

            currentRestaurant = restaurant;
            const restaurantNameElement = document.getElementById('restaurantName');
            if (restaurantNameElement) {
                restaurantNameElement.textContent = restaurant.name;
            }

            if (restaurant.primary_color) {
                document.documentElement.style.setProperty('--primary-color', restaurant.primary_color);
            }

            isOnline = restaurant.pedidos_online || false;
            updateOnlineToggleUI();

            // Verificar tipo de neg√≥cio e aplicar UI condicional
            await checkBusinessTypeAndApplyUI(restaurant);

        } catch (error) {
            console.error('‚ùå Erro ao carregar dados do restaurante:', error);
            this.showNotification('Erro ao carregar dados do restaurante. Verifique sua conex√£o.', 'error');
            
            // Tentar recarregar ap√≥s alguns segundos
            setTimeout(() => {
                this.loadRestaurantData();
            }, 5000);
        }
    }

    async loadOrders() {
        try {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }

            const currentInstance = getInstanceData();
            if (!currentInstance) {
                throw new Error('Inst√¢ncia n√£o encontrada para carregar pedidos.');
            }
            const restaurantId = currentInstance.restaurantId;

            console.log('üìä Carregando pedidos do Supabase para restaurante:', restaurantId);

            let ordersData, itemsData, deliverersData = [];

            // Carregar pedidos do Supabase
            const { data: supabaseOrdersData, error: ordersError } = await supabase
                .from('orders')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .order('created_at', { ascending: false });

            if (ordersError) {
                console.error('‚ùå Erro ao carregar pedidos:', ordersError);
                throw ordersError;
            }
            
            ordersData = supabaseOrdersData || [];
            console.log('‚úÖ Pedidos carregados do Supabase:', ordersData.length);

            // Carregar itens dos pedidos
            if (ordersData.length > 0) {
                const { data: supabaseItemsData, error: itemsError } = await supabase
                    .from('order_items')
                    .select('*')
                    .in('order_id', ordersData.map(order => order.id));

                if (itemsError) {
                    console.error('‚ùå Erro ao carregar itens:', itemsError);
                    throw itemsError;
                }
                itemsData = supabaseItemsData || [];
                console.log('‚úÖ Itens carregados do Supabase:', itemsData.length);
            } else {
                itemsData = [];
                console.log('‚ÑπÔ∏è Nenhum pedido encontrado para este restaurante');
            }

            // Continuar processamento...

            // Buscar dados dos entregadores para pedidos que t√™m deliverer_id
            const delivererIds = [...new Set(ordersData.filter(order => order.deliverer_id).map(order => order.deliverer_id))];
            deliverersData = [];
            
            if (delivererIds.length > 0) {
                const { data: deliverersResponse, error: deliverersError } = await supabase
                    .from('deliverers')
                    .select('id, name')
                    .in('id', delivererIds);
                
                if (!deliverersError) {
                    deliverersData = deliverersResponse || [];
                }
            }

            const ordersWithItems = ordersData.map(order => {
                const deliverer = deliverersData.find(d => d.id === order.deliverer_id);
                return {
                    ...order,
                    order_number: String(order.id).slice(-8).toUpperCase(),
                    order_items: itemsData.filter(item => item.order_id === order.id),
                    deliverer_name: deliverer?.name || null
                };
            });

            this.orders = ordersWithItems;

            // --- NOVO --- : L√≥gica para o alerta sonoro e modal
            const newOrders = this.orders.filter(order => order.status === 'novo');
            if (newOrders.length > 0 && newOrderSoundEnabled) {
                newOrders.forEach(order => {
                    if (!soundIntervals[order.id]) {
                        soundIntervals[order.id] = playNewOrderSoundLoop();
                    }
                });
            }

            for (const orderId in soundIntervals) {
                const orderExists = this.orders.some(o => o.id === orderId);
                const orderStatusIsNew = this.orders.find(o => o.id === orderId)?.status === 'novo';
                if (!orderExists || !orderStatusIsNew) {
                    stopNewOrderSound(orderId);
                }
            }


            const newOrderToShow = this.orders.find(order =>
                order.status === 'novo' && !this.shownNewOrderIds.has(order.id)
            );

            if (newOrderToShow) {
                this.openOrderDetails(newOrderToShow.id);
                this.shownNewOrderIds.add(newOrderToShow.id); // Marca como j√° exibido para n√£o repetir
            }
            // --- FIM DA L√ìGICA NOVA ---

            this.applyDefaultFilters();
            this.renderOrders();

            const ordersCountElement = document.getElementById('ordersCount');
            if (ordersCountElement) {
                ordersCountElement.textContent = this.filteredOrders.length;
            }

            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

        } catch (error) {
            this.showNotification('Erro ao carregar pedidos', 'error');
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    }

    async loadProducts() {
        try {
            const currentInstance = getInstanceData();
            if (!currentInstance) {
                throw new Error('Inst√¢ncia n√£o encontrada para carregar produtos.');
            }
            const restaurantId = currentInstance.restaurantId;

            const { data: products, error: productsError } = await supabase
                .from('products')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .eq('active', true)
                .order('name');

            if (productsError) throw productsError;

            const { data: categories, error: categoriesError } = await supabase
                .from('product_categories')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .eq('active', true);

            if (categoriesError) throw categoriesError;

            const productsWithCategories = products.map(product => ({
                ...product,
                product_categories: categories.find(cat => cat.id === product.category_id) || null
            }));

            this.products = productsWithCategories;
            return productsWithCategories;
        } catch (error) {
            this.showNotification('Erro ao carregar produtos', 'error');
            return [];
        }
    }

    async loadDeliverers() {
        try {
            const currentInstance = getInstanceData();
            if (!currentInstance) {
                throw new Error('Inst√¢ncia n√£o encontrada para carregar entregadores.');
            }
            const restaurantId = currentInstance.restaurantId;

            // Buscar todos os entregadores ativos
            const { data: allDeliverers, error: deliverersError } = await supabase
                .from('deliverers')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .eq('status', 'active');

            if (deliverersError) throw deliverersError;

            // Buscar pedidos que est√£o "saiu_entrega" para identificar entregadores ocupados
            const { data: ordersInDelivery, error: ordersError } = await supabase
                .from('orders')
                .select('deliverer_id')
                .eq('restaurant_id', restaurantId)
                .eq('status', 'saiu_entrega')
                .not('deliverer_id', 'is', null);

            if (ordersError) throw ordersError;

            // IDs dos entregadores que est√£o ocupados
            const busyDelivererIds = new Set(ordersInDelivery.map(order => order.deliverer_id));

            // Filtrar entregadores dispon√≠veis (n√£o ocupados)
            const data = allDeliverers.filter(deliverer => !busyDelivererIds.has(deliverer.id));
            this.deliverers = data;
            return data;
        } catch (error) {
            this.showNotification('Erro ao carregar entregadores.', 'error');
            return [];
        }
    }

    applyDefaultFilters() {
        this.filteredOrders = this.orders.filter(order => {
            return order.status !== 'entregue' && order.status !== 'cancelado' && order.status !== 'encerrado' && order.status !== 'aguardando';
        });
    }

    applyFilters() {
        const statusElement = document.getElementById('statusFilter');
        const searchElement = document.getElementById('searchInput');
        const dateElement = document.getElementById('dateFilter');

        const status = statusElement ? statusElement.value : '';
        const search = searchElement ? searchElement.value.toLowerCase() : '';
        const date = dateElement ? dateElement.value : '';

        this.filteredOrders = this.orders.filter(order => {
            const orderSector = getOrderSector(order);
            if (currentSectorFilter !== 'todos' && orderSector !== currentSectorFilter) {
                return false;
            }

            if (status && status !== '') {
                if (order.status !== status) {
                    return false;
                }
            } else {
                if (order.status === 'entregue' || order.status === 'cancelado' || order.status === 'encerrado') {
                    return false;
                }
            }

            if (search && search !== '') {
                const searchInName = order.customer_name?.toLowerCase().includes(search);
                const searchInNumber = order.order_number?.toLowerCase().includes(search);
                const searchInPhone = order.customer_phone?.replace(/\D/g, '').includes(search.replace(/\D/g, ''));

                if (!searchInName && !searchInNumber && !searchInPhone) {
                    return false;
                }
            }

            if (date && date !== '') {
                const orderDate = order.created_at.split('T')[0];
                if (orderDate !== date) {
                    return false;
                }
            }

            return true;
        });

        this.renderOrders();
        const ordersCountElement = document.getElementById('ordersCount');
        if (ordersCountElement) {
            ordersCountElement.textContent = this.filteredOrders.length;
        }
    }

    clearFilters() {
        const statusElement = document.getElementById('statusFilter');
        const searchElement = document.getElementById('searchInput');
        const dateElement = document.getElementById('dateFilter');

        if (statusElement) statusElement.value = '';
        if (searchElement) searchElement.value = '';
        if (dateElement) dateElement.value = '';

        currentSectorFilter = 'todos';
        document.querySelectorAll('.sector-filter-btn').forEach(btn => btn.classList.remove('active'));
        const todosBtn = document.querySelector('[data-sector="todos"]');
        if (todosBtn) todosBtn.classList.add('active');

        this.applyDefaultFilters();
        this.renderOrders();

        const ordersCountElement = document.getElementById('ordersCount');
        if (ordersCountElement) {
            ordersCountElement.textContent = this.filteredOrders.length;
        }
    }

    renderOrders() {
        const container = document.getElementById('ordersGrid');
        if (!container) {
            return;
        }

        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'none';
        }

        if (this.filteredOrders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Nenhum pedido encontrado</h3>
                    <p>Novos pedidos aparecer√£o aqui automaticamente</p>
                </div>
            `;
            return;
        }

        container.innerHTML = this.filteredOrders.map(order => this.createOrderCard(order)).join('');
    }

    createOrderCard(order) {
        const statusClass = this.getStatusClass(order.status);
        const statusLabel = this.getStatusLabel(order.status);
        const timeAgo = this.getTimeAgo(order.created_at);
        const total = parseFloat(order.total || order.total_amount || 0);
        const orderSector = getOrderSector(order);
        const orderIcon = this.getOrderIcon(orderSector);

        return `
            <div class="order-card ${statusClass}" data-order-id="${order.id}" onclick="ordersManager.openOrderDetails('${order.id}')">
                <div class="order-header">
                    <div class="order-number">#${order.order_number}</div>
                    <div class="order-status ${order.status}">${statusLabel}</div>
                </div>

                <div class="order-type">
                    <div class="order-type-icon">
                        <i class="fas ${orderIcon}"></i>
                    </div>
                    <span>${this.getOrderTypeLabel(orderSector)}</span>
                </div>

                <div class="order-customer">${order.customer_name}</div>

                <div class="order-details">
                    <div class="order-detail">
                        <i class="fas fa-phone"></i>
                        <span>${order.customer_phone}</span>
                    </div>
                    <div class="order-detail">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${order.delivery_address}</span>
                    </div>
                    <div class="order-detail">
                        <i class="fas fa-clock"></i>
                        <span>${timeAgo}</span>
                    </div>
                    ${order.status === 'saiu_entrega' && order.deliverer_name ? `
                        <div class="order-detail">
                            <i class="fas fa-motorcycle"></i>
                            <span>Entregador: ${order.deliverer_name}</span>
                        </div>
                    ` : ''}
                </div>

                <div class="order-footer">
                    <div class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</div>
                    <div class="order-actions">
                        ${this.getOrderActions(order)}
                    </div>
                </div>
            </div>
        `;
    }

    getOrderIcon(sector) {
        const icons = {
            'delivery': 'fa-motorcycle',
            'balcao': 'fa-shopping-bag',
            'mesa': 'fa-utensils'
        };
        return icons[sector] || 'fa-shopping-cart';
    }

    getOrderTypeLabel(sector) {
        const labels = {
            'delivery': 'Delivery',
            'balcao': 'Balc√£o',
            'mesa': 'Mesa'
        };
        return labels[sector] || 'Pedido';
    }

    getOrderActions(order) {
        const actions = [];
        const orderSector = getOrderSector(order);
        switch (order.status) {
            case 'novo':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'aceito')"><i class="fas fa-check"></i></button>`);
                actions.push(`<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'rejeitado')"><i class="fas fa-times"></i></button>`);
                break;
            case 'aceito':
                actions.push(`<button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'preparo')"><i class="fas fa-utensils"></i></button>`);
                break;
            case 'preparo':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatus('${order.id}', 'pronto')"><i class="fas fa-check-circle"></i></button>`);
                break;
            case 'pronto':
                if (orderSector === 'delivery') {
                    actions.push(`<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openDelivererSelectionModal('${order.id}')"><i class="fas fa-motorcycle"></i></button>`);
                } else {
                    actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); ordersManager.updateOrderStatusFromDetails('${order.id}', 'entregue')"><i class="fas fa-check-double"></i></button>`);
                }
                break;
            case 'saiu_entrega':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openPaymentMethodModal('${order.id}')"><i class="fas fa-flag-checkered"></i></button>`);
                break;
            case 'Aberta':
                actions.push(`<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openFinalizarMesaModal('${order.id}')"><i class="fas fa-dollar-sign"></i></button>`);
                break;
        }
        return actions.join('');
    }

    renderDeliveryOrderItems() {
        const tbody = document.getElementById('deliveryItemsTableBody');
        if (!tbody) return;

        if (this.newOrderItems.length === 0) {
            tbody.innerHTML = `
                <tr class="no-items-row">
                    <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o bot√£o "Adicionar Item".</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = this.newOrderItems.map((item, index) => `
                <tr>
                    <td>
                        <div class="item-name-cell">${item.name}</div>
                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                    </td>
                    <td class="item-quantity-cell">
                        <input type="number" value="${item.quantity}" min="1"
                                onchange="updateDeliveryOrderItemQuantity(${index}, this.value)"
                                style="width: 60px; text-align: center;">
                    </td>
                    <td class="item-price-cell">
                        <input type="number" value="${item.price.toFixed(2)}" step="0.01"
                                onchange="updateDeliveryOrderItemPrice(${index}, this.value)"
                                style="width: 80px; text-align: right;">
                    </td>
                    <td class="item-total-cell">R$ ${(item.quantity * item.price).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <div class="item-actions">
                            <button type="button" class="item-action-btn edit" onclick="editDeliveryOrderItemNotes(${index})" title="Observa√ß√µes">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="item-action-btn delete" onclick="removeDeliveryOrderItem(${index})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        this.updateDeliveryOrderDisplays();
    }

    renderBalcaoOrderItems() {
        const tbody = document.getElementById('balcaoItemsTableBody');
        if (!tbody) return;

        if (this.newOrderItems.length === 0) {
            tbody.innerHTML = `
                <tr class="no-items-row">
                    <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o bot√£o "Adicionar Item".</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = this.newOrderItems.map((item, index) => `
                <tr>
                    <td>
                        <div class="item-name-cell">${item.name}</div>
                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                    </td>
                    <td class="item-quantity-cell">
                        <input type="number" value="${item.quantity}" min="1"
                                onchange="updateBalcaoOrderItemQuantity(${index}, this.value)"
                                style="width: 60px; text-align: center;">
                    </td>
                    <td class="item-price-cell">
                        <input type="number" value="${item.price.toFixed(2)}" step="0.01"
                                onchange="updateBalcaoOrderItemPrice(${index}, this.value)"
                                style="width: 80px; text-align: right;">
                    </td>
                    <td class="item-total-cell">R$ ${(item.quantity * item.price).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <div class="item-actions">
                            <button type="button" class="item-action-btn edit" onclick="editBalcaoOrderItemNotes(${index})" title="Observa√ß√µes">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="item-action-btn delete" onclick="removeBalcaoOrderItem(${index})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        this.updateBalcaoOrderDisplays();
    }

    renderMesaOrderItems() {
        const tbody = document.getElementById('mesaItemsTableBody');
        if (!tbody) return;

        if (this.newOrderItems.length === 0) {
            tbody.innerHTML = `
                <tr class="no-items-row">
                    <td colspan="5">Nenhum item adicionado ainda. Use a busca acima ou o bot√£o "Adicionar Item".</td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = this.newOrderItems.map((item, index) => `
                <tr>
                    <td>
                        <div class="item-name-cell">${item.name}</div>
                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                    </td>
                    <td class="item-quantity-cell">
                        <input type="number" value="${item.quantity}" min="1"
                                onchange="updateMesaOrderItemQuantity(${index}, this.value)"
                                style="width: 60px; text-align: center;">
                    </td>
                    <td class="item-price-cell">
                        <input type="number" value="${item.price.toFixed(2)}" step="0.01"
                                onchange="updateMesaOrderItemPrice(${index}, this.value)"
                                style="width: 80px; text-align: right;">
                    </td>
                    <td class="item-total-cell">R$ ${(item.quantity * item.price).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <div class="item-actions">
                            <button type="button" class="item-action-btn edit" onclick="editMesaOrderItemNotes(${index})" title="Observa√ß√µes">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="item-action-btn delete" onclick="removeMesaOrderItem(${index})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        this.updateMesaOrderDisplays();
    }

    updateDeliveryOrderDisplays() {
        let subtotal = 0;
        this.newOrderItems.forEach(item => {
            subtotal += item.quantity * item.price;
        });

        const deliveryFeeInput = document.getElementById('deliveryFee');
        const deliveryFee = deliveryFeeInput ? parseFloat(deliveryFeeInput.value) || 0 : 0;
        const total = subtotal + deliveryFee;

        const subtotalDisplay = document.getElementById('deliverySubtotalDisplay');
        const feeDisplay = document.getElementById('deliveryFeeDisplayTotal');
        const totalDisplay = document.getElementById('deliveryTotalDisplay');

        if (subtotalDisplay) subtotalDisplay.textContent = subtotal.toFixed(2).replace('.', ',');
        if (feeDisplay) feeDisplay.textContent = deliveryFee.toFixed(2).replace('.', ',');
        if (totalDisplay) totalDisplay.textContent = total.toFixed(2).replace('.', ',');

        const subtotalHidden = document.getElementById('deliverySubtotal');
        const totalHidden = document.getElementById('deliveryTotal');
        if (subtotalHidden) subtotalHidden.value = subtotal.toFixed(2);
        if (totalHidden) totalHidden.value = total.toFixed(2);
    }

    updateBalcaoOrderDisplays() {
        let subtotal = 0;
        this.newOrderItems.forEach(item => {
            subtotal += item.quantity * item.price;
        });

        const totalDisplay = document.getElementById('balcaoTotalDisplay');
        if (totalDisplay) totalDisplay.textContent = subtotal.toFixed(2).replace('.', ',');

        const subtotalHidden = document.getElementById('balcaoSubtotal');
        const totalHidden = document.getElementById('balcaoTotal');
        if (subtotalHidden) subtotalHidden.value = subtotal.toFixed(2);
        if (totalHidden) totalHidden.value = subtotal.toFixed(2);
    }

    updateMesaOrderDisplays() {
        let subtotal = 0;
        this.newOrderItems.forEach(item => {
            subtotal += item.quantity * item.price;
        });

        const serviceFeeCheckbox = document.getElementById('mesaServiceFee');
        const serviceFee = serviceFeeCheckbox && serviceFeeCheckbox.checked ? subtotal * 0.10 : 0;
        const total = subtotal + serviceFee;

        const subtotalDisplay = document.getElementById('mesaSubtotalDisplay');
        const serviceFeeDisplay = document.getElementById('mesaServiceFeeDisplay');
        const totalDisplay = document.getElementById('mesaTotalDisplay');
        const serviceFeeDisplayDiv = document.getElementById('mesaServiceFeeDisplayDiv');

        if (subtotalDisplay) subtotalDisplay.textContent = subtotal.toFixed(2).replace('.', ',');
        if (serviceFeeDisplay) serviceFeeDisplay.textContent = serviceFee.toFixed(2).replace('.', ',');
        if (totalDisplay) totalDisplay.textContent = total.toFixed(2).replace('.', ',');
        if (serviceFee > 0 && serviceFeeDisplayDiv) {
            serviceFeeDisplayDiv.style.display = 'flex';
        } else if (serviceFeeDisplayDiv) {
            serviceFeeDisplayDiv.style.display = 'none';
        }

        const subtotalHidden = document.getElementById('mesaSubtotal');
        const totalHidden = document.getElementById('mesaTotal');
        if (subtotalHidden) subtotalHidden.value = subtotal.toFixed(2);
        if (totalHidden) totalHidden.value = total.toFixed(2);
    }

    async performProductSearch(searchTerm, context) {
        const resultsContainer = document.getElementById(`${context}SearchResults`);

        if (!resultsContainer) return;

        if (!searchTerm || searchTerm.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        const searchLower = searchTerm.toLowerCase();

        const filtered = this.products.filter(product => {
            const last4Digits = product.id.slice(-4);
            const productNameLower = product.name.toLowerCase();
            return productNameLower.includes(searchLower) || last4Digits.includes(searchTerm);
        });

        if (filtered.length > 0) {
            resultsContainer.innerHTML = filtered.slice(0, 5).map(product => {
                const last4Digits = product.id.slice(-4);
                const productJsonString = JSON.stringify(product).replace(/"/g, '&quot;');
                return `
                    <div class="search-result-item" onclick='handleProductSelection(${productJsonString}, "${context}")'>
                        <div class="product-search-name">${last4Digits} - ${product.name}</div>
                        <div class="product-search-price">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</div>
                        ${product.product_categories ? `<div class="product-search-category">${product.product_categories.name}</div>` : ''}
                    </div>
                `;
            }).join('');
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.innerHTML = `<div class="search-result-item" style="cursor: default;">Nenhum produto encontrado.</div>`;
            resultsContainer.style.display = 'block';
        }
    }

    updateNewOrderItemQuantity(index, quantity, context) {
        const qty = parseInt(quantity);
        if (qty > 0 && this.newOrderItems[index]) {
            this.newOrderItems[index].quantity = qty;
            switch (context) {
                case 'delivery':
                    this.renderDeliveryOrderItems();
                    break;
                case 'balcao':
                    this.renderBalcaoOrderItems();
                    break;
                case 'mesa':
                    this.renderMesaOrderItems();
                    break;
            }
        }
    }

    updateNewOrderItemPrice(index, price, context) {
        const priceValue = parseFloat(price);
        if (priceValue >= 0 && this.newOrderItems[index]) {
            this.newOrderItems[index].price = priceValue;
            switch (context) {
                case 'delivery':
                    this.renderDeliveryOrderItems();
                    break;
                case 'balcao':
                    this.renderBalcaoOrderItems();
                    break;
                case 'mesa':
                    this.renderMesaOrderItems();
                    break;
            }
        }
    }

    async editNewOrderItemNotes(index, context) {
        if (!this.newOrderItems[index]) return;
        const newNotes = await showCustomPrompt('Observa√ß√µes do item:', 'Editar Observa√ß√µes');
        if (newNotes !== null) {
            this.newOrderItems[index].notes = newNotes;
            switch (context) {
                case 'delivery':
                    this.renderDeliveryOrderItems();
                    break;
                case 'balcao':
                    this.renderBalcaoOrderItems();
                    break;
                case 'mesa':
                    this.renderMesaOrderItems();
                    break;
            }
        }
    }

    removeNewOrderItem(index, context) {
        showCustomConfirmation('Remover este item do pedido?', 'Remover Item').then(confirmed => {
            if (confirmed && this.newOrderItems[index]) {
                this.newOrderItems.splice(index, 1);
                switch (context) {
                    case 'delivery':
                        this.renderDeliveryOrderItems();
                        break;
                    case 'balcao':
                        this.renderBalcaoOrderItems();
                        break;
                    case 'mesa':
                        this.renderMesaOrderItems();
                        break;
                }
            }
        });
    }

    async saveOrder(orderData) {
        try {

            if (!orderData.items || orderData.items.length === 0) {
                throw new Error('Adicione pelo menos um item ao pedido');
            }

            // CORRE√á√ÉO: APENAS para pedidos DELIVERY criar/atualizar dados de customer
            let customer = null;
            let normalizedCustomerPhone = orderData.customer_phone;
            
            if (this.currentOrderMode === 'delivery' && orderData.customer_phone) {
                // NORMALIZA√á√ÉO DO TELEFONE: Aplica a mesma l√≥gica de normaliza√ß√£o
                const cleanPhone = orderData.customer_phone.replace(/\D/g, '');
                
                if (cleanPhone.length === 11 && cleanPhone.match(/^[1-9][1-9]/)) {
                    normalizedCustomerPhone = '55' + cleanPhone;
                } else if (cleanPhone.length === 10 && cleanPhone.match(/^[1-9][1-9]/)) {
                    normalizedCustomerPhone = '55' + cleanPhone;
                } else if (cleanPhone.length === 13 && cleanPhone.startsWith('55')) {
                    normalizedCustomerPhone = cleanPhone;
                } else {
                    normalizedCustomerPhone = cleanPhone;
                }
                
                // CORRE√á√ÉO: Usar consulta direta na tabela customers
                const { data: rpcData, error: rpcError } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('restaurant_id', getInstanceData().restaurantId)
                    .eq('phone', normalizedCustomerPhone);

                if (rpcError) {
                    // Ignora o erro se for apenas "nenhuma linha encontrada"
                    if (rpcError.code !== 'PGRST116' && !rpcError.message.includes('Result with 0 rows was returned')) {
                        throw rpcError;
                    }
                }
                // A consulta direta retorna um array, ent√£o pegamos o primeiro elemento
                customer = rpcData && rpcData.length > 0 ? rpcData[0] : null;
                
                // Prepara os dados de insert ou update do cliente
                const customerInsertData = {
                    restaurant_id: getInstanceData().restaurantId,
                    name: orderData.customer_name,
                    phone: normalizedCustomerPhone, // Salva o telefone normalizado com c√≥digo do pa√≠s
                    address: orderData.delivery_address,
                    zip_code: orderData.zip_code,
                    preferences: JSON.stringify(orderData.items.map(item => ({
                        item: item.name,
                        quantidade: item.quantity,
                        observacoes: item.notes,
                        valor_unitario: item.price.toFixed(2),
                        valor_total_item: (item.quantity * item.price).toFixed(2)
                    }))),
                    total_orders: (customer ? (customer.total_orders || 0) + 1 : 1),
                    total_spent: (customer ? parseFloat(customer.total_spent || 0) + orderData.total_amount : orderData.total_amount)
                };

                // Salva ou atualiza o cliente
                if (customer) {
                    const { error: updateError } = await supabase
                        .from('customers')
                        .update(customerInsertData)
                        .eq('id', customer.id);
                    if (updateError) throw updateError;
                } else {
                    const { error: insertError } = await supabase
                        .from('customers')
                        .insert([customerInsertData]);
                    if (insertError) throw insertError;
                }
            }
            

            let orderInsertData = {
                restaurant_id: getInstanceData().restaurantId,
                subtotal: orderData.subtotal,
                total: orderData.total_amount,
                notes: orderData.notes?.trim() || null,
                order_balcao: this.currentOrderMode === 'balcao' ? 'Balc√£o' : null,
                order_mesa: this.currentOrderMode === 'mesa' ? `Mesa ${orderData.mesa_number || ''}` : null
            };

            // CORRE√á√ÉO: Garantir que payment_method sempre tenha um valor v√°lido para a constraint do BD
            const validPaymentMethods = ['money', 'card', 'card_debit', 'card_credit', 'pix', 'voucher', 'Cart√£o de Cr√©dito/D√©bito'];
            let paymentMethod = orderData.payment_method?.trim();
            
            // Para pedidos de mesa sem m√©todo de pagamento definido, usar 'money' como padr√£o
            if (!paymentMethod || paymentMethod === '') {
                if (this.currentOrderMode === 'mesa') {
                    paymentMethod = 'money'; // Padr√£o para mesa (pode ser alterado depois na finaliza√ß√£o)
                } else {
                    throw new Error('M√©todo de pagamento √© obrigat√≥rio');
                }
            }
            
            // Validar se o m√©todo de pagamento √© permitido pelo banco de dados
            if (!validPaymentMethods.includes(paymentMethod)) {
                throw new Error(`M√©todo de pagamento inv√°lido: ${paymentMethod}. Use: ${validPaymentMethods.join(', ')}`);
            }
            
            orderInsertData.payment_method = paymentMethod;
            
            // Incluir valor recebido quando pagamento for em dinheiro
            if (paymentMethod === 'money' && orderData.cash_received !== null && orderData.cash_received !== undefined) {
                orderInsertData.change_for_amount = parseFloat(orderData.cash_received);
                orderInsertData.change_amount = Math.max(0, parseFloat(orderData.cash_received) - orderData.total_amount);
            }

            switch (this.currentOrderMode) {
                case 'delivery':
                    Object.assign(orderInsertData, {
                        customer_name: orderData.customer_name.trim(),
                        customer_phone: orderData.customer_phone?.trim() || 'N/A', // CORRIGIDO: Evitar null
                        delivery_address: orderData.delivery_address.trim(),
                        delivery_fee: parseFloat(orderData.delivery_fee) || 0,
                        delivery_distance: currentDeliveryDistance || null,
                        delivery_duration: currentEstimatedDeliveryTime || null,
                        delivery_type: orderData.delivery_type || null,
                        delivery_coordinates: currentDeliveryCoordinates ? `(${currentDeliveryCoordinates.longitude},${currentDeliveryCoordinates.latitude})` : null,
                        status: 'preparo'
                    });
                    break;
                case 'balcao':
                    const balcaoPhone = orderData.customer_phone?.trim() || 'N/A';
                    Object.assign(orderInsertData, {
                        customer_name: orderData.customer_name?.trim() || 'Cliente de Balc√£o',
                        customer_phone: balcaoPhone,
                        delivery_address: 'Balc√£o',
                        delivery_fee: 0,
                        status: 'Aberta'
                    });
                    break;
                case 'mesa':
                    Object.assign(orderInsertData, {
                        customer_name: orderData.customer_name || `Mesa ${orderData.mesa_number}`,
                        customer_phone: orderData.customer_phone?.trim() || 'N/A', // Valor padr√£o em vez de null
                        delivery_address: `Mesa ${orderData.mesa_number}`,
                        delivery_fee: 0,
                        status: 'Aberta'
                    });
                    break;
            }

            const { data: order, error: orderError } = await supabase
                .from('orders')
                .insert([orderInsertData])
                .select()
                .single();

            if (orderError) throw orderError;

            const orderItems = orderData.items.map(item => ({
                order_id: order.id,
                product_id: item.productId || null,
                product_name: item.name.trim(),
                quantity: parseInt(item.quantity),
                price: parseFloat(item.price),
                notes: item.notes?.trim() || null
            }));

            const { error: itemsError } = await supabase
                .from('order_items')
                .insert(orderItems);

            if (itemsError) {
                await supabase.from('orders').delete().eq('id', order.id);
                throw itemsError;
            }

            this.showNotification('Pedido criado com sucesso!', 'success');
            await this.loadOrders();
        } catch (error) {
            this.showNotification('Erro ao criar pedido: ' + error.message, 'error');
        }
    }

    openOrderDetails(orderId) {
        const order = this.orders.find(o => o.id === orderId);
        if (!order) return;

        const modal = document.getElementById('orderDetailsModal');
        const title = document.getElementById('orderDetailsTitle');
        const body = document.getElementById('orderDetailsBody');
        const actions = document.getElementById('orderDetailsActions');

        if (!modal || !title || !body || !actions) return;

        title.textContent = `Pedido #${order.order_number}`;

        body.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Dados do Cliente</h4>
                        <p><strong>Nome:</strong> ${order.customer_name || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${order.customer_phone || 'N/A'}</p>
                        <p><strong>Endere√ßo:</strong> ${order.delivery_address || 'N/A'}</p>
                        ${order.notes ? `<p><strong>Observa√ß√µes:</strong> ${order.notes}</p>` : ''}
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Informa√ß√µes do Pedido</h4>
                        <p><strong>Status:</strong> <span class="order-status-badge ${order.status}">${this.getStatusLabel(order.status)}</span></p>
                        <p><strong>Pagamento:</strong> ${this.getPaymentMethodLabel(order.payment_method)}</p>
                        <p><strong>Criado em:</strong> ${new Date(order.created_at).toLocaleString('pt-BR')}</p>
                        ${order.status === 'saiu_entrega' && order.deliverer_name ? `<p><strong>Entregador:</strong> ${order.deliverer_name}</p>` : ''}
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: var(--primary-color); margin: 0;">Itens do Pedido</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="openAddProductToOrderModal('${order.id}')" title="Adicionar Produto">
                                <i class="fas fa-plus"></i> Produto
                            </button>
                        </div>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr><th>Item</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody>
                            ${order.order_items.map(item => `
                                <tr>
                                    <td>
                                        <div class="item-name-cell">${item.product_name}</div>
                                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                                    </td>
                                    <td class="item-quantity-cell">${item.quantity}</td>
                                    <td class="item-price-cell">R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')}</td>
                                    <td class="item-total-cell">R$ ${(item.quantity * parseFloat(item.price)).toFixed(2).replace('.', ',')}</td>
                                    <td class="item-actions-cell">
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-warning btn-xs" onclick="openEditItemModal('${item.id}', '${order.id}')" title="Editar Item">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-xs" onclick="deleteOrderItem('${item.id}', '${order.id}')" title="Excluir Item">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="margin-top: 1rem; text-align: right;">
                        <p><strong>Subtotal:</strong> R$ ${parseFloat(order.subtotal || 0).toFixed(2).replace('.', ',')}</p>
                        <p><strong>Taxa de Entrega:</strong> R$ ${parseFloat(order.delivery_fee || 0).toFixed(2).replace('.', ',')}</p>
                        <p style="font-size: 1.2rem;"><strong>Total:</strong> R$ ${parseFloat(order.total || order.total_amount || 0).toFixed(2).replace('.', ',')}</p>
                        ${order.payment_method === 'money' && order.change_for_amount ? `
                            <p><strong>Dinheiro Recebido:</strong> R$ ${parseFloat(order.change_for_amount).toFixed(2).replace('.', ',')}</p>
                            <p style="color: var(--primary-color); font-weight: bold;">
                                <strong>Troco:</strong> R$ ${(parseFloat(order.change_for_amount) - parseFloat(order.total || 0)).toFixed(2).replace('.', ',')}
                            </p>
                        ` : ''}
                    </div>
                </div>
            `;

        actions.innerHTML = `
                <button type="button" class="btn btn-outline" onclick="ordersManager.closeOrderDetailsModal()">Fechar</button>
                <div style="display: flex; gap: 0.5rem;">
                    ${this.getOrderDetailActions(order)}
                </div>
            `;

        modal.classList.add('show');
    }

    closeOrderDetailsModal() {
        const modal = document.getElementById('orderDetailsModal');
        if (modal) {
            modal.classList.remove('show');
        }
    }

    getOrderDetailActions(order) {
        const actions = [];
        const orderSector = getOrderSector(order);

        switch (order.status) {
            case 'novo':
                actions.push(`<button class="btn btn-success" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'aceito')"><i class="fas fa-check"></i> Aceitar</button>`);
                actions.push(`<button class="btn btn-danger" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'rejeitado')"><i class="fas fa-times"></i> Rejeitar</button>`);
                break;
            case 'aceito':
                actions.push(`<button class="btn btn-primary" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'preparo')"><i class="fas fa-utensils"></i> Iniciar Preparo</button>`);
                break;
            case 'preparo':
                actions.push(`<button class="btn btn-success" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'pronto')"><i class="fas fa-check-circle"></i> Marcar como Pronto</button>`);
                break;
            case 'pronto':
                if (orderSector === 'delivery') {
                    actions.push(`<button class="btn btn-primary" onclick="openDelivererSelectionModal('${order.id}')"><i class="fas fa-motorcycle"></i> Enviar p/ Entrega</button>`);
                } else {
                    actions.push(`<button class="btn btn-success" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'entregue')"><i class="fas fa-check-double"></i> Finalizar Retirada</button>`);
                }
                break;
            case 'saiu_entrega':
                actions.push(`<button class="btn btn-success" onclick="openPaymentMethodModal('${order.id}')"><i class="fas fa-flag-checkered"></i> Finalizar Entrega</button>`);
                break;
            case 'Aberta':
                actions.push(`<button class="btn btn-primary" onclick="openFinalizarMesaModal('${order.id}')"><i class="fas fa-dollar-sign"></i> Finalizar Mesa</button>`);
                break;
        }

        if (!['saiu_entrega', 'entregue', 'cancelado', 'rejeitado', 'encerrado'].includes(order.status)) {
            actions.push(`<button class="btn btn-danger" onclick="ordersManager.updateOrderStatusFromDetails('${order.id}', 'cancelado')"><i class="fas fa-ban"></i> Cancelar</button>`);
        }

        return actions.join('');
    }

    getStatusClass(status) {
        const classes = {
            'novo': 'novo',
            'aceito': 'aceito',
            'preparo': 'preparo',
            'pronto': 'pronto',
            'saiu_entrega': 'saiu_entrega',
            'entregue': 'entregue',
            'rejeitado': 'rejeitado',
            'cancelado': 'cancelado',
            'Aberta': 'Aberta',
            'encerrado': 'encerrado'
        };
        return classes[status] || 'novo';
    }

    getStatusLabel(status) {
        const labels = {
            'novo': 'Novo',
            'aceito': 'Aceito',
            'preparo': 'Em Preparo',
            'pronto': 'Pronto',
            'saiu_entrega': 'Saiu p/ Entrega',
            'entregue': 'Entregue',
            'rejeitado': 'Rejeitado',
            'cancelado': 'Cancelado',
            'Aberta': 'Aberta (Mesa)',
            'encerrado': 'Encerrado'
        };
        return labels[status] || status;
    }

    getPaymentMethodLabel(method) {
        const labels = {
            'money': 'Dinheiro',
            'card': 'Cart√£o',
            'pix': 'PIX',
            'voucher': 'Vale'
        };
        return labels[method] || (method ? method : 'N√£o informado');
    }

    getTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInMinutes = Math.floor((now - date) / (1000 * 60));

        if (diffInMinutes < 1) return 'Agora';
        if (diffInMinutes < 60) return `${diffInMinutes}min atr√°s`;

        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) return `${diffInHours}h atr√°s`;

        const diffInDays = Math.floor(diffInHours / 24);
        return `${diffInDays}d atr√°s`;
    }

    setupEventListeners() {
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        const dateFilter = document.getElementById('dateFilter');
        const phoneInput = document.getElementById('deliveryCustomerPhone');

        if (statusFilter) {
            statusFilter.addEventListener('change', () => this.applyFilters());
        }
        if (searchInput) {
            searchInput.addEventListener('input', () => this.applyFilters());
        }
        if (dateFilter) {
            dateFilter.addEventListener('change', () => this.applyFilters());
        }

        // Event listener para o campo de telefone no modal de delivery
        if (phoneInput) {
            phoneInput.addEventListener('blur', async (e) => {
                // A limpeza do telefone √© feita aqui para garantir que mesmo
                // uma entrada sem formata√ß√£o seja tratada corretamente.
                const phone = e.target.value.trim().replace(/\D/g, '');
                if (phone.length >= 10) {
                    await this.checkCustomerByPhone(phone);
                }
            });
        }

        // Event listener para a busca direta por produtos
        document.querySelectorAll('#deliveryProductSearch, #balcaoProductSearch, #mesaProductSearch').forEach(input => {
            input.addEventListener('input', (e) => {
                this.performProductSearch(e.target.value.trim(), input.id.replace('ProductSearch', ''));
            });
        });

        // Clica fora para fechar os resultados
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.search-results').forEach(results => {
                if (!e.target.closest('.product-search-container')) {
                    results.style.display = 'none';
                }
            });
        });

        const deliveryFeeInput = document.getElementById('deliveryFee');
        if (deliveryFeeInput) {
            deliveryFeeInput.addEventListener('input', () => {
                this.updateDeliveryOrderDisplays();
            });
        }

        const mesaServiceFeeCheckbox = document.getElementById('mesaServiceFee');
        if (mesaServiceFeeCheckbox) {
            mesaServiceFeeCheckbox.addEventListener('change', () => {
                this.updateMesaOrderDisplays();
            });
        }

        // Event Listeners for Delivery Route Calculation
        // DESABILITADO: Agora o usu√°rio deve clicar no bot√£o "Calcular Taxa de Entrega" manualmente
        document.querySelectorAll('#deliveryCep, #deliveryNumber, #deliveryComplement').forEach(element => {
            element.addEventListener('blur', () => {
                clearTimeout(routeCalculationTimeout);
                routeCalculationTimeout = setTimeout(() => {
                    // calculateDeliveryRoute(); // Comentado - usu√°rio deve calcular manualmente
                }, 500); // Debounce de 500ms
            });
            element.addEventListener('input', () => {
                // Junta os campos para formar o endere√ßo completo
                const rua = document.getElementById('deliveryRua')?.value.trim() || '';
                const numero = document.getElementById('deliveryNumber')?.value.trim() || '';
                const complemento = document.getElementById('deliveryComplement')?.value.trim() || '';
                const bairro = document.getElementById('deliveryBairro')?.value.trim() || '';
                const cidade = document.getElementById('deliveryCidade')?.value.trim() || '';
                const uf = document.getElementById('deliveryUf')?.value.trim() || '';

                let enderecoCompleto = `${rua}`;
                if (numero) enderecoCompleto += `, ${numero}`;
                if (complemento) enderecoCompleto += `, ${complemento}`;
                if (bairro) enderecoCompleto += `, ${bairro}`;
                if (cidade) enderecoCompleto += `, ${cidade}`;
                if (uf) enderecoCompleto += ` - ${uf}`;

                document.getElementById('deliveryAddress').value = enderecoCompleto.replace(/,(\s*,){1,}/g, ',').replace(/(^\s*,)|(,\s*$)/g, '');
            });
        });

        const deliveryRoundtripCheckbox = document.getElementById('deliveryIncludeRoundtrip');
        if (deliveryRoundtripCheckbox) {
            deliveryRoundtripCheckbox.addEventListener('change', () => {
                // calculateDeliveryRoute(); // Comentado - usu√°rio deve calcular manualmente
                // Resetar flag quando checkbox mudar
                deliveryFeeCalculated = false;
                const indicator = document.getElementById('deliveryFeeCalculatedIndicator');
                if (indicator) indicator.style.display = 'none';
            });
        }
    }

    // CORRIGIDO: Esta fun√ß√£o agora usa a fun√ß√£o RPC 'get_customer_by_phone' para uma busca robusta.
    async checkCustomerByPhone(phone) {
        try {
            const currentInstance = getInstanceData();
            if (!currentInstance) {
                return;
            }

            let restaurantId = currentInstance.restaurantId;
            
            // Se n√£o tiver restaurantId no cookie, buscar pelo nome da inst√¢ncia
            if (!restaurantId && currentInstance.instanceName) {
                const { data: restaurant, error: restaurantError } = await supabase
                    .from('restaurants')
                    .select('id')
                    .eq('name', currentInstance.instanceName)
                    .single();
                
                if (restaurantError) {
                    ordersManager.showNotification('Erro: Restaurante n√£o encontrado. Verifique a configura√ß√£o da inst√¢ncia.', 'error');
                    return;
                }
                
                if (restaurant) {
                    restaurantId = restaurant.id;
                } else {
                    ordersManager.showNotification('Erro: Restaurante n√£o encontrado.', 'error');
                    return;
                }
            }

            if (!restaurantId) {
                ordersManager.showNotification('Erro: Configura√ß√£o da inst√¢ncia incompleta.', 'error');
                return;
            }

            
            // NORMALIZA√á√ÉO DO TELEFONE: 
            // Se usu√°rio digita "13991292600" (11 d√≠gitos), adiciona c√≥digo do pa√≠s "55" -> "5513991292600"
            // Se j√° tem c√≥digo do pa√≠s, mant√©m como est√°
            let normalizedPhone = phone;
            
            if (phone.length === 11 && phone.match(/^[1-9][1-9]/)) {
                // N√∫mero com 11 d√≠gitos come√ßando com c√≥digo de √°rea v√°lido (11-99)
                normalizedPhone = '55' + phone;
            } else if (phone.length === 10 && phone.match(/^[1-9][1-9]/)) {
                // N√∫mero com 10 d√≠gitos (telefone fixo) come√ßando com c√≥digo de √°rea v√°lido
                normalizedPhone = '55' + phone;
            } else if (phone.length === 13 && phone.startsWith('55')) {
                // J√° tem c√≥digo do pa√≠s, mant√©m como est√°
                normalizedPhone = phone;
            } else {
            }
            
            
            // CORRE√á√ÉO: Usar consulta direta na tabela customers em vez de RPC
            // Primeiro, tenta buscar com o telefone normalizado
            let { data: customers, error } = await supabase
                .from('customers')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .eq('phone', normalizedPhone);
            
                
            // Se n√£o encontrou e o telefone original √© diferente do normalizado, tenta com o original tamb√©m
            if ((!customers || customers.length === 0) && normalizedPhone !== phone) {
                const { data: customers2, error: error2 } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('restaurant_id', restaurantId)
                    .eq('phone', phone);
                
                
                if (!error2 && customers2) {
                    customers = customers2;
                    error = error2;
                }
            }
            
            // Converter para formato compat√≠vel com o c√≥digo existente
            const rpcData = customers;

            if (error) {
                // Ignora o erro se for apenas "nenhuma linha encontrada"
                if (error.code !== 'PGRST116' && !error.message.includes('Result with 0 rows was returned')) {
                    throw error;
                }
            }
            
            // A consulta direta retorna um array, ent√£o pegamos o primeiro elemento
            const customer = rpcData && rpcData.length > 0 ? rpcData[0] : null;

            if (customer) {
                // Cliente encontrado, preenche os campos
                ordersManager.showNotification('Dados do cliente carregados!', 'success');
                
                // Limpa todos os campos primeiro
                document.getElementById('deliveryCustomerName').value = '';
                document.getElementById('deliveryCep').value = '';
                document.getElementById('deliveryRua').value = '';
                document.getElementById('deliveryNumber').value = '';
                document.getElementById('deliveryComplement').value = '';
                document.getElementById('deliveryBairro').value = '';
                document.getElementById('deliveryCidade').value = '';
                document.getElementById('deliveryUf').value = '';
                document.getElementById('deliveryAddress').value = '';
                
                // Preenche com dados do cliente
                document.getElementById('deliveryCustomerName').value = customer.name || '';
                document.getElementById('deliveryAddress').value = customer.address || '';
                document.getElementById('deliveryCep').value = customer.zip_code || '';

                // Parse inteligente do endere√ßo - diferentes formatos poss√≠veis
                if (customer.address) {
                    const addressParts = customer.address.split(',').map(p => p.trim());
                    
                    if (addressParts.length === 4 && addressParts[3].includes(' - ')) {
                        // Formato: "Avenida General San Martin, 315, Ponta da Praia, Santos - SP"
                        const rua = addressParts[0]; // "Avenida General San Martin"
                        const numero = addressParts[1]; // "315"
                        const bairro = addressParts[2]; // "Ponta da Praia"
                        const cidadeUf = addressParts[3].split(' - '); // ["Santos", "SP"]
                        const cidade = cidadeUf[0]; // "Santos"
                        const uf = cidadeUf[1] || ''; // "SP"
                        
                        // Preenche os campos corretamente
                        document.getElementById('deliveryRua').value = rua;
                        document.getElementById('deliveryNumber').value = numero;
                        document.getElementById('deliveryBairro').value = bairro;
                        document.getElementById('deliveryCidade').value = cidade;
                        document.getElementById('deliveryUf').value = uf;
                        
                        console.log('üìç Endere√ßo parseado (formato 4 partes):', {
                            rua: rua,
                            numero: numero,
                            bairro: bairro,
                            cidade: cidade,
                            uf: uf
                        });
                        
                    } else if (addressParts.length >= 5) {
                        // Formato alternativo: "Rua Nome, N√∫mero, Bairro, Cidade, UF"
                        document.getElementById('deliveryRua').value = addressParts[0] || '';
                        document.getElementById('deliveryNumber').value = addressParts[1] || '';
                        document.getElementById('deliveryBairro').value = addressParts[2] || '';
                        document.getElementById('deliveryCidade').value = addressParts[3] || '';
                        document.getElementById('deliveryUf').value = addressParts[4] || '';
                        
                        console.log('üìç Endere√ßo parseado (formato 5+ partes):', {
                            rua: addressParts[0],
                            numero: addressParts[1],
                            bairro: addressParts[2],
                            cidade: addressParts[3],
                            uf: addressParts[4]
                        });
                        
                    } else if (addressParts.length >= 3) {
                        // Formato com n√∫mero junto na rua: "Avenida General San Martin 315, Ponta da Praia, Santos, SP"
                        const firstPart = addressParts[0]; // "Avenida General San Martin 315"
                        
                        // Tenta extrair n√∫mero do final da rua usando regex
                        const streetMatch = firstPart.match(/^(.+?)\s+(\d+.*?)$/);
                        let rua = firstPart;
                        let numero = '';
                        
                        if (streetMatch) {
                            rua = streetMatch[1].trim(); // "Avenida General San Martin"
                            numero = streetMatch[2].trim(); // "315"
                        }
                        
                        // Preenche os campos corretamente
                        document.getElementById('deliveryRua').value = rua;
                        document.getElementById('deliveryNumber').value = numero;
                        document.getElementById('deliveryBairro').value = addressParts[1] || '';
                        document.getElementById('deliveryCidade').value = addressParts[2] || '';
                        document.getElementById('deliveryUf').value = addressParts[3] || '';
                        
                        console.log('üìç Endere√ßo parseado (formato com n√∫mero na rua):', {
                            rua: rua,
                            numero: numero,
                            bairro: addressParts[1],
                            cidade: addressParts[2],
                            uf: addressParts[3]
                        });
                        
                    } else {
                        // Formato n√£o reconhecido - coloca tudo no campo rua
                        document.getElementById('deliveryRua').value = customer.address;
                    }
                }

                // Dispara o c√°lculo da rota usando updateDeliveryAddress para garantir que o endere√ßo seja montado corretamente
                setTimeout(() => {
                    updateDeliveryAddress();
                }, 100);
            } else {
                // Cliente n√£o encontrado, avisa o usu√°rio e limpa apenas os campos de dados do cliente
                ordersManager.showNotification('Cliente n√£o encontrado. Preencha os dados manualmente.', 'info');
                
                // Limpa apenas os dados do cliente, mant√©m o telefone
                document.getElementById('deliveryCustomerName').value = '';
                document.getElementById('deliveryAddress').value = '';
                document.getElementById('deliveryCep').value = '';
                document.getElementById('deliveryRua').value = '';
                document.getElementById('deliveryNumber').value = '';
                document.getElementById('deliveryComplement').value = '';
                document.getElementById('deliveryBairro').value = '';
                document.getElementById('deliveryCidade').value = '';
                document.getElementById('deliveryUf').value = '';
                // N√ÉO limpa o telefone, pois foi o que o usu√°rio digitou
            }
        } catch (error) {
            ordersManager.showNotification('Erro ao buscar cliente. Verifique a conex√£o.', 'error');
        }
    }

    setupRealtimeUpdates() {
        if (!currentRestaurant) return;

        if (realtimeSubscription) {
            supabase.removeChannel(realtimeSubscription);
        }

        const currentInstance = getInstanceData();
        if (!currentInstance) return;
        const restaurantId = currentInstance.restaurantId;

        realtimeSubscription = supabase
            .channel('orders-updates')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'orders', filter: `restaurant_id=eq.${restaurantId}` },
                (payload) => {
                    // Adiciona o novo ID √† lista de IDs j√° exibidos para evitar reabrir o modal
                    if (payload.eventType === 'INSERT' && payload.new.status === 'novo') {
                        this.shownNewOrderIds.add(payload.new.id);
                    }
                    this.loadOrders();
                }
            )
            .subscribe();
    }

    setupAutoRefresh() {
        this.updateInterval = setInterval(() => {
            this.loadOrders();
        }, 60000);
    }

    setupEnhancedRealTimeCheck() {
        
        // Garantir que o √°udio esteja sempre habilitado
        this.ensureAudioEnabled();
        
        // Verifica√ß√£o a cada 3 segundos
        if (realTimeCheckInterval) {
            clearInterval(realTimeCheckInterval);
        }
        
        realTimeCheckInterval = setInterval(async () => {
            try {
                const currentInstance = getInstanceData();
                if (!currentInstance) return;
                
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('id, status, created_at, customer_name, total')
                    .eq('restaurant_id', currentInstance.restaurantId)
                    .eq('status', 'novo')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    return;
                }
                
                // Verificar se h√° novos pedidos
                const newOrders = orders?.filter(order => !this.shownNewOrderIds.has(order.id)) || [];
                
                if (newOrders.length > 0) {
                    
                    // Garantir que o √°udio toque
                    this.forceAudioActivation();
                    
                    // Carregar todos os pedidos para atualizar a interface
                    await this.loadOrders();
                    
                    // Mostrar modal para o primeiro novo pedido (com order_number gerado)
                    if (newOrders[0]) {
                        const orderWithNumber = {
                            ...newOrders[0],
                            order_number: String(newOrders[0].id).slice(-8).toUpperCase()
                        };
                        this.showNewOrderModal(orderWithNumber);
                    }
                }
                
            } catch (error) {
            }
        }, 3000); // Verifica√ß√£o a cada 3 segundos
    }

    ensureAudioEnabled() {
        newOrderSoundEnabled = true;
        
        // For√ßa a cria√ß√£o do contexto de √°udio na pr√≥xima intera√ß√£o
        document.addEventListener('click', resumeAudioContext, { once: true });
        document.addEventListener('touchstart', resumeAudioContext, { once: true });
        document.addEventListener('keydown', resumeAudioContext, { once: true });
        
        // Mostrar indicador se √°udio j√° estiver ativo
        if (audioContextResumed) {
            showAudioIndicator();
        }
    }

    forceAudioActivation() {
        if (!audioContextResumed) {
            resumeAudioContext();
        }
        
        newOrderSoundEnabled = true;
        showAudioIndicator();
    }

    showNewOrderModal(order) {
        
        // Marcar como j√° mostrado
        this.shownNewOrderIds.add(order.id);
        
        // Configurar dados do pedido para notifica√ß√£o
        currentNewOrderForNotification = order;
        
        // Mostrar notifica√ß√£o visual se existir
        const notificationModal = document.getElementById('newOrderNotificationModal');
        if (notificationModal) {
            // Atualizar conte√∫do do modal se necess√°rio
            const title = notificationModal.querySelector('.new-order-notification-title');
            const subtitle = notificationModal.querySelector('.new-order-notification-subtitle');
            
            if (title) title.textContent = `Novo Pedido #${order.order_number}`;
            if (subtitle) subtitle.textContent = `Cliente: ${order.customer_name} - Total: R$ ${parseFloat(order.total || 0).toFixed(2).replace('.', ',')}`;
            
            notificationModal.classList.add('show');
        }
    }

    async updateOrderStatus(orderId, newStatus) {
        try {
            const { data, error } = await supabase
                .from('orders')
                .update({
                    status: newStatus,
                    updated_at: new Date().toISOString()
                })
                .eq('id', orderId)
                .select()
                .single();

            if (error) throw error;

            if (newStatus !== 'novo') {
                stopNewOrderSound(orderId);
            }

            this.showNotification(`Status atualizado para: ${this.getStatusLabel(newStatus)}`, 'success');
            await this.loadOrders();
        } catch (error) {
            this.showNotification('Erro ao atualizar status', 'error');
        }
    }

    async updateOrderStatusFromDetails(orderId, newStatus) {
        await this.updateOrderStatus(orderId, newStatus);
        this.closeOrderDetailsModal();
    }

    showNotification(message, type = 'info') {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 400);
        }, 3000);
    }

    async openDelivererSelectionModal(orderId) {
        if (!this) return;
        this.currentOrderForDelivery = orderId;

        const modal = document.getElementById('delivererSelectionModal');
        const select = document.getElementById('delivererSelect');
        const deliveryTypeSelect = document.getElementById('deliveryTypeSelectAssign');
        const modalCloseButton = document.querySelector('#delivererSelectionModal .modal-close');
        const modalCancelButton = document.querySelector('#delivererSelectionModal .btn-secondary');

        if (!modal || !select || !modalCloseButton || !modalCancelButton) {
            return;
        }

        // Resetar sele√ß√£o de tipo de entrega
        if (deliveryTypeSelect) {
            deliveryTypeSelect.value = '';
        }
        
        // Ocultar container de entregador e info de terceiros
        const delivererContainer = document.getElementById('delivererSelectContainer');
        const thirdPartyInfo = document.getElementById('thirdPartyInfo');
        if (delivererContainer) delivererContainer.style.display = 'none';
        if (thirdPartyInfo) thirdPartyInfo.style.display = 'none';

        // Limpa as op√ß√µes existentes
        select.innerHTML = '<option value="">Carregando...</option>';
        modal.classList.add('show');

        // Adiciona event listeners aos bot√µes de fechar e cancelar
        modalCloseButton.onclick = () => this.closeDelivererSelectionModal();
        modalCancelButton.onclick = () => this.closeDelivererSelectionModal();

        try {
            const deliverersData = await this.loadDeliverers();
            select.innerHTML = '<option value="">Selecione o entregador</option>';
            deliverersData.forEach(deliverer => {
                const option = document.createElement('option');
                option.value = deliverer.id;
                option.textContent = deliverer.name;
                select.appendChild(option);
            });
        } catch (error) {
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }

    closeDelivererSelectionModal() {
        const modal = document.getElementById('delivererSelectionModal');
        if (modal) {
            modal.classList.remove('show');
        }
        this.currentOrderForDelivery = null;
    }

    async confirmDelivererSelection() {
        const deliveryType = document.getElementById('deliveryTypeSelectAssign')?.value;
        const delivererId = document.getElementById('delivererSelect')?.value;
        const orderId = this.currentOrderForDelivery;

        // Validar tipo de entrega obrigat√≥rio
        if (!orderId || !deliveryType) {
            this.showNotification('Selecione o tipo de entrega para continuar.', 'warning');
            return;
        }

        // Se for entrega da casa, validar entregador
        if (deliveryType === 'house' && !delivererId) {
            this.showNotification('Selecione um entregador para entrega da casa.', 'warning');
            return;
        }

        try {
            // Definir se √© entrega pr√≥pria ou terceiros
            const isHouseDelivery = deliveryType === 'house';
            
            // Preparar dados de atualiza√ß√£o
            const updateData = {
                status: 'saiu_entrega',
                delivery_type: deliveryType,
                updated_at: new Date().toISOString()
            };
            
            // Se for entrega da casa, adicionar deliverer_id
            if (isHouseDelivery) {
                updateData.deliverer_id = delivererId;
            } else {
                // Se for terceiros, limpar deliverer_id se existir
                updateData.deliverer_id = null;
            }

            // Atualiza a tabela de orders
            const { error: orderError } = await supabase
                .from('orders')
                .update(updateData)
                .eq('id', orderId);

            if (orderError) throw orderError;

            // Se for entrega da casa, atualiza a tabela de deliverers
            if (isHouseDelivery && delivererId) {
                const { error: delivererError } = await supabase
                    .from('deliverers')
                    .update({
                        status: 'active',
                        id_pedido: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', delivererId);

                if (delivererError) throw delivererError;
            }

            const mensagem = isHouseDelivery 
                ? 'Pedido enviado para entrega com entregador pr√≥prio!' 
                : 'Pedido marcado como entrega de terceiros!';
            
            this.showNotification(mensagem, 'success');
            await this.loadOrders();
            this.closeDelivererSelectionModal();
            this.closeOrderDetailsModal();
        } catch (error) {
            console.error('Erro ao confirmar entrega:', error);
            this.showNotification('Erro ao enviar para entrega. Tente novamente.', 'error');
        }
    }

    openPaymentMethodModal(orderId) {
        if (!this) return;
        this.currentOrderForPayment = orderId;
        const modal = document.getElementById('paymentMethodModal');
        const order = this.orders.find(o => o.id === orderId);

        if (!modal || !order) return;

        // Adicionando os event listeners para os bot√µes de fechar
        const modalCloseButton = modal.querySelector('.modal-close');
        const modalCancelButton = modal.querySelector('.btn-secondary');

        if (modalCloseButton) {
            modalCloseButton.onclick = () => this.closePaymentMethodModal();
        }
        if (modalCancelButton) {
            modalCancelButton.onclick = () => this.closePaymentMethodModal();
        }

        const finalPaymentMethodSelect = document.getElementById('finalPaymentMethod');
        if (finalPaymentMethodSelect) {
            finalPaymentMethodSelect.value = order.payment_method || '';
            toggleFinalChangeFields();
        }
        modal.classList.add('show');
    }

    closePaymentMethodModal() {
        const modal = document.getElementById('paymentMethodModal');
        if (modal) {
            modal.classList.remove('show');
        }
        this.currentOrderForPayment = null;
    }

    async confirmPaymentAndFinish() {
        const paymentMethod = document.getElementById('finalPaymentMethod')?.value;
        const orderId = this.currentOrderForPayment;
        if (!orderId || !paymentMethod) {
            this.showNotification('Selecione a forma de pagamento.', 'warning');
            return;
        }

        try {
            // Atualiza a tabela de orders
            const { error: orderError } = await supabase
                .from('orders')
                .update({
                    status: 'entregue',
                    payment_method: paymentMethod,
                    updated_at: new Date().toISOString()
                })
                .eq('id', orderId);

            if (orderError) throw orderError;

            // **NOVO**: Atualiza a tabela de deliverers
            const { error: delivererError } = await supabase
                .from('deliverers')
                .update({
                    status: 'active',
                    id_pedido: null, // Limpa o ID do pedido
                    updated_at: new Date().toISOString()
                })
                .eq('id_pedido', orderId); // Busca pelo ID do pedido

            if (delivererError) throw delivererError;

            this.showNotification('Entrega finalizada com sucesso!', 'success');
            await this.loadOrders();
            this.closePaymentMethodModal();
            this.closeOrderDetailsModal();
        } catch (error) {
            this.showNotification('Erro ao finalizar entrega. Tente novamente.', 'error');
        }
    }
}

// FUN√á√ïES DE ALERTA SONORO
function resumeAudioContext() {
    try {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                audioContextResumed = true;
                showAudioIndicator();
            }).catch(error => {
            });
        } else if (audioContext.state === 'running') {
            audioContextResumed = true;
            showAudioIndicator();
        }
    } catch (error) {
        // Tenta novamente na pr√≥xima intera√ß√£o
        document.addEventListener('click', resumeAudioContext, { once: true });
    }
}

function showAudioIndicator() {
    const indicator = document.getElementById('audioIndicator');
    if (indicator && !audioIndicatorVisible) {
        indicator.style.display = 'block';
        audioIndicatorVisible = true;
    }
}

function hideAudioIndicator() {
    const indicator = document.getElementById('audioIndicator');
    if (indicator && audioIndicatorVisible) {
        indicator.style.display = 'none';
        audioIndicatorVisible = false;
    }
}

function playNewOrderSound() {
    if (!audioContextResumed || !audioContext || audioContext.state !== 'running') {
        
        // Mostrar bot√£o de ativa√ß√£o se ainda n√£o estiver vis√≠vel
        const activateBtn = document.getElementById('activateSoundBtn');
        if (activateBtn) {
            activateBtn.style.display = 'block';
            activateBtn.onclick = () => {
                resumeAudioContext();
                activateBtn.style.display = 'none';
            };
        }
        return;
    }

    if (newOrderOscillator) {
        newOrderOscillator.stop();
        newOrderOscillator.disconnect();
    }

    newOrderOscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    newOrderOscillator.type = 'sine';
    newOrderOscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

    newOrderOscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    newOrderOscillator.start();
    setTimeout(() => {
        if (newOrderOscillator) {
            newOrderOscillator.stop();
        }
    }, 500); // Toca por 0.5 segundos
}


function playNewOrderSoundLoop() {
    playNewOrderSound();
    return setInterval(() => {
        playNewOrderSound();
    }, 3000); // Toca o som a cada 3 segundos
}

function stopNewOrderSound(orderId) {
    if (soundIntervals[orderId]) {
        clearInterval(soundIntervals[orderId]);
        delete soundIntervals[orderId];
        // Se n√£o houver mais pedidos com o alerta, para o oscilador global
        if (Object.keys(soundIntervals).length === 0) {
            if (newOrderOscillator) {
                newOrderOscillator.stop();
                newOrderOscillator.disconnect();
                newOrderOscillator = null;
            }
        }
    }
}

// ===== FUN√á√ÉO DE INICIALIZA√á√ÉO PRINCIPAL =====
async function checkAuthenticationAndLoadConfig() {
    try {
        await initializeConfiguration();
        
        
        // Debug dos cookies dispon√≠veis
        
        // Verifica autentica√ß√£o com bypass para desenvolvimento no Replit
        const instanceData = getInstanceData();
        
        // Detectar ambiente de desenvolvimento (Replit/localhost)
        const isDevelopment = window.location.hostname.includes('replit') || 
                             window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1' ||
                             window.location.hostname.includes('replit.dev') ||
                             window.location.hostname.includes('repl.co');
        
        const authCheck = isAuthenticated();
        
        // Para desenvolvimento, permitir acesso direto ou criar sess√£o tempor√°ria
        if (!authCheck) {
            if (isDevelopment) {
                console.log('üõ†Ô∏è MODO DESENVOLVIMENTO: Criando sess√£o tempor√°ria para testes');
                
                // Criar dados tempor√°rios para desenvolvimento
                const tempInstanceData = {
                    instanceId: 'dev-temp-instance',
                    instanceName: 'Restaurante Demo',
                    token: 'dev-temp-token',
                    type: 'restaurant',
                    userEmail: 'demo@timepulse.dev',
                    restaurantId: 'dev-restaurant-1'
                };
                
                // Salvar temporariamente
                const tempToken = encodeURIComponent(JSON.stringify(tempInstanceData));
                window.localStorage.setItem('timepulse_instance_token', tempToken);
                window.sessionStorage.setItem('timepulse_instance_token', tempToken);
                
                console.log('‚úÖ Sess√£o tempor√°ria criada para desenvolvimento');
                
                // Continuar carregamento da p√°gina
            } else {
                // Produ√ß√£o: redirecionar para login
                window.location.href = 'login.html';
                return;
            }
        }

        const currentInstance = getInstanceData();

        // Se a autentica√ß√£o estiver correta, inicia o OrdersManager.
        ordersManager = new OrdersManager();
        await ordersManager.init();
        
        // Garantir que o √°udio esteja sempre habilitado ap√≥s inicializa√ß√£o
        setTimeout(() => {
            if (ordersManager) {
                ordersManager.ensureAudioEnabled();
                ordersManager.forceAudioActivation();
            }
        }, 1000);
        
        
    } catch (error) {
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; font-family: 'Inter', sans-serif;">
                <div style="padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h2 style="color: #dc3545; margin-bottom: 1rem;">Erro na Inicializa√ß√£o</h2>
                    <p style="margin-bottom: 1rem;">${error.message}</p>
                    <button onclick="window.location.reload()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Recarregar</button>
                </div>
            </div>
        `;
    }
}

// ===== FUN√á√ïES PARA ADICIONAIS =====
async function handleProductSelection(product, context) {
    try {
        const { data: links, error: linkError } = await supabase
            .from('product_add_on_categories_link')
            .select('add_on_category_id')
            .eq('product_id', product.id);

        if (linkError) throw linkError;

        if (!links || links.length === 0) {
            addProductItemToOrder([], product, context);
            return;
        }

        await openAddOnsModal(product, links.map(l => l.add_on_category_id), context);
    } catch (error) {
        if (ordersManager) ordersManager.showNotification('Erro ao carregar adicionais do produto.', 'error');
    }
}

async function openAddOnsModal(product, categoryIds, context) {
    currentProductForAddOns = product;
    currentOrderContextForAddOns = context;

    const modal = document.getElementById('addOnsModal');
    const title = document.getElementById('addOnsModalTitle');
    const loading = document.getElementById('addOnsLoading');
    const content = document.getElementById('addOnsContent');

    if (!modal || !title || !loading || !content) return;

    title.textContent = `Adicionais para: ${product.name}`;
    loading.style.display = 'block';
    content.style.display = 'none';
    content.innerHTML = '';
    modal.classList.add('show');

    try {
        const { data: categories, error: catError } = await supabase
            .from('add_on_categories')
            .select('*')
            .in('id', categoryIds);

        if (catError) throw catError;

        const { data: addOns, error: addOnError } = await supabase
            .from('product_add_ons')
            .select('*')
            .in('add_on_category_id', categoryIds)
            .eq('active', true)
            .order('name');

        if (addOnError) throw addOnError;

        let html = '';
        for (const category of categories) {
            const itemsInCategory = addOns.filter(item => item.add_on_category_id === category.id);
            if (itemsInCategory.length === 0) continue;

            const inputType = category.selection_type === 'single' ? 'radio' : 'checkbox';

            html += `
                    <div class="form-section">
                        <h4>${category.name} ${category.min_selection > 0 ? '*' : ''}</h4>
                        ${category.description ? `<p class="form-text text-muted">${category.description}</p>` : ''}
                        <div class="add-ons-group" data-category-id="${category.id}" data-min="${category.min_selection || 0}" data-max="${category.max_selection || itemsInCategory.length}">
                            ${itemsInCategory.map(item => `
                                <div class="add-on-item">
                                    <input type="${inputType}" id="addon_${item.id}" name="addon_cat_${category.id}" value="${item.id}" data-price="${item.price}" data-name="${item.name}">
                                    <label for="addon_${item.id}">
                                        <span class="add-on-name">${item.name}</span>
                                        <span class="add-on-price">+ R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')}</span>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        }
        content.innerHTML = html;
        loading.style.display = 'none';
        content.style.display = 'block';
    } catch (error) {
        loading.innerHTML = '<p class="text-danger">N√£o foi poss√≠vel carregar os adicionais.</p>';
    }
}

function closeAddOnsModal() {
    const modal = document.getElementById('addOnsModal');
    if (modal) {
        modal.classList.remove('show');
    }
    currentProductForAddOns = null;
    currentOrderContextForAddOns = null;
}

function confirmAddOnsSelection() {
    const selectedAddOns = [];
    let validationError = false;

    document.querySelectorAll('.add-ons-group').forEach(group => {
        const min = parseInt(group.dataset.min);
        const max = parseInt(group.dataset.max);
        const selectedCount = group.querySelectorAll('input:checked').length;
        const categoryName = group.previousElementSibling.textContent;

        if (selectedCount < min) {
            if (ordersManager) ordersManager.showNotification(`Selecione pelo menos ${min} item(ns) em "${categoryName}".`, 'warning');
            validationError = true;
        }
        if (selectedCount > max) {
            if (ordersManager) ordersManager.showNotification(`Selecione no m√°ximo ${max} item(ns) em "${categoryName}".`, 'warning');
            validationError = true;
        }
    });

    if (validationError) return;

    document.querySelectorAll('#addOnsModalBody input:checked').forEach(input => {
        selectedAddOns.push({
            id: input.value,
            name: input.dataset.name,
            price: parseFloat(input.dataset.price)
        });
    });

    addProductItemToOrder(selectedAddOns, currentProductForAddOns, currentOrderContextForAddOns);
    closeAddOnsModal();
}

function addProductItemToOrder(selectedAddOns, product, context) {
    if (!product || !context || !ordersManager) return;

    let totalItemPrice = parseFloat(product.price);
    let notes = selectedAddOns.map(addOn => `+ ${addOn.name}`).join('\n');

    selectedAddOns.forEach(addOn => {
        totalItemPrice += addOn.price;
    });

    const newItem = {
        productId: product.id,
        name: product.name,
        price: totalItemPrice,
        quantity: 1,
        notes: notes,
        selected_add_ons: selectedAddOns.map(a => ({ id: a.id, name: a.name, price: a.price })),
        base_price: parseFloat(product.price)
    };

    ordersManager.newOrderItems.push(newItem);

    switch (context) {
        case 'delivery':
            ordersManager.renderDeliveryOrderItems();
            ordersManager.updateDeliveryOrderDisplays();
            break;
        case 'balcao':
            ordersManager.renderBalcaoOrderItems();
            ordersManager.updateBalcaoOrderDisplays();
            break;
        case 'mesa':
            ordersManager.renderMesaOrderItems();
            ordersManager.updateMesaOrderDisplays();
            break;
    }

    if (ordersManager) ordersManager.showNotification(`${product.name} adicionado ao pedido.`, 'success');
    // Fechando o modal de sele√ß√£o de produtos e mantendo o modal principal
    closeProductSelectionModal();
}

// ===== FUN√á√ïES DO SISTEMA =====
function filterBySector(sector) {
    currentSectorFilter = sector;
    document.querySelectorAll('.sector-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const selectedBtn = document.querySelector(`[data-sector="${sector}"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
    }
    if (ordersManager) {
        ordersManager.applyFilters();
    }
}

function getOrderSector(order) {
    if (order.delivery_address === 'Balc√£o') {
        return 'balcao';
    } else if (order.delivery_address && order.delivery_address.startsWith('Mesa ')) {
        return 'mesa';
    } else if (order.delivery_fee > 0 || (order.delivery_address && order.delivery_address !== 'Balc√£o' && !order.delivery_address.startsWith('Mesa '))) {
        return 'delivery';
    } else {
        return order.delivery_fee > 0 ? 'delivery' : 'balcao';
    }
}

function updateOnlineToggleUI() {
    const toggle = document.getElementById('onlineToggle');
    const icon = document.getElementById('onlineIcon');
    const text = document.getElementById('onlineText');

    if (!toggle || !icon || !text) return;

    if (isOnline) {
        toggle.className = 'online-toggle online';
        icon.className = 'fas fa-circle';
        text.textContent = 'Online';
    } else {
        toggle.className = 'online-toggle offline';
        icon.className = 'fas fa-circle';
        text.textContent = 'Offline';
    }
}

async function toggleOnlineStatus() {
    try {
        const newStatus = !isOnline;
        const currentInstance = getInstanceData();
        if (!currentInstance) {
            throw new Error('Inst√¢ncia n√£o encontrada.');
        }
        const restaurantId = currentInstance.restaurantId;

        const { data, error } = await supabase
            .from('restaurants')
            .update({
                pedidos_online: newStatus,
                updated_at: new Date().toISOString()
            })
            .eq('id', restaurantId)
            .select()
            .single();

        if (error) throw error;

        isOnline = newStatus;
        currentRestaurant.pedidos_online = newStatus;
        updateOnlineToggleUI();

        const statusText = newStatus ? 'Online' : 'Offline';
        const statusColor = newStatus ? 'success' : 'warning';

        if (ordersManager) {
            ordersManager.showNotification(`Status alterado para: ${statusText}`, statusColor);
        }
    } catch (error) {
        if (ordersManager) {
            ordersManager.showNotification('Erro ao alterar status online', 'error');
        }
    }
}

function toggleFullscreen() {
    const body = document.body;
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const fullscreenIcon = document.getElementById('fullscreenIcon');
    const fullscreenText = document.getElementById('fullscreenText');

    if (!isFullscreenMode) {
        body.classList.add('fullscreen-mode');
        if (sidebar) sidebar.style.display = 'none';
        if (sidebarOverlay) sidebarOverlay.classList.remove('show');
        isFullscreenMode = true;
        if (fullscreenIcon) fullscreenIcon.className = 'fas fa-compress';
        if (fullscreenText) fullscreenText.textContent = 'Sair da Tela Cheia';
        
        // Request fullscreen API
        if (body.requestFullscreen) {
            body.requestFullscreen();
        } else if (body.webkitRequestFullscreen) { /* Safari */
            body.webkitRequestFullscreen();
        } else if (body.msRequestFullscreen) { /* IE11 */
            body.msRequestFullscreen();
        }
    } else {
        body.classList.remove('fullscreen-mode');
        if (sidebar) sidebar.style.display = 'block';
        isFullscreenMode = false;
        if (fullscreenIcon) fullscreenIcon.className = 'fas fa-expand';
        if (fullscreenText) fullscreenText.textContent = 'Tela Cheia';
        
        // Exit fullscreen API
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) { /* Safari */
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) { /* IE11 */
            document.msExitFullscreen();
        }
    }
}

// Listen for fullscreen change event to keep state in sync
document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
        // If fullscreen was exited by user (e.g., Esc key), update our state
        if (isFullscreenMode) {
            isFullscreenMode = false;
            document.body.classList.remove('fullscreen-mode');
            const sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.style.display = 'block';
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            const fullscreenText = document.getElementById('fullscreenText');
            if (fullscreenIcon) fullscreenIcon.className = 'fas fa-expand';
            if (fullscreenText) fullscreenText.textContent = 'Tela Cheia';
        }
    }
});

// ===== FUN√á√ïES DE MODAL =====
function openOrderTypeSelectionModal() {
    const modal = document.getElementById('orderTypeSelectionModal');
    if (modal) {
        modal.classList.add('show');
    }
}

function closeOrderTypeSelectionModal() {
    const modal = document.getElementById('orderTypeSelectionModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

function selectOrderType(type) {
    closeOrderTypeSelectionModal();
    if (!ordersManager) return;

    ordersManager.currentOrderMode = type;
    ordersManager.currentOrderContext = type;
    ordersManager.newOrderItems = [];

    switch (type) {
        case 'delivery':
            openDeliveryOrderModal();
            break;
        case 'balcao':
            openBalcaoOrderModal();
            break;
        case 'mesa':
            openMesaOrderModal();
            break;
    }
}

function openDeliveryOrderModal() {
    const modal = document.getElementById('deliveryOrderModal');
    if (modal && ordersManager) {
        ordersManager.newOrderItems = [];
        const form = document.getElementById('deliveryOrderForm');
        if (form) {
            form.reset();
        }
        
        // Resetar flag de taxa calculada e displays
        deliveryFeeCalculated = false;
        currentDeliveryDistance = null;
        currentEstimatedDeliveryTime = null;
        currentDeliveryCoordinates = null;
        
        const indicator = document.getElementById('deliveryFeeCalculatedIndicator');
        if (indicator) indicator.style.display = 'none';
        
        const distanceDisplay = document.getElementById('deliveryDistanceDisplay');
        const durationDisplay = document.getElementById('deliveryDurationDisplay');
        const feeMetricDisplay = document.getElementById('deliveryFeeMetricDisplay');
        
        if (distanceDisplay) distanceDisplay.textContent = '-- km';
        if (durationDisplay) durationDisplay.textContent = '-- min';
        if (feeMetricDisplay) feeMetricDisplay.textContent = '--';
        
        ordersManager.renderDeliveryOrderItems();
        modal.classList.add('show');
    }
}

// Atualiza a taxa de entrega baseada no tipo selecionado
function updateDeliveryFeeByType() {
    if (!currentRestaurant) {
        console.warn('Dados do restaurante n√£o carregados ainda');
        return;
    }
    
    // Resetar flag de taxa calculada quando tipo de entrega mudar
    deliveryFeeCalculated = false;
    const indicator = document.getElementById('deliveryFeeCalculatedIndicator');
    if (indicator) indicator.style.display = 'none';
    
    const deliveryAddress = document.getElementById('deliveryAddress')?.value?.trim();
    
    // Se j√° houver um endere√ßo preenchido, o usu√°rio deve recalcular manualmente
    // N√ÉO recalcula automaticamente - usu√°rio deve clicar no bot√£o "Calcular Taxa de Entrega"
    if (deliveryAddress && currentRestaurant?.latitude && currentRestaurant?.longitude) {
        // N√£o recalcula automaticamente - apenas reseta a flag
        return;
    }
    
    // Se n√£o houver endere√ßo, calcular apenas a taxa m√≠nima baseada no tipo
    const deliveryTypeSelect = document.getElementById('deliveryTypeSelect');
    const includeRoundtrip = document.getElementById('deliveryIncludeRoundtrip')?.checked || false;
    const deliveryType = deliveryTypeSelect?.value;
    
    if (!deliveryType) {
        // Se n√£o selecionou tipo, n√£o atualiza
        return;
    }
    
    let minimumFee = 0;
    let returnFee = 0;
    
    if (deliveryType === 'third-party') {
        // Entrega de Terceiros (Apps de Delivery)
        minimumFee = parseFloat(currentRestaurant.minimum_delivery_fee) || 8.00;
        returnFee = parseFloat(currentRestaurant.delivery_retun) || 5.00;
    } else if (deliveryType === 'house') {
        // Entrega da Casa (Pr√≥pria)
        minimumFee = parseFloat(currentRestaurant.house_minimum_delivery_fee) || 5.00;
        returnFee = 0; // Entrega da casa n√£o tem taxa de retorno
    }
    
    // Calcular taxa m√≠nima
    let calculatedFee = minimumFee;
    
    // Se incluir retorno (ida e volta) e for terceiros
    if (includeRoundtrip && deliveryType === 'third-party' && returnFee > 0) {
        calculatedFee += returnFee;
    }
    
    // Atualizar campos de exibi√ß√£o
    const deliveryFeeInput = document.getElementById('deliveryFee');
    const deliveryFeeDisplay = document.getElementById('deliveryFeeDisplay');
    const deliveryFeeDisplayTotal = document.getElementById('deliveryFeeDisplayTotal');
    
    if (deliveryFeeInput) {
        deliveryFeeInput.value = calculatedFee.toFixed(2);
    }
    if (deliveryFeeDisplay) {
        deliveryFeeDisplay.textContent = calculatedFee.toFixed(2).replace('.', ',');
    }
    if (deliveryFeeDisplayTotal) {
        deliveryFeeDisplayTotal.textContent = calculatedFee.toFixed(2).replace('.', ',');
    }
    
    // Recalcular o total do pedido
    if (typeof calculateDeliveryOrderTotal === 'function') {
        calculateDeliveryOrderTotal();
    }
    
    console.log(`Taxa de entrega atualizada: ${deliveryType} - R$ ${calculatedFee.toFixed(2)} (Retorno: ${includeRoundtrip ? 'Sim' : 'N√£o'})`);
}

function closeDeliveryOrderModal() {
    const modal = document.getElementById('deliveryOrderModal');
    if (modal) {
        modal.classList.remove('show');
    }
    const form = document.getElementById('deliveryOrderForm');
    if (form) {
        form.reset();
    }
    if (ordersManager) {
        ordersManager.newOrderItems = [];
        ordersManager.renderDeliveryOrderItems();
    }
}

function openBalcaoOrderModal() {
    const modal = document.getElementById('balcaoOrderModal');
    if (modal && ordersManager) {
        ordersManager.newOrderItems = [];
        const form = document.getElementById('balcaoOrderForm');
        if (form) {
            form.reset();
        }
        ordersManager.renderBalcaoOrderItems();
        modal.classList.add('show');
    }
}

function closeBalcaoOrderModal() {
    const modal = document.getElementById('balcaoOrderModal');
    if (modal) {
        modal.classList.remove('show');
    }
    const form = document.getElementById('balcaoOrderForm');
    if (form) {
        form.reset();
    }
    if (ordersManager) {
        ordersManager.newOrderItems = [];
        ordersManager.renderBalcaoOrderItems();
    }
}

function openMesaOrderModal() {
    const modal = document.getElementById('mesaOrderModal');
    if (modal && ordersManager) {
        ordersManager.newOrderItems = [];
        const form = document.getElementById('mesaOrderForm');
        if (form) {
            form.reset();
        }
        ordersManager.renderMesaOrderItems();
        modal.classList.add('show');
    }
}

function closeMesaOrderModal() {
    const modal = document.getElementById('mesaOrderModal');
    if (modal) {
        modal.classList.remove('show');
    }
    const form = document.getElementById('mesaOrderForm');
    if (form) {
        form.reset();
    }
    if (ordersManager) {
        ordersManager.newOrderItems = [];
        ordersManager.renderMesaOrderItems();
    }
}

async function openProductSelectionModal(context) {
    if (!ordersManager) return;

    ordersManager.currentOrderContext = context;
    ordersManager.isNewOrderContext = true;

    const modal = document.getElementById('productSelectionModal');
    const productCategoriesContainer = document.getElementById('productCategories');

    if (!modal || !productCategoriesContainer) return;

    const productsGroupedByCategory = ordersManager.products.reduce((acc, product) => {
        const categoryName = product.product_categories?.name || 'Sem Categoria';
        if (!acc[categoryName]) {
            acc[categoryName] = [];
        }
        acc[categoryName].push(product);
        return acc;
    }, {});

    let htmlContent = '';
    for (const categoryName in productsGroupedByCategory) {
        const productsInCategory = productsGroupedByCategory[categoryName];
        htmlContent += `
                    <div class="form-section">
                        <h4>${categoryName}</h4>
                        <div class="product-list-container">
                            ${productsInCategory.map(product => {
            const last4Digits = product.id.slice(-4).toUpperCase();
            const productJsonString = JSON.stringify(product).replace(/"/g, '&quot;');
            return `
                                <div class="product-list-item" onclick="handleProductSelection(${productJsonString}, '${context}')">
                                    <div class="product-list-item-header">
                                        <span class="product-name">${last4Digits} - ${product.name}</span>
                                        <span class="product-price">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</span>
                                    </div>
                                    <div class="product-list-item-description">
                                        ${product.description || 'Nenhuma descri√ß√£o dispon√≠vel.'}
                                    </div>
                                </div>
                                `;
        }).join('')}
                        </div>
                    </div>
                `;
    }
    productCategoriesContainer.innerHTML = htmlContent;

    modal.classList.add('show');
}

function closeProductSelectionModal() {
    const modal = document.getElementById('productSelectionModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// ===== FUN√á√ïES DE SUBMISS√ÉO DE PEDIDOS =====
async function submitDeliveryOrder() {
    if (!ordersManager) return;

    const customerName = document.getElementById('deliveryCustomerName')?.value.trim();
    const customerPhone = document.getElementById('deliveryCustomerPhone')?.value.trim();

    const rua = document.getElementById('deliveryRua')?.value.trim();
    const numero = document.getElementById('deliveryNumber')?.value.trim();
    const complemento = document.getElementById('deliveryComplement')?.value.trim();
    const bairro = document.getElementById('deliveryBairro')?.value.trim();
    const cidade = document.getElementById('deliveryCidade')?.value.trim();
    const uf = document.getElementById('deliveryUf')?.value.trim();
    const zipCode = document.getElementById('deliveryCep')?.value.trim();

    let deliveryAddress = '';
    if (rua) {
        deliveryAddress = rua;
        if (numero) deliveryAddress += `, ${numero}`;
        if (complemento) deliveryAddress += `, ${complemento}`;
        if (bairro) deliveryAddress += `, ${bairro}`;
        if (cidade) deliveryAddress += `, ${cidade}`;
        if (uf) deliveryAddress += ` - ${uf}`;
    } else {
        deliveryAddress = document.getElementById('deliveryAddress')?.value.trim();
    }

    const paymentMethod = document.getElementById('deliveryPaymentMethod')?.value;
    const deliveryFee = parseFloat(document.getElementById('deliveryFee')?.value) || 0;
    const notes = document.getElementById('deliveryOrderNotes')?.value.trim();
    const deliveryType = document.getElementById('deliveryTypeSelect')?.value;

    // Valida√ß√£o dos campos obrigat√≥rios (CEP √© opcional)
    const missingFields = [];
    if (!customerName) missingFields.push('Nome do Cliente');
    if (!customerPhone) missingFields.push('Telefone');
    if (!deliveryAddress) missingFields.push('Endere√ßo de Entrega');
    if (!deliveryType) missingFields.push('Tipo de Entrega');
    if (!paymentMethod) missingFields.push('Forma de Pagamento');
    
    if (missingFields.length > 0) {
        const message = `Preencha os campos obrigat√≥rios: ${missingFields.join(', ')}`;
        if (ordersManager) ordersManager.showNotification(message, 'warning');
        return;
    }
    
    // Validar se a taxa de entrega foi calculada
    if (!deliveryFeeCalculated || currentDeliveryDistance === null || currentEstimatedDeliveryTime === null) {
        if (ordersManager) ordersManager.showNotification('Por favor, calcule a taxa de entrega antes de criar o pedido', 'warning');
        return;
    }

    // Validar itens do pedido (apenas obrigat√≥rio para neg√≥cios de alimentos)
    if (isFoodBusiness && ordersManager.newOrderItems.length === 0) {
        if (ordersManager) ordersManager.showNotification('Adicione pelo menos um item ao pedido', 'warning');
        return;
    }

    const subtotal = ordersManager.newOrderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    const totalAmount = subtotal + deliveryFee;

    // Capturar dados de troco quando pagamento for em dinheiro
    const cashReceived = paymentMethod === 'money' ? parseFloat(document.getElementById('deliveryChangeForAmount')?.value) || 0 : null;

    const includeRoundtrip = document.getElementById('deliveryIncludeRoundtrip')?.checked || false;
    
    const orderData = {
        customer_name: customerName,
        customer_phone: customerPhone,
        delivery_address: deliveryAddress,
        zip_code: zipCode,
        delivery_fee: deliveryFee,
        delivery_type: deliveryType,
        include_roundtrip: includeRoundtrip,
        payment_method: paymentMethod,
        notes: notes,
        subtotal: subtotal,
        total_amount: totalAmount,
        cash_received: cashReceived,
        items: [...ordersManager.newOrderItems]
    };

    if (ordersManager) await ordersManager.saveOrder(orderData);
    closeDeliveryOrderModal();
}

function submitBalcaoOrder() {
    if (!ordersManager) return;

    const customerName = document.getElementById('balcaoCustomerName')?.value.trim() || 'Cliente de Balc√£o';
    const customerPhone = document.getElementById('balcaoCustomerPhone')?.value.trim() || 'N/A';
    const paymentMethod = document.getElementById('balcaoPaymentMethod')?.value;
    const notes = document.getElementById('balcaoOrderNotes')?.value.trim();

    if (!paymentMethod) {
        if (ordersManager) ordersManager.showNotification('Selecione a forma de pagamento', 'warning');
        return;
    }

    // Validar itens do pedido (apenas obrigat√≥rio para neg√≥cios de alimentos)
    if (isFoodBusiness && ordersManager.newOrderItems.length === 0) {
        if (ordersManager) ordersManager.showNotification('Adicione pelo menos um item ao pedido', 'warning');
        return;
    }

    const subtotal = ordersManager.newOrderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

    // Capturar dados de troco quando pagamento for em dinheiro
    const cashReceived = paymentMethod === 'money' ? parseFloat(document.getElementById('balcaoChangeForAmount')?.value) || 0 : null;

    const orderData = {
        customer_name: customerName,
        customer_phone: customerPhone,
        delivery_address: 'Balc√£o',
        delivery_fee: 0,
        payment_method: paymentMethod,
        notes: notes,
        subtotal: subtotal,
        total_amount: subtotal,
        cash_received: cashReceived,
        items: [...ordersManager.newOrderItems]
    };

    if (ordersManager) ordersManager.saveOrder(orderData);
    closeBalcaoOrderModal();
}

function submitMesaOrder() {
    if (!ordersManager) return;

    const mesaNumber = document.getElementById('mesaNumber')?.value.trim();
    const customerName = document.getElementById('mesaCustomerName')?.value.trim() || `Mesa ${mesaNumber}`;
    const paymentMethod = document.getElementById('mesaPaymentMethod')?.value || '';
    const notes = document.getElementById('mesaOrderNotes')?.value.trim();
    const subtotal = ordersManager.newOrderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    const serviceFeeCheckbox = document.getElementById('mesaServiceFee');
    const serviceFee = serviceFeeCheckbox && serviceFeeCheckbox.checked ? subtotal * 0.10 : 0;
    const totalAmount = subtotal + serviceFee;

    if (!mesaNumber) {
        if (ordersManager) ordersManager.showNotification('Selecione o n√∫mero da mesa', 'warning');
        return;
    }

    // Validar itens do pedido (apenas obrigat√≥rio para neg√≥cios de alimentos)
    if (isFoodBusiness && ordersManager.newOrderItems.length === 0) {
        if (ordersManager) ordersManager.showNotification('Adicione pelo menos um item ao pedido', 'warning');
        return;
    }

    const orderData = {
        customer_name: customerName,
        mesa_number: mesaNumber,
        payment_method: paymentMethod,
        notes: notes,
        subtotal: subtotal,
        total_amount: totalAmount,
        items: [...ordersManager.newOrderItems]
    };

    if (ordersManager) ordersManager.saveOrder(orderData);
    closeMesaOrderModal();
}

// ===== FUN√á√ïES PARA MANIPULA√á√ÉO DE ITENS =====
function updateDeliveryOrderItemQuantity(index, quantity) { if (ordersManager) ordersManager.updateNewOrderItemQuantity(index, quantity, 'delivery'); }
function updateDeliveryOrderItemPrice(index, price) { if (ordersManager) ordersManager.updateNewOrderItemPrice(index, price, 'delivery'); }
function editDeliveryOrderItemNotes(index) { if (ordersManager) ordersManager.editNewOrderItemNotes(index, 'delivery'); }
function removeDeliveryOrderItem(index) { if (ordersManager) ordersManager.removeNewOrderItem(index, 'delivery'); }
function updateBalcaoOrderItemQuantity(index, quantity) { if (ordersManager) ordersManager.updateNewOrderItemQuantity(index, quantity, 'balcao'); }
function updateBalcaoOrderItemPrice(index, price) { if (ordersManager) ordersManager.updateNewOrderItemPrice(index, price, 'balcao'); }
function editBalcaoOrderItemNotes(index) { if (ordersManager) ordersManager.editNewOrderItemNotes(index, 'balcao'); }
function removeBalcaoOrderItem(index) { if (ordersManager) ordersManager.removeNewOrderItem(index, 'balcao'); }
function updateMesaOrderItemQuantity(index, quantity) { if (ordersManager) ordersManager.updateNewOrderItemQuantity(index, quantity, 'mesa'); }
function updateMesaOrderItemPrice(index, price) { if (ordersManager) ordersManager.updateNewOrderItemPrice(index, price, 'mesa'); }
function editMesaOrderItemNotes(index) { if (ordersManager) ordersManager.editNewOrderItemNotes(index, 'mesa'); }
function removeMesaOrderItem(index) { if (ordersManager) ordersManager.removeNewOrderItem(index, 'mesa'); }

// ===== FUN√á√ïES DE FILTROS E A√á√ïES =====
function applyFilters() { if (ordersManager) ordersManager.applyFilters(); }
function clearFilters() { if (ordersManager) ordersManager.clearFilters(); }
function refreshOrders() { if (ordersManager) { ordersManager.loadOrders().then(() => { if (ordersManager) ordersManager.showNotification('Pedidos atualizados!', 'success'); }); } }
function openOrderDetails(orderId) { if (ordersManager) ordersManager.openOrderDetails(orderId); }
function closeOrderDetailsModal() { if (ordersManager) ordersManager.closeOrderDetailsModal(); }

// FUN√á√ïES DE STATUS (AGORA CHAMAM A CLASSE)
async function updateOrderStatusFromDetails(orderId, newStatus) { if (ordersManager) { await ordersManager.updateOrderStatus(orderId, newStatus); ordersManager.closeOrderDetailsModal(); } }
async function updateOrderStatusFromCard(orderId, newStatus) { if (ordersManager) { await ordersManager.updateOrderStatus(orderId, newStatus); } }

function openFinalizarMesaModal(orderId) { if (!ordersManager) return; ordersManager.currentOrderForMesaFinalization = orderId; const modal = document.getElementById('finalizarMesaModal'); const order = ordersManager.orders.find(o => o.id === orderId); if (modal && order) { const totalDisplay = document.getElementById('mesaFinalTotalDisplay'); if (totalDisplay) { totalDisplay.textContent = parseFloat(order.total || order.total_amount || 0).toFixed(2).replace('.', ','); } modal.classList.add('show'); } }
function closeFinalizarMesaModal() { const modal = document.getElementById('finalizarMesaModal'); if (modal) { modal.classList.remove('show'); } if (ordersManager) { ordersManager.currentOrderForMesaFinalization = null; } }

async function confirmMesaPaymentAndFinish() {
    const paymentMethod = document.getElementById('mesaFinalPaymentMethod')?.value;
    const orderId = ordersManager?.currentOrderForMesaFinalization;
    if (!orderId || !ordersManager) { ordersManager?.showNotification('Erro: pedido de mesa n√£o identificado.', 'error'); return; }
    if (!paymentMethod) { ordersManager.showNotification('Selecione uma forma de pagamento.', 'warning'); return; }
    try {
        await supabase.from('orders').update({ status: 'encerrado', payment_method: paymentMethod, updated_at: new Date().toISOString() }).eq('id', orderId);
        ordersManager.showNotification('Mesa encerrada com sucesso!', 'success');
        await ordersManager.loadOrders();
        closeFinalizarMesaModal();
        closeOrderDetailsModal();
    } catch (error) {
        ordersManager.showNotification('Erro ao finalizar mesa. Tente novamente.', 'error');
    }
}

// ===== FUN√á√ïES DE NOTIFICA√á√ÉO =====
function hideNewOrderNotification() { const modal = document.getElementById('newOrderNotificationModal'); if (modal) { modal.classList.remove('show'); } currentNewOrderForNotification = null; }
function acceptNewOrderFromNotification() { if (!currentNewOrderForNotification || !ordersManager) return; ordersManager.updateOrderStatus(currentNewOrderForNotification.id, 'aceito').then(() => { hideNewOrderNotification(); if (ordersManager) ordersManager.showNotification('Pedido aceito com sucesso!', 'success'); }); }

// ===== FUN√á√ïES DE VERIFICA√á√ÉO =====
function startNewOrderChecking() { }
function startAcceptedOrdersChecking() { }

// ===== FUN√á√ïES APRIMORADAS DE √ÅUDIO =====
function ensureAudioEnabled() {
    // Ativar automaticamente o √°udio quando a p√°gina carrega
    newOrderSoundEnabled = true;
    
    // N√£o criar o AudioContext imediatamente, aguardar intera√ß√£o do usu√°rio
    
    // Configurar listeners para primeira intera√ß√£o
    const setupAudioOnInteraction = () => {
        resumeAudioContext();
        // Remove os listeners ap√≥s a primeira intera√ß√£o
        document.removeEventListener('click', setupAudioOnInteraction);
        document.removeEventListener('touchstart', setupAudioOnInteraction);
        document.removeEventListener('keydown', setupAudioOnInteraction);
    };
    
    document.addEventListener('click', setupAudioOnInteraction);
    document.addEventListener('touchstart', setupAudioOnInteraction);  
    document.addEventListener('keydown', setupAudioOnInteraction);
}

function forceAudioActivation() {
    if (!audioContextResumed) {
        resumeAudioContext();
    }
    
    // Garantir que o som est√° habilitado
    newOrderSoundEnabled = true;
    
    // Mostrar indicador
    showAudioIndicator();
    
}

// ===== FUN√á√ïES UTILIT√ÅRIAS =====
function showCustomConfirmation(message, title = 'Confirma√ß√£o') {
    return new Promise((resolve) => {
        const modalHtml = `
                <div class="modal" id="customConfirmationDialog" style="z-index: 16000; display:flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header"><h3>${title}</h3><button class="modal-close">&times;</button></div>
                        <div class="modal-body" style="text-align: center; padding: 2rem;"><p>${message}</p></div>
                        <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: center; gap: 1rem;">
                            <button class="btn btn-secondary" id="cancelConfirmBtn">Cancelar</button>
                            <button class="btn btn-primary" id="confirmConfirmBtn">Confirmar</button>
                        </div>
                    </div>
                </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const dialog = document.getElementById('customConfirmationDialog');
        const close = () => { dialog.remove(); resolve(false); };
        const confirm = () => { dialog.remove(); resolve(true); };
        dialog.querySelector('.modal-close').onclick = close;
        dialog.querySelector('#cancelConfirmBtn').onclick = close;
        dialog.querySelector('#confirmConfirmBtn').onclick = confirm;
    });
}

function showCustomPrompt(message, title = 'Digite') {
    return new Promise((resolve) => {
        const modalHtml = `
                <div class="modal" id="customPromptDialog" style="z-index: 16000; display:flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header"><h3>${title}</h3><button class="modal-close">&times;</button></div>
                        <div class="modal-body" style="padding: 2rem;">
                            <p style="margin-bottom: 1rem;">${message}</p>
                            <input type="text" id="promptInput" class="form-input" placeholder="Digite aqui..." style="width: 100%;">
                        </div>
                        <div style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: center; gap: 1rem;">
                            <button class="btn btn-secondary" id="cancelPromptBtn">Cancelar</button>
                            <button class="btn btn-primary" id="confirmPromptBtn">Confirmar</button>
                        </div>
                    </div>
                </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const dialog = document.getElementById('customPromptDialog');
        const input = document.getElementById('promptInput');
        const close = () => { dialog.remove(); resolve(null); };
        const confirm = () => { 
            const value = input.value;
            dialog.remove(); 
            resolve(value); 
        };
        dialog.querySelector('.modal-close').onclick = close;
        dialog.querySelector('#cancelPromptBtn').onclick = close;
        dialog.querySelector('#confirmPromptBtn').onclick = confirm;
        
        // Focus no input e permitir Enter para confirmar
        input.focus();
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirm();
            }
        });
    });
}

async function signOut() {
    // Usar modal padr√£o de confirma√ß√£o
    const confirmLogout = await showCustomConfirmation('Deseja realmente sair?', 'Sair');
    if (confirmLogout) {
        try {
            // 1. PRIMEIRO: Fazer logout do Supabase
            if (window.supabase) {
                await window.supabase.auth.signOut();
                console.log('‚úÖ Logout do Supabase realizado');
            }
            
            // 2. Limpar dados locais
            if (window.SECURE_INSTANCE_MANAGER) {
                window.SECURE_INSTANCE_MANAGER.logout();
            } else {
                // Fallback manual
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                localStorage.clear();
                sessionStorage.clear();
            }
        } catch (error) {
            console.error('Erro durante logout:', error);
        }
        window.location.href = 'login.html';
    }
}

// Adicionar event listener espec√≠fico para o bot√£o de logout
document.addEventListener('DOMContentLoaded', function() {
    const logoutButton = document.getElementById('logoutButton');
    if (logoutButton) {
        logoutButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üö™ Bot√£o sair clicado - iniciando signOut()');
            signOut();
        });
    }
});

// ===== FUN√á√ïES DE VALIDA√á√ÉO E FORMATA√á√ÉO =====
function toggleDeliveryChangeFields() { document.getElementById('deliveryChangeFields').style.display = document.getElementById('deliveryPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleBalcaoChangeFields() { document.getElementById('balcaoChangeFields').style.display = document.getElementById('balcaoPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleMesaChangeFields() { document.getElementById('mesaChangeFields').style.display = document.getElementById('mesaPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleFinalChangeFields() { document.getElementById('finalChangeFields').style.display = document.getElementById('finalPaymentMethod').value === 'money' ? 'block' : 'none'; }
function toggleFinalMesaChangeFields() { document.getElementById('mesaFinalChangeFields').style.display = document.getElementById('mesaFinalPaymentMethod').value === 'money' ? 'block' : 'none'; }
function calculateChange(total, changeFor) { return changeFor >= total ? (changeFor - total).toFixed(2) : '0.00'; }

// Toggle para exibir/ocultar sele√ß√£o de entregador baseado no tipo de entrega
function toggleDelivererSelection() {
    const deliveryType = document.getElementById('deliveryTypeSelectAssign')?.value;
    const delivererContainer = document.getElementById('delivererSelectContainer');
    const thirdPartyInfo = document.getElementById('thirdPartyInfo');
    
    if (!deliveryType) {
        // Se n√£o selecionou nenhum tipo, oculta ambos
        if (delivererContainer) delivererContainer.style.display = 'none';
        if (thirdPartyInfo) thirdPartyInfo.style.display = 'none';
        return;
    }
    
    if (deliveryType === 'house') {
        // Entrega da Casa: Mostra select de entregador
        if (delivererContainer) delivererContainer.style.display = 'block';
        if (thirdPartyInfo) thirdPartyInfo.style.display = 'none';
    } else if (deliveryType === 'third-party') {
        // Entrega de Terceiros: Mostra mensagem informativa
        if (delivererContainer) delivererContainer.style.display = 'none';
        if (thirdPartyInfo) thirdPartyInfo.style.display = 'block';
    }
}
function calculateDeliveryChange() { const total = parseFloat(document.getElementById('deliveryTotal').value); const changeFor = parseFloat(document.getElementById('deliveryChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('deliveryChangeAmount').value = change; document.getElementById('deliveryChangeDisplay').textContent = change.replace('.', ','); document.getElementById('deliveryChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateBalcaoChange() { const total = parseFloat(document.getElementById('balcaoTotal').value); const changeFor = parseFloat(document.getElementById('balcaoChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('balcaoChangeAmount').value = change; document.getElementById('balcaoChangeDisplay').textContent = change.replace('.', ','); document.getElementById('balcaoChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateMesaChange() { const total = parseFloat(document.getElementById('mesaTotal').value); const changeFor = parseFloat(document.getElementById('mesaChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('mesaChangeAmount').value = change; document.getElementById('mesaChangeDisplay').textContent = change.replace('.', ','); document.getElementById('mesaChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateFinalChange() { const total = parseFloat(document.getElementById('mesaFinalTotalDisplay').textContent.replace(',', '.')); const changeFor = parseFloat(document.getElementById('finalChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('finalChangeAmount').value = change; document.getElementById('finalChangeDisplay').textContent = change.replace('.', ','); document.getElementById('finalChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function calculateFinalMesaChange() { const total = parseFloat(document.getElementById('mesaFinalTotalDisplay').textContent.replace(',', '.')); const changeFor = parseFloat(document.getElementById('mesaFinalChangeForAmount').value); const change = calculateChange(total, changeFor); document.getElementById('mesaFinalChangeAmount').value = change; document.getElementById('mesaFinalChangeDisplay').textContent = change.replace('.', ','); document.getElementById('mesaFinalChangeCalculation').style.display = change > 0 ? 'block' : 'none'; }
function checkMesaAvailability() { const mesaNumber = document.getElementById('mesaNumber')?.value; const availabilityMessage = document.getElementById('mesaAvailabilityMessage'); if (!mesaNumber || !availabilityMessage) return; const occupiedTables = ['3', '7']; if (occupiedTables.includes(mesaNumber)) { availabilityMessage.innerHTML = `<div style="background:#f8d7da;color:#721c24;padding:1rem;border-radius:var(--border-radius);"><i class="fas fa-exclamation-triangle"></i> <strong>Aten√ß√£o:</strong> Mesa ${mesaNumber} j√° est√° ocupada. Deseja continuar mesmo assim?</div>`; availabilityMessage.style.display = 'block'; } else { availabilityMessage.innerHTML = `<div style="background:#d4edda;color:#155724;padding:1rem;border-radius:var(--border-radius);"><i class="fas fa-check-circle"></i> <strong>Dispon√≠vel:</strong> Mesa ${mesaNumber} est√° livre.</div>`; availabilityMessage.style.display = 'block'; } }

// ===== FUN√á√ïES DE REGISTRO DE CLIENTE =====
function openCustomerRegistrationModal() { document.getElementById('customerRegistrationModal').classList.add('show'); }
function closeCustomerRegistrationModal() { document.getElementById('customerRegistrationModal').classList.remove('show'); document.getElementById('customerRegistrationForm')?.reset(); }
function formatCEP(input) { let v = input.value.replace(/\D/g, ''); if (v.length > 5) v = v.replace(/^(\d{5})(\d)/, '$1-$2'); input.value = v; }
async function handleCustomerRegistration(event) { event.preventDefault(); const customerData = { name: document.getElementById('newCustomerName')?.value.trim(), phone: document.getElementById('newCustomerPhone')?.value.trim(), email: document.getElementById('newCustomerEmail')?.value.trim(), birth_date: document.getElementById('newCustomerBirthDate')?.value, cep: document.getElementById('newCustomerCep')?.value.trim(), address: document.getElementById('newCustomerRua')?.value.trim(), number: document.getElementById('newCustomerNumber')?.value.trim(), complement: document.getElementById('newCustomerComplement')?.value.trim(), neighborhood: document.getElementById('newCustomerBairro')?.value.trim(), city: document.getElementById('newCustomerCidade')?.value.trim(), state: document.getElementById('newCustomerUf')?.value.trim() }; if (!customerData.name || !customerData.phone) { if (ordersManager) ordersManager.showNotification('Nome e telefone s√£o obrigat√≥rios', 'warning'); return; } try { await supabase.from('customers').insert([{ restaurant_id: currentRestaurant?.id, ...customerData }]); if (ordersManager) ordersManager.showNotification('Cliente cadastrado com sucesso!', 'success'); closeCustomerRegistrationModal(); } catch (error) {  if (ordersManager) ordersManager.showNotification('Erro ao cadastrar cliente: ' + error.message, 'error'); } }

// ===== FUN√á√ïES DE PLACEHOLDER =====
function closeAddProductModal() { document.getElementById('addProductModal')?.classList.remove('show'); }
function closeEditItemModal() { document.getElementById('editItemModal')?.classList.remove('show'); }
function addProductToOrder() { }
function updateOrderItem() { }
function filterProducts() { }

// ===== INICIALIZA√á√ÉO DA APLICA√á√ÉO =====
document.addEventListener('DOMContentLoaded', async function() {
    await checkAuthenticationAndLoadConfig();
    initializeWhatsAppStatus();
    
    // Aguardar um pouco para garantir que a inst√¢ncia foi carregada
    setTimeout(async () => {
        await loadPaymentMethodsFromSupabase();
    }, 2000);
});

// ===== PAYMENT METHODS LOADING =====

// Vari√°vel global para armazenar as formas de pagamento
let paymentMethodsConfig = null;

// Fun√ß√£o para carregar formas de pagamento do Supabase
async function loadPaymentMethodsFromSupabase() {
    try {
        
        if (!supabase) {
            setDefaultPaymentMethods();
            updatePaymentMethodSelects();
            return;
        }

        // Primeiro, tentar usar a inst√¢ncia conectada
        let restaurantId = null;
        const currentInstance = getInstanceData();
        if (currentInstance && currentInstance.restaurantId) {
            restaurantId = currentInstance.restaurantId;
        } else {
        }

        let restaurants = [];
        
        if (restaurantId) {
            // Buscar o restaurante espec√≠fico da inst√¢ncia
            const { data: specificRestaurant, error: specificError } = await supabase
                .from('restaurants')
                .select('id, name, payment_methods')
                .eq('id', restaurantId)
                .single();

            if (specificError) {
            } else if (specificRestaurant) {
                restaurants = [specificRestaurant];
            }
        }
        
        // Se n√£o encontrou o restaurante da inst√¢ncia, buscar qualquer um com payment_methods
        if (restaurants.length === 0) {
            const { data: allRestaurants, error } = await supabase
                .from('restaurants')
                .select('id, name, payment_methods')
                .not('payment_methods', 'is', null)
                .limit(10);

            if (error) {
                setDefaultPaymentMethods();
                updatePaymentMethodSelects();
                return;
            }
            restaurants = allRestaurants || [];
        }

        
        if (restaurants.length > 0) {
            // Usar o primeiro restaurante que tem payment_methods v√°lidos
            let selectedRestaurant = null;
            
            for (const restaurant of restaurants) {
                
                if (restaurant.payment_methods && typeof restaurant.payment_methods === 'object') {
                    selectedRestaurant = restaurant;
                    break;
                }
            }
            
            if (selectedRestaurant) {
                
                // Validar e processar os dados recebidos
                const rawPaymentMethods = selectedRestaurant.payment_methods;
                paymentMethodsConfig = {
                    pix: rawPaymentMethods.pix || { enabled: false, key: null },
                    card: rawPaymentMethods.card || { enabled: false, debit: false, credit: false },
                    cash: rawPaymentMethods.cash || { enabled: false, needs_change: false }
                };
                
                
                // Log de quais op√ß√µes estar√£o dispon√≠veis
                const availableOptions = [];
                if (paymentMethodsConfig.pix.enabled) availableOptions.push('PIX');
                if (paymentMethodsConfig.card.enabled) {
                    const cardOptions = [];
                    if (paymentMethodsConfig.card.debit) cardOptions.push('Cart√£o de D√©bito');
                    if (paymentMethodsConfig.card.credit) cardOptions.push('Cart√£o de Cr√©dito');
                    if (cardOptions.length === 0) cardOptions.push('Cart√£o');
                    availableOptions.push(...cardOptions);
                }
                if (paymentMethodsConfig.cash.enabled) availableOptions.push('Dinheiro');
                availableOptions.push('Vale'); // Sempre dispon√≠vel
                
                
            } else {
                setDefaultPaymentMethods();
            }
        } else {
            setDefaultPaymentMethods();
        }

        // Sempre aplicar as configura√ß√µes nos modais
        updatePaymentMethodSelects();
        
    } catch (error) {
        setDefaultPaymentMethods();
        updatePaymentMethodSelects();
    }
}

// Fun√ß√£o para definir formas de pagamento padr√£o
function setDefaultPaymentMethods() {
    paymentMethodsConfig = {
        "pix": {
            "key": null,
            "enabled": true
        },
        "card": {
            "debit": true,
            "credit": true,
            "enabled": true
        },
        "cash": {
            "enabled": true,
            "needs_change": false
        }
    };
}

// Fun√ß√£o para atualizar os selects com as formas de pagamento
function updatePaymentMethodSelects() {
    try {
        
        if (!paymentMethodsConfig) {
            return;
        }

        const selectIds = [
            'deliveryPaymentMethod',
            'balcaoPaymentMethod', 
            'mesaPaymentMethod',
            'finalPaymentMethod'
        ];

        selectIds.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                updateSinglePaymentSelect(select, selectId);
            } else {
            }
        });

    } catch (error) {
    }
}

// Fun√ß√£o para atualizar um √∫nico select
function updateSinglePaymentSelect(select, selectId) {
    try {
        
        // Limpar op√ß√µes existentes, mas manter a primeira ("Selecione...")
        const firstOption = select.options[0];
        const firstOptionText = firstOption ? firstOption.textContent : '';
        select.innerHTML = '';
        
        // Recriar primeira op√ß√£o
        if (firstOption) {
            const newFirstOption = document.createElement('option');
            newFirstOption.value = firstOption.value;
            newFirstOption.textContent = firstOptionText;
            select.appendChild(newFirstOption);
        }

        let optionsAdded = 0;

        // Verificar e adicionar formas de pagamento conforme configura√ß√£o
        if (paymentMethodsConfig) {
            
            // Adicionar PIX se habilitado
            if (paymentMethodsConfig.pix && paymentMethodsConfig.pix.enabled === true) {
                const option = document.createElement('option');
                option.value = 'pix';
                option.textContent = 'PIX';
                select.appendChild(option);
                optionsAdded++;
            } else {
            }

            // Adicionar Cart√£o se habilitado - separar d√©bito e cr√©dito
            if (paymentMethodsConfig.card && paymentMethodsConfig.card.enabled === true) {
                console.log('üí≥ [PAYMENT METHODS] Processando cart√µes para ' + selectId + ':', {
                    debit: paymentMethodsConfig.card.debit,
                    credit: paymentMethodsConfig.card.credit
                });
                
                // Adicionar Cart√£o de D√©bito se habilitado
                if (paymentMethodsConfig.card.debit === true) {
                    const debitOption = document.createElement('option');
                    debitOption.value = 'card_debit';
                    debitOption.textContent = 'Cart√£o de D√©bito';
                    select.appendChild(debitOption);
                    optionsAdded++;
                }
                
                // Adicionar Cart√£o de Cr√©dito se habilitado
                if (paymentMethodsConfig.card.credit === true) {
                    const creditOption = document.createElement('option');
                    creditOption.value = 'card_credit';
                    creditOption.textContent = 'Cart√£o de Cr√©dito';
                    select.appendChild(creditOption);
                    optionsAdded++;
                }
                
                // Se nem d√©bito nem cr√©dito estiverem especificamente habilitados, adicionar cart√£o gen√©rico
                if (!paymentMethodsConfig.card.debit && !paymentMethodsConfig.card.credit) {
                    const genericCardOption = document.createElement('option');
                    genericCardOption.value = 'card';
                    genericCardOption.textContent = 'Cart√£o';
                    select.appendChild(genericCardOption);
                    optionsAdded++;
                }
                
            } else {
            }

            // Adicionar Dinheiro se habilitado
            if (paymentMethodsConfig.cash && paymentMethodsConfig.cash.enabled === true) {
                const option = document.createElement('option');
                option.value = 'money';
                option.textContent = 'Dinheiro';
                select.appendChild(option);
                optionsAdded++;
            } else {
            }
        } else {
            // Adicionar todas as op√ß√µes como fallback
            const fallbackOptions = [
                { value: 'pix', text: 'PIX' },
                { value: 'card', text: 'Cart√£o' },
                { value: 'money', text: 'Dinheiro' }
            ];
            
            fallbackOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                select.appendChild(option);
                optionsAdded++;
            });
        }

        // Sempre adicionar Vale como op√ß√£o adicional (conforme c√≥digo original)
        const valeOption = document.createElement('option');
        valeOption.value = 'voucher';
        valeOption.textContent = 'Vale';
        select.appendChild(valeOption);
        optionsAdded++;


    } catch (error) {
    }
}

// ===== WHATSAPP STATUS FUNCTIONS =====

// Configura√ß√£o da Evolution API (ser√° carregada do backend)
let EVOLUTION_API = null;
let whatsappInstanceName = null;

// Inicializar verifica√ß√£o do status do WhatsApp
async function initializeWhatsAppStatus() {
    
    // Configurar nome da inst√¢ncia WhatsApp
    await initializeWhatsAppInstanceName();
    
    // Verificar status inicial
    await checkWhatsAppStatus();
    
    // Verificar status periodicamente (a cada 10 segundos para tempo real)
    setInterval(async () => {
        await checkWhatsAppStatus();
    }, 10000);
    
    // Verifica√ß√µes adicionais em eventos importantes
    setupRealTimeWhatsAppChecks();
}

// Configurar nome da inst√¢ncia WhatsApp automaticamente consultando Supabase
async function initializeWhatsAppInstanceName() {
    try {
        // Obter dados da inst√¢ncia atual
        const instance = getInstanceData();
        if (!instance || !instance.restaurantId) {
            whatsappInstanceName = 'timepulse_default';
            return;
        }

        // Consultar nome real do restaurante no Supabase
        const { data: restaurant, error } = await supabase
            .from('restaurants')
            .select('name')
            .eq('id', instance.restaurantId)
            .single();

        if (error) {
            whatsappInstanceName = 'timepulse_default';
            return;
        }

        if (restaurant && restaurant.name) {
            // Usar o nome EXATAMENTE como est√° registrado no banco de dados
            whatsappInstanceName = restaurant.name;
            
        } else {
            whatsappInstanceName = 'timepulse_default';
        }
        
    } catch (error) {
        whatsappInstanceName = 'timepulse_default';
    }
}

// Verificar status do WhatsApp
async function checkWhatsAppStatus() {
    const indicator = document.getElementById('whatsappStatusIndicator');
    const statusText = document.getElementById('whatsappStatusText');
    
    if (!indicator || !statusText) return;
    
    try {
        // Estado: verificando (apenas se n√£o estiver verificando j√°)
        if (!indicator.classList.contains('checking')) {
            updateWhatsAppStatusDisplay('checking', 'Verificando...');
        }
        
        if (!whatsappInstanceName) {
            // Tentar inicializar o nome da inst√¢ncia primeiro
            await initializeWhatsAppInstanceName();
            if (!whatsappInstanceName) {
                updateWhatsAppStatusDisplay('disconnected', 'Inst√¢ncia n√£o configurada');
                return;
            }
        }

        // Carregar configura√ß√£o da Evolution se ainda n√£o carregada
        if (!EVOLUTION_API || !EVOLUTION_API.serverUrl) {
            try {
                const config = await fetchPublicConfig();
                
                if (config && config.evolution && config.evolution.serverUrl) {
                    EVOLUTION_API = config.evolution;
                    console.log('üîß Evolution API configurada via proxy seguro:', {
                        serverUrl: EVOLUTION_API.serverUrl,
                        proxyEndpoint: '/api/evolution/connectionState/',
                        securityMode: 'API key protegida no servidor'
                    });
                } else {
                    console.error('‚ùå Configura√ß√£o Evolution n√£o encontrada:', {
                        hasConfig: !!config,
                        hasEvolution: !!(config?.evolution),
                        hasServerUrl: !!(config?.evolution?.serverUrl)
                    });
                    updateWhatsAppStatusDisplay('disconnected', 'Config Evolution n√£o encontrada');
                    return;
                }
            } catch (configError) {
                updateWhatsAppStatusDisplay('disconnected', 'Erro ao carregar config');
                return;
            }
        }
        
        // Verificar se temos as configura√ß√µes m√≠nimas necess√°rias (sem API key no frontend)
        if (!EVOLUTION_API.serverUrl) {
            console.error('‚ùå Configura√ß√£o Evolution incompleta:', {
                hasServerUrl: !!EVOLUTION_API.serverUrl,
                proxyMode: 'Usando proxy seguro do servidor'
            });
            updateWhatsAppStatusDisplay('disconnected', 'Config Evolution incompleta');
            return;
        }
        
        // Primeiro, verificar o estado da conex√£o usando a API connectionState
        await checkEvolutionConnectionState(whatsappInstanceName);
        
    } catch (error) {
        updateWhatsAppStatusDisplay('disconnected', 'Erro');
    }
}

// Nova fun√ß√£o para verificar estado da conex√£o usando proxy seguro do servidor
async function checkEvolutionConnectionState(instanceName) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 segundos timeout
        
        // Usar endpoint proxy seguro do servidor (sem expor API key)
        const connectionUrl = `/api/evolution/connectionState/${instanceName}`;
        
        const response = await fetch(connectionUrl, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (response.ok) {
            const data = await response.json();
            
            if (data.instance && data.instance.state) {
                const state = data.instance.state.toLowerCase();
                
                if (state === 'open') {
                    updateWhatsAppStatusDisplay('connected', 'Conectado');
                } else if (state === 'close') {
                    updateWhatsAppStatusDisplay('disconnected', 'Desconectado');
                } else {
                    updateWhatsAppStatusDisplay('checking', `Status: ${state}`);
                }
            } else {
                updateWhatsAppStatusDisplay('disconnected', 'Status indefinido');
            }
            
        } else if (response.status === 404) {
            // 404 significa que a inst√¢ncia n√£o existe
            const errorData = await response.json().catch(() => ({}));
            updateWhatsAppStatusDisplay('disconnected', 'Inst√¢ncia n√£o encontrada');
            
        } else {
            // Outros erros HTTP
            const errorData = await response.json().catch(() => ({}));
            updateWhatsAppStatusDisplay('disconnected', `Erro HTTP ${response.status}`);
        }
        
    } catch (error) {
        if (error.name === 'AbortError') {
            updateWhatsAppStatusDisplay('disconnected', 'Timeout na verifica√ß√£o');
        } else {
            updateWhatsAppStatusDisplay('disconnected', 'Erro de conex√£o');
        }
    }
}

// Atualizar display do status do WhatsApp
function updateWhatsAppStatusDisplay(status, text) {
    const indicator = document.getElementById('whatsappStatusIndicator');
    const statusText = document.getElementById('whatsappStatusText');
    
    if (!indicator || !statusText) return;
    
    // Verificar se houve mudan√ßa de status para log
    const currentStatus = indicator.className.includes('connected') ? 'connected' : 
                         indicator.className.includes('disconnected') ? 'disconnected' : 'checking';
    
    if (currentStatus !== status) {
    }
    
    // Remover todas as classes de status
    indicator.classList.remove('connected', 'disconnected', 'checking');
    
    // Adicionar nova classe de status
    indicator.classList.add(status);
    
    // Atualizar texto
    statusText.textContent = text;
}

// Configurar verifica√ß√µes em tempo real
function setupRealTimeWhatsAppChecks() {
    // Verificar quando a p√°gina ganha foco (usu√°rio volta para a aba)
    window.addEventListener('focus', async () => {
        await checkWhatsAppStatus();
    });
    
    // Verificar quando h√° atividade de rede (quando outros dados s√£o carregados)
    // Interceptar fetch global para detectar atividade
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
        const result = await originalFetch.apply(this, args);
        
        // Se h√° atividade de rede, aproveitar para verificar WhatsApp ocasionalmente
        if (Math.random() < 0.1) { // 10% de chance a cada request
            setTimeout(() => checkWhatsAppStatus(), 1000);
        }
        
        return result;
    };
    
    // Verificar quando usu√°rio interage com a p√°gina (cliques importantes)
    document.addEventListener('click', (event) => {
        // Se clicou em bot√µes importantes, verificar WhatsApp
        if (event.target.matches('.btn-primary, .online-toggle, .nav-link')) {
            setTimeout(() => checkWhatsAppStatus(), 2000);
        }
    });
    
    // Verificar quando h√° mudan√ßa de visibilidade da p√°gina
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            setTimeout(() => checkWhatsAppStatus(), 500);
        }
    });
    
}

// Verifica√ß√£o mais agressiva quando necess√°rio
let intensiveCheckingMode = false;
let intensiveCheckingInterval = null;

function enableIntensiveWhatsAppChecking(duration = 60000) {
    if (intensiveCheckingMode) return;
    
    intensiveCheckingMode = true;
    
    // Verificar a cada 3 segundos no modo intensivo
    intensiveCheckingInterval = setInterval(async () => {
        await checkWhatsAppStatus();
    }, 3000);
    
    // Desativar ap√≥s o per√≠odo especificado
    setTimeout(() => {
        disableIntensiveWhatsAppChecking();
    }, duration);
}

function disableIntensiveWhatsAppChecking() {
    if (!intensiveCheckingMode) return;
    
    intensiveCheckingMode = false;
    
    if (intensiveCheckingInterval) {
        clearInterval(intensiveCheckingInterval);
        intensiveCheckingInterval = null;
    }
}
// Adiciona o event listener para a primeira intera√ß√£o do usu√°rio, ativando o AudioContext.
document.addEventListener('click', resumeAudioContext, { once: true });


// ===== EVENT LISTENERS GLOBAIS =====
document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) e.target.classList.remove('show'); });

// ===== FUN√á√ïES ESPEC√çFICAS PARA DETALHES DE PEDIDOS (DELEGA√á√ÉO) =====
// Fun√ß√µes que delegam a chamada para a inst√¢ncia `ordersManager`
function openDelivererSelectionModal(orderId) { if (ordersManager) ordersManager.openDelivererSelectionModal(orderId); }
function closeDelivererSelectionModal() { if (ordersManager) ordersManager.closeDelivererSelectionModal(); }
function confirmDelivererSelection() { if (ordersManager) ordersManager.confirmDelivererSelection(); }
function openPaymentMethodModal(orderId) { if (ordersManager) ordersManager.openPaymentMethodModal(orderId); }
async function confirmPaymentAndFinish() { if (ordersManager) await ordersManager.confirmPaymentAndFinish(); }

// Manter as fun√ß√µes originais que n√£o estavam quebradas, mas renomeando para evitar conflito.
function openOrderDetailsComplete(orderId) { openOrderDetails(orderId); }
function getOrderDetailActionsComplete(order) { return getOrderDetailActions(order); }
async function updateOrderStatusComplete(orderId, newStatus) { if (ordersManager) await ordersManager.updateOrderStatus(orderId, newStatus); }
async function loadDeliverersComplete(selectElement) { if (ordersManager) await ordersManager.loadDeliverers(selectElement); }
async function confirmDelivererSelectionComplete() { if (ordersManager) await ordersManager.confirmDelivererSelection(); }
function openPaymentMethodModalComplete(orderId) { if (ordersManager) ordersManager.openPaymentMethodModal(orderId); }
async function confirmPaymentAndFinishComplete() { if (ordersManager) await ordersManager.confirmPaymentAndFinish(); }
function openFinalizarMesaModalComplete(orderId) { openFinalizarMesaModal(orderId); }
async function confirmMesaPaymentAndFinishComplete() { await confirmMesaPaymentAndFinish(); }

// ===== NOVAS FUN√á√ïES PARA GERENCIAMENTO DE PEDIDOS =====

// Vari√°veis globais para os novos modais
let currentOrderForEdit = null;
let currentOrderForDelete = null;
let currentOrderForAddProduct = null;

// ===== FUN√á√ïES PARA ADICIONAR PRODUTO AO PEDIDO =====
async function openAddProductToOrderModal(orderId) {
    try {
        if (!ordersManager) {
            return;
        }
        
        currentOrderForAddProduct = orderId;
        const modal = document.getElementById('addProductToOrderModal');
        
        if (!modal) {
            if (ordersManager) ordersManager.showNotification('Modal n√£o encontrado. Recarregue a p√°gina.', 'error');
            return;
        }
        
        // Limpar campo de busca
        const searchInput = document.getElementById('productSearchAddToOrder');
        if (searchInput) searchInput.value = '';
        
        // Carregar produtos
        await loadProductsForOrderModal();
        
        // Mostrar modal
        modal.classList.add('show');
        
    } catch (error) {
        if (ordersManager) ordersManager.showNotification('Erro ao carregar produtos: ' + error.message, 'error');
    }
}

function closeAddProductToOrderModal() {
    const modal = document.getElementById('addProductToOrderModal');
    if (modal) modal.classList.remove('show');
    currentOrderForAddProduct = null;
}

async function loadProductsForOrderModal() {
    try {
        const container = document.getElementById('productsByCategoryAddToOrder');
        if (!container) {
            return;
        }
        
        // Mostrar carregando
        container.innerHTML = '<div style="text-align: center; padding: 2rem;">Carregando produtos...</div>';
        
        // Verificar se produtos j√° est√£o carregados
        if (!ordersManager || !ordersManager.products || ordersManager.products.length === 0) {
            await ordersManager.loadProducts();
        }
        
        if (!ordersManager.products || ordersManager.products.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">Nenhum produto encontrado. Verifique se h√° produtos cadastrados.</div>';
            return;
        }
        
        
        // Agrupar produtos por categoria
        const productsByCategory = {};
        ordersManager.products.forEach(product => {
            const categoryName = product.product_categories?.name || 'Sem Categoria';
            if (!productsByCategory[categoryName]) {
                productsByCategory[categoryName] = [];
            }
            productsByCategory[categoryName].push(product);
        });
        
        // Verificar se h√° categorias
        if (Object.keys(productsByCategory).length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">Nenhuma categoria de produto encontrada.</div>';
            return;
        }
        
        // Gerar HTML
        let html = '';
        Object.keys(productsByCategory).forEach(categoryName => {
            html += `
                <div class="category-section" style="margin-bottom: 2rem;">
                    <h5 style="color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-color);">
                        ${categoryName} (${productsByCategory[categoryName].length} produtos)
                    </h5>
                    <div class="products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                        ${productsByCategory[categoryName].map(product => `
                            <div class="product-card" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s ease; background: white;" 
                                 onclick="addProductToExistingOrder('${product.id}', '${product.name.replace(/'/g, "\\'")}', ${product.price})">
                                <h6 style="margin-bottom: 0.5rem; color: var(--dark-color);">${product.name}</h6>
                                <p style="color: var(--primary-color); font-weight: 600; margin: 0;">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</p>
                                ${product.description ? `<p style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem;">${product.description}</p>` : ''}
                                <div style="margin-top: 0.5rem; text-align: center;">
                                    <small style="color: #28a745; font-weight: 500;">Clique para adicionar</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        const container = document.getElementById('productsByCategoryAddToOrder');
        if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc3545;">Erro ao carregar produtos. Tente novamente.</div>';
        }
    }
}

function searchProductsForOrder(searchTerm) {
    if (!ordersManager || !ordersManager.products) return;
    
    const container = document.getElementById('productsByCategoryAddToOrder');
    if (!container) return;
    
    if (!searchTerm || searchTerm.length < 2) {
        loadProductsForOrderModal();
        return;
    }
    
    const searchLower = searchTerm.toLowerCase();
    const filtered = ordersManager.products.filter(product => 
        product.name.toLowerCase().includes(searchLower) ||
        product.id.slice(-4).includes(searchTerm)
    );
    
    let html = `
        <div class="category-section">
            <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Resultados da Busca (${filtered.length})</h5>
            <div class="products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                ${filtered.map(product => `
                    <div class="product-card" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.3s ease;" 
                         onclick="addProductToExistingOrder('${product.id}', '${product.name}', ${product.price})">
                        <h6 style="margin-bottom: 0.5rem; color: var(--dark-color);">${product.name}</h6>
                        <p style="color: var(--primary-color); font-weight: 600; margin: 0;">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</p>
                        ${product.description ? `<p style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem;">${product.description}</p>` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

async function addProductToExistingOrder(productId, productName, productPrice) {
    
    try {
        if (!currentOrderForAddProduct || currentOrderForAddProduct === 'null' || !ordersManager) {
            if (ordersManager) ordersManager.showNotification('Erro: Pedido n√£o selecionado ou sistema n√£o carregado.', 'error');
            return;
        }
        
        const quantity = await showCustomPrompt(`Quantos itens de "${productName}" deseja adicionar?`, 'Quantidade');
        if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
            if (ordersManager) ordersManager.showNotification('Quantidade inv√°lida.', 'warning');
            return;
        }
        
        const notes = await showCustomPrompt('Observa√ß√µes para este item (opcional):', 'Observa√ß√µes') || '';
        
        const currentInstance = getInstanceData();
        if (!currentInstance) {
            if (ordersManager) ordersManager.showNotification('Erro: Inst√¢ncia do restaurante n√£o encontrada.', 'error');
            return;
        }
        
        const itemData = {
            order_id: currentOrderForAddProduct,
            product_id: productId,
            product_name: productName,
            quantity: parseInt(quantity),
            price: parseFloat(productPrice),
            notes: notes || null
        };
        
        // Adicionar item ao pedido no banco de dados
        const { error } = await supabase
            .from('order_items')
            .insert([itemData]);
            
        if (error) {
            if (ordersManager) ordersManager.showNotification('Erro ao adicionar produto: ' + error.message, 'error');
            return;
        }
        
        // Salvar o ID do pedido antes de limpar a vari√°vel
        const orderId = currentOrderForAddProduct;
        
        // Recalcular total do pedido
        await recalculateOrderTotals(orderId);
        
        // Verificar se modal de detalhes estava aberto antes de fechar o modal de adicionar
        const detailsModal = document.getElementById('orderDetailsModal');
        const wasDetailsModalOpen = detailsModal && detailsModal.classList.contains('show');
        
        // Atualizar pedido em tempo real (inclui modal se estiver aberto)
        await updateSingleOrderRealTime(orderId);
        
        if (ordersManager) ordersManager.showNotification('Produto adicionado ao pedido com sucesso!', 'success');
        
        closeAddProductToOrderModal();
        
        // Se o modal de detalhes estava aberto, reabri-lo com dados atualizados
        if (wasDetailsModalOpen && ordersManager) {
            setTimeout(() => {
                ordersManager.showOrderDetails(orderId);
            }, 300); // Aguarda um pouco para garantir que o modal anterior fechou
        }
        
    } catch (error) {
        if (ordersManager) ordersManager.showNotification('Erro inesperado: ' + error.message, 'error');
    }
}


// ===== FUN√á√ïES PARA EDITAR PEDIDO =====
async function openEditOrderModal(orderId) {
    if (!ordersManager) return;
    
    const order = ordersManager.orders.find(o => o.id === orderId);
    if (!order) return;
    
    currentOrderForEdit = orderId;
    const modal = document.getElementById('editOrderModal');
    const body = document.getElementById('editOrderModalBody');
    
    if (!modal || !body) return;
    
    // Gerar formul√°rio de edi√ß√£o
    body.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div>
                <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Dados do Cliente</h5>
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">Nome do Cliente</label>
                    <input type="text" id="editCustomerName" class="form-input" value="${order.customer_name || ''}" placeholder="Nome do cliente">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">Telefone</label>
                    <input type="text" id="editCustomerPhone" class="form-input" value="${order.customer_phone || ''}" placeholder="Telefone">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">Endere√ßo</label>
                    <textarea id="editDeliveryAddress" class="form-input" rows="3" placeholder="Endere√ßo de entrega">${order.delivery_address || ''}</textarea>
                </div>
            </div>
            <div>
                <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Informa√ß√µes do Pedido</h5>
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">M√©todo de Pagamento</label>
                    <select id="editPaymentMethod" class="form-input" onchange="toggleEditChangeFields()">
                        <option value="money" ${order.payment_method === 'money' ? 'selected' : ''}>Dinheiro</option>
                        <option value="card" ${order.payment_method === 'card' ? 'selected' : ''}>Cart√£o de Cr√©dito/D√©bito</option>
                        <option value="pix" ${order.payment_method === 'pix' ? 'selected' : ''}>PIX</option>
                        <option value="voucher" ${order.payment_method === 'voucher' ? 'selected' : ''}>Voucher</option>
                    </select>
                </div>
                <div id="editChangeFields" style="display: ${order.payment_method === 'money' ? 'block' : 'none'}; margin-bottom: 1rem;">
                    <label class="filter-label">Dinheiro Recebido</label>
                    <input type="number" id="editCashReceived" class="form-input" value="${order.change_for_amount || ''}" step="0.01" placeholder="0,00">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">Taxa de Entrega</label>
                    <input type="number" id="editDeliveryFee" class="form-input" value="${parseFloat(order.delivery_fee || 0).toFixed(2)}" step="0.01" placeholder="0,00">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="filter-label">Observa√ß√µes</label>
                    <textarea id="editOrderNotes" class="form-input" rows="3" placeholder="Observa√ß√µes do pedido">${order.notes || ''}</textarea>
                </div>
            </div>
        </div>
        
        <div>
            <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Itens do Pedido</h5>
            <table class="items-table">
                <thead>
                    <tr><th>Item</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th><th>A√ß√µes</th></tr>
                </thead>
                <tbody id="editOrderItemsTable">
                    ${order.order_items.map((item, index) => `
                        <tr data-item-id="${item.id}">
                            <td>
                                <div class="item-name-cell">${item.product_name}</div>
                                ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                            </td>
                            <td class="item-quantity-cell">
                                <input type="number" value="${item.quantity}" min="1" style="width: 60px; text-align: center;" 
                                       onchange="updateEditItemQuantity('${item.id}', this.value)">
                            </td>
                            <td class="item-price-cell">
                                <input type="number" value="${parseFloat(item.price).toFixed(2)}" step="0.01" style="width: 80px; text-align: right;" 
                                       onchange="updateEditItemPrice('${item.id}', this.value)">
                            </td>
                            <td class="item-total-cell" id="itemTotal_${item.id}">R$ ${(item.quantity * parseFloat(item.price)).toFixed(2).replace('.', ',')}</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeEditOrderItem('${item.id}')" title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    modal.classList.add('show');
}

function closeEditOrderModal() {
    const modal = document.getElementById('editOrderModal');
    if (modal) modal.classList.remove('show');
    currentOrderForEdit = null;
}

function toggleEditChangeFields() {
    const paymentMethod = document.getElementById('editPaymentMethod')?.value;
    const changeFields = document.getElementById('editChangeFields');
    if (changeFields) {
        changeFields.style.display = paymentMethod === 'money' ? 'block' : 'none';
    }
}

function updateEditItemQuantity(itemId, quantity) {
    const qty = parseInt(quantity);
    if (qty <= 0) return;
    
    const priceInput = document.querySelector(`tr[data-item-id="${itemId}"] .item-price-cell input`);
    const price = parseFloat(priceInput?.value || 0);
    const total = qty * price;
    
    const totalCell = document.getElementById(`itemTotal_${itemId}`);
    if (totalCell) {
        totalCell.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }
}

function updateEditItemPrice(itemId, price) {
    const priceValue = parseFloat(price);
    if (priceValue < 0) return;
    
    const qtyInput = document.querySelector(`tr[data-item-id="${itemId}"] .item-quantity-cell input`);
    const quantity = parseInt(qtyInput?.value || 1);
    const total = quantity * priceValue;
    
    const totalCell = document.getElementById(`itemTotal_${itemId}`);
    if (totalCell) {
        totalCell.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }
}

async function removeEditOrderItem(itemId) {
    if (!confirm('Deseja remover este item do pedido?')) return;
    
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    if (row) {
        row.remove();
    }
}

async function saveEditedOrder() {
    if (!currentOrderForEdit || !ordersManager) return;
    
    const customerName = document.getElementById('editCustomerName')?.value?.trim();
    const customerPhone = document.getElementById('editCustomerPhone')?.value?.trim();
    const deliveryAddress = document.getElementById('editDeliveryAddress')?.value?.trim();
    const paymentMethod = document.getElementById('editPaymentMethod')?.value;
    const cashReceived = document.getElementById('editCashReceived')?.value;
    const deliveryFee = parseFloat(document.getElementById('editDeliveryFee')?.value || 0);
    const notes = document.getElementById('editOrderNotes')?.value?.trim();
    
    if (!customerName) {
        ordersManager.showNotification('Nome do cliente √© obrigat√≥rio', 'warning');
        return;
    }
    
    try {
        // Atualizar dados do pedido
        const orderUpdateData = {
            customer_name: customerName,
            customer_phone: customerPhone?.trim() || 'N/A', // CORRIGIDO: Evitar null
            delivery_address: deliveryAddress,
            payment_method: paymentMethod,
            delivery_fee: deliveryFee,
            notes: notes || null,
            updated_at: new Date().toISOString()
        };
        
        if (paymentMethod === 'money' && cashReceived) {
            orderUpdateData.change_for_amount = parseFloat(cashReceived);
        }
        
        const { error: orderError } = await supabase
            .from('orders')
            .update(orderUpdateData)
            .eq('id', currentOrderForEdit);
            
        if (orderError) throw orderError;
        
        // Atualizar itens do pedido
        const itemRows = document.querySelectorAll('#editOrderItemsTable tr[data-item-id]');
        const itemUpdates = [];
        
        for (const row of itemRows) {
            const itemId = row.getAttribute('data-item-id');
            const quantity = parseInt(row.querySelector('.item-quantity-cell input').value);
            const price = parseFloat(row.querySelector('.item-price-cell input').value);
            
            itemUpdates.push(
                supabase
                    .from('order_items')
                    .update({ quantity, price })
                    .eq('id', itemId)
            );
        }
        
        await Promise.all(itemUpdates);
        
        // Recalcular total
        await recalculateOrderTotal(currentOrderForEdit);
        
        ordersManager.showNotification('Pedido editado com sucesso!', 'success');
        closeEditOrderModal();
        
        // Recarregar pedidos
        await ordersManager.loadOrders();
        ordersManager.openOrderDetails(currentOrderForEdit);
        
    } catch (error) {
        ordersManager.showNotification('Erro ao salvar edi√ß√µes do pedido', 'error');
    }
}

// ===== FUN√á√ïES PARA EXCLUIR PEDIDO =====
function openDeleteOrderModal(orderId) {
    if (!ordersManager) return;
    
    const order = ordersManager.orders.find(o => o.id === orderId);
    if (!order) return;
    
    currentOrderForDelete = orderId;
    const modal = document.getElementById('deleteOrderModal');
    const infoElement = document.getElementById('deleteOrderInfo');
    const passwordInput = document.getElementById('deleteOrderPassword');
    
    if (modal && infoElement && passwordInput) {
        infoElement.innerHTML = `
            Pedido #${order.order_number}<br>
            Cliente: ${order.customer_name}<br>
            Total: R$ ${parseFloat(order.total || order.total_amount || 0).toFixed(2).replace('.', ',')}
        `;
        
        passwordInput.value = '';
        modal.classList.add('show');
    }
}

function closeDeleteOrderModal() {
    const modal = document.getElementById('deleteOrderModal');
    if (modal) modal.classList.remove('show');
    currentOrderForDelete = null;
    
    const passwordInput = document.getElementById('deleteOrderPassword');
    if (passwordInput) passwordInput.value = '';
}

async function confirmDeleteOrder() {
    if (!currentOrderForDelete || !ordersManager) return;
    
    const password = document.getElementById('deleteOrderPassword')?.value;
    if (!password) {
        ordersManager.showNotification('Digite a senha para confirmar', 'warning');
        return;
    }
    
    try {
        const currentInstance = getInstanceData();
        if (!currentInstance) throw new Error('Inst√¢ncia n√£o encontrada');
        
        // Verificar se √© o owner do restaurante atrav√©s da sess√£o atual
        // Como n√£o temos campo password na tabela restaurants, vamos usar uma confirma√ß√£o simples
        if (password.toLowerCase() !== 'confirmar') {
            ordersManager.showNotification('Digite "confirmar" para excluir o pedido', 'warning');
            return;
        }
        
        // Excluir itens do pedido primeiro
        const { error: itemsError } = await supabase
            .from('order_items')
            .delete()
            .eq('order_id', currentOrderForDelete);
            
        if (itemsError) throw itemsError;
        
        // Excluir pedido
        const { error: orderError } = await supabase
            .from('orders')
            .delete()
            .eq('id', currentOrderForDelete);
            
        if (orderError) throw orderError;
        
        ordersManager.showNotification('Pedido exclu√≠do com sucesso!', 'success');
        closeDeleteOrderModal();
        closeOrderDetailsModal();
        
        // Recarregar pedidos
        await ordersManager.loadOrders();
        
    } catch (error) {
        ordersManager.showNotification('Erro ao excluir pedido: ' + error.message, 'error');
    }
}

// ===== FUN√á√ïES PARA EDITAR E EXCLUIR ITENS INDIVIDUAIS =====

let currentEditingOrderId = null;

function openEditItemModal(itemId, orderId) {
    const order = ordersManager.orders.find(o => o.id === orderId);
    if (!order) return;
    
    const item = order.order_items.find(i => i.id === itemId);
    if (!item) return;
    
    currentEditingItem = item;
    currentEditingOrderId = orderId;
    
    const modal = document.getElementById('editItemModal');
    const content = document.getElementById('editItemContent');
    
    if (!modal || !content) return;
    
    content.innerHTML = `
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: var(--primary-color); margin-bottom: 1rem;">${item.product_name}</h4>
            
            <div style="margin-bottom: 1rem;">
                <label class="filter-label">Quantidade</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button type="button" class="btn btn-outline" onclick="adjustItemQuantity(-1)">-</button>
                    <input type="number" id="editItemQuantity" class="form-input" value="${item.quantity}" min="1" 
                           style="width: 80px; text-align: center;" onchange="updateItemTotal()">
                    <button type="button" class="btn btn-outline" onclick="adjustItemQuantity(1)">+</button>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label class="filter-label">Pre√ßo Unit√°rio</label>
                <input type="number" id="editItemPrice" class="form-input" value="${item.price}" 
                       step="0.01" onchange="updateItemTotal()">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label class="filter-label">Observa√ß√µes</label>
                <textarea id="editItemNotes" class="form-input" rows="3" 
                          placeholder="Observa√ß√µes especiais...">${item.notes || ''}</textarea>
            </div>
            
            <div style="background-color: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: right;">
                <strong>Total do Item: R$ <span id="editItemTotal">${(item.quantity * parseFloat(item.price)).toFixed(2).replace('.', ',')}</span></strong>
            </div>
        </div>
    `;
    
    modal.classList.add('show');
}

function closeEditItemModal() {
    const modal = document.getElementById('editItemModal');
    if (modal) modal.classList.remove('show');
    currentEditingItem = null;
    currentEditingOrderId = null;
}

function adjustItemQuantity(change) {
    const quantityInput = document.getElementById('editItemQuantity');
    if (!quantityInput) return;
    
    const currentQuantity = parseInt(quantityInput.value) || 1;
    const newQuantity = Math.max(1, currentQuantity + change);
    
    quantityInput.value = newQuantity;
    updateItemTotal();
}

function updateItemTotal() {
    const quantity = parseInt(document.getElementById('editItemQuantity')?.value) || 1;
    const price = parseFloat(document.getElementById('editItemPrice')?.value) || 0;
    const total = quantity * price;
    
    const totalElement = document.getElementById('editItemTotal');
    if (totalElement) {
        totalElement.textContent = total.toFixed(2).replace('.', ',');
    }
}

async function saveItemChanges() {
    if (!currentEditingItem || !currentEditingOrderId || !ordersManager) return;
    
    const quantity = parseInt(document.getElementById('editItemQuantity')?.value) || 1;
    const price = parseFloat(document.getElementById('editItemPrice')?.value) || 0;
    const notes = document.getElementById('editItemNotes')?.value?.trim() || null;
    
    if (quantity <= 0) {
        ordersManager.showNotification('A quantidade deve ser maior que zero', 'error');
        return;
    }
    
    if (price < 0) {
        ordersManager.showNotification('O pre√ßo n√£o pode ser negativo', 'error');
        return;
    }
    
    try {
        const currentInstance = getInstanceData();
        if (!currentInstance) throw new Error('Inst√¢ncia n√£o encontrada');
        
        // Atualizar o item
        const { error: itemError } = await supabase
            .from('order_items')
            .update({
                quantity: quantity,
                price: price,
                notes: notes
            })
            .eq('id', currentEditingItem.id);
            
        if (itemError) throw itemError;
        
        // Salvar o ID do pedido antes de limpar as vari√°veis
        const orderId = currentEditingOrderId;
        
        // Recalcular totais do pedido
        await recalculateOrderTotals(orderId);
        
        // Atualizar pedido em tempo real (inclui modal se estiver aberto)
        await updateSingleOrderRealTime(orderId);
        
        ordersManager.showNotification('Item atualizado com sucesso!', 'success');
        closeEditItemModal();
        
    } catch (error) {
        ordersManager.showNotification('Erro ao atualizar item: ' + error.message, 'error');
    }
}

async function deleteOrderItem(itemId, orderId) {
    
    try {
        // Verifica√ß√µes iniciais
        if (!ordersManager || !ordersManager.orders) {
            if (ordersManager) ordersManager.showNotification('Sistema n√£o carregado. Recarregue a p√°gina.', 'error');
            return;
        }
        
        const order = ordersManager.orders.find(o => o.id === orderId);
        if (!order) {
            if (ordersManager) ordersManager.showNotification('Pedido n√£o encontrado.', 'error');
            return;
        }
        
        const item = order.order_items.find(i => i.id === itemId);
        if (!item) {
            if (ordersManager) ordersManager.showNotification('Item n√£o encontrado.', 'error');
            return;
        }
        
        // Verificar se √© o √∫ltimo item do pedido
        if (order.order_items.length <= 1) {
            if (ordersManager) ordersManager.showNotification('N√£o √© poss√≠vel excluir o √∫ltimo item do pedido. Exclua o pedido inteiro se necess√°rio.', 'warning');
            return;
        }
        
        // Primeira confirma√ß√£o
        const firstConfirmation = await showCustomConfirmation(`Tem certeza que deseja excluir "${item.product_name}" do pedido?`, 'Confirmar Exclus√£o');
        if (!firstConfirmation) {
            return;
        }
        
        // Segunda confirma√ß√£o com senha
        const confirmText = await showCustomPrompt('Digite "confirmar" para excluir o item:', 'Confirma√ß√£o de Seguran√ßa');
        if (!confirmText) {
            if (ordersManager) ordersManager.showNotification('Exclus√£o cancelada.', 'info');
            return;
        }
        
        if (confirmText.toLowerCase() !== 'confirmar') {
            if (ordersManager) ordersManager.showNotification('Digite exatamente "confirmar" para excluir o item.', 'warning');
            return;
        }
        
        // Verificar inst√¢ncia
        const currentInstance = getInstanceData();
        if (!currentInstance) {
            if (ordersManager) ordersManager.showNotification('Erro: Inst√¢ncia do restaurante n√£o encontrada.', 'error');
            return;
        }
        
        // Excluir o item do banco de dados
        const { error: itemError } = await supabase
            .from('order_items')
            .delete()
            .eq('id', itemId);
            
        if (itemError) {
            if (ordersManager) ordersManager.showNotification('Erro ao excluir item: ' + itemError.message, 'error');
            return;
        }
        
        // Recalcular totais do pedido
        await recalculateOrderTotals(orderId);
        
        // Atualizar pedido em tempo real (inclui modal se estiver aberto)
        await updateSingleOrderRealTime(orderId);
        
        if (ordersManager) ordersManager.showNotification('Item exclu√≠do com sucesso!', 'success');
        
    } catch (error) {
        if (ordersManager) ordersManager.showNotification('Erro inesperado: ' + error.message, 'error');
    }
}

async function recalculateOrderTotals(orderId) {
    
    try {
        if (!orderId || orderId === 'null' || orderId === 'undefined') {
            return;
        }
        
        // Buscar todos os itens do pedido
        const { data: items, error: itemsError } = await supabase
            .from('order_items')
            .select('quantity, price')
            .eq('order_id', orderId);
            
        if (itemsError) throw itemsError;
        
        // Calcular subtotal
        const subtotal = items.reduce((total, item) => {
            const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
            return total + itemTotal;
        }, 0);
        
        // Buscar taxa de entrega atual
        const { data: orderData, error: orderError } = await supabase
            .from('orders')
            .select('delivery_fee')
            .eq('id', orderId)
            .single();
            
        if (orderError) throw orderError;
        
        const deliveryFee = parseFloat(orderData.delivery_fee || 0);
        const total = subtotal + deliveryFee;
        
        // Atualizar pedido
        const { error: updateError } = await supabase
            .from('orders')
            .update({
                subtotal: subtotal,
                total: total
            })
            .eq('id', orderId);
            
        if (updateError) throw updateError;
        
    } catch (error) {
        throw error;
    }
}

// Fun√ß√£o para atualizar apenas um pedido espec√≠fico em tempo real
async function updateSingleOrderRealTime(orderId) {
    
    try {
        if (!ordersManager || !orderId || orderId === 'null' || orderId === 'undefined') {
            return;
        }
        
        // Buscar o pedido atualizado do banco (sem join problem√°tico)
        const { data: orderData, error: orderError } = await supabase
            .from('orders')
            .select('*')
            .eq('id', orderId)
            .single();
            
        if (orderError) throw orderError;
        
        // Buscar os itens do pedido separadamente
        const { data: itemsData, error: itemsError } = await supabase
            .from('order_items')
            .select('id, product_id, product_name, quantity, price, notes')
            .eq('order_id', orderId);
            
        if (itemsError) throw itemsError;
        
        // Combinar dados do pedido com seus itens
        orderData.order_items = itemsData || [];
        
        // Encontrar o pedido na lista local e atualizar
        const orderIndex = ordersManager.orders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
            ordersManager.orders[orderIndex] = orderData;
            
            // Atualizar apenas o card deste pedido na tela principal
            await updateOrderCardInDOM(orderData);
            
            // Se o modal de detalhes deste pedido estiver aberto, atualizar tamb√©m
            const modal = document.getElementById('orderDetailsModal');
            if (modal && modal.classList.contains('show')) {
                const modalContent = modal.querySelector('#orderDetailsBody');
                if (modalContent) {
                    // Recriar o conte√∫do do modal com os dados atualizados
                    await forceRefreshModalContent(orderData);
                } else {
                }
            } else {
            }
        } else {
        }
        
        
    } catch (error) {
    }
}

// Fun√ß√£o para for√ßar atualiza√ß√£o do conte√∫do do modal com dados frescos
async function forceRefreshModalContent(orderData) {
    
    try {
        const modal = document.getElementById('orderDetailsModal');
        if (!modal || !orderData) {
            return;
        }
        
        const modalContent = modal.querySelector('#orderDetailsBody');
        if (!modalContent) {
            return;
        }
        
        // Atualizar t√≠tulo do modal
        const modalTitle = modal.querySelector('#orderDetailsTitle');
        if (modalTitle) {
            modalTitle.textContent = `Pedido #${orderData.order_number}`;
        }
        
        // Gerar novo conte√∫do do modal usando exatamente o mesmo formato da fun√ß√£o showOrderDetails
        modalContent.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Dados do Cliente</h4>
                        <p><strong>Nome:</strong> ${orderData.customer_name || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${orderData.customer_phone || 'N/A'}</p>
                        <p><strong>Endere√ßo:</strong> ${orderData.delivery_address || 'N/A'}</p>
                        ${orderData.notes ? `<p><strong>Observa√ß√µes:</strong> ${orderData.notes}</p>` : ''}
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Informa√ß√µes do Pedido</h4>
                        <p><strong>Status:</strong> <span class="order-status-badge ${orderData.status}">${ordersManager.getStatusLabel(orderData.status)}</span></p>
                        <p><strong>Pagamento:</strong> ${ordersManager.getPaymentMethodLabel(orderData.payment_method)}</p>
                        <p><strong>Criado em:</strong> ${new Date(orderData.created_at).toLocaleString('pt-BR')}</p>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: var(--primary-color); margin: 0;">Itens do Pedido</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="openAddProductToOrderModal('${orderData.id}')" title="Adicionar Produto">
                                <i class="fas fa-plus"></i> Produto
                            </button>
                        </div>
                    </div>
                    <table class="items-table">
                        <thead>
                            <tr><th>Item</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody>
                            ${orderData.order_items.map(item => `
                                <tr>
                                    <td>
                                        <div class="item-name-cell">${item.product_name}</div>
                                        ${item.notes ? `<div class="item-notes-cell">${item.notes}</div>` : ''}
                                    </td>
                                    <td class="item-quantity-cell">${item.quantity}</td>
                                    <td class="item-price-cell">R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')}</td>
                                    <td class="item-total-cell">R$ ${(item.quantity * parseFloat(item.price)).toFixed(2).replace('.', ',')}</td>
                                    <td class="item-actions-cell">
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-warning btn-xs" onclick="openEditItemModal('${item.id}', '${orderData.id}')" title="Editar Item">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-xs" onclick="deleteOrderItem('${item.id}', '${orderData.id}')" title="Excluir Item">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="margin-top: 1rem; text-align: right;">
                        <p><strong>Subtotal:</strong> R$ ${parseFloat(orderData.subtotal || 0).toFixed(2).replace('.', ',')}</p>
                        <p><strong>Taxa de Entrega:</strong> R$ ${parseFloat(orderData.delivery_fee || 0).toFixed(2).replace('.', ',')}</p>
                        <p style="font-size: 1.2rem;"><strong>Total:</strong> R$ ${parseFloat(orderData.total || orderData.total_amount || 0).toFixed(2).replace('.', ',')}</p>
                        ${orderData.payment_method === 'money' && orderData.cash_received ? `
                            <p><strong>Dinheiro Recebido:</strong> R$ ${parseFloat(orderData.cash_received).toFixed(2).replace('.', ',')}</p>
                            <p style="color: var(--primary-color); font-weight: bold;">
                                <strong>Troco:</strong> R$ ${(parseFloat(orderData.cash_received) - parseFloat(orderData.total || 0)).toFixed(2).replace('.', ',')}
                            </p>
                        ` : ''}
                    </div>
                </div>
        `;
        
        
    } catch (error) {
    }
}

// Fun√ß√£o para atualizar o card de um pedido espec√≠fico no DOM
async function updateOrderCardInDOM(orderData) {
    try {
        // Simplesmente recarregar apenas a √°rea dos pedidos de forma mais eficiente
        if (ordersManager) {
            ordersManager.renderOrders();
        }
    } catch (error) {
    }
}

// Fun√ß√£o para atualizar o conte√∫do do modal sem fechar
async function refreshOrderDetailsModal(orderId) {
    try {
        if (!orderId || orderId === 'null' || orderId === 'undefined') {
            return;
        }
        
        const modal = document.getElementById('orderDetailsModal');
        if (!modal || !ordersManager) return;
        
        // Buscar o pedido atualizado diretamente do banco para garantir dados frescos
        const { data: orderData, error: orderError } = await supabase
            .from('orders')
            .select('*')
            .eq('id', orderId)
            .single();
            
        if (orderError) {
            return;
        }
        
        // Buscar os itens do pedido atualizados
        const { data: itemsData, error: itemsError } = await supabase
            .from('order_items')
            .select('id, product_id, product_name, quantity, price, notes')
            .eq('order_id', orderId);
            
        if (itemsError) {
            return;
        }
        
        // Combinar dados
        orderData.order_items = itemsData || [];
        
        // Atualizar tamb√©m a lista local
        const orderIndex = ordersManager.orders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
            ordersManager.orders[orderIndex] = orderData;
        }
        
        const order = orderData;
        
        // Atualizar o conte√∫do do modal mantendo ele aberto
        const modalContent = modal.querySelector('#orderDetailsContent');
        if (modalContent) {
            // Gerar novo conte√∫do do modal
            modalContent.innerHTML = `
                <div class="order-header-info">
                    <div class="order-info-grid">
                        <div class="order-info-item">
                            <strong>Pedido:</strong> #${order.order_number}
                        </div>
                        <div class="order-info-item">
                            <strong>Cliente:</strong> ${order.customer_name}
                        </div>
                        <div class="order-info-item">
                            <strong>Status:</strong> 
                            <span class="order-status status-${order.status}">${ordersManager.getStatusLabel(order.status)}</span>
                        </div>
                        <div class="order-info-item">
                            <strong>Total:</strong> R$ ${parseFloat(order.total || order.total_amount || 0).toFixed(2).replace('.', ',')}
                        </div>
                    </div>
                </div>
                
                <h4 style="margin: 1.5rem 0 1rem 0;">Itens do Pedido:</h4>
                <div class="order-items-list">
                    ${order.order_items.map(item => `
                        <div class="order-item-detail">
                            <div class="item-info">
                                <span class="item-name">${item.product_name}</span>
                                <span class="item-quantity">Qtd: ${item.quantity}</span>
                                <span class="item-price">R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')}</span>
                                ${item.notes ? `<span class="item-notes">Obs: ${item.notes}</span>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-xs btn-outline" onclick="openEditItemModal('${item.id}', '${order.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-xs btn-danger" onclick="deleteOrderItem('${item.id}', '${order.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="order-actions-section" style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="openAddProductToOrderModal('${order.id}')">
                        <i class="fas fa-plus"></i> Adicionar Produto
                    </button>
                    <button class="btn btn-secondary" onclick="openEditOrderModal('${order.id}')">
                        <i class="fas fa-edit"></i> Editar Pedido
                    </button>
                    <button class="btn btn-danger" onclick="openDeleteOrderModal('${order.id}')">
                        <i class="fas fa-trash"></i> Excluir Pedido
                    </button>
                </div>
            `;
        }
        
    } catch (error) {
    }
}

// ===== SISTEMA DE CONFIGURA√á√ÉO SEGURA =====
// Sistema seguro de backend usando APIs - mesmo sistema do login.html
async function fetchPublicConfig() {
    try {
        const currentHost = window.location.hostname;
        const currentPort = window.location.port;
        const currentProtocol = window.location.protocol;
        
        // Determinar URL base baseada no ambiente atual
        let baseUrl;
        if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
            // Desenvolvimento local
            baseUrl = `${currentProtocol}//${currentHost}:${currentPort || '5000'}`;
        } else if (currentHost === 'timepulseai.com.br' || currentHost === 'www.timepulseai.com.br') {
            // Produ√ß√£o - usar HTTPS sem especificar porta
            baseUrl = `https://${currentHost}`;
        } else if (currentHost.includes('replit')) {
            // Replit - usar a URL atual sem modifica√ß√£o
            baseUrl = `${currentProtocol}//${currentHost}${currentPort ? ':' + currentPort : ''}`;
        } else {
            // Outros ambientes
            baseUrl = `${currentProtocol}//${currentHost}${currentPort ? ':' + currentPort : ''}`;
        }
        
        const timestamp = Date.now();
        const configUrl = `${baseUrl}/api/config?t=${timestamp}`;
        
        // Buscar configura√ß√£o b√°sica do servidor
        const response = await fetch(configUrl, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro do servidor: ${response.status} - ${response.statusText}`);
        }
        
        const basicConfig = await response.json();
        
        // Buscar configura√ß√£o do Supabase
        const supabaseUrl = `${baseUrl}/api/config/supabase`;
        
        const supabaseResponse = await fetch(supabaseUrl, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!supabaseResponse.ok) {
            throw new Error(`Erro ao carregar configura√ß√£o do Supabase: ${supabaseResponse.status}`);
        }
        
        const supabaseConfig = await supabaseResponse.json();
        
        // Buscar configura√ß√£o do Evolution API com retry e fallback
        let evolutionConfig = {};
        try {
            const evolutionResponse = await fetch(`${baseUrl}/api/config/evolution?t=${timestamp}`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate'
                }
            });
            
            if (evolutionResponse.ok) {
                evolutionConfig = await evolutionResponse.json();
                console.log('‚úÖ Configura√ß√£o Evolution carregada com sucesso:', {
                    status: evolutionConfig.status,
                    configured: evolutionConfig.configured,
                    serverUrl: evolutionConfig.serverUrl,
                    hasApiKey: !!evolutionConfig.apiKey,
                    apiKeyLength: evolutionConfig.apiKey?.length || 0
                });
                
                // Valida√ß√£o adicional - API key fica protegida no servidor
                if (!evolutionConfig.serverUrl) {
                    console.warn('‚ö†Ô∏è  Configura√ß√£o Evolution incompleta - serverUrl ausente');
                }
            } else {
                const errorText = await evolutionResponse.text().catch(() => 'Erro desconhecido');
                console.error('‚ùå Erro ao carregar configura√ß√£o Evolution:', {
                    status: evolutionResponse.status,
                    statusText: evolutionResponse.statusText,
                    error: errorText
                });
            }
        } catch (evolutionError) {
            console.error('‚ùå Erro de conex√£o Evolution API:', evolutionError);
        }
        
        // Buscar configura√ß√£o do Mapbox
        const mapboxResponse = await fetch(`${baseUrl}/api/config/mapbox?t=${timestamp}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        
        const mapboxConfig = mapboxResponse.ok ? await mapboxResponse.json() : {};
        
        // Buscar configura√ß√£o do OpenAI
        const openaiResponse = await fetch(`${baseUrl}/api/config/openai?t=${timestamp}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        
        const openaiConfig = openaiResponse.ok ? await openaiResponse.json() : {};
        
        // Office Integrator removido
        
        const finalConfig = {
            ...basicConfig,
            // Supabase
            supabaseUrl: supabaseConfig.supabaseUrl || supabaseConfig.url,
            supabaseAnonKey: supabaseConfig.supabaseAnonKey || supabaseConfig.anon_key,
            // Evolution API
            evolution: {
                serverUrl: evolutionConfig.serverUrl,
                apiKey: evolutionConfig.apiKey,
                instance: evolutionConfig.instance
            },
            // Mapbox
            mapbox: {
                accessToken: mapboxConfig.accessToken,
                publicKey: mapboxConfig.publicKey
            },
            // OpenAI
            openai: {
                baseUrl: openaiConfig.baseUrl,
                model: openaiConfig.model
            },
            // Office Integrator removido
        };
        
        Logger.success('CONFIG', 'Todas as configura√ß√µes carregadas', {
            supabase: !!finalConfig.supabaseUrl,
            evolution: !!finalConfig.evolution?.serverUrl,
            mapbox: !!finalConfig.mapbox?.accessToken,
            openai: !!finalConfig.openai?.baseUrl,
            office: !!finalConfig.office?.baseUrl,
            totalEndpoints: 6,
            configuredEndpoints: [
                finalConfig.supabaseUrl && 'supabase',
                finalConfig.evolution?.serverUrl && 'evolution',
                finalConfig.mapbox?.accessToken && 'mapbox',
                finalConfig.openai?.baseUrl && 'openai',
                finalConfig.office?.baseUrl && 'office'
            ].filter(Boolean).length
        });
        return finalConfig;
        
    } catch (error) {
        Logger.error('CONFIG', 'Erro no carregamento de configura√ß√µes do servidor', error, {
            url: window.location.href,
            userAgent: navigator.userAgent.substring(0, 100)
        });
        throw new Error('Erro ao carregar configura√ß√µes do servidor. Verifique sua conex√£o e recarregue a p√°gina.');
    }
}

</script>

<script>
// Fun√ß√£o para controlar o menu mobile
function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

// Fechar menu ao clicar em um link (em mobile)
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('.nav-link');
    
    navLinks.forEach(link => {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
        });
    });
});
</script>
</body>
</html>
