================================================================================
           DOCUMENTAÃ‡ÃƒO COMPLETA - MODAL "NOVO PEDIDO - DELIVERY"
                        TimePulse AI - Sistema de GestÃ£o
================================================================================

ğŸ“‹ ÃNDICE
1. VisÃ£o Geral
2. Estrutura do Modal
3. Campos do FormulÃ¡rio
4. FunÃ§Ãµes JavaScript
5. Fluxo de CriaÃ§Ã£o de Pedido
6. ValidaÃ§Ãµes e Regras de NegÃ³cio
7. IntegraÃ§Ãµes e APIs
8. Troubleshooting

================================================================================
1. VISÃƒO GERAL
================================================================================

O modal "Novo Pedido - Delivery" Ã© responsÃ¡vel por criar pedidos de entrega
no sistema TimePulse AI. Ele integra:
- Dados do cliente
- EndereÃ§o completo com CEP
- Busca e seleÃ§Ã£o de produtos
- CÃ¡lculo automÃ¡tico de taxa de entrega via Mapbox
- CÃ¡lculo de troco para pagamento em dinheiro
- ValidaÃ§Ã£o completa de campos obrigatÃ³rios

LOCALIZAÃ‡ÃƒO: public/gestao_pedidos.html (linhas 1680-1875)
ID DO MODAL: deliveryOrderModal
CLASSE CSS: modal delivery-modal

================================================================================
2. ESTRUTURA DO MODAL
================================================================================

COMPONENTES PRINCIPAIS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CABEÃ‡ALHO                                                   â”‚
â”‚ - TÃ­tulo: "Novo Pedido - Delivery"                        â”‚
â”‚ - Ãcone: <i class="fas fa-motorcycle"></i>                â”‚
â”‚ - BotÃ£o fechar: closeDeliveryOrderModal()                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CORPO DO FORMULÃRIO (deliveryOrderForm)                    â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€ SEÃ‡ÃƒO 1: DADOS DO CLIENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ - Telefone* (deliveryCustomerPhone)                 â”‚  â”‚
â”‚ â”‚ - Nome do Cliente* (deliveryCustomerName)           â”‚  â”‚
â”‚ â”‚ - CEP (deliveryCep) + autocomplete                  â”‚  â”‚
â”‚ â”‚ - Rua (deliveryRua)                                 â”‚  â”‚
â”‚ â”‚ - NÃºmero (deliveryNumber)                           â”‚  â”‚
â”‚ â”‚ - Complemento (deliveryComplement)                  â”‚  â”‚
â”‚ â”‚ - Bairro (deliveryBairro) - DESTACADO              â”‚  â”‚
â”‚ â”‚ - Cidade (deliveryCidade) - readonly                â”‚  â”‚
â”‚ â”‚ - UF (deliveryUf) - readonly                        â”‚  â”‚
â”‚ â”‚ - EndereÃ§o completo (deliveryAddress) - hidden      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€ SEÃ‡ÃƒO 2: ITENS DO PEDIDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ - BotÃ£o: Adicionar Item                             â”‚  â”‚
â”‚ â”‚ - Campo busca: deliveryProductSearch                â”‚  â”‚
â”‚ â”‚ - Resultados: deliverySearchResults                 â”‚  â”‚
â”‚ â”‚ - Tabela de itens: deliveryItemsTableBody           â”‚  â”‚
â”‚ â”‚   Colunas: Item | Qtd | PreÃ§o | Total | AÃ§Ãµes      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€ SEÃ‡ÃƒO 3: CÃLCULO DE ENTREGA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ - Checkbox: Incluir retorno (ida e volta)           â”‚  â”‚
â”‚ â”‚ - MÃ©tricas (calculadas automaticamente):            â”‚  â”‚
â”‚ â”‚   * DistÃ¢ncia (km)                                  â”‚  â”‚
â”‚ â”‚   * Tempo Estimado (min)                            â”‚  â”‚
â”‚ â”‚   * Taxa de Entrega (R$)                            â”‚  â”‚
â”‚ â”‚ - Input manual: deliveryFee                         â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€ SEÃ‡ÃƒO 4: FORMA DE PAGAMENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ - Select: deliveryPaymentMethod*                    â”‚  â”‚
â”‚ â”‚   OpÃ§Ãµes: Dinheiro | CartÃ£o | PIX | Vale            â”‚  â”‚
â”‚ â”‚ - Se Dinheiro (deliveryChangeFields):               â”‚  â”‚
â”‚ â”‚   * Cliente paga: deliveryChangeForAmount           â”‚  â”‚
â”‚ â”‚   * Troco: deliveryChangeAmount (readonly)          â”‚  â”‚
â”‚ â”‚   * ExibiÃ§Ã£o troco: deliveryChangeDisplay           â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€ SEÃ‡ÃƒO 5: TOTAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ - Subtotal: deliverySubtotalDisplay                 â”‚  â”‚
â”‚ â”‚ - Taxa de Entrega: deliveryFeeDisplayTotal          â”‚  â”‚
â”‚ â”‚ - Total: deliveryTotalDisplay                       â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€ SEÃ‡ÃƒO 6: OBSERVAÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ - Textarea: deliveryOrderNotes                      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RODAPÃ‰                                                      â”‚
â”‚ - BotÃ£o Cancelar: closeDeliveryOrderModal()                â”‚
â”‚ - BotÃ£o Criar Pedido: submitDeliveryOrder()                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

* Campos obrigatÃ³rios

================================================================================
3. CAMPOS DO FORMULÃRIO
================================================================================

3.1 DADOS DO CLIENTE
---------------------
Campo: deliveryCustomerPhone
- Tipo: tel
- ID: deliveryCustomerPhone
- ObrigatÃ³rio: SIM
- Placeholder: "(11) 99999-9999"
- ValidaÃ§Ã£o: Campo nÃ£o pode estar vazio

Campo: deliveryCustomerName
- Tipo: text
- ID: deliveryCustomerName
- ObrigatÃ³rio: SIM
- Placeholder: "Nome completo"
- ValidaÃ§Ã£o: Campo nÃ£o pode estar vazio

3.2 ENDEREÃ‡O
-------------
Campo: deliveryCep
- Tipo: text
- ID: deliveryCep
- ObrigatÃ³rio: NÃƒO (mas recomendado)
- Maxlength: 8
- Placeholder: "11065001"
- Evento onblur: pesquisacep(this.value, 'delivery')
- FunÃ§Ã£o: Autocomplete via API ViaCEP

Campo: deliveryRua
- Tipo: text
- ID: deliveryRua
- Preenchido por: CEP autocomplete ou manual
- Placeholder: "Rua/Avenida"

Campo: deliveryNumber
- Tipo: text
- ID: deliveryNumber
- Placeholder: "551"

Campo: deliveryComplement
- Tipo: text
- ID: deliveryComplement
- Placeholder: "Apto, Casa, etc."

Campo: deliveryBairro
- Tipo: text
- ID: deliveryBairro
- Classe especial: highlighted-field
- Placeholder: "Bairro"
- ImportÃ¢ncia: Campo destacado visualmente

Campo: deliveryCidade
- Tipo: text
- ID: deliveryCidade
- Readonly: true
- Placeholder: "Santos"
- Preenchido por: CEP autocomplete

Campo: deliveryUf
- Tipo: text
- ID: deliveryUf
- Readonly: true
- Maxlength: 2
- Placeholder: "SP"
- Preenchido por: CEP autocomplete

Campo: deliveryAddress (OCULTO)
- Tipo: hidden
- ID: deliveryAddress
- FunÃ§Ã£o: Armazena endereÃ§o completo formatado
- Formato: "Rua, NÃºmero, Complemento, Bairro, Cidade - UF"

3.3 ITENS DO PEDIDO
--------------------
Campo: deliveryProductSearch
- Tipo: text
- ID: deliveryProductSearch
- Placeholder: "Buscar produto (nome ou cÃ³digo)..."
- Evento oninput: ordersManager.performProductSearch(this.value.trim(), 'delivery')
- FunÃ§Ã£o: Busca produtos em tempo real

Tabela: deliveryItemsTableBody
- ID: deliveryItemsTableBody
- Colunas:
  1. Item (nome do produto)
  2. Qtd (quantidade editÃ¡vel)
  3. PreÃ§o (preÃ§o unitÃ¡rio editÃ¡vel)
  4. Total (calculado automaticamente)
  5. AÃ§Ãµes (editar notas, remover item)

3.4 CÃLCULO DE ENTREGA
-----------------------
Campo: deliveryIncludeRoundtrip
- Tipo: checkbox
- ID: deliveryIncludeRoundtrip
- Label: "Incluir retorno (ida e volta)"
- FunÃ§Ã£o: Altera cÃ¡lculo da taxa de entrega

Display de MÃ©tricas (somente leitura):
- DistÃ¢ncia: Calculada via Mapbox Directions API
- Tempo Estimado: Calculado via Mapbox Directions API
- Taxa de Entrega: Calculada com base na distÃ¢ncia

Campo: deliveryFee
- Tipo: number
- ID: deliveryFee
- Step: 0.01
- Min: 0
- Valor padrÃ£o: 8.00
- FunÃ§Ã£o: Permite ajuste manual da taxa

3.5 FORMA DE PAGAMENTO
-----------------------
Campo: deliveryPaymentMethod
- Tipo: select
- ID: deliveryPaymentMethod
- ObrigatÃ³rio: SIM
- Evento onchange: toggleDeliveryChangeFields()
- OpÃ§Ãµes:
  * "" - Selecione...
  * "money" - Dinheiro
  * "card" - CartÃ£o
  * "pix" - PIX
  * "voucher" - Vale

Campos de Troco (visÃ­vel apenas se pagamento = "money"):
Container: deliveryChangeFields

Campo: deliveryChangeForAmount
- Tipo: number
- ID: deliveryChangeForAmount
- Step: 0.01
- Placeholder: "0,00"
- Evento oninput: calculateDeliveryChange()
- Label: "Cliente paga:"

Campo: deliveryChangeAmount
- Tipo: number
- ID: deliveryChangeAmount
- Step: 0.01
- Placeholder: "0,00"
- Readonly: true
- Label: "Troco:"
- FunÃ§Ã£o: Exibe troco calculado

Display: deliveryChangeDisplay
- ID: deliveryChangeDisplay
- Container: deliveryChangeCalculation
- Formato: "Troco: R$ X,XX"
- VisÃ­vel apenas se troco > 0

3.6 TOTAIS
-----------
Display: deliverySubtotalDisplay
- ID: deliverySubtotalDisplay
- Formato: "R$ X,XX"
- CÃ¡lculo: Soma de (quantidade Ã— preÃ§o) de todos os itens

Display: deliveryFeeDisplayTotal
- ID: deliveryFeeDisplayTotal
- Formato: "R$ X,XX"
- Valor: CÃ³pia de deliveryFee

Display: deliveryTotalDisplay
- ID: deliveryTotalDisplay
- Formato: "R$ X,XX"
- CÃ¡lculo: Subtotal + Taxa de Entrega

Campos hidden:
- deliverySubtotal: Armazena subtotal numÃ©rico
- deliveryTotal: Armazena total numÃ©rico

3.7 OBSERVAÃ‡Ã•ES
----------------
Campo: deliveryOrderNotes
- Tipo: textarea
- ID: deliveryOrderNotes
- Rows: 2
- Placeholder: "ObservaÃ§Ãµes especiais"
- Opcional

================================================================================
4. FUNÃ‡Ã•ES JAVASCRIPT
================================================================================

4.1 ABERTURA E FECHAMENTO DO MODAL
-----------------------------------

openDeliveryOrderModal()
- Linha: 5495
- FunÃ§Ã£o: Abre o modal de delivery
- AÃ§Ãµes:
  1. Exibe modal (adiciona classe 'show')
  2. Reseta formulÃ¡rio deliveryOrderForm
  3. Limpa itens do pedido via ordersManager

CÃ³digo:
```javascript
function openDeliveryOrderModal() {
    const modal = document.getElementById('deliveryOrderModal');
    if (modal) {
        const form = document.getElementById('deliveryOrderForm');
        if (form) form.reset();
        if (ordersManager) ordersManager.newOrderItems = [];
        if (ordersManager) ordersManager.renderNewOrderItems('delivery');
        modal.classList.add('show');
    }
}
```

closeDeliveryOrderModal()
- Linha: 5508
- FunÃ§Ã£o: Fecha o modal de delivery
- AÃ§Ãµes:
  1. Remove classe 'show' do modal
  2. Reseta formulÃ¡rio
  3. Limpa itens do pedido

CÃ³digo:
```javascript
function closeDeliveryOrderModal() {
    const modal = document.getElementById('deliveryOrderModal');
    if (modal) {
        modal.classList.remove('show');
        const form = document.getElementById('deliveryOrderForm');
        if (form) form.reset();
        if (ordersManager) ordersManager.newOrderItems = [];
    }
}
```

4.2 AUTOCOMPLETE DE CEP
------------------------

pesquisacep(valor, context)
- Linha: 3102
- ParÃ¢metros:
  * valor: CEP informado (com ou sem hÃ­fen)
  * context: 'delivery' (identifica qual formulÃ¡rio)
- FunÃ§Ã£o: Busca endereÃ§o via API ViaCEP
- ValidaÃ§Ã£o: Regex /^[0-9]{5}-?[0-9]{3}$/

Fluxo:
1. Remove caracteres nÃ£o numÃ©ricos do CEP
2. Valida formato com regex
3. Cria script tag dinÃ¢mico apontando para ViaCEP
4. ViaCEP retorna dados via callback JSONP
5. Chama meu_callback(conteudo)

meu_callback(conteudo)
- Linha: 3121
- ParÃ¢metro: conteudo (objeto retornado pelo ViaCEP)
- FunÃ§Ã£o: Preenche campos de endereÃ§o
- Campos preenchidos (context = 'delivery'):
  * deliveryRua â† conteudo.logradouro
  * deliveryBairro â† conteudo.bairro
  * deliveryCidade â† conteudo.localidade
  * deliveryUf â† conteudo.uf
  * deliveryAddress â† endereÃ§o formatado completo

CÃ³digo relevante:
```javascript
if (context === 'delivery') {
    document.getElementById('deliveryRua').value = (conteudo.logradouro);
    document.getElementById('deliveryBairro').value = (conteudo.bairro);
    document.getElementById('deliveryCidade').value = (conteudo.localidade);
    document.getElementById('deliveryUf').value = (conteudo.uf);
    document.getElementById('deliveryAddress').value = 
        `${conteudo.logradouro}, ${deliveryNumber}, ${deliveryComplement}, ${conteudo.bairro}, ${conteudo.localidade} - ${conteudo.uf}`;
}
```

4.3 CÃLCULO DE ROTA E TAXA DE ENTREGA
---------------------------------------

calculateDeliveryRoute()
- Linha: 3007
- FunÃ§Ã£o: Calcula distÃ¢ncia, tempo e taxa de entrega
- IntegraÃ§Ã£o: Mapbox Geocoding API + Directions API
- Gatilho: AlteraÃ§Ã£o no endereÃ§o ou checkbox de retorno

Fluxo completo:
1. Captura endereÃ§o de entrega (deliveryAddress)
2. Captura estado do checkbox (deliveryIncludeRoundtrip)
3. Valida endereÃ§o e coordenadas do restaurante
4. Exibe "Calculando rota..." nos displays
5. Chama geocodeAddress(deliveryAddress) para obter coordenadas
6. Chama calculateRouteDistance() para calcular rota
7. Chama calculateDeliveryFee() para calcular taxa
8. Atualiza displays com resultados
9. Trata erros exibindo mensagem

geocodeAddress(address)
- Linha: 2907 (aproximado)
- ParÃ¢metro: address (string)
- Retorno: { longitude, latitude, formatted_address }
- API: Mapbox Geocoding API v5
- URL: https://api.mapbox.com/geocoding/v5/mapbox.places/{address}.json

CÃ³digo:
```javascript
const encodedAddress = encodeURIComponent(address);
const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodedAddress}.json?access_token=${accessToken}&country=br&limit=1`;

const response = await fetch(url);
const data = await response.json();

if (data.features && data.features.length > 0) {
    const coordinates = data.features[0].center;
    return {
        longitude: coordinates[0],
        latitude: coordinates[1],
        formatted_address: data.features[0].place_name
    };
}
```

calculateRouteDistance(restaurantCoords, deliveryCoords, includeRoundtrip)
- Linha: 2938
- ParÃ¢metros:
  * restaurantCoords: { longitude, latitude }
  * deliveryCoords: { longitude, latitude }
  * includeRoundtrip: boolean
- Retorno: { distance, duration, geometry }
- API: Mapbox Directions API v5
- Modo: driving-traffic

LÃ³gica:
- Se includeRoundtrip = true:
  coordinates = "resto_lng,resto_lat;entrega_lng,entrega_lat;resto_lng,resto_lat"
- Se includeRoundtrip = false:
  coordinates = "resto_lng,resto_lat;entrega_lng,entrega_lat"

URL exemplo:
https://api.mapbox.com/directions/v5/mapbox/driving-traffic/{coordinates}?access_token={token}&geometries=geojson&overview=simplified

ConversÃµes:
- distance: route.distance / 1000 (metros â†’ km)
- duration: route.duration / 60 (segundos â†’ minutos)

calculateDeliveryFee(distance, includeRoundtrip)
- Linha: 2981
- ParÃ¢metros:
  * distance: distÃ¢ncia em km
  * includeRoundtrip: boolean
- Retorno: { totalFee }
- ConfiguraÃ§Ãµes do restaurante:
  * minimumDistanceKm: 3.0 (padrÃ£o)
  * minimumDeliveryFee: 8.00 (padrÃ£o)
  * deliveryFeePerKm: 0.50 (padrÃ£o)
  * deliveryReturnPerKm: 0.12 (padrÃ£o)

REGRAS DE CÃLCULO:

A) SEM RETORNO (includeRoundtrip = false):
   totalFee = minimumDeliveryFee
   
   SE distance > minimumDistanceKm:
      extraDistance = distance - minimumDistanceKm
      totalFee += extraDistance * deliveryFeePerKm

   Exemplo: distÃ¢ncia 5km
   - AtÃ© 3km: R$ 8,00
   - Extra 2km: 2 Ã— R$ 0,50 = R$ 1,00
   - Total: R$ 9,00

B) COM RETORNO (includeRoundtrip = true):
   oneWayDistance = distance / 2
   
   outboundCost = minimumDeliveryFee
   SE oneWayDistance > minimumDistanceKm:
      extraDistance = oneWayDistance - minimumDistanceKm
      outboundCost += extraDistance * deliveryFeePerKm
   
   returnCost = oneWayDistance * deliveryReturnPerKm
   totalFee = outboundCost + returnCost

   Exemplo: distÃ¢ncia total 10km (5km ida + 5km volta)
   - Ida atÃ© 3km: R$ 8,00
   - Ida extra 2km: 2 Ã— R$ 0,50 = R$ 1,00
   - Retorno 5km: 5 Ã— R$ 0,12 = R$ 0,60
   - Total: R$ 9,60

4.4 GERENCIAMENTO DE ITENS
---------------------------

FunÃ§Ãµes disponÃ­veis (Linha 5787-5790):

updateDeliveryOrderItemQuantity(index, quantity)
- Atualiza quantidade de um item
- Chama: ordersManager.updateNewOrderItemQuantity(index, quantity, 'delivery')

updateDeliveryOrderItemPrice(index, price)
- Atualiza preÃ§o unitÃ¡rio de um item
- Chama: ordersManager.updateNewOrderItemPrice(index, price, 'delivery')

editDeliveryOrderItemNotes(index)
- Abre modal para editar observaÃ§Ãµes do item
- Chama: ordersManager.editNewOrderItemNotes(index, 'delivery')

removeDeliveryOrderItem(index)
- Remove item da lista
- Chama: ordersManager.removeNewOrderItem(index, 'delivery')

Busca de produtos:
- Campo: deliveryProductSearch
- Evento: oninput
- FunÃ§Ã£o: ordersManager.performProductSearch(value.trim(), 'delivery')
- Resultados exibidos em: deliverySearchResults

4.5 CÃLCULO DE TROCO
---------------------

toggleDeliveryChangeFields()
- Linha: 5978
- Gatilho: onChange do select deliveryPaymentMethod
- FunÃ§Ã£o: Exibe/oculta campos de troco

CÃ³digo:
```javascript
function toggleDeliveryChangeFields() {
    document.getElementById('deliveryChangeFields').style.display = 
        document.getElementById('deliveryPaymentMethod').value === 'money' 
        ? 'block' : 'none';
}
```

calculateDeliveryChange()
- Linha: 5984
- Gatilho: oninput do campo deliveryChangeForAmount
- FunÃ§Ã£o: Calcula e exibe troco

Fluxo:
1. Captura total do pedido (deliveryTotal.value)
2. Captura valor pago pelo cliente (deliveryChangeForAmount.value)
3. Chama calculateChange(total, changeFor)
4. Atualiza deliveryChangeAmount (campo readonly)
5. Atualiza deliveryChangeDisplay (texto formatado)
6. Exibe/oculta deliveryChangeCalculation conforme troco > 0

CÃ³digo:
```javascript
function calculateDeliveryChange() {
    const total = parseFloat(document.getElementById('deliveryTotal').value);
    const changeFor = parseFloat(document.getElementById('deliveryChangeForAmount').value);
    const change = calculateChange(total, changeFor);
    
    document.getElementById('deliveryChangeAmount').value = change;
    document.getElementById('deliveryChangeDisplay').textContent = change.replace('.', ',');
    document.getElementById('deliveryChangeCalculation').style.display = 
        change > 0 ? 'block' : 'none';
}
```

calculateChange(total, changeFor)
- FunÃ§Ã£o utilitÃ¡ria (definida em outro local)
- CÃ¡lculo: changeFor - total
- Retorno: string formatada com 2 casas decimais

4.6 SUBMISSÃƒO DO PEDIDO
------------------------

submitDeliveryOrder()
- Linha: 5638
- FunÃ§Ã£o: Valida e envia pedido para o servidor
- AssÃ­ncrona: async function

FLUXO COMPLETO:

1. CAPTURA DE DADOS:
```javascript
const customerName = document.getElementById('deliveryCustomerName')?.value.trim();
const customerPhone = document.getElementById('deliveryCustomerPhone')?.value.trim();
const rua = document.getElementById('deliveryRua')?.value.trim();
const numero = document.getElementById('deliveryNumber')?.value.trim();
const complemento = document.getElementById('deliveryComplement')?.value.trim();
const bairro = document.getElementById('deliveryBairro')?.value.trim();
const cidade = document.getElementById('deliveryCidade')?.value.trim();
const uf = document.getElementById('deliveryUf')?.value.trim();
const zipCode = document.getElementById('deliveryCep')?.value.trim();
const paymentMethod = document.getElementById('deliveryPaymentMethod')?.value;
const deliveryFee = parseFloat(document.getElementById('deliveryFee')?.value) || 0;
const notes = document.getElementById('deliveryOrderNotes')?.value.trim();
```

2. FORMATAÃ‡ÃƒO DO ENDEREÃ‡O:
```javascript
let deliveryAddress = '';
if (rua) {
    deliveryAddress = rua;
    if (numero) deliveryAddress += `, ${numero}`;
    if (complemento) deliveryAddress += `, ${complemento}`;
    if (bairro) deliveryAddress += `, ${bairro}`;
    if (cidade) deliveryAddress += `, ${cidade}`;
    if (uf) deliveryAddress += ` - ${uf}`;
} else {
    deliveryAddress = document.getElementById('deliveryAddress')?.value.trim();
}
```

3. VALIDAÃ‡ÃƒO DE CAMPOS OBRIGATÃ“RIOS:
```javascript
const missingFields = [];
if (!customerName) missingFields.push('Nome do Cliente');
if (!customerPhone) missingFields.push('Telefone');
if (!deliveryAddress) missingFields.push('EndereÃ§o de Entrega');
if (!paymentMethod) missingFields.push('Forma de Pagamento');

if (missingFields.length > 0) {
    const message = `Preencha os campos obrigatÃ³rios: ${missingFields.join(', ')}`;
    ordersManager.showNotification(message, 'warning');
    return;
}
```

4. VALIDAÃ‡ÃƒO DE ITENS:
```javascript
if (ordersManager.newOrderItems.length === 0) {
    ordersManager.showNotification('Adicione pelo menos um item ao pedido', 'warning');
    return;
}
```

5. CÃLCULO DE TOTAIS:
```javascript
const subtotal = ordersManager.newOrderItems.reduce(
    (sum, item) => sum + (item.quantity * item.price), 0
);
const totalAmount = subtotal + deliveryFee;
```

6. CAPTURA DE TROCO (se pagamento em dinheiro):
```javascript
const cashReceived = paymentMethod === 'money' 
    ? parseFloat(document.getElementById('deliveryChangeForAmount')?.value) || 0 
    : null;
```

7. MONTAGEM DO OBJETO orderData:
```javascript
const orderData = {
    customer_name: customerName,
    customer_phone: customerPhone,
    delivery_address: deliveryAddress,
    zip_code: zipCode,
    delivery_fee: deliveryFee,
    payment_method: paymentMethod,
    notes: notes,
    subtotal: subtotal,
    total_amount: totalAmount,
    cash_received: cashReceived,
    items: [...ordersManager.newOrderItems]
};
```

8. ENVIO PARA O SERVIDOR:
```javascript
await ordersManager.saveOrder(orderData);
```

9. FECHAMENTO DO MODAL:
```javascript
closeDeliveryOrderModal();
```

ESTRUTURA DO orderData ENVIADO:
{
    customer_name: string (obrigatÃ³rio),
    customer_phone: string (obrigatÃ³rio),
    delivery_address: string (obrigatÃ³rio),
    zip_code: string (opcional),
    delivery_fee: number,
    payment_method: string (obrigatÃ³rio - 'money'|'card'|'pix'|'voucher'),
    notes: string (opcional),
    subtotal: number,
    total_amount: number,
    cash_received: number|null (apenas se money),
    items: [
        {
            product_name: string,
            quantity: number,
            price: number,
            notes: string (opcional)
        }
    ]
}

================================================================================
5. FLUXO DE CRIAÃ‡ÃƒO DE PEDIDO
================================================================================

DIAGRAMA DE FLUXO:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ABERTURA DO MODAL                                        â”‚
â”‚    - UsuÃ¡rio clica "Novo Pedido" â†’ "Delivery"              â”‚
â”‚    - openDeliveryOrderModal() Ã© chamada                     â”‚
â”‚    - FormulÃ¡rio Ã© resetado                                  â”‚
â”‚    - Lista de itens Ã© limpa                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. PREENCHIMENTO DE DADOS DO CLIENTE                        â”‚
â”‚    - UsuÃ¡rio digita telefone (obrigatÃ³rio)                  â”‚
â”‚    - UsuÃ¡rio digita nome (obrigatÃ³rio)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PREENCHIMENTO DE ENDEREÃ‡O                                â”‚
â”‚    OPÃ‡ÃƒO A - Com CEP:                                       â”‚
â”‚      - UsuÃ¡rio digita CEP                                   â”‚
â”‚      - onblur dispara pesquisacep()                         â”‚
â”‚      - ViaCEP retorna dados                                 â”‚
â”‚      - meu_callback() preenche campos automaticamente       â”‚
â”‚      - UsuÃ¡rio completa nÃºmero e complemento                â”‚
â”‚                                                             â”‚
â”‚    OPÃ‡ÃƒO B - Manual:                                        â”‚
â”‚      - UsuÃ¡rio preenche todos os campos manualmente         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ADIÃ‡ÃƒO DE ITENS                                          â”‚
â”‚    OPÃ‡ÃƒO A - Busca rÃ¡pida:                                  â”‚
â”‚      - UsuÃ¡rio digita no campo deliveryProductSearch        â”‚
â”‚      - oninput dispara performProductSearch()               â”‚
â”‚      - Resultados aparecem em tempo real                    â”‚
â”‚      - UsuÃ¡rio clica no produto desejado                    â”‚
â”‚                                                             â”‚
â”‚    OPÃ‡ÃƒO B - Modal de seleÃ§Ã£o:                              â”‚
â”‚      - UsuÃ¡rio clica "Adicionar Item"                       â”‚
â”‚      - openProductSelectionModal('delivery') Ã© chamada      â”‚
â”‚      - Produtos organizados por categoria                   â”‚
â”‚      - UsuÃ¡rio seleciona produto                            â”‚
â”‚                                                             â”‚
â”‚    â†’ Item Ã© adicionado Ã  tabela deliveryItemsTableBody      â”‚
â”‚    â†’ Subtotal Ã© atualizado automaticamente                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CÃLCULO DE ENTREGA                                       â”‚
â”‚    - Sistema monta endereÃ§o completo                        â”‚
â”‚    - calculateDeliveryRoute() Ã© disparado                   â”‚
â”‚    - geocodeAddress() obtÃ©m coordenadas                     â”‚
â”‚    - calculateRouteDistance() calcula rota via Mapbox       â”‚
â”‚    - calculateDeliveryFee() calcula taxa                    â”‚
â”‚    - Displays sÃ£o atualizados:                              â”‚
â”‚      * DistÃ¢ncia: X,X km                                    â”‚
â”‚      * Tempo: X min                                         â”‚
â”‚      * Taxa: R$ X,XX                                        â”‚
â”‚    - UsuÃ¡rio pode ajustar taxa manualmente                  â”‚
â”‚    - Se marcar "Incluir retorno", recalcula                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. SELEÃ‡ÃƒO DE FORMA DE PAGAMENTO                            â”‚
â”‚    - UsuÃ¡rio seleciona no select deliveryPaymentMethod      â”‚
â”‚    - onChange dispara toggleDeliveryChangeFields()          â”‚
â”‚                                                             â”‚
â”‚    SE paymentMethod == 'money':                             â”‚
â”‚      - deliveryChangeFields torna-se visÃ­vel                â”‚
â”‚      - UsuÃ¡rio informa valor que cliente pagarÃ¡             â”‚
â”‚      - oninput dispara calculateDeliveryChange()            â”‚
â”‚      - Troco Ã© calculado e exibido automaticamente          â”‚
â”‚                                                             â”‚
â”‚    SENÃƒO:                                                   â”‚
â”‚      - deliveryChangeFields permanece oculto                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. REVISÃƒO E OBSERVAÃ‡Ã•ES                                    â”‚
â”‚    - UsuÃ¡rio revisa:                                        â”‚
â”‚      * Subtotal calculado                                   â”‚
â”‚      * Taxa de entrega                                      â”‚
â”‚      * Total do pedido                                      â”‚
â”‚    - UsuÃ¡rio adiciona observaÃ§Ãµes (opcional)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. SUBMISSÃƒO DO PEDIDO                                      â”‚
â”‚    - UsuÃ¡rio clica "Criar Pedido"                           â”‚
â”‚    - submitDeliveryOrder() Ã© chamada                        â”‚
â”‚                                                             â”‚
â”‚    ValidaÃ§Ãµes:                                              â”‚
â”‚    âœ“ Nome do Cliente estÃ¡ preenchido?                       â”‚
â”‚    âœ“ Telefone estÃ¡ preenchido?                              â”‚
â”‚    âœ“ EndereÃ§o estÃ¡ preenchido?                              â”‚
â”‚    âœ“ Forma de pagamento estÃ¡ selecionada?                   â”‚
â”‚    âœ“ HÃ¡ pelo menos 1 item no pedido?                        â”‚
â”‚                                                             â”‚
â”‚    SE todas validaÃ§Ãµes OK:                                  â”‚
â”‚      - orderData Ã© montado                                  â”‚
â”‚      - await ordersManager.saveOrder(orderData)             â”‚
â”‚      - Pedido Ã© salvo no Supabase                           â”‚
â”‚      - Modal Ã© fechado                                      â”‚
â”‚      - NotificaÃ§Ã£o de sucesso Ã© exibida                     â”‚
â”‚      - Lista de pedidos Ã© atualizada                        â”‚
â”‚                                                             â”‚
â”‚    SE alguma validaÃ§Ã£o FALHAR:                              â”‚
â”‚      - NotificaÃ§Ã£o de erro Ã© exibida                        â”‚
â”‚      - Modal permanece aberto                               â”‚
â”‚      - UsuÃ¡rio corrige e tenta novamente                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
6. VALIDAÃ‡Ã•ES E REGRAS DE NEGÃ“CIO
================================================================================

6.1 VALIDAÃ‡Ã•ES DE CAMPOS
-------------------------

OBRIGATÃ“RIOS (bloqueiam submissÃ£o):
âœ“ Nome do Cliente (deliveryCustomerName)
  â†’ Mensagem: "Preencha os campos obrigatÃ³rios: Nome do Cliente"

âœ“ Telefone (deliveryCustomerPhone)
  â†’ Mensagem: "Preencha os campos obrigatÃ³rios: Telefone"

âœ“ EndereÃ§o de Entrega (deliveryAddress)
  â†’ Mensagem: "Preencha os campos obrigatÃ³rios: EndereÃ§o de Entrega"

âœ“ Forma de Pagamento (deliveryPaymentMethod)
  â†’ Mensagem: "Preencha os campos obrigatÃ³rios: Forma de Pagamento"

âœ“ Pelo menos 1 item no pedido
  â†’ Mensagem: "Adicione pelo menos um item ao pedido"

OPCIONAIS:
- CEP (recomendado para autocomplete)
- Complemento
- ObservaÃ§Ãµes

6.2 REGRAS DE CÃLCULO
----------------------

SUBTOTAL:
- FÃ³rmula: Î£(quantidade Ã— preÃ§o) para todos os itens
- AtualizaÃ§Ã£o: AutomÃ¡tica ao adicionar/remover/editar itens

TAXA DE ENTREGA:
- Base: R$ 8,00 (configurÃ¡vel por restaurante)
- DistÃ¢ncia mÃ­nima: 3 km (configurÃ¡vel)
- Taxa por km adicional: R$ 0,50 (configurÃ¡vel)
- Taxa de retorno por km: R$ 0,12 (configurÃ¡vel)

Exemplo de configuraÃ§Ã£o do restaurante:
{
    minimum_distance_km: 3.0,
    minimum_delivery_fee: 8.00,
    delivery_fee_per_km: 0.50,
    delivery_return_per_km: 0.12
}

TOTAL:
- FÃ³rmula: Subtotal + Taxa de Entrega
- AtualizaÃ§Ã£o: AutomÃ¡tica

TROCO (apenas se pagamento em dinheiro):
- FÃ³rmula: Valor pago - Total
- ValidaÃ§Ã£o: Valor pago deve ser â‰¥ Total
- ExibiÃ§Ã£o: Somente se troco > 0

6.3 REGRAS DE INTERFACE
------------------------

CAMPOS READONLY:
- Cidade (preenchido por CEP)
- UF (preenchido por CEP)
- Troco (calculado automaticamente)

CAMPOS DESTACADOS:
- Bairro (classe: highlighted-field)
  RazÃ£o: Campo importante para cÃ¡lculo de taxa

CAMPOS CONDICIONAIS:
- deliveryChangeFields
  VisÃ­vel apenas se: paymentMethod === 'money'

CÃLCULOS AUTOMÃTICOS:
- Taxa de entrega (ao preencher endereÃ§o)
- Subtotal (ao modificar itens)
- Total (ao modificar subtotal ou taxa)
- Troco (ao informar valor pago)

6.4 REGRAS DE INTEGRAÃ‡ÃƒO MAPBOX
---------------------------------

GEOCODING:
- Limite: 1 resultado
- PaÃ­s: Brasil (country=br)
- Encoding: URL encoded

DIRECTIONS:
- Modo: driving-traffic (considera trÃ¢nsito)
- Geometria: geojson
- Overview: simplified
- Coordenadas: WGS84 (longitude, latitude)

TRATAMENTO DE ERROS:
- EndereÃ§o nÃ£o encontrado:
  â†’ Exibe: "Erro ao calcular rota. Verifique o endereÃ§o."
  â†’ Taxa permanece no valor padrÃ£o

- API indisponÃ­vel:
  â†’ Permite ajuste manual da taxa
  â†’ NÃ£o bloqueia criaÃ§Ã£o do pedido

================================================================================
7. INTEGRAÃ‡Ã•ES E APIS
================================================================================

7.1 VIACEP API
---------------
Endpoint: https://viacep.com.br/ws/{cep}/json/
MÃ©todo: GET (via JSONP)
Callback: meu_callback

REQUEST:
- CEP: 8 dÃ­gitos sem formataÃ§Ã£o
- Exemplo: 11065001

RESPONSE (sucesso):
{
    "cep": "11065-001",
    "logradouro": "Rua Exemplo",
    "complemento": "",
    "bairro": "Centro",
    "localidade": "Santos",
    "uf": "SP",
    "ibge": "3548500",
    "gia": "",
    "ddd": "13",
    "siafi": "7071"
}

RESPONSE (erro):
{
    "erro": true
}

CAMPOS UTILIZADOS:
- logradouro â†’ deliveryRua
- bairro â†’ deliveryBairro
- localidade â†’ deliveryCidade
- uf â†’ deliveryUf

7.2 MAPBOX GEOCODING API
-------------------------
Endpoint: https://api.mapbox.com/geocoding/v5/mapbox.places/{query}.json
MÃ©todo: GET
AutenticaÃ§Ã£o: access_token (query param)

REQUEST:
- query: EndereÃ§o completo (URL encoded)
- country: br
- limit: 1
- access_token: MAPBOX_ACCESS_TOKEN

RESPONSE (sucesso):
{
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [-46.332474, -23.963036]
            },
            "place_name": "Rua Exemplo, Santos, SÃ£o Paulo, Brasil",
            ...
        }
    ]
}

DADOS EXTRAÃDOS:
- coordinates[0] â†’ longitude
- coordinates[1] â†’ latitude
- place_name â†’ formatted_address

7.3 MAPBOX DIRECTIONS API
--------------------------
Endpoint: https://api.mapbox.com/directions/v5/mapbox/driving-traffic/{coordinates}
MÃ©todo: GET
AutenticaÃ§Ã£o: access_token (query param)

REQUEST:
- coordinates: "lng1,lat1;lng2,lat2" ou "lng1,lat1;lng2,lat2;lng1,lat1"
- geometries: geojson
- overview: simplified
- access_token: MAPBOX_ACCESS_TOKEN

COORDINATES FORMATS:
Sem retorno:
  "restaurante_lng,restaurante_lat;entrega_lng,entrega_lat"

Com retorno (ida e volta):
  "restaurante_lng,restaurante_lat;entrega_lng,entrega_lat;restaurante_lng,restaurante_lat"

RESPONSE (sucesso):
{
    "routes": [
        {
            "distance": 1300.5,  // metros
            "duration": 240,     // segundos
            "geometry": { ... }
        }
    ]
}

CONVERSÃ•ES:
- distance (m â†’ km): value / 1000
- duration (s â†’ min): value / 60

DADOS RETORNADOS:
{
    distance: 1.3,      // km
    duration: 4,        // min
    geometry: {...}     // GeoJSON
}

7.4 SUPABASE (BACKEND)
-----------------------
Gerenciado por: ordersManager.saveOrder(orderData)

Tabela: orders
Campos criados:
- customer_name
- customer_phone
- delivery_address
- zip_code
- delivery_fee
- payment_method
- notes
- subtotal
- total (ou total_amount)
- cash_received
- order_type: 'delivery'
- status: 'novo'
- restaurant_id: (do contexto do usuÃ¡rio)
- created_at: timestamp atual

Tabela: order_items
Campos criados para cada item:
- order_id: (FK para orders)
- product_name
- quantity
- unit_price
- total_price: quantity Ã— unit_price
- notes

TRANSAÃ‡ÃƒO:
1. INSERT em orders
2. Se sucesso, INSERT em order_items
3. Se erro em order_items, DELETE order em orders (rollback)

================================================================================
8. TROUBLESHOOTING
================================================================================

8.1 PROBLEMAS COMUNS
---------------------

PROBLEMA: CEP nÃ£o preenche automaticamente
CAUSA: CEP invÃ¡lido ou API ViaCEP indisponÃ­vel
SOLUÃ‡ÃƒO:
- Verificar formato do CEP (8 dÃ­gitos)
- Preencher campos manualmente
- Verificar console para erros de rede

PROBLEMA: Taxa de entrega nÃ£o Ã© calculada
CAUSA: EndereÃ§o invÃ¡lido ou API Mapbox indisponÃ­vel
SOLUÃ‡ÃƒO:
- Verificar se MAPBOX_ACCESS_TOKEN estÃ¡ configurado
- Verificar endereÃ§o completo no campo oculto deliveryAddress
- Ajustar taxa manualmente no campo deliveryFee
- Verificar console para erros de API

PROBLEMA: Troco nÃ£o Ã© calculado
CAUSA: Valor pago menor que total ou campo vazio
SOLUÃ‡ÃƒO:
- Verificar se forma de pagamento Ã© "Dinheiro"
- Informar valor pago maior ou igual ao total
- Verificar se campos de troco estÃ£o visÃ­veis

PROBLEMA: NÃ£o permite criar pedido sem CEP
CAUSA: CEP nÃ£o Ã© obrigatÃ³rio, mas endereÃ§o completo Ã©
SOLUÃ‡ÃƒO:
- CEP Ã© opcional
- Preencher manualmente: Rua, NÃºmero, Bairro, Cidade, UF
- Sistema monta endereÃ§o automaticamente

PROBLEMA: Itens nÃ£o aparecem na tabela
CAUSA: Erro na busca de produtos ou problemas no ordersManager
SOLUÃ‡ÃƒO:
- Verificar se cardÃ¡pio estÃ¡ cadastrado no Supabase
- Verificar se ordersManager estÃ¡ inicializado
- Usar busca rÃ¡pida ou modal de seleÃ§Ã£o
- Verificar console para erros JavaScript

8.2 VERIFICAÃ‡Ã•ES DE DEBUG
--------------------------

CONSOLE LOGS IMPORTANTES:
- "âœ… Pedido criado com sucesso:" â†’ Sucesso na criaÃ§Ã£o
- "âŒ Erro ao criar pedido:" â†’ Erro na submissÃ£o
- "ğŸ”§ Executando consulta Supabase:" â†’ Chamada ao backend
- "ğŸ“¦ CardÃ¡pio carregado do cache" â†’ Produtos disponÃ­veis

VALIDAR DADOS ANTES DA SUBMISSÃƒO:
```javascript
// No console do navegador:
const form = document.getElementById('deliveryOrderForm');
const customerName = document.getElementById('deliveryCustomerName').value;
const customerPhone = document.getElementById('deliveryCustomerPhone').value;
const address = document.getElementById('deliveryAddress').value;
const paymentMethod = document.getElementById('deliveryPaymentMethod').value;
const items = ordersManager.newOrderItems;

console.log({
    customerName,
    customerPhone,
    address,
    paymentMethod,
    items
});
```

VERIFICAR CONFIGURAÃ‡ÃƒO MAPBOX:
```javascript
// No console do navegador:
console.log('Mapbox Token:', window.MAPBOX_ACCESS_TOKEN ? 'Configurado' : 'NÃƒO configurado');
console.log('Restaurante coords:', currentRestaurant?.latitude, currentRestaurant?.longitude);
```

VERIFICAR SUPABASE:
```javascript
// No console do navegador:
console.log('Supabase Client:', supabase ? 'Inicializado' : 'NÃƒO inicializado');
console.log('Restaurant ID:', currentRestaurant?.id);
```

8.3 ERROS E SOLUÃ‡Ã•ES
---------------------

ERRO: "Preencha os campos obrigatÃ³rios"
- Verificar se todos os campos obrigatÃ³rios estÃ£o preenchidos
- Campos: Nome, Telefone, EndereÃ§o, Forma de Pagamento

ERRO: "Adicione pelo menos um item ao pedido"
- Adicionar produtos via busca ou modal
- Verificar se ordersManager.newOrderItems.length > 0

ERRO: "EndereÃ§o nÃ£o encontrado" (Geocoding)
- Verificar formataÃ§Ã£o do endereÃ§o
- Tentar preencher CEP vÃ¡lido
- Preencher manualmente todos os campos

ERRO: "Erro ao calcular rota" (Directions)
- Verificar token Mapbox
- Verificar coordenadas do restaurante
- Taxa pode ser ajustada manualmente

ERRO: "Restaurant ID nÃ£o encontrado"
- Verificar autenticaÃ§Ã£o do usuÃ¡rio
- Verificar se usuÃ¡rio tem restaurante associado
- Relogar no sistema

ERRO: Network/CORS (APIs externas)
- Verificar conexÃ£o com internet
- APIs podem estar temporariamente indisponÃ­veis
- Usar funcionalidades manuais como alternativa

================================================================================
RESUMO FINAL
================================================================================

O modal "Novo Pedido - Delivery" Ã© um componente completo que:

âœ… COLETA dados do cliente (nome, telefone)
âœ… AUTOCOMPLETA endereÃ§o via CEP (ViaCEP)
âœ… PERMITE seleÃ§Ã£o de produtos com busca em tempo real
âœ… CALCULA automaticamente rota e taxa de entrega (Mapbox)
âœ… CALCULA subtotal, total e troco
âœ… VALIDA todos os campos obrigatÃ³rios
âœ… ENVIA pedido para o Supabase
âœ… TRATA erros de forma amigÃ¡vel

PRINCIPAIS DEPENDÃŠNCIAS:
- ordersManager (gerenciamento de pedidos e itens)
- ViaCEP API (autocomplete de endereÃ§o)
- Mapbox Geocoding API (coordenadas)
- Mapbox Directions API (rota e distÃ¢ncia)
- Supabase (persistÃªncia de dados)

ARQUIVOS RELACIONADOS:
- public/gestao_pedidos.html (interface)
- public/js/secure-config.js (configuraÃ§Ã£o Supabase/Mapbox)
- server.js (backend - endpoint create_delivery_order)

================================================================================
FIM DA DOCUMENTAÃ‡ÃƒO
================================================================================

Ãšltima atualizaÃ§Ã£o: 07/10/2025
VersÃ£o do sistema: TimePulse AI 1.0.0
Desenvolvido por: TimePulse Team
