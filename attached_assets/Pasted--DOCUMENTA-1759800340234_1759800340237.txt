================================================================================
          DOCUMENTA√á√ÉO COMPLETA - INTEGRA√á√ÉO OPENAI API
                    TimePulse AI - Sistema de Gest√£o
================================================================================

üìã √çNDICE
1. Vis√£o Geral
2. Configura√ß√£o da API
3. Modelo e Par√¢metros
4. Endpoints do Sistema
5. Assistente Virtual Ana
6. Assistente Administrativo
7. Sistema MCP (Model Context Protocol)
8. Prompts Personalizados
9. Rate Limiting e Seguran√ßa
10. Troubleshooting

================================================================================
1. VIS√ÉO GERAL
================================================================================

O TimePulse AI utiliza a API OpenAI para alimentar seus assistentes virtuais
inteligentes que interagem com clientes e administradores.

COMPONENTES PRINCIPAIS:
- Ana - Assistente Virtual para clientes (atendimento, pedidos, card√°pio)
- Assistente Administrativo (gerenciamento, an√°lises, suporte)
- Sistema MCP - Integra√ß√£o com banco de dados para respostas contextuais

MODELO UTILIZADO: GPT-5-mini
PROVIDER: OpenAI API (https://api.openai.com/v1)

CARACTER√çSTICAS:
‚úì Chat conversacional com mem√≥ria de contexto
‚úì Racioc√≠nio adapt√°vel (reasoning_effort)
‚úì Integra√ß√£o com dados do restaurante
‚úì Cria√ß√£o autom√°tica de pedidos
‚úì Consulta de card√°pio
‚úì Prompts personaliz√°veis por restaurante

================================================================================
2. CONFIGURA√á√ÉO DA API
================================================================================

2.1 VARI√ÅVEIS DE AMBIENTE
---------------------------

Vari√°vel Obrigat√≥ria:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ OPENAI_API_KEY                                              ‚îÇ
‚îÇ Descri√ß√£o: Chave de API da OpenAI                          ‚îÇ
‚îÇ Formato: sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx             ‚îÇ
‚îÇ Seguran√ßa: NUNCA expor ao frontend                         ‚îÇ
‚îÇ Local: Vari√°vel de ambiente do servidor                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Verifica√ß√£o da Chave:
```javascript
const apiKey = process.env.OPENAI_API_KEY;
if (!apiKey) {
    console.error('‚ùå OPENAI_API_KEY n√£o configurada');
    return res.status(500).json({ 
        error: 'Configura√ß√£o da OpenAI API n√£o encontrada' 
    });
}
```

2.2 ARQUIVO DE CONFIGURA√á√ÉO
-----------------------------

Arquivo: api/config/openai

Estrutura:
```json
{
    "status": "secure_config",
    "configured": false,
    "environment": "production",
    "note": "API keys are now managed via environment variables for security. Using OpenAI API for GPT-5-mini access",
    "required_env_vars": ["OPENAI_API_KEY"],
    "baseUrl": "https://api.openai.com/v1",
    "features": {
        "chat": true,
        "completions": true,
        "embeddings": true,
        "images": false,
        "audio": false,
        "reasoning": true,
        "tools": true,
        "streaming": true
    },
    "models": {
        "chat": "gpt-5-mini",
        "completion": "gpt-5-mini",
        "embedding": "text-embedding-ada-002"
    },
    "parameters": {
        "reasoning_effort": "medium",
        "max_completion_tokens": 4096,
        "stream": false,
        "response_format": {"type": "text"}
    },
    "reasoning_levels": {
        "minimal": "Para instru√ß√µes claras e diretas",
        "low": "Para tarefas simples com racioc√≠nio b√°sico", 
        "medium": "Equil√≠brio entre qualidade e velocidade (padr√£o)",
        "high": "Para an√°lises complexas e racioc√≠nio aprofundado"
    },
    "limits": {
        "requests_per_minute": 60,
        "tokens_per_minute": 40000
    }
}
```

2.3 ENDPOINT DE CONFIGURA√á√ÉO
------------------------------

Endpoint: GET /api/config/openai
Autentica√ß√£o: N√£o requerida (dados p√∫blicos sanitizados)
Cache-Control: no-cache

Response (server.js - linha 1494):
```json
{
    "status": "ok",
    "configured": true,
    "environment": "production",
    "baseUrl": "https://api.openai.com/v1",
    "provider": "OpenAI API",
    "model": "gpt-5-mini",
    "features": {
        "chat": true,
        "completions": true,
        "embeddings": true,
        "images": false,
        "audio": false,
        "reasoning": true,
        "tools": true,
        "streaming": true
    },
    "models": {
        "chat": "gpt-5-mini",
        "completion": "gpt-5-mini",
        "embedding": "text-embedding-ada-002"
    },
    "parameters": {
        "reasoning_effort": "medium",
        "max_completion_tokens": 4096,
        "stream": false,
        "response_format": {"type": "text"}
    },
    "reasoning_levels": {
        "minimal": "Para instru√ß√µes claras e diretas",
        "low": "Para tarefas simples com racioc√≠nio b√°sico", 
        "medium": "Equil√≠brio entre qualidade e velocidade (padr√£o)",
        "high": "Para an√°lises complexas e racioc√≠nio aprofundado"
    },
    "limits": {
        "requests_per_minute": 60,
        "tokens_per_minute": 40000
    },
    "timestamp": "2025-10-07T00:00:00.000Z"
}
```

IMPORTANTE: A chave da API (OPENAI_API_KEY) N√ÉO √© inclu√≠da na resposta
por quest√µes de seguran√ßa.

================================================================================
3. MODELO E PAR√ÇMETROS
================================================================================

3.1 MODELO PRINCIPAL
---------------------

MODELO: gpt-5-mini
PROVIDER: OpenAI
ENDPOINT: https://api.openai.com/v1/chat/completions
M√âTODO: POST

CARACTER√çSTICAS DO GPT-5-MINI:
- Racioc√≠nio avan√ßado (reasoning capabilities)
- Suporte a tools/functions
- Contexto de at√© 128k tokens
- Respostas r√°pidas e eficientes
- Custo-benef√≠cio otimizado

3.2 PAR√ÇMETROS PADR√ÉO
----------------------

```javascript
{
    model: 'gpt-5-mini',                    // SEMPRE gpt-5-mini
    messages: [...],                         // Array de mensagens
    max_completion_tokens: 4096,             // M√°ximo de tokens na resposta
    temperature: 0.7,                        // Criatividade (0.0 a 2.0)
    stream: false,                           // Sem streaming
    reasoning_effort: 'medium'               // N√≠vel de racioc√≠nio
}
```

PAR√ÇMETROS DETALHADOS:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ model (string) - OBRIGAT√ìRIO                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Valor fixo: "gpt-5-mini"                                         ‚îÇ
‚îÇ Descri√ß√£o: Modelo de linguagem a ser usado                      ‚îÇ
‚îÇ Importante: NUNCA usar outro modelo                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ messages (array) - OBRIGAT√ìRIO                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Estrutura:                                                       ‚îÇ
‚îÇ [                                                                ‚îÇ
‚îÇ   {                                                              ‚îÇ
‚îÇ     role: "system",                                              ‚îÇ
‚îÇ     content: "Voc√™ √© Ana, assistente virtual..."                ‚îÇ
‚îÇ   },                                                             ‚îÇ
‚îÇ   {                                                              ‚îÇ
‚îÇ     role: "user",                                                ‚îÇ
‚îÇ     content: "Qual √© o card√°pio?"                                ‚îÇ
‚îÇ   },                                                             ‚îÇ
‚îÇ   {                                                              ‚îÇ
‚îÇ     role: "assistant",                                           ‚îÇ
‚îÇ     content: "Aqui est√° nosso card√°pio..."                       ‚îÇ
‚îÇ   }                                                              ‚îÇ
‚îÇ ]                                                                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ Roles dispon√≠veis:                                               ‚îÇ
‚îÇ - system: Instru√ß√µes e contexto do assistente                   ‚îÇ
‚îÇ - user: Mensagens do usu√°rio                                    ‚îÇ
‚îÇ - assistant: Respostas anteriores da IA                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ max_completion_tokens (integer) - OPCIONAL                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Valor padr√£o: 4096                                               ‚îÇ
‚îÇ Descri√ß√£o: N√∫mero m√°ximo de tokens na resposta                  ‚îÇ
‚îÇ Range: 1 a 128000 (modelo suporta at√© 128k)                     ‚îÇ
‚îÇ Uso t√≠pico: 4096 tokens ‚âà 3000 palavras                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ temperature (float) - OPCIONAL                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Valor padr√£o: 0.7                                                ‚îÇ
‚îÇ Range: 0.0 a 2.0                                                 ‚îÇ
‚îÇ Descri√ß√£o: Controla a criatividade/aleatoriedade                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ Valores recomendados:                                            ‚îÇ
‚îÇ - 0.0 a 0.3: Respostas determin√≠sticas e precisas               ‚îÇ
‚îÇ - 0.4 a 0.7: Balanceado (padr√£o do sistema)                     ‚îÇ
‚îÇ - 0.8 a 1.2: Criativo e variado                                 ‚îÇ
‚îÇ - 1.3 a 2.0: Muito criativo (pode ser incoerente)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ stream (boolean) - OPCIONAL                                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Valor padr√£o: false                                              ‚îÇ
‚îÇ Descri√ß√£o: Habilita streaming de respostas                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ false: Aguarda resposta completa antes de retornar              ‚îÇ
‚îÇ true: Envia resposta em chunks (atualmente desabilitado)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ reasoning_effort (string) - ESPEC√çFICO DO GPT-5-MINI             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Valor padr√£o: "medium"                                           ‚îÇ
‚îÇ Valores poss√≠veis:                                               ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ "minimal" - Para instru√ß√µes claras e diretas                     ‚îÇ
‚îÇ           - Respostas r√°pidas                                    ‚îÇ
‚îÇ           - Menor consumo de tokens                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ "low"     - Para tarefas simples com racioc√≠nio b√°sico          ‚îÇ
‚îÇ           - Respostas diretas                                    ‚îÇ
‚îÇ           - Baixo consumo                                        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ "medium"  - Equil√≠brio entre qualidade e velocidade (PADR√ÉO)    ‚îÇ
‚îÇ           - Uso geral                                            ‚îÇ
‚îÇ           - Melhor custo-benef√≠cio                               ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ "high"    - Para an√°lises complexas e racioc√≠nio aprofundado    ‚îÇ
‚îÇ           - Respostas mais elaboradas                            ‚îÇ
‚îÇ           - Maior consumo de tokens                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

3.3 LIMITES DE USO
-------------------

Configurados no sistema:
- requests_per_minute: 60
- tokens_per_minute: 40000

Rate Limiting (ver se√ß√£o 9):
- Clientes: 30 requests / 60 segundos
- Administradores: Sem limite espec√≠fico
- Sistema MCP: Incluso nas requisi√ß√µes de chat

================================================================================
4. ENDPOINTS DO SISTEMA
================================================================================

4.1 ENDPOINT DE CHAT DO ASSISTENTE (CLIENTES)
----------------------------------------------

ENDPOINT: POST /api/assistant/chat
Arquivo: server.js (linha 3839)
Autentica√ß√£o: authenticateEvolutionAPI
Rate Limit: 30 requisi√ß√µes / 60 segundos

REQUEST BODY:
```json
{
    "messages": [
        {
            "role": "system",
            "content": "Voc√™ √© Ana, assistente virtual..."
        },
        {
            "role": "user",
            "content": "Qual √© o card√°pio de hoje?"
        }
    ],
    "model": "gpt-5-mini",
    "reasoning_effort": "medium",
    "max_completion_tokens": 4096,
    "temperature": 0.7,
    "restaurant_id": "uuid-do-restaurante",
    "session_id": "sessao-unica-do-cliente"
}
```

RESPONSE (Sucesso):
```json
{
    "response": "Ol√°! Aqui est√° nosso card√°pio delicioso...",
    "model_used": "gpt-5-mini",
    "reasoning_effort": "medium",
    "mcp_activated": false,
    "mcp_data": null
}
```

RESPONSE (Com MCP ativado):
```json
{
    "response": "Com base nos dados do sistema, temos 15 produtos...",
    "model_used": "gpt-5-mini",
    "reasoning_effort": "medium",
    "mcp_activated": true,
    "mcp_data": {
        "count": 15,
        "data": [...]
    }
}
```

RESPONSE (Erro):
```json
{
    "error": "Erro no processamento da IA",
    "details": "..."
}
```

FLUXO DE PROCESSAMENTO:

1. Valida√ß√£o de autentica√ß√£o e restaurant_id
2. Verifica√ß√£o da OPENAI_API_KEY
3. Detec√ß√£o de palavras-chave MCP (opcional)
4. Se MCP detectado:
   - Executar consulta ao banco de dados
   - Adicionar dados MCP ao contexto da mensagem
5. Chamar OpenAI API:
   ```javascript
   const gptResponse = await fetch('https://api.openai.com/v1/chat/completions', {
       method: 'POST',
       headers: {
           'Authorization': `Bearer ${apiKey}`,
           'Content-Type': 'application/json'
       },
       body: JSON.stringify({
           model: 'gpt-5-mini',
           messages: messages,
           max_completion_tokens: max_completion_tokens || 4096,
           temperature: temperature || 0.7,
           stream: false
       })
   });
   ```
6. Processar resposta da OpenAI
7. Retornar ao cliente com metadados

C√ìDIGO COMPLETO (server.js - linha 3839-3949):
```javascript
app.post('/api/assistant/chat', authenticateEvolutionAPI, rateLimitEvolutionAPI(30, 60000), async (req, res) => {
    try {
        const { messages, model, reasoning_effort, max_completion_tokens, temperature, restaurant_id, session_id } = req.body;

        // Verificar se o usu√°rio tem acesso a este restaurante
        if (restaurant_id && req.session.restaurantId !== restaurant_id) {
            return res.status(403).json({
                error: "Acesso n√£o autorizado"
            });
        }
        
        if (!messages || !Array.isArray(messages)) {
            return res.status(400).json({ error: 'Mensagens s√£o obrigat√≥rias' });
        }

        const apiKey = process.env.OPENAI_API_KEY;
        if (!apiKey) {
            return res.status(500).json({ error: 'Configura√ß√£o da OpenAI API n√£o encontrada' });
        }

        // Integra√ß√£o MCP (ver se√ß√£o 7)
        let mcpData = null;
        let mcpActivated = false;
        const lastMessage = messages[messages.length - 1];
        if (lastMessage && lastMessage.role === 'user' && detectMCPKeywords(lastMessage.content)) {
            // ... l√≥gica MCP
        }

        // Chamar OpenAI API
        const gptResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-5-mini',
                messages: messages,
                max_completion_tokens: max_completion_tokens || 4096,
                temperature: temperature || 0.7,
                stream: false
            })
        });

        const data = await gptResponse.json();
        const responseMessage = data.choices?.[0]?.message?.content || 'Desculpe, n√£o consegui processar sua mensagem.';

        res.json({
            response: responseMessage,
            model_used: 'gpt-5-mini',
            reasoning_effort: reasoning_effort || 'medium',
            mcp_activated: mcpActivated,
            mcp_data: mcpActivated ? mcpData : null
        });

    } catch (error) {
        console.error('‚ùå Erro no endpoint do assistente:', error);
        res.status(500).json({ error: 'Erro interno do servidor' });
    }
});
```

4.2 ENDPOINT DE CHAT ADMINISTRATIVO
------------------------------------

ENDPOINT: POST /api/admin/assistant/chat
Arquivo: server.js (linha 2639)
Autentica√ß√£o: authenticateAdmin
Rate Limit: N√£o especificado (administrativo)

REQUEST BODY:
```json
{
    "messages": [...],
    "model": "gpt-5-mini",
    "reasoning_effort": "medium",
    "max_completion_tokens": 4096,
    "temperature": 0.7,
    "restaurant_id": "uuid-do-restaurante",
    "session_id": "admin-12345"
}
```

RESPONSE:
```json
{
    "response": "Como administrador, voc√™ pode...",
    "model_used": "gpt-5-mini",
    "reasoning_effort": "medium",
    "session_id": "admin-12345",
    "admin_mode": true,
    "usage": {
        "prompt_tokens": 150,
        "completion_tokens": 300,
        "total_tokens": 450
    },
    "timestamp": "2025-10-07T00:00:00.000Z"
}
```

DIFEREN√áAS DO ENDPOINT DE CLIENTES:
- Autentica√ß√£o administrativa obrigat√≥ria
- Retorna dados de usage (consumo de tokens)
- Flag admin_mode: true
- Sem integra√ß√£o MCP
- Sem rate limiting agressivo

C√ìDIGO (server.js - linha 2639-2716):
```javascript
app.post('/api/admin/assistant/chat', authenticateAdmin, async (req, res) => {
    try {
        const { messages, model, reasoning_effort, max_completion_tokens, temperature, restaurant_id, session_id } = req.body;

        const finalModel = 'gpt-5-mini'; // SEMPRE gpt-5-mini
        const finalReasoningEffort = reasoning_effort || 'medium';
        const finalMaxTokens = max_completion_tokens || 4096;
        const finalSessionId = session_id || `admin-${Date.now()}`;

        const apiKey = process.env.OPENAI_API_KEY;
        if (!apiKey) {
            return res.status(500).json({
                error: 'OpenAI API n√£o configurada'
            });
        }

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: finalModel,
                messages: messages,
                max_completion_tokens: finalMaxTokens,
                stream: false
            })
        });

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;

        res.json({
            response: aiResponse,
            model_used: finalModel,
            reasoning_effort: finalReasoningEffort,
            session_id: finalSessionId,
            admin_mode: true,
            usage: data.usage || {},
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        res.status(500).json({
            error: 'Erro interno do servidor',
            details: error.message
        });
    }
});
```

4.3 ENDPOINT DE STATUS/HEALTH
------------------------------

ENDPOINT: GET /api/health
Arquivo: server.js (linha 1710)
Autentica√ß√£o: N√£o requerida

Verifica conectividade com OpenAI:

```javascript
try {
    const openaiKey = process.env.OPENAI_API_KEY;
    if (openaiKey) {
        const OpenAI = require('openai');
        const openai = new OpenAI({ apiKey: openaiKey });
        
        // Listar modelos com timeout de 5 segundos
        const modelsPromise = openai.models.list();
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('timeout')), 5000)
        );
        
        await Promise.race([modelsPromise, timeoutPromise]);
        services.openai = "connected";
    } else {
        services.openai = "not_configured";
    }
} catch (error) {
    services.openai = error.message.includes('timeout') ? "timeout" : "error";
}
```

RESPONSE:
```json
{
    "status": "ok",
    "services": {
        "openai": "connected",
        "supabase": "connected",
        "evolution": "connected",
        "mapbox": "connected"
    }
}
```

Status poss√≠veis para OpenAI:
- "connected": API funcionando normalmente
- "not_configured": OPENAI_API_KEY n√£o configurada
- "timeout": Timeout na conex√£o
- "error": Erro na conex√£o

================================================================================
5. ASSISTENTE VIRTUAL ANA (FRONTEND)
================================================================================

5.1 VIS√ÉO GERAL
----------------

Arquivo: public/js/assistente.js (1421 linhas)
Modelo: GPT-5-mini via OpenAI API
Endpoint Backend: POST /api/assistant/chat

DESCRI√á√ÉO:
A classe AnaAssistant implementa um assistente virtual completo no frontend
para atendimento de clientes de restaurantes. Integra chat conversacional,
mem√≥ria persistente, consulta a banco de dados (MCP), cria√ß√£o de pedidos e
prompts personalizados.

PRINCIPAIS FUNCIONALIDADES:
‚úì Chat conversacional com GPT-5-mini
‚úì Mem√≥ria persistente de conversa (localStorage)
‚úì Integra√ß√£o MCP (Model Context Protocol) para consultas ao banco
‚úì Carregamento din√¢mico de prompts personalizados
‚úì Cria√ß√£o autom√°tica de pedidos delivery
‚úì Consulta de card√°pio em tempo real
‚úì Valida√ß√£o de dados do cliente
‚úì Preven√ß√£o XSS (Cross-Site Scripting)
‚úì Estados de conversa com m√°quina de estados

5.2 CLASSE AnaAssistant
------------------------

Linha: 4-1374

ESTRUTURA COMPLETA:
```javascript
class AnaAssistant {
    constructor() {
        // Dados principais
        this.messages = [];                  // Hist√≥rico de mensagens
        this.chatMemory = new Map();         // Mem√≥ria de contexto (Map)
        this.isTyping = false;               // Estado de digita√ß√£o
        this.restaurantData = null;          // Dados do restaurante (Supabase)
        this.customerData = null;            // Dados do cliente (Supabase)
        this.currentOrder = null;            // Pedido em andamento
        this.sessionId = null;               // ID da sess√£o (persistente)
        this.messageCount = 0;               // Contador de mensagens enviadas
        this.ordersCreated = 0;              // Total de pedidos criados
        this.customSystemPrompt = null;      // Prompt personalizado (cache)
        this.systemPromptLoaded = false;     // Flag de carregamento do prompt
        
        // Configura√ß√µes do assistente
        this.config = {
            assistantName: "Ana",
            assistantRole: "Assistente Virtual",
            tone: "calorosa, humanizada brasileira",
            language: "pt-BR",
            restaurantSchedule: "das 18:00 √†s 23:00"  // Padr√£o
        };
        
        // Estados da conversa (state machine)
        this.conversationState = {
            stage: 'initial',                     // Est√°gio atual
            waitingForAddressConfirmation: false, // Aguardando confirma√ß√£o
            waitingForPayment: false,             // Aguardando pagamento
            currentProduct: null,                 // Produto sendo adicionado
            selectedAdditionals: [],              // Adicionais selecionados
            pendingOrder: null                    // Pedido pendente
        };
    }
}
```

EST√ÅGIOS POSS√çVEIS (conversationState.stage):
- 'initial': In√≠cio da conversa
- 'greeting': Sauda√ß√£o inicial
- 'address_confirmation': Confirmando endere√ßo
- 'menu_inquiry': Consultando card√°pio
- 'product_selection': Selecionando produtos
- 'additionals': Escolhendo adicionais
- 'payment': Definindo forma de pagamento
- 'finalization': Finalizando pedido

5.3 INICIALIZA√á√ÉO
------------------

M√©todo: async init()
Linha: 38-78

FLUXO DE INICIALIZA√á√ÉO:
1. ‚úì Verificar autentica√ß√£o do usu√°rio
2. ‚úì Carregar dados do restaurante (Supabase)
3. ‚úì Inicializar cliente Supabase
4. ‚úì Configurar event listeners (input, bot√µes)
5. ‚úì Carregar prompt personalizado do servidor
6. ‚úì Carregar mem√≥ria de chat (localStorage)
7. ‚úì Obter telefone do cliente e carregar dados
8. ‚úì Inicializar chat com mensagem de boas-vindas

C√≥digo:
```javascript
async init() {
    try {
        console.log('üöÄ Inicializando Ana - Assistente Virtual...');
        
        // 1. Verificar autentica√ß√£o
        if (!window.SECURE_INSTANCE_MANAGER?.isAuthenticated()) {
            window.location.href = '../login.html';
            return;
        }

        // 2. Carregar dados do restaurante
        await this.loadRestaurantData();
        
        // 3. Inicializar Supabase
        await this.initializeSupabase();
        
        // 4. Configurar interface
        this.setupEventListeners();
        
        // 5. Carregar prompt personalizado
        await this.loadCustomSystemPrompt();
        
        // 6. Verificar mem√≥ria de chat existente
        await this.loadChatMemory();
        
        // 7. Tentar obter telefone e carregar dados do cliente
        const customerPhone = this.getCustomerPhoneFromContext();
        if (customerPhone) {
            await this.loadCustomerData(customerPhone);
        }
        
        // 8. Inicializar chat
        this.initializeChat();
        
        console.log('‚úÖ Ana inicializada com sucesso');
        
    } catch (error) {
        console.error('‚ùå Erro ao inicializar Ana:', error);
        this.showError('Erro ao inicializar o assistente. Recarregue a p√°gina.');
    }
}
```

5.4 CARREGAMENTO DE DADOS DO RESTAURANTE
-----------------------------------------

M√©todo: async loadRestaurantData()
Linha: 84-115

FUN√á√ÉO:
Carrega dados completos do restaurante do Supabase e define o sessionId
para persist√™ncia de mem√≥ria.

DADOS CARREGADOS:
- ID do restaurante
- Nome do restaurante
- Telefone
- Hor√°rios de funcionamento
- Tipo de neg√≥cio

SESSION ID:
Formato: `{restaurant_id}_{user_email}` (caracteres especiais substitu√≠dos por _)
Exemplo: `50b2dbcb-66bb-4969-92cf-493f03237e49_admin_timepulse_com`

C√≥digo:
```javascript
async loadRestaurantData() {
    try {
        const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
        if (!instance?.restaurantId) {
            throw new Error('Restaurant ID n√£o encontrado');
        }

        const supabase = await window.secureConfig.getSupabaseClient();
        const { data: restaurant, error } = await supabase
            .from('restaurants')
            .select('*')
            .eq('id', instance.restaurantId)
            .single();

        if (error) throw error;
        
        this.restaurantData = restaurant;
        
        // Definir sessionId baseado no restaurante e usu√°rio
        this.sessionId = `${instance.restaurantId}_${instance.userEmail}`
            .replace(/[^a-zA-Z0-9_]/g, '_');
        
        this.updateRestaurantUI();
        
        console.log('‚úÖ Dados do restaurante carregados:', restaurant.name);
        console.log('üîë Session ID definido:', this.sessionId);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados do restaurante:', error);
        throw error;
    }
}
```

5.5 SISTEMA DE MEM√ìRIA DE CHAT
-------------------------------

A Ana utiliza um sistema de mem√≥ria persistente baseado em Map + localStorage.

ESTRUTURA DA MEM√ìRIA:
```javascript
this.chatMemory = new Map([
    ['nome', 'Jo√£o Silva'],
    ['phone', '+5513991234567'],
    ['endereco', 'Rua das Flores, 123, Apto 45, Centro, Santos - SP'],
    ['payment_method', 'PIX'],
    ['delivery_fee', '8.00'],
    ['data_confirmada', true],
    ['session_id', '50b2dbcb_admin@timepulse.com'],
    ['restaurant_id', '50b2dbcb-66bb-4969-92cf-493f03237e49'],
    ['ultimo_pedido_id', 'abc-123-def-456'],
    ['ultima_mensagem_user', 'Quero um X-Bacon'],
    ['ultima_resposta_ana', 'Perfeito! Adicionei...']
]);
```

M√âTODOS DE MEM√ìRIA:

1. Carregar mem√≥ria (Linha 171-182):
```javascript
async loadChatMemory() {
    try {
        const savedMemory = localStorage.getItem(`ana_memory_${this.sessionId}`);
        if (savedMemory) {
            this.chatMemory = new Map(JSON.parse(savedMemory));
            this.updateMemoryUI();
        }
    } catch (error) {
        console.warn('N√£o foi poss√≠vel carregar mem√≥ria de chat:', error);
    }
}
```

2. Salvar mem√≥ria (Linha 184-191):
```javascript
saveChatMemory() {
    try {
        localStorage.setItem(`ana_memory_${this.sessionId}`, 
            JSON.stringify([...this.chatMemory]));
    } catch (error) {
        console.warn('N√£o foi poss√≠vel salvar mem√≥ria de chat:', error);
    }
}
```

3. Atualizar UI (Linha 193-222):
Exibe a mem√≥ria na interface de forma segura (com sanitiza√ß√£o XSS).

5.6 OBTEN√á√ÉO E CARREGAMENTO DE DADOS DO CLIENTE
------------------------------------------------

OBTEN√á√ÉO DO TELEFONE (Linha 224-259):

M√©todo: getCustomerPhoneFromContext()

PRIORIDADE DE BUSCA:
1. URL parameters (?phone=, ?telefone=, ?customer_phone=)
2. Mem√≥ria de chat (chatMemory.get('phone'))
3. localStorage (`customer_phone_${restaurantId}`)
4. null (solicita ao usu√°rio)

C√≥digo:
```javascript
getCustomerPhoneFromContext() {
    try {
        // 1. URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const phoneFromUrl = urlParams.get('phone') || 
                            urlParams.get('telefone') || 
                            urlParams.get('customer_phone');
        
        if (phoneFromUrl) {
            console.log('üìû Telefone obtido da URL:', phoneFromUrl);
            return this.normalizePhoneNumber(phoneFromUrl);
        }
        
        // 2. Mem√≥ria
        const phoneFromMemory = this.chatMemory.get('phone');
        if (phoneFromMemory) {
            return this.normalizePhoneNumber(phoneFromMemory);
        }
        
        // 3. localStorage
        const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
        const storedPhone = localStorage.getItem(`customer_phone_${instance.restaurantId}`);
        if (storedPhone) {
            return this.normalizePhoneNumber(storedPhone);
        }
        
        return null;
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao obter telefone do contexto:', error);
        return null;
    }
}
```

NORMALIZA√á√ÉO DE TELEFONE (Linha 261-276):

M√©todo: normalizePhoneNumber(phone)

REGRAS:
- Remove caracteres n√£o num√©ricos
- Adiciona c√≥digo do pa√≠s (+55) se necess√°rio
- Formato final: +5513991234567

CARREGAMENTO DE DADOS (Linha 278-311):

M√©todo: async loadCustomerData(phone)

PROCESSO:
1. Verifica se telefone foi fornecido
2. Consulta via MCP (queryCustomerDataMCP)
3. Tenta m√∫ltiplos formatos de telefone
4. Salva dados em this.customerData
5. Armazena telefone no localStorage

5.7 SISTEMA DE PROMPTS PERSONALIZADOS
--------------------------------------

M√©todo: async loadCustomSystemPrompt()
Linha: 861-942

PRIORIDADE DE CARREGAMENTO:
1. Prompt baseado no tipo de neg√≥cio (lanchonete, pizzaria, etc.)
2. Prompt personalizado espec√≠fico do restaurante
3. Prompt do localStorage
4. Prompt padr√£o (hardcoded)

ENDPOINT TIPO DE NEG√ìCIO:
GET /api/assistant/business-type-prompt?restaurant_id={id}

ENDPOINT PERSONALIZADO:
GET /api/assistant/system-prompt

C√≥digo:
```javascript
async loadCustomSystemPrompt() {
    if (this.systemPromptLoaded) {
        return this.customSystemPrompt;
    }
    
    try {
        // PRIORIDADE 1: Tipo de neg√≥cio
        if (this.restaurantData && this.restaurantData.id) {
            const businessTypeResponse = await fetch(
                `/api/assistant/business-type-prompt?restaurant_id=${this.restaurantData.id}`,
                { method: 'GET', credentials: 'include' }
            );
            
            if (businessTypeResponse.ok) {
                const businessTypeData = await businessTypeResponse.json();
                
                if (businessTypeData.hasPrompt && businessTypeData.prompt) {
                    this.customSystemPrompt = businessTypeData.prompt;
                    this.systemPromptLoaded = true;
                    console.log(`‚úÖ Prompt tipo de neg√≥cio: ${businessTypeData.businessType}`);
                    return this.customSystemPrompt;
                }
            }
        }
        
        // PRIORIDADE 2: Prompt espec√≠fico
        const response = await fetch('/api/assistant/system-prompt', {
            method: 'GET',
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.hasCustomPrompt && data.prompt) {
                this.customSystemPrompt = data.prompt;
                this.systemPromptLoaded = true;
                console.log('‚úÖ Prompt personalizado carregado!');
                return this.customSystemPrompt;
            }
        }
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao carregar prompt:', error);
    }
    
    // PRIORIDADE 3: localStorage
    try {
        const instance = window.SECURE_INSTANCE_MANAGER.getInstance();
        const localPrompt = localStorage.getItem(`custom_prompt_${instance.restaurantId}`);
        
        if (localPrompt) {
            this.customSystemPrompt = localPrompt;
            console.log('‚úÖ Prompt do localStorage!');
        }
    } catch (localError) {
        console.warn('‚ö†Ô∏è Erro ao acessar localStorage:', localError);
    }
    
    this.systemPromptLoaded = true;
    return this.customSystemPrompt;
}
```

5.8 PROCESSAMENTO DE MENSAGENS
-------------------------------

M√©todo: async processMessage(userMessage)
Linha: 616-674

FLUXO COMPLETO:
1. ‚úì Verificar se cliente precisa confirmar dados
2. ‚úì Verificar se est√° atualizando dados
3. ‚úì Extrair informa√ß√µes da mensagem (telefone, nome, endere√ßo)
4. ‚úì Verificar e ativar MCP se necess√°rio
5. ‚úì Construir contexto para GPT-5-mini
6. ‚úì Chamar GPT-5-mini via backend
7. ‚úì Processar resposta (criar pedido, consultar card√°pio)
8. ‚úì Atualizar mem√≥ria de chat

C√≥digo:
```javascript
async processMessage(userMessage) {
    try {
        // 1. Confirmar dados do cliente (se necess√°rio)
        if (this.customerData && this.chatMemory.get('data_confirmada') === false) {
            const confirmation = this.checkDataConfirmation(userMessage);
            if (confirmation !== null) {
                if (confirmation) {
                    this.chatMemory.set('data_confirmada', true);
                    this.saveChatMemory();
                    return 'Perfeito! üéâ Dados confirmados! Agora me conta...';
                } else {
                    // Iniciar atualiza√ß√£o
                    this.chatMemory.set('updating_customer_data', true);
                    this.customerData = null;
                    return 'Sem problemas! üòä Vamos atualizar seus dados...';
                }
            }
        }

        // 2. Atualizar dados (se em processo)
        if (this.chatMemory.get('updating_customer_data') === true) {
            const updateResult = await this.processCustomerDataUpdate(userMessage);
            if (updateResult) {
                return updateResult;
            }
        }
        
        // 3. Extrair informa√ß√µes
        this.extractInfoFromMessage(userMessage);
        
        // 4. Verificar MCP
        const mcpResponse = await this.checkAndActivateMCP(userMessage);
        if (mcpResponse) {
            this.updateChatMemory(userMessage, mcpResponse);
            return mcpResponse;
        }
        
        // 5. Construir contexto
        const context = this.buildContext(userMessage);
        
        // 6. Chamar GPT-5-mini
        const response = await this.callGPT5Mini(context);
        
        // 7. Processar resposta
        const processedResponse = await this.processGPTResponse(response, userMessage);
        
        // 8. Atualizar mem√≥ria
        this.updateChatMemory(userMessage, processedResponse);
        
        return processedResponse;
        
    } catch (error) {
        console.error('‚ùå Erro ao processar mensagem:', error);
        return 'Desculpe, tive um problema t√©cnico. Pode tentar novamente?';
    }
}
```

5.9 INTEGRA√á√ÉO MCP (MODEL CONTEXT PROTOCOL)
--------------------------------------------

M√©todo: async checkAndActivateMCP(userMessage)
Linha: 750-828

FUN√á√ÉO:
Detecta palavras-chave na mensagem do usu√°rio e ativa consultas ao banco de
dados via MCP para fornecer respostas baseadas em dados reais.

PALAVRAS-CHAVE MCP:
```javascript
const mcpKeywords = [
    'mcp', 'database', 'banco de dados', 'consulta', 'query', 
    'tabela', 'dados', 'sql', 'supabase', 'buscar dados', 
    'verificar banco', 'consultar base', 'dados do sistema',
    'restaurante', 'restaurant', 'pedido', 'order', 'cliente', 'customer',
    'produto', 'product', 'entregador', 'deliverer', 'delivery',
    'cupom', 'coupon', 'desconto', 'notificacao', 'notification',
    'log', 'atividade', 'activity', 'chat', 'conversa', 'message',
    'prompt', 'prompit', 'administrador', 'admin', 'usuario', 'user',
    'tipo negocio', 'business type', 'relatorio', 'report', 'estatistica',
    // Palavras para cria√ß√£o de pedidos
    'criar pedido', 'novo pedido', 'fazer pedido', 'create order', 'new order',
    'pedido delivery', 'pedido balcao', 'balc√£o', 'counter order', 'delivery order',
    'finalizar pedido', 'processar pedido', 'salvar pedido', 'complete order'
];
```

PROCESSO:
1. Normalizar mensagem (lowercase)
2. Verificar se cont√©m palavra-chave
3. Se SIM:
   a. Obter token CSRF (GET /api/csrf-token)
   b. Chamar endpoint MCP (POST /api/mcp/activate)
   c. Retornar resposta com dados do banco
4. Se N√ÉO: retornar null (continuar processamento normal)

ENDPOINT MCP:
POST /api/mcp/activate

PAYLOAD:
```json
{
    "message": "consultar pedidos",
    "restaurantId": "50b2dbcb-66bb-4969-92cf-493f03237e49"
}
```

RESPONSE (MCP Ativado):
```json
{
    "mcpActivated": true,
    "response": "Encontrei 15 pedidos no sistema. Os mais recentes s√£o...",
    "data": {
        "count": 15,
        "items": [...]
    }
}
```

C√≥digo:
```javascript
async checkAndActivateMCP(userMessage) {
    try {
        const mcpKeywords = ['mcp', 'database', 'pedido', 'cliente', ...];
        
        const messageNormalized = userMessage.toLowerCase().trim();
        const shouldActivateMCP = mcpKeywords.some(keyword => 
            messageNormalized.includes(keyword)
        );
        
        if (!shouldActivateMCP) {
            return null; // N√£o ativar MCP
        }
        
        console.log('üîß Palavra-chave MCP detectada:', userMessage);
        
        // 1. Obter token CSRF
        const csrfResponse = await fetch('/api/csrf-token', {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!csrfResponse.ok) {
            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter token CSRF');
            return null;
        }
        
        const csrfData = await csrfResponse.json();
        
        // 2. Chamar MCP
        const response = await fetch('/api/mcp/activate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfData.csrfToken
            },
            credentials: 'include',
            body: JSON.stringify({
                message: userMessage,
                restaurantId: this.restaurantData?.id
            })
        });
        
        if (!response.ok) {
            console.warn('‚ö†Ô∏è Erro na chamada MCP');
            return null;
        }
        
        const mcpData = await response.json();
        
        if (mcpData.mcpActivated && mcpData.response) {
            console.log('‚úÖ MCP ativado com sucesso!');
            
            // Adicionar indicador visual
            const mcpIndicator = 'üîß <strong>MCP Database Ativado</strong><br><br>';
            
            return mcpIndicator + mcpData.response;
        }
        
        return null;
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao verificar MCP:', error);
        return null; // Continuar sem MCP
    }
}
```

5.10 CONSTRU√á√ÉO DE CONTEXTO E CHAMADA AO GPT-5-MINI
----------------------------------------------------

CONSTRU√á√ÉO DE CONTEXTO (Linha 944-1087):

M√©todo: buildContext(userMessage)

FUN√á√ÉO:
Monta o contexto completo para enviar ao GPT-5-mini, incluindo:
- System prompt (personalizado ou padr√£o)
- Dados do restaurante
- Mem√≥ria da conversa
- Hist√≥rico de mensagens (√∫ltimas 10)
- Mensagem atual do usu√°rio

ESTRUTURA DO CONTEXTO:
```javascript
{
    messages: [
        {
            role: "system",
            content: `[PROMPT PERSONALIZADO]
            
DADOS DO RESTAURANTE (DIN√ÇMICOS):
- Nome: Frutidelis
- ID: 50b2dbcb-66bb-4969-92cf-493f03237e49
- Hor√°rio: das 18:00 √†s 23:00

MEM√ìRIA ATUAL DA CONVERSA:
nome: Jo√£o Silva
phone: +5513991234567
endereco: Rua das Flores, 123, Apto 45, Centro, Santos - SP
payment_method: PIX
delivery_fee: 8.00

Estado da conversa: initial`
        },
        // √öltimas 10 mensagens do hist√≥rico
        {
            role: "user",
            content: "Oi"
        },
        {
            role: "assistant",
            content: "Ol√°! Como posso ajudar?"
        },
        // Mensagem atual
        {
            role: "user",
            content: "Quero fazer um pedido"
        }
    ]
}
```

CHAMADA AO GPT-5-MINI (Linha 1089-1119):

M√©todo: async callGPT5Mini(context)

ENDPOINT BACKEND: POST /api/assistant/chat

PAYLOAD:
```json
{
    "messages": [...],
    "model": "gpt-5-mini",
    "reasoning_effort": "medium",
    "max_completion_tokens": 4096,
    "temperature": 0.7,
    "restaurant_id": "50b2dbcb-66bb-4969-92cf-493f03237e49",
    "session_id": "50b2dbcb_admin_timepulse_com"
}
```

C√≥digo:
```javascript
async callGPT5Mini(context) {
    try {
        const response = await fetch('/api/assistant/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                messages: context.messages,
                model: 'gpt-5-mini',                    // SEMPRE gpt-5-mini
                reasoning_effort: 'medium',             // Padr√£o: medium
                max_completion_tokens: 4096,            // M√°ximo de tokens
                temperature: 0.7,                       // Criatividade
                restaurant_id: this.restaurantData.id,
                session_id: this.sessionId
            })
        });

        if (!response.ok) {
            throw new Error(`Erro na API: ${response.status}`);
        }

        const data = await response.json();
        return data.response || data.message || 'Desculpe, n√£o consegui processar.';
        
    } catch (error) {
        console.error('‚ùå Erro ao chamar GPT-5-mini:', error);
        throw error;
    }
}
```

5.11 CRIA√á√ÉO DE PEDIDOS
-----------------------

M√©todo: async createOrder()
Linha: 1214-1351

FUN√á√ÉO:
Cria um pedido completo no banco de dados (Supabase) com todos os dados
coletados durante a conversa.

VALIDA√á√ïES OBRIGAT√ìRIAS:
‚úì Nome do Cliente
‚úì Telefone
‚úì Endere√ßo de Entrega (completo)
‚úì Forma de Pagamento
‚úì Pelo menos 1 item no pedido

ESTRUTURA DO PEDIDO:
```javascript
const orderData = {
    restaurant_id: this.restaurantData.id,
    customer_name: customerName,
    customer_phone: customerPhone,
    delivery_address: customerAddress,
    zip_code: zipCode,
    delivery_fee: deliveryFee,              // Padr√£o: R$ 8,00
    payment_method: paymentMethod,          // money/card/pix/voucher
    cash_received: cashReceived,            // Se payment_method = money
    subtotal: subtotal,                     // Soma dos itens
    total_amount: totalAmount,              // subtotal + delivery_fee
    order_type: 'delivery',
    status: 'novo',                         // SEMPRE "novo"
    notes: `Pedido criado via Ana - Assistente Virtual\nSession ID: ${this.sessionId}`,
    created_at: new Date().toISOString()
};
```

FLUXO:
1. Extrair dados da mem√≥ria (chatMemory)
2. Validar campos obrigat√≥rios
3. Calcular subtotal dos itens
4. Calcular total (subtotal + taxa de entrega)
5. Inserir pedido na tabela 'orders'
6. Inserir itens na tabela 'order_items'
7. Atualizar mem√≥ria com ID do pedido
8. Limpar pedido atual

C√≥digo:
```javascript
async createOrder() {
    try {
        // 1. Extrair dados da mem√≥ria
        const customerName = this.chatMemory.get('nome') || 'Cliente';
        const customerPhone = this.chatMemory.get('phone') || '';
        const customerAddress = this.chatMemory.get('endereco') || '';
        const paymentMethod = this.chatMemory.get('payment_method') || 'PIX';
        const deliveryFee = parseFloat(this.chatMemory.get('delivery_fee') || '8.00');
        const cashReceived = this.chatMemory.get('cash_received') ? 
            parseFloat(this.chatMemory.get('cash_received')) : null;
        
        // 2. Valida√ß√µes
        const missingFields = [];
        
        if (!customerName || customerName === 'Cliente') {
            missingFields.push('Nome do Cliente');
        }
        
        if (!customerPhone) {
            missingFields.push('Telefone');
        }
        
        if (!customerAddress) {
            missingFields.push('Endere√ßo de Entrega');
        }
        
        if (!paymentMethod) {
            missingFields.push('Forma de Pagamento');
        }
        
        if (!this.currentOrder?.items || this.currentOrder.items.length === 0) {
            missingFields.push('Pelo menos 1 item no pedido');
        }
        
        if (missingFields.length > 0) {
            throw new Error(`Campos faltando: ${missingFields.join(', ')}`);
        }

        // 3. Calcular valores
        const subtotal = this.currentOrder.items.reduce((sum, item) => {
            return sum + ((item.price || 0) * (item.quantity || 1));
        }, 0);
        
        const totalAmount = subtotal + deliveryFee;

        // 4. Criar pedido
        const orderData = {
            restaurant_id: this.restaurantData.id,
            customer_name: customerName,
            customer_phone: customerPhone,
            delivery_address: customerAddress,
            delivery_fee: deliveryFee,
            payment_method: paymentMethod,
            cash_received: cashReceived,
            subtotal: subtotal,
            total_amount: totalAmount,
            order_type: 'delivery',
            status: 'novo',                          // STATUS OBRIGAT√ìRIO
            notes: `Pedido criado via Ana\nSession: ${this.sessionId}`,
            created_at: new Date().toISOString()
        };

        const { data: order, error: orderError } = await this.supabase
            .from('orders')
            .insert([orderData])
            .select()
            .single();

        if (orderError) throw orderError;

        // 5. Criar itens do pedido
        if (this.currentOrder.items && this.currentOrder.items.length > 0) {
            const orderItems = this.currentOrder.items.map(item => ({
                order_id: order.id,
                product_name: item.name,
                quantity: item.quantity || 1,
                unit_price: item.price || 0,
                total_price: (item.price || 0) * (item.quantity || 1),
                notes: item.notes || '',
                additionals: item.additionals || []
            }));

            const { error: itemsError } = await this.supabase
                .from('order_items')
                .insert(orderItems);

            if (itemsError) {
                // Rollback: remover pedido
                await this.supabase.from('orders').delete().eq('id', order.id);
                throw itemsError;
            }
        }

        console.log('‚úÖ Pedido criado:', {
            id: order.id,
            status: 'novo',
            total: totalAmount
        });
        
        // 6. Atualizar mem√≥ria
        this.chatMemory.set('ultimo_pedido_id', order.id);
        this.chatMemory.set('ultimo_pedido_status', 'novo');
        this.chatMemory.set('ultimo_pedido_total', totalAmount);
        this.saveChatMemory();
        
        // 7. Limpar pedido atual
        this.currentOrder = null;
        
        return order;
        
    } catch (error) {
        console.error('‚ùå Erro ao criar pedido:', error);
        throw error;
    }
}
```

5.12 CONSULTA DE CARD√ÅPIO
--------------------------

M√©todo: async getRestaurantMenu()
Linha: 1151-1177

FUN√á√ÉO:
Busca produtos ativos do restaurante no Supabase com suas categorias.

QUERY:
```javascript
const { data: products, error } = await this.supabase
    .from('products')
    .select(`
        id,
        name,
        description,
        price,
        category_id,
        product_categories (
            name
        )
    `)
    .eq('restaurant_id', this.restaurantData.id)
    .eq('active', true)
    .order('category_id')
    .order('name');
```

FORMATA√á√ÉO (Linha 1179-1212):

M√©todo: formatMenuResponse(products)

RESULTADO:
```
Aqui est√° nosso card√°pio delicioso! üòã

üçΩÔ∏è **Lanches**

‚Ä¢ **X-Bacon** - R$ 18,00
  Hamb√∫rguer, bacon, queijo e salada

‚Ä¢ **X-Salada** - R$ 15,00
  Hamb√∫rguer, queijo, alface e tomate

üçΩÔ∏è **Bebidas**

‚Ä¢ **Coca-Cola 350ml** - R$ 5,00
  Refrigerante gelado

Qual desses te deixou com √°gua na boca? üòä
```

5.13 PREVEN√á√ÉO XSS E SEGURAN√áA
-------------------------------

A Ana implementa m√∫ltiplas camadas de prote√ß√£o contra XSS:

1. SANITIZA√á√ÉO B√ÅSICA (Linha 453-461):
```javascript
sanitizeForDisplay(text) {
    if (!text) return text;
    
    const div = document.createElement('div');
    div.textContent = text;  // textContent escapa automaticamente
    return div.innerHTML;
}
```

2. ESCAPE HTML COMPLETO (Linha 464-479):
```javascript
escapeHTML(text) {
    if (!text) return '';
    
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
        '/': '&#x2F;'
    };
    
    return String(text).replace(/[&<>"'\/]/g, function (s) {
        return map[s];
    });
}
```

3. FORMATA√á√ÉO DE MENSAGENS (Linha 544-586):
- Escapa TODO o conte√∫do antes de exibir
- Processa formata√ß√£o especial (pedidos, pagamentos)
- Nunca insere HTML n√£o sanitizado

5.14 EVENT LISTENERS E UI
--------------------------

CONFIGURA√á√ÉO DE EVENTOS (Linha 141-169):

M√©todo: setupEventListeners()

EVENTOS CONFIGURADOS:
1. Auto-resize do textarea (input)
2. Enviar mensagem com Enter (keypress)
3. Bot√£o de enviar (click)
4. Habilitar inputs ap√≥s inicializa√ß√£o

FUN√á√ïES GLOBAIS (Linha 1377-1402):

1. clearChat(): Limpa conversa completa
2. selectPaymentMethod(method): Seleciona forma de pagamento

INICIALIZA√á√ÉO AUTOM√ÅTICA (Linha 1405-1421):
```javascript
document.addEventListener('DOMContentLoaded', async () => {
    try {
        window.ana = new AnaAssistant();
        await window.ana.init();
    } catch (error) {
        console.error('‚ùå Erro ao inicializar Ana:', error);
        // Exibir mensagem de erro
    }
});

// Exportar para uso global
window.AnaAssistant = AnaAssistant;
```

5.15 RESUMO DO FLUXO COMPLETO
------------------------------

FLUXO DE UMA MENSAGEM COMPLETA:

1. Usu√°rio digita mensagem ‚Üí sendMessage()
2. Adicionar mensagem √† UI
3. Mostrar indicador "digitando..."
4. processMessage():
   a. Verificar confirma√ß√£o de dados do cliente
   b. Verificar atualiza√ß√£o de dados
   c. Extrair informa√ß√µes (telefone, nome, endere√ßo)
   d. Verificar ativa√ß√£o MCP
      - Se ativado: retornar resposta do banco
   e. Construir contexto (prompt + mem√≥ria + hist√≥rico)
   f. Chamar GPT-5-mini via /api/assistant/chat
   g. Processar resposta:
      - Criar pedido se necess√°rio
      - Consultar card√°pio se solicitado
   h. Atualizar mem√≥ria
5. Ocultar indicador "digitando..."
6. Exibir resposta da Ana
7. Salvar mem√≥ria em localStorage

ENDPOINTS UTILIZADOS:
- POST /api/assistant/chat (GPT-5-mini)
- POST /api/mcp/activate (Consultas ao banco)
- GET /api/assistant/system-prompt (Prompt personalizado)
- GET /api/assistant/business-type-prompt (Prompt por tipo de neg√≥cio)
- GET /api/csrf-token (Token CSRF para MCP)

TABELAS SUPABASE:
- restaurants (dados do restaurante)
- customers (dados do cliente)
- products (card√°pio)
- product_categories (categorias)
- orders (pedidos)
- order_items (itens do pedido)

================================================================================

5.OLD BACKUP - INICIALIZA√á√ÉO (IGNORAR)
------------------

M√©todo: async init()
Linha: 38

Fluxo:
1. Verificar autentica√ß√£o
2. Carregar dados do restaurante
3. Inicializar Supabase
4. Configurar event listeners
5. Carregar prompt personalizado
6. Carregar mem√≥ria de chat
7. Carregar dados do cliente (se dispon√≠vel)
8. Inicializar chat

C√≥digo:
```javascript
async init() {
    try {
        console.log('üöÄ Inicializando Ana - Assistente Virtual...');
        
        // Verificar autentica√ß√£o
        if (!window.SECURE_INSTANCE_MANAGER?.isAuthenticated()) {
            window.location.href = '../login.html';
            return;
        }

        // Carregar dados do restaurante
        await this.loadRestaurantData();
        
        // Carregar configura√ß√£o do Supabase
        await this.initializeSupabase();
        
        // Configurar interface
        this.setupEventListeners();
        
        // Carregar prompt personalizado (se existir)
        await this.loadCustomSystemPrompt();
        
        // Verificar mem√≥ria de chat existente
        await this.loadChatMemory();
        
        // Tentar obter telefone do cliente e carregar dados
        const customerPhone = this.getCustomerPhoneFromContext();
        if (customerPhone) {
            await this.loadCustomerData(customerPhone);
        }
        
        // Inicializar chat
        this.initializeChat();
        
        console.log('‚úÖ Ana inicializada com sucesso');
        
    } catch (error) {
        console.error('‚ùå Erro ao inicializar Ana:', error);
        this.showError('Erro ao inicializar o assistente. Recarregue a p√°gina.');
    }
}
```

5.3 ENVIO DE MENSAGENS
-----------------------

M√©todo: async sendMessage()
Linha: 481

Fluxo:
1. Validar mensagem e estado
2. Adicionar mensagem do usu√°rio √† interface
3. Mostrar indicador de "digitando"
4. Processar mensagem:
   - Verificar ativa√ß√£o MCP
   - Construir contexto
   - Chamar GPT-5-mini
   - Processar resposta
5. Atualizar mem√≥ria
6. Exibir resposta

C√≥digo:
```javascript
async sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message || this.isTyping) return;

    // Adicionar mensagem do usu√°rio
    this.addMessage('user', message);
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    // Indicador de digita√ß√£o
    this.isTyping = true;
    this.showTypingIndicator();
    
    try {
        // Processar mensagem
        const response = await this.processMessage(message);
        
        // Adicionar resposta
        this.addMessage('assistant', response);
        this.messageCount++;
        
    } catch (error) {
        console.error('‚ùå Erro ao processar mensagem:', error);
        this.addMessage('assistant', 'Desculpe, tive um problema. Por favor, tente novamente.');
    } finally {
        this.isTyping = false;
        this.hideTypingIndicator();
        messageInput.focus();
    }
}
```

5.4 CHAMADA √Ä API OPENAI
-------------------------

M√©todo: async callGPT5Mini(context)
Linha: 1020

REQUEST:
```javascript
const response = await fetch('/api/assistant/chat', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify({
        messages: context.messages,
        model: 'gpt-5-mini',
        reasoning_effort: 'medium',
        max_completion_tokens: 4096,
        temperature: 0.7,
        restaurant_id: this.restaurantData.id,
        session_id: this.sessionId
    })
});
```

RESPONSE HANDLING:
```javascript
if (!response.ok) {
    throw new Error(`Erro na API: ${response.status}`);
}

const data = await response.json();
return data.response || data.message || 'Desculpe, n√£o consegui processar sua mensagem.';
```

5.5 CONSTRU√á√ÉO DE CONTEXTO
---------------------------

M√©todo: buildContext(userMessage)
Linha: 940

O contexto inclui:
1. Prompt do sistema (personalizado ou padr√£o)
2. √öltimas 10 mensagens da conversa
3. Dados do restaurante
4. Dados do cliente (se dispon√≠vel)
5. Mem√≥ria de chat
6. Estado da conversa

Exemplo de System Prompt:
```
Voc√™ √© Ana, assistente virtual calorosa e humanizada para o restaurante [Nome].

Seu papel:
- Atender clientes com gentileza
- Tirar d√∫vidas sobre o card√°pio
- Ajudar a fazer pedidos
- Confirmar endere√ßos de entrega

Dados do restaurante:
- Nome: [Nome]
- Telefone: [Telefone]
- Hor√°rio: [Hor√°rio]
- Endere√ßo: [Endere√ßo]

Cliente atual:
- Nome: [Nome]
- Telefone: [Telefone]
- Endere√ßo: [Endere√ßo]

Mem√≥ria da conversa:
[Dados da mem√≥ria]

Estado da conversa: [stage]
```

5.6 PROCESSAMENTO DE RESPOSTAS
-------------------------------

M√©todo: async processGPTResponse(response, userMessage)
Linha: 1052

A√á√ïES ESPECIAIS DETECTADAS:

1. FINALIZAR PEDIDO:
   - Detecta: 'action":"finalizar' ou 'finalizar pedido'
   - A√ß√£o: Chama createOrder()
   - Incrementa contador de pedidos

2. CONSULTAR CARD√ÅPIO:
   - Detecta: 'consulta_sistema' ou palavras 'card√°pio'/'menu'
   - A√ß√£o: Chama getRestaurantMenu()
   - Formata resposta com produtos

C√≥digo:
```javascript
async processGPTResponse(response, userMessage) {
    // Verificar se precisa criar pedido
    if (response.includes('action":"finalizar') || response.includes('finalizar pedido')) {
        try {
            await this.createOrder();
            this.ordersCreated++;
            document.getElementById('ordersCount').textContent = this.ordersCreated;
        } catch (error) {
            console.error('‚ùå Erro ao criar pedido:', error);
            return response + '\n\nOps! Tive um problema ao processar seu pedido. Nosso suporte entrar√° em contato.';
        }
    }
    
    // Verificar se precisa consultar card√°pio
    if (response.includes('consulta_sistema') || userMessage.toLowerCase().includes('card√°pio') || userMessage.toLowerCase().includes('menu')) {
        try {
            const menu = await this.getRestaurantMenu();
            if (menu) {
                return this.formatMenuResponse(menu);
            }
        } catch (error) {
            console.error('‚ùå Erro ao buscar card√°pio:', error);
        }
    }
    
    return response;
}
```

5.7 MEM√ìRIA DE CHAT
--------------------

A Ana mant√©m mem√≥ria persistente usando localStorage.

SALVAMENTO:
```javascript
saveChatMemory() {
    try {
        localStorage.setItem(`ana_memory_${this.sessionId}`, 
            JSON.stringify([...this.chatMemory]));
    } catch (error) {
        console.warn('N√£o foi poss√≠vel salvar mem√≥ria de chat:', error);
    }
}
```

CARREGAMENTO:
```javascript
async loadChatMemory() {
    try {
        const savedMemory = localStorage.getItem(`ana_memory_${this.sessionId}`);
        if (savedMemory) {
            this.chatMemory = new Map(JSON.parse(savedMemory));
            this.updateMemoryUI();
        }
    } catch (error) {
        console.warn('N√£o foi poss√≠vel carregar mem√≥ria de chat:', error);
    }
}
```

DADOS ARMAZENADOS NA MEM√ìRIA:
- nome_cliente
- telefone_cliente
- endereco_entrega
- produto_interesse
- forma_pagamento
- ultimo_pedido_id
- estado_conversa

================================================================================
6. ASSISTENTE ADMINISTRATIVO
================================================================================

O assistente administrativo usa o mesmo modelo GPT-5-mini mas com
endpoint e autentica√ß√£o separados.

DIFEREN√áAS:
‚úì Autentica√ß√£o administrativa (authenticateAdmin)
‚úì Acesso a dados privilegiados
‚úì Sem rate limiting agressivo
‚úì Retorna m√©tricas de uso (usage)
‚úì Sem integra√ß√£o MCP
‚úì Flag admin_mode: true

ENDPOINT: POST /api/admin/assistant/chat
Ver se√ß√£o 4.2 para detalhes completos

================================================================================
7. SISTEMA MCP (MODEL CONTEXT PROTOCOL)
================================================================================

O MCP (Model Context Protocol) √© um sistema que permite √† IA acessar dados
do banco de dados em tempo real para fornecer respostas precisas.

7.1 DETEC√á√ÉO DE PALAVRAS-CHAVE
--------------------------------

Fun√ß√£o: detectMCPKeywords(message)
Linha: 5076 (server.js)

PALAVRAS-CHAVE MCP:
- mcp, database, banco de dados
- consulta, query, tabela, dados, sql
- supabase, buscar dados, verificar banco
- consultar base, dados do sistema
- restaurante, restaurant, pedido, order
- cliente, customer, produto, product
- entregador, deliverer, delivery
- cupom, coupon, desconto
- notificacao, notification
- log, atividade, activity
- chat, conversa, message
- prompt, prompit
- administrador, admin, usuario, user
- tipo negocio, business type
- relatorio, report, estatistica
- criar pedido, novo pedido, fazer pedido
- pedido delivery, pedido balcao
- finalizar pedido, processar pedido

C√≥digo:
```javascript
function detectMCPKeywords(message) {
    const mcpKeywords = [
        'mcp', 'database', 'banco de dados', 'consulta', 'query', 
        'tabela', 'dados', 'sql', 'supabase', 'buscar dados', 
        'verificar banco', 'consultar base', 'dados do sistema',
        'restaurante', 'restaurant', 'pedido', 'order', 'cliente', 'customer',
        'produto', 'product', 'entregador', 'deliverer', 'delivery',
        'cupom', 'coupon', 'desconto', 'notificacao', 'notification',
        'log', 'atividade', 'activity', 'chat', 'conversa', 'message',
        'prompt', 'prompit', 'administrador', 'admin', 'usuario', 'user',
        'tipo negocio', 'business type', 'relatorio', 'report', 'estatistica',
        'criar pedido', 'novo pedido', 'fazer pedido', 'create order', 'new order',
        'pedido delivery', 'pedido balcao', 'balc√£o', 'counter order', 'delivery order',
        'finalizar pedido', 'processar pedido', 'salvar pedido', 'complete order'
    ];
    
    const messageNormalized = message.toLowerCase().trim();
    return mcpKeywords.some(keyword => messageNormalized.includes(keyword));
}
```

7.2 EXECU√á√ÉO DE CONSULTAS MCP
-------------------------------

Fun√ß√£o: async executeSupabaseQuery(command, params)
Linha: 5098 (server.js)

COMANDOS SUPORTADOS:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ list_tables                                                     ‚îÇ
‚îÇ Lista todas as tabelas do banco de dados                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ restaurants_data                                                ‚îÇ
‚îÇ Retorna dados do restaurante espec√≠fico                        ‚îÇ
‚îÇ Par√¢metros: restaurant_id                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ orders_data                                                     ‚îÇ
‚îÇ Retorna pedidos do restaurante                                 ‚îÇ
‚îÇ Par√¢metros: restaurant_id                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ customers_data                                                  ‚îÇ
‚îÇ Retorna clientes do restaurante                                ‚îÇ
‚îÇ Par√¢metros: restaurant_id                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ products_data                                                   ‚îÇ
‚îÇ Retorna produtos do restaurante                                ‚îÇ
‚îÇ Par√¢metros: restaurant_id                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ deliverers_data                                                 ‚îÇ
‚îÇ Retorna entregadores do restaurante                            ‚îÇ
‚îÇ Par√¢metros: restaurant_id                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ coupons_data                                                    ‚îÇ
‚îÇ Retorna cupons do restaurante                                  ‚îÇ
‚îÇ Par√¢metros: restaurant_id                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ create_delivery_order                                           ‚îÇ
‚îÇ Cria um pedido de delivery                                      ‚îÇ
‚îÇ Par√¢metros: restaurant_id, customer_name, customer_phone,       ‚îÇ
‚îÇ             delivery_address, items[], total_amount, etc.       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ create_counter_order                                            ‚îÇ
‚îÇ Cria um pedido de balc√£o                                        ‚îÇ
‚îÇ Par√¢metros: restaurant_id, customer_name, items[], etc.         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

7.3 INTEGRA√á√ÉO COM GPT-5-MINI
-------------------------------

Quando palavras-chave MCP s√£o detectadas (linha 3868 server.js):

1. Determinar comando baseado na mensagem:
```javascript
let queryCommand = 'list_tables';
const msg = lastMessage.content.toLowerCase();

if (msg.includes('restaurante') || msg.includes('restaurant')) {
    queryCommand = 'restaurants_data';
} else if (msg.includes('pedido') || msg.includes('order')) {
    queryCommand = 'orders_data';
} else if (msg.includes('cliente') || msg.includes('customer')) {
    queryCommand = 'customers_data';
} // ... etc
```

2. Executar consulta MCP:
```javascript
mcpData = await executeSupabaseQuery(queryCommand, { restaurant_id: restaurant_id });
mcpActivated = true;
```

3. Adicionar dados ao contexto:
```javascript
if (mcpData) {
    const mcpContext = `\n\nüìä DADOS DO SISTEMA MCP:
${typeof mcpData === 'string' ? mcpData : JSON.stringify(mcpData, null, 2)}

Use esses dados para responder √† pergunta do usu√°rio de forma precisa e √∫til.`;
    
    // Modificar a √∫ltima mensagem para incluir o contexto MCP
    messages[messages.length - 1].content += mcpContext;
    console.log('‚úÖ Dados MCP adicionados ao contexto do assistente');
}
```

4. Retornar resposta com flag mcp_activated:
```javascript
res.json({
    response: responseMessage,
    model_used: 'gpt-5-mini',
    reasoning_effort: reasoning_effort || 'medium',
    mcp_activated: true,
    mcp_data: mcpData
});
```

EXEMPLO DE USO:

Usu√°rio: "Quantos pedidos temos hoje?"

1. Sistema detecta palavra-chave "pedidos"
2. Comando MCP: 'orders_data'
3. Consulta banco de dados
4. Retorna: { count: 45, data: [...] }
5. Adiciona ao prompt: "üìä DADOS DO SISTEMA MCP: { count: 45, data: [...] }"
6. GPT-5-mini responde: "Hoje temos 45 pedidos no sistema!"

================================================================================
8. PROMPTS PERSONALIZADOS
================================================================================

O sistema permite que cada restaurante tenha seu pr√≥prio prompt personalizado
para adaptar o comportamento da Ana.

8.1 TABELA DO BANCO DE DADOS
------------------------------

Tabela: ai_system_prompts

Estrutura:
```sql
CREATE TABLE ai_system_prompts (
    id UUID PRIMARY KEY,
    restaurant_id UUID REFERENCES restaurants(id),
    prompt_text TEXT NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

8.2 ENDPOINT DE CARREGAMENTO (CLIENTE)
---------------------------------------

ENDPOINT: GET /api/assistant/system-prompt
Autentica√ß√£o: authenticateEvolutionAPI
Rate Limit: 30 requisi√ß√µes / 60 segundos

Query Params:
- restaurant_id: UUID do restaurante

Response (com prompt personalizado):
```json
{
    "hasCustomPrompt": true,
    "prompt": {
        "id": "uuid",
        "restaurant_id": "uuid",
        "prompt_text": "Voc√™ √© Ana, assistente do Restaurante XYZ...",
        "is_active": true,
        "created_at": "2025-10-07T00:00:00.000Z",
        "updated_at": "2025-10-07T00:00:00.000Z"
    }
}
```

Response (sem prompt personalizado):
```json
{
    "hasCustomPrompt": false,
    "prompt": null
}
```

8.3 ENDPOINT ADMINISTRATIVO
-----------------------------

ENDPOINT: GET /api/admin/system-prompt
Autentica√ß√£o: authenticateAdmin

Query Params:
- restaurant_id: UUID do restaurante (obrigat√≥rio)

ENDPOINT: POST /api/admin/system-prompt
Autentica√ß√£o: authenticateAdmin
Rate Limit: 5 requisi√ß√µes / 60 segundos
CSRF Protection: Sim

Body:
```json
{
    "restaurant_id": "uuid",
    "prompt_text": "Voc√™ √© Ana, assistente virtual..."
}
```

Response:
```json
{
    "success": true,
    "message": "Prompt personalizado salvo com sucesso",
    "prompt": {
        "id": "uuid",
        "restaurant_id": "uuid",
        "prompt_text": "...",
        "is_active": true,
        "created_at": "...",
        "updated_at": "..."
    }
}
```

8.4 USO NO FRONTEND
--------------------

M√©todo: async loadCustomSystemPrompt()
Arquivo: public/js/assistente.js
Linha: 790

C√≥digo:
```javascript
async loadCustomSystemPrompt() {
    if (this.systemPromptLoaded) return;
    
    try {
        const response = await fetch(`/api/assistant/system-prompt?restaurant_id=${this.restaurantData.id}`, {
            credentials: 'include'
        });
        
        if (!response.ok) {
            console.log('‚ö†Ô∏è Nenhum prompt personalizado encontrado, usando prompt padr√£o');
            this.systemPromptLoaded = true;
            return;
        }
        
        const data = await response.json();
        
        if (data.hasCustomPrompt && data.prompt?.prompt_text) {
            this.customSystemPrompt = data.prompt.prompt_text;
            console.log('‚úÖ Prompt personalizado carregado para', this.restaurantData.name);
        } else {
            console.log('üìù Usando prompt padr√£o do sistema');
        }
        
        this.systemPromptLoaded = true;
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar prompt personalizado:', error);
        this.systemPromptLoaded = true;
    }
}
```

PROMPT PADR√ÉO (caso n√£o haja personalizado):
```
Voc√™ √© Ana, assistente virtual calorosa e humanizada para o restaurante [Nome].

Seu papel √© atender clientes com gentileza, tirar d√∫vidas sobre o card√°pio,
ajudar a fazer pedidos e confirmar endere√ßos de entrega.

Caracter√≠sticas:
- Sempre gentil e atenciosa
- Use emojis moderadamente
- Seja objetiva mas amig√°vel
- Confirme sempre os dados importantes
- Ajude o cliente a escolher produtos

Lembre-se: voc√™ est√° representando o restaurante, ent√£o mantenha sempre
um atendimento de excel√™ncia!
```

================================================================================
9. RATE LIMITING E SEGURAN√áA
================================================================================

9.1 RATE LIMITING
------------------

Middleware: rateLimitEvolutionAPI(maxRequests, windowMs)

CONFIGURA√á√ïES:

Endpoint: /api/assistant/chat
- Limite: 30 requisi√ß√µes
- Janela: 60000ms (60 segundos)
- Por IP ou sess√£o

Endpoint: /api/assistant/menu/:restaurantId
- Limite: 30 requisi√ß√µes
- Janela: 60000ms (60 segundos)

Endpoint: /api/assistant/create-order
- Limite: 10 requisi√ß√µes
- Janela: 60000ms (60 segundos)

Endpoint: /api/assistant/product-info
- Limite: 30 requisi√ß√µes
- Janela: 60000ms (60 segundos)

Endpoint: /api/assistant/system-prompt (GET)
- Limite: 30 requisi√ß√µes
- Janela: 60000ms (60 segundos)

Endpoint: /api/assistant/system-prompt (POST)
- Limite: 5 requisi√ß√µes
- Janela: 60000ms (60 segundos)

9.2 AUTENTICA√á√ÉO
-----------------

CLIENTES:
- Middleware: authenticateEvolutionAPI
- Valida√ß√£o de sess√£o
- Verifica√ß√£o de restaurant_id
- Prote√ß√£o contra acesso n√£o autorizado

ADMINISTRADORES:
- Middleware: authenticateAdmin
- Autentica√ß√£o administrativa
- Permiss√µes elevadas
- Acesso a endpoints privilegiados

9.3 PROTE√á√ÉO CSRF
------------------

Endpoints protegidos:
- POST /api/assistant/system-prompt
- POST /api/admin/system-prompt

Middleware: csrfProtection

Token CSRF obtido em:
- GET /api/admin/csrf-token

9.4 SEGURAN√áA DA API KEY
-------------------------

NUNCA EXPOR:
```javascript
// ‚ùå ERRADO - Expor a chave
res.json({
    apiKey: process.env.OPENAI_API_KEY  // NUNCA FAZER ISSO
});

// ‚úÖ CORRETO - Manter no servidor
const apiKey = process.env.OPENAI_API_KEY;
// Usar apenas no backend
```

VALIDA√á√ÉO:
```javascript
const apiKey = process.env.OPENAI_API_KEY;
if (!apiKey) {
    console.error('‚ùå OPENAI_API_KEY n√£o configurada');
    return res.status(500).json({ 
        error: 'Configura√ß√£o da OpenAI API n√£o encontrada' 
    });
}
```

ARMAZENAMENTO:
- Vari√°vel de ambiente (process.env)
- Secrets do Replit
- NUNCA em c√≥digo ou frontend

================================================================================
10. TROUBLESHOOTING
================================================================================

10.1 PROBLEMAS COMUNS
----------------------

PROBLEMA: "OPENAI_API_KEY n√£o configurada"
CAUSA: Vari√°vel de ambiente n√£o definida
SOLU√á√ÉO:
1. Verificar Secrets no Replit
2. Adicionar OPENAI_API_KEY com valor v√°lido
3. Reiniciar servidor

PROBLEMA: "Erro na OpenAI API: 401"
CAUSA: API key inv√°lida ou expirada
SOLU√á√ÉO:
1. Verificar validade da chave em platform.openai.com
2. Gerar nova chave se necess√°rio
3. Atualizar secret OPENAI_API_KEY

PROBLEMA: "Erro na OpenAI API: 429"
CAUSA: Rate limit da OpenAI excedido
SOLU√á√ÉO:
1. Aguardar reset do limite
2. Verificar uso em platform.openai.com
3. Considerar upgrade de plano

PROBLEMA: "Timeout na conex√£o com OpenAI"
CAUSA: Rede inst√°vel ou API temporariamente indispon√≠vel
SOLU√á√ÉO:
1. Verificar status em status.openai.com
2. Tentar novamente
3. Implementar retry logic

PROBLEMA: "Ana n√£o responde"
CAUSA: Diversos fatores
DEBUG:
1. Verificar console do navegador
2. Verificar logs do servidor
3. Testar endpoint /api/health
4. Verificar se OPENAI_API_KEY est√° configurada
5. Testar chamada direta √† API

PROBLEMA: "Resposta em ingl√™s ao inv√©s de portugu√™s"
CAUSA: Prompt do sistema n√£o est√° em portugu√™s
SOLU√á√ÉO:
1. Verificar prompt personalizado
2. Garantir que est√° em pt-BR
3. Adicionar instru√ß√£o expl√≠cita: "Responda SEMPRE em portugu√™s brasileiro"

PROBLEMA: "MCP n√£o est√° ativando"
CAUSA: Palavras-chave n√£o detectadas
SOLU√á√ÉO:
1. Usar palavras-chave espec√≠ficas (ver se√ß√£o 7.1)
2. Exemplo: "Mostre os dados dos pedidos"
3. Verificar logs: "üîß Palavras-chave MCP detectadas"

PROBLEMA: "Prompt personalizado n√£o carrega"
CAUSA: Erro na consulta ao banco ou prompt inativo
SOLU√á√ÉO:
1. Verificar tabela ai_system_prompts
2. Garantir is_active = true
3. Verificar restaurant_id correto
4. Verificar logs do servidor

10.2 LOGS E DEBUGGING
----------------------

LOGS IMPORTANTES:

Inicializa√ß√£o:
- "üîß Servindo GPT-5-mini config via OpenAI API"
- "‚úÖ Ana inicializada com sucesso"

Processamento:
- "ü§ñ Ana processando mensagem para restaurante {id}"
- "üîß Palavras-chave MCP detectadas, executando consulta..."
- "‚úÖ Ana respondeu para {session_id}"

Erros:
- "‚ùå OPENAI_API_KEY n√£o configurada"
- "‚ùå Erro na OpenAI API:"
- "‚ùå Erro no endpoint do assistente:"

VERIFICAR NO CONSOLE:
```javascript
// Status da configura√ß√£o
console.log('Mapbox Token:', window.MAPBOX_ACCESS_TOKEN);
console.log('Supabase Client:', supabase);

// Estado da Ana
console.log('Ana Messages:', ana.messages);
console.log('Ana Memory:', ana.chatMemory);
console.log('Restaurant Data:', ana.restaurantData);

// Testar endpoint
fetch('/api/config/openai')
    .then(r => r.json())
    .then(console.log);
```

10.3 HEALTH CHECK
------------------

VERIFICAR STATUS:
```bash
curl http://localhost:5000/api/health
```

Response esperada:
```json
{
    "status": "ok",
    "services": {
        "openai": "connected",
        "supabase": "connected",
        "evolution": "connected",
        "mapbox": "connected"
    }
}
```

Se openai != "connected":
- "not_configured": Adicionar OPENAI_API_KEY
- "timeout": Problema de rede
- "error": Verificar validade da chave

10.4 TESTE DE INTEGRA√á√ÉO
--------------------------

TESTE MANUAL (cURL):
```bash
# Obter CSRF token (se necess√°rio)
curl -X GET http://localhost:5000/api/admin/csrf-token \
  -H "Cookie: session=..." \
  -c cookies.txt

# Testar chat
curl -X POST http://localhost:5000/api/assistant/chat \
  -H "Content-Type: application/json" \
  -H "Cookie: session=..." \
  -d '{
    "messages": [
      {
        "role": "system",
        "content": "Voc√™ √© Ana, assistente virtual."
      },
      {
        "role": "user",
        "content": "Ol√°!"
      }
    ],
    "model": "gpt-5-mini",
    "restaurant_id": "uuid-do-restaurante",
    "session_id": "test-123"
  }'
```

TESTE VIA JAVASCRIPT (Console):
```javascript
// No console do navegador
fetch('/api/assistant/chat', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    credentials: 'include',
    body: JSON.stringify({
        messages: [
            { role: 'system', content: 'Voc√™ √© Ana.' },
            { role: 'user', content: 'Ol√°!' }
        ],
        model: 'gpt-5-mini',
        restaurant_id: 'uuid',
        session_id: 'test'
    })
})
.then(r => r.json())
.then(console.log);
```

================================================================================
RESUMO EXECUTIVO
================================================================================

MODELO: GPT-5-mini
PROVIDER: OpenAI (https://api.openai.com/v1)
CHAVE: OPENAI_API_KEY (vari√°vel de ambiente)

ENDPOINTS PRINCIPAIS:
‚úì POST /api/assistant/chat (clientes)
‚úì POST /api/admin/assistant/chat (administradores)
‚úì GET /api/config/openai (configura√ß√£o p√∫blica)
‚úì GET /api/health (status)

ASSISTENTES:
‚úì Ana - Assistente Virtual (clientes)
‚úì Assistente Administrativo (gest√£o)

RECURSOS ESPECIAIS:
‚úì MCP - Model Context Protocol (acesso a dados)
‚úì Prompts personalizados por restaurante
‚úì Mem√≥ria de conversa persistente
‚úì Rate limiting configur√°vel
‚úì Integra√ß√£o com Supabase

PAR√ÇMETROS T√çPICOS:
- model: 'gpt-5-mini'
- max_completion_tokens: 4096
- temperature: 0.7
- reasoning_effort: 'medium'
- stream: false

SEGURAN√áA:
‚úì API key protegida no servidor
‚úì Autentica√ß√£o obrigat√≥ria
‚úì Rate limiting ativo
‚úì CSRF protection em endpoints de escrita
‚úì Valida√ß√£o de restaurant_id

RATE LIMITS:
- Chat: 30 req/min
- Cria√ß√£o de pedidos: 10 req/min
- Salvamento de prompts: 5 req/min

================================================================================
FIM DA DOCUMENTA√á√ÉO
================================================================================

√öltima atualiza√ß√£o: 07/10/2025
Vers√£o do sistema: TimePulse AI 1.0.0
Modelo: GPT-5-mini
Desenvolvido por: TimePulse Team

Para suporte adicional, consulte:
- Documenta√ß√£o OpenAI: https://platform.openai.com/docs
- Status da API: https://status.openai.com
- Dashboard: https://platform.openai.com/account/usage
