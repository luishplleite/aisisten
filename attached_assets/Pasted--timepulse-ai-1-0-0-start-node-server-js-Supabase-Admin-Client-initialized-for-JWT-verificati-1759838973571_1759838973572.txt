
> timepulse-ai@1.0.0 start
> node server.js

✅ Supabase Admin Client initialized for JWT verification
🛡️ Endpoints administrativos adicionais configurados
✅ Servidor TimePulse AI rodando em http://0.0.0.0:5000
   Servidor iniciado em: 10/7/2025, 12:07:11 PM
📊 Ambiente: development
🔒 Modo de segurança: Desenvolvimento
🛡️ Sistema administrativo: Endpoints /api/admin/* disponíveis
💳 Sistema de assinaturas: Endpoints /api/asaas/* disponíveis
🔧 Sistema MCP: Endpoints /api/mcp/* disponíveis
🚫 No-cache headers aplicados para: /js/secure-config.js
📊 Rate limit OK para 172.31.111.98: 1/10
❌ ID de restaurante inválido: dev-restaurant-1
🔐 Verificando autenticação para Evolution API...
🔍 Debug cookies recebidos: Sim (325 chars)
🔍 JSON Cookie encontrado: Sim
✅ Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
✅ Usuário autenticado: luishplleite@gmail.com
📊 Rate limit OK para luishplleite@gmail.com: 1/30
🔍 Validando nome da instância: "Frutidelis" (length: 10)
✅ Nome da instância válido: "Frutidelis"
🔍 Proxy Evolution: Verificando instância "Frutidelis"
✅ Evolution: Instância "Frutidelis" - Status: open
📊 Rate limit OK para 172.31.111.98: 2/10
🔐 Verificando autenticação para Evolution API...
🔍 Debug cookies recebidos: Sim (325 chars)
🔍 JSON Cookie encontrado: Sim
✅ Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
✅ Usuário autenticado: luishplleite@gmail.com
📊 Rate limit OK para luishplleite@gmail.com: 2/30
🔍 Validando nome da instância: "Frutidelis" (length: 10)
✅ Nome da instância válido: "Frutidelis"
🔍 Proxy Evolution: Verificando instância "Frutidelis"
✅ Evolution: Instância "Frutidelis" - Status: open
📊 Status do teste para restaurante 50b2dbcb-66bb-4969-92cf-493f03237e49: active, 0 dias restantes
📨 Webhook Evolution API recebido: {
  "event": "messages.upsert",
  "instance": "Frutidelis",
  "messageType": "conversation",
  "hasMessage": true,
  "fromMe": false,
  "pushName": "Luis Leite"
}
💬 Mensagem de Luis Leite na instância Frutidelis: Oi
📝 Mensagem armazenada no histórico. Total: 1
🏪 Restaurante encontrado: Frutidelis (ID: 50b2dbcb-66bb-4969-92cf-493f03237e49)
🔍 Buscando contexto completo via MCP...
📞 Telefone normalizado: 5513991292600@s.whatsapp.net -> +5513991292600
📞 Buscando cliente em 5 formatos de telefone
🔧 Executando consulta Supabase: customers_data {
  phone: '+5513991292600',
  restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49'
}
🔍 Buscando cliente por telefone: +*********2600
📞 Tentando 2 formatos de telefone
✅ Cliente encontrado via busca otimizada
✅ Consulta Supabase executada com sucesso
👤 Cliente encontrado: Luis Leite (formato: +5513991292600)
🔧 Executando consulta Supabase: products_data { restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49' }
🔍 Buscando cardápio completo para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
📦 Cardápio salvo no cache para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
✅ Consulta Supabase executada com sucesso
📝 Cardápio carregado: 2 categorias, 5 produtos
💾 Mensagem salva no histórico: 5513991292600@s.whatsapp.net (user)
❌ Erro ao carregar histórico: {
  code: '42703',
  details: null,
  hint: null,
  message: 'column chat_histories.created_at does not exist'
}
🤖 Processando mensagem com Ana...
📚 Usando histórico de 0 mensagens
🎯 Buscando prompt para tipo de negócio: lanchonete
✅ Prompt personalizado carregado para tipo: lanchonete
✅ Ana processou a mensagem: Oi! Que alegria te ver por aqui! 😊 

Só pra confirmar, qual é o seu nome?...
💾 Mensagem salva no histórico: 5513991292600@s.whatsapp.net (assistant)
📤 Enviando mensagem via Evolution API: {
  instance: 'Frutidelis',
  remoteJid: '5513991292600@s.whatsapp.net',
  cleanNumber: '5513991292600',
  messageLength: 74
}
✅ Mensagem enviada com sucesso via Evolution API
✅ Resposta enviada com sucesso via Evolution API
📨 Webhook Evolution API recebido: {
  "event": "messages.update",
  "instance": "Frutidelis",
  "hasMessage": false,
  "pushName": "Anônimo"
}
⚠️ Webhook inválido: estrutura incorreta
🔐 Verificando autenticação para Evolution API...
🔍 Debug cookies recebidos: Sim (325 chars)
🔍 JSON Cookie encontrado: Sim
✅ Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
✅ Usuário autenticado: luishplleite@gmail.com
📊 Rate limit OK para luishplleite@gmail.com: 3/30
🔍 Validando nome da instância: "Frutidelis" (length: 10)
✅ Nome da instância válido: "Frutidelis"
🔍 Proxy Evolution: Verificando instância "Frutidelis"
✅ Evolution: Instância "Frutidelis" - Status: open
📊 Rate limit OK para 172.31.111.98: 3/10
🔐 Verificando autenticação para Evolution API...
🔍 Debug cookies recebidos: Sim (325 chars)
🔍 JSON Cookie encontrado: Sim
✅ Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
✅ Usuário autenticado: luishplleite@gmail.com
📊 Rate limit OK para luishplleite@gmail.com: 4/30
🔍 Validando nome da instância: "Frutidelis" (length: 10)
✅ Nome da instância válido: "Frutidelis"
🔍 Proxy Evolution: Verificando instância "Frutidelis"
✅ Evolution: Instância "Frutidelis" - Status: open
📊 Status do teste para restaurante 50b2dbcb-66bb-4969-92cf-493f03237e49: active, 0 dias restantes
📨 Webhook Evolution API recebido: {
  "event": "messages.upsert",
  "instance": "Frutidelis",
  "messageType": "conversation",
  "hasMessage": true,
  "fromMe": false,
  "pushName": "Luis Leite"
}
💬 Mensagem de Luis Leite na instância Frutidelis: Quais ferramentas no MCP tem disponível
📝 Mensagem armazenada no histórico. Total: 2
🏪 Restaurante encontrado: Frutidelis (ID: 50b2dbcb-66bb-4969-92cf-493f03237e49)
🔍 Buscando contexto completo via MCP...
📞 Telefone normalizado: 5513991292600@s.whatsapp.net -> +5513991292600
📞 Buscando cliente em 5 formatos de telefone
🔧 Executando consulta Supabase: customers_data {
  phone: '+5513991292600',
  restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49'
}
🔍 Buscando cliente por telefone: +*********2600
📞 Tentando 2 formatos de telefone
✅ Cliente encontrado via busca otimizada
✅ Consulta Supabase executada com sucesso
👤 Cliente encontrado: Luis Leite (formato: +5513991292600)
🔧 Executando consulta Supabase: products_data { restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49' }
🔍 Buscando cardápio completo para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
📦 Cardápio carregado do cache para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
✅ Consulta Supabase executada com sucesso
📝 Cardápio carregado: 2 categorias, 5 produtos
💾 Mensagem salva no histórico: 5513991292600@s.whatsapp.net (user)
❌ Erro ao carregar histórico: {
  code: '42703',
  details: null,
  hint: null,
  message: 'column chat_histories.created_at does not exist'
}
🤖 Processando mensagem com Ana...
📚 Usando histórico de 0 mensagens
🎯 Buscando prompt para tipo de negócio: lanchonete
✅ Prompt personalizado carregado para tipo: lanchonete
🔧 Palavras-chave MCP detectadas no WhatsApp, executando consulta...
🔧 Executando consulta Supabase: list_tables { restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49' }
✅ Consulta Supabase executada com sucesso
✅ Dados MCP obtidos com sucesso no WhatsApp
✅ Dados MCP adicionados ao contexto do WhatsApp
✅ Ana processou a mensagem (com dados MCP): No MCP, temos várias ferramentas disponíveis que nos ajudam a gerenciar o restaurante e atender você...
💾 Mensagem salva no histórico: 5513991292600@s.whatsapp.net (assistant)
📤 Enviando mensagem via Evolution API: {
  instance: 'Frutidelis',
  remoteJid: '5513991292600@s.whatsapp.net',
  cleanNumber: '5513991292600',
  messageLength: 1861
}
✅ Mensagem enviada com sucesso via Evolution API
✅ Resposta enviada com sucesso via Evolution API
📨 Webhook Evolution API recebido: {
  "event": "messages.update",
  "instance": "Frutidelis",
  "hasMessage": false,
  "pushName": "Anônimo"
}
⚠️ Webhook inválido: estrutura incorreta
🔐 Verificando autenticação para Evolution API...
🔍 Debug cookies recebidos: Sim (325 chars)
🔍 JSON Cookie encontrado: Sim
✅ Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
✅ Usuário autenticado: luishplleite@gmail.com
📊 Rate limit OK para luishplleite@gmail.com: 1/30
🔍 Validando nome da instância: "Frutidelis" (length: 10)
✅ Nome da instância válido: "Frutidelis"
🔍 Proxy Evolution: Verificando instância "Frutidelis"
✅ Evolution: Instância "Frutidelis" - Status: open
🔐 Verificando autenticação para Evolution API...
🔍 Debug cookies recebidos: Sim (325 chars)
🔍 JSON Cookie encontrado: Sim
✅ Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
✅ Usuário autenticado: luishplleite@gmail.com
📊 Rate limit OK para luishplleite@gmail.com: 2/30
🔍 Validando nome da instância: "Frutidelis" (length: 10)
✅ Nome da instância válido: "Frutidelis"
🔍 Proxy Evolution: Verificando instância "Frutidelis"
📊 Rate limit OK para 172.31.111.98: 1/10
✅ Evolution: Instância "Frutidelis" - Status: open
📊 Status do teste para restaurante 50b2dbcb-66bb-4969-92cf-493f03237e49: active, 0 dias restantes
^C