
> timepulse-ai@1.0.0 start
> node server.js

âœ… Supabase Admin Client initialized for JWT verification
ğŸ›¡ï¸ Endpoints administrativos adicionais configurados
âœ… Servidor TimePulse AI rodando em http://0.0.0.0:5000
   Servidor iniciado em: 10/7/2025, 12:07:11 PM
ğŸ“Š Ambiente: development
ğŸ”’ Modo de seguranÃ§a: Desenvolvimento
ğŸ›¡ï¸ Sistema administrativo: Endpoints /api/admin/* disponÃ­veis
ğŸ’³ Sistema de assinaturas: Endpoints /api/asaas/* disponÃ­veis
ğŸ”§ Sistema MCP: Endpoints /api/mcp/* disponÃ­veis
ğŸš« No-cache headers aplicados para: /js/secure-config.js
ğŸ“Š Rate limit OK para 172.31.111.98: 1/10
âŒ ID de restaurante invÃ¡lido: dev-restaurant-1
ğŸ” Verificando autenticaÃ§Ã£o para Evolution API...
ğŸ” Debug cookies recebidos: Sim (325 chars)
ğŸ” JSON Cookie encontrado: Sim
âœ… Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
âœ… UsuÃ¡rio autenticado: luishplleite@gmail.com
ğŸ“Š Rate limit OK para luishplleite@gmail.com: 1/30
ğŸ” Validando nome da instÃ¢ncia: "Frutidelis" (length: 10)
âœ… Nome da instÃ¢ncia vÃ¡lido: "Frutidelis"
ğŸ” Proxy Evolution: Verificando instÃ¢ncia "Frutidelis"
âœ… Evolution: InstÃ¢ncia "Frutidelis" - Status: open
ğŸ“Š Rate limit OK para 172.31.111.98: 2/10
ğŸ” Verificando autenticaÃ§Ã£o para Evolution API...
ğŸ” Debug cookies recebidos: Sim (325 chars)
ğŸ” JSON Cookie encontrado: Sim
âœ… Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
âœ… UsuÃ¡rio autenticado: luishplleite@gmail.com
ğŸ“Š Rate limit OK para luishplleite@gmail.com: 2/30
ğŸ” Validando nome da instÃ¢ncia: "Frutidelis" (length: 10)
âœ… Nome da instÃ¢ncia vÃ¡lido: "Frutidelis"
ğŸ” Proxy Evolution: Verificando instÃ¢ncia "Frutidelis"
âœ… Evolution: InstÃ¢ncia "Frutidelis" - Status: open
ğŸ“Š Status do teste para restaurante 50b2dbcb-66bb-4969-92cf-493f03237e49: active, 0 dias restantes
ğŸ“¨ Webhook Evolution API recebido: {
  "event": "messages.upsert",
  "instance": "Frutidelis",
  "messageType": "conversation",
  "hasMessage": true,
  "fromMe": false,
  "pushName": "Luis Leite"
}
ğŸ’¬ Mensagem de Luis Leite na instÃ¢ncia Frutidelis: Oi
ğŸ“ Mensagem armazenada no histÃ³rico. Total: 1
ğŸª Restaurante encontrado: Frutidelis (ID: 50b2dbcb-66bb-4969-92cf-493f03237e49)
ğŸ” Buscando contexto completo via MCP...
ğŸ“ Telefone normalizado: 5513991292600@s.whatsapp.net -> +5513991292600
ğŸ“ Buscando cliente em 5 formatos de telefone
ğŸ”§ Executando consulta Supabase: customers_data {
  phone: '+5513991292600',
  restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49'
}
ğŸ” Buscando cliente por telefone: +*********2600
ğŸ“ Tentando 2 formatos de telefone
âœ… Cliente encontrado via busca otimizada
âœ… Consulta Supabase executada com sucesso
ğŸ‘¤ Cliente encontrado: Luis Leite (formato: +5513991292600)
ğŸ”§ Executando consulta Supabase: products_data { restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49' }
ğŸ” Buscando cardÃ¡pio completo para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
ğŸ“¦ CardÃ¡pio salvo no cache para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
âœ… Consulta Supabase executada com sucesso
ğŸ“ CardÃ¡pio carregado: 2 categorias, 5 produtos
ğŸ’¾ Mensagem salva no histÃ³rico: 5513991292600@s.whatsapp.net (user)
âŒ Erro ao carregar histÃ³rico: {
  code: '42703',
  details: null,
  hint: null,
  message: 'column chat_histories.created_at does not exist'
}
ğŸ¤– Processando mensagem com Ana...
ğŸ“š Usando histÃ³rico de 0 mensagens
ğŸ¯ Buscando prompt para tipo de negÃ³cio: lanchonete
âœ… Prompt personalizado carregado para tipo: lanchonete
âœ… Ana processou a mensagem: Oi! Que alegria te ver por aqui! ğŸ˜Š 

SÃ³ pra confirmar, qual Ã© o seu nome?...
ğŸ’¾ Mensagem salva no histÃ³rico: 5513991292600@s.whatsapp.net (assistant)
ğŸ“¤ Enviando mensagem via Evolution API: {
  instance: 'Frutidelis',
  remoteJid: '5513991292600@s.whatsapp.net',
  cleanNumber: '5513991292600',
  messageLength: 74
}
âœ… Mensagem enviada com sucesso via Evolution API
âœ… Resposta enviada com sucesso via Evolution API
ğŸ“¨ Webhook Evolution API recebido: {
  "event": "messages.update",
  "instance": "Frutidelis",
  "hasMessage": false,
  "pushName": "AnÃ´nimo"
}
âš ï¸ Webhook invÃ¡lido: estrutura incorreta
ğŸ” Verificando autenticaÃ§Ã£o para Evolution API...
ğŸ” Debug cookies recebidos: Sim (325 chars)
ğŸ” JSON Cookie encontrado: Sim
âœ… Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
âœ… UsuÃ¡rio autenticado: luishplleite@gmail.com
ğŸ“Š Rate limit OK para luishplleite@gmail.com: 3/30
ğŸ” Validando nome da instÃ¢ncia: "Frutidelis" (length: 10)
âœ… Nome da instÃ¢ncia vÃ¡lido: "Frutidelis"
ğŸ” Proxy Evolution: Verificando instÃ¢ncia "Frutidelis"
âœ… Evolution: InstÃ¢ncia "Frutidelis" - Status: open
ğŸ“Š Rate limit OK para 172.31.111.98: 3/10
ğŸ” Verificando autenticaÃ§Ã£o para Evolution API...
ğŸ” Debug cookies recebidos: Sim (325 chars)
ğŸ” JSON Cookie encontrado: Sim
âœ… Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
âœ… UsuÃ¡rio autenticado: luishplleite@gmail.com
ğŸ“Š Rate limit OK para luishplleite@gmail.com: 4/30
ğŸ” Validando nome da instÃ¢ncia: "Frutidelis" (length: 10)
âœ… Nome da instÃ¢ncia vÃ¡lido: "Frutidelis"
ğŸ” Proxy Evolution: Verificando instÃ¢ncia "Frutidelis"
âœ… Evolution: InstÃ¢ncia "Frutidelis" - Status: open
ğŸ“Š Status do teste para restaurante 50b2dbcb-66bb-4969-92cf-493f03237e49: active, 0 dias restantes
ğŸ“¨ Webhook Evolution API recebido: {
  "event": "messages.upsert",
  "instance": "Frutidelis",
  "messageType": "conversation",
  "hasMessage": true,
  "fromMe": false,
  "pushName": "Luis Leite"
}
ğŸ’¬ Mensagem de Luis Leite na instÃ¢ncia Frutidelis: Quais ferramentas no MCP tem disponÃ­vel
ğŸ“ Mensagem armazenada no histÃ³rico. Total: 2
ğŸª Restaurante encontrado: Frutidelis (ID: 50b2dbcb-66bb-4969-92cf-493f03237e49)
ğŸ” Buscando contexto completo via MCP...
ğŸ“ Telefone normalizado: 5513991292600@s.whatsapp.net -> +5513991292600
ğŸ“ Buscando cliente em 5 formatos de telefone
ğŸ”§ Executando consulta Supabase: customers_data {
  phone: '+5513991292600',
  restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49'
}
ğŸ” Buscando cliente por telefone: +*********2600
ğŸ“ Tentando 2 formatos de telefone
âœ… Cliente encontrado via busca otimizada
âœ… Consulta Supabase executada com sucesso
ğŸ‘¤ Cliente encontrado: Luis Leite (formato: +5513991292600)
ğŸ”§ Executando consulta Supabase: products_data { restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49' }
ğŸ” Buscando cardÃ¡pio completo para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
ğŸ“¦ CardÃ¡pio carregado do cache para restaurante: 50b2dbcb-66bb-4969-92cf-493f03237e49
âœ… Consulta Supabase executada com sucesso
ğŸ“ CardÃ¡pio carregado: 2 categorias, 5 produtos
ğŸ’¾ Mensagem salva no histÃ³rico: 5513991292600@s.whatsapp.net (user)
âŒ Erro ao carregar histÃ³rico: {
  code: '42703',
  details: null,
  hint: null,
  message: 'column chat_histories.created_at does not exist'
}
ğŸ¤– Processando mensagem com Ana...
ğŸ“š Usando histÃ³rico de 0 mensagens
ğŸ¯ Buscando prompt para tipo de negÃ³cio: lanchonete
âœ… Prompt personalizado carregado para tipo: lanchonete
ğŸ”§ Palavras-chave MCP detectadas no WhatsApp, executando consulta...
ğŸ”§ Executando consulta Supabase: list_tables { restaurant_id: '50b2dbcb-66bb-4969-92cf-493f03237e49' }
âœ… Consulta Supabase executada com sucesso
âœ… Dados MCP obtidos com sucesso no WhatsApp
âœ… Dados MCP adicionados ao contexto do WhatsApp
âœ… Ana processou a mensagem (com dados MCP): No MCP, temos vÃ¡rias ferramentas disponÃ­veis que nos ajudam a gerenciar o restaurante e atender vocÃª...
ğŸ’¾ Mensagem salva no histÃ³rico: 5513991292600@s.whatsapp.net (assistant)
ğŸ“¤ Enviando mensagem via Evolution API: {
  instance: 'Frutidelis',
  remoteJid: '5513991292600@s.whatsapp.net',
  cleanNumber: '5513991292600',
  messageLength: 1861
}
âœ… Mensagem enviada com sucesso via Evolution API
âœ… Resposta enviada com sucesso via Evolution API
ğŸ“¨ Webhook Evolution API recebido: {
  "event": "messages.update",
  "instance": "Frutidelis",
  "hasMessage": false,
  "pushName": "AnÃ´nimo"
}
âš ï¸ Webhook invÃ¡lido: estrutura incorreta
ğŸ” Verificando autenticaÃ§Ã£o para Evolution API...
ğŸ” Debug cookies recebidos: Sim (325 chars)
ğŸ” JSON Cookie encontrado: Sim
âœ… Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
âœ… UsuÃ¡rio autenticado: luishplleite@gmail.com
ğŸ“Š Rate limit OK para luishplleite@gmail.com: 1/30
ğŸ” Validando nome da instÃ¢ncia: "Frutidelis" (length: 10)
âœ… Nome da instÃ¢ncia vÃ¡lido: "Frutidelis"
ğŸ” Proxy Evolution: Verificando instÃ¢ncia "Frutidelis"
âœ… Evolution: InstÃ¢ncia "Frutidelis" - Status: open
ğŸ” Verificando autenticaÃ§Ã£o para Evolution API...
ğŸ” Debug cookies recebidos: Sim (325 chars)
ğŸ” JSON Cookie encontrado: Sim
âœ… Cookie JSON parseado com sucesso: {
  hasInstanceId: true,
  hasToken: true,
  hasRestaurantId: true,
  hasUserEmail: true,
  instanceName: 'Frutidelis'
}
âœ… UsuÃ¡rio autenticado: luishplleite@gmail.com
ğŸ“Š Rate limit OK para luishplleite@gmail.com: 2/30
ğŸ” Validando nome da instÃ¢ncia: "Frutidelis" (length: 10)
âœ… Nome da instÃ¢ncia vÃ¡lido: "Frutidelis"
ğŸ” Proxy Evolution: Verificando instÃ¢ncia "Frutidelis"
ğŸ“Š Rate limit OK para 172.31.111.98: 1/10
âœ… Evolution: InstÃ¢ncia "Frutidelis" - Status: open
ğŸ“Š Status do teste para restaurante 50b2dbcb-66bb-4969-92cf-493f03237e49: active, 0 dias restantes
^C